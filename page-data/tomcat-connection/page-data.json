{"componentChunkName":"component---src-templates-post-jsx","path":"/tomcat-connection/","result":{"data":{"site":{"siteMetadata":{"title":"소잉데이"}},"markdownRemark":{"id":"c2d0081b-ae3d-5801-ace1-d61452e19444","excerpt":"개요 지난 게시물에서는 Tomcat의 아키텍처와 클라이언트와의 연결 방식, 그리고 요청 처리 메커니즘에 대해 알아보았다.\n특히, NIO Connector의 Selector를 활용한 이벤트 루프 처리 방식은 BIO Connector에 비해 훨씬 더 많은 연결을 효율적으로 관리하면서 요청을 처리할 수 있게 만들었다. 이번 게시물에서는 Tomcat이 Selec…","html":"<h2 id=\"개요\" style=\"position:relative;\">개요<a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><a href=\"https://px201226.github.io/tomcat/\">지난 게시물</a>에서는 Tomcat의 아키텍처와 클라이언트와의 연결 방식, 그리고 요청 처리 메커니즘에 대해 알아보았다.\n특히, NIO Connector의 Selector를 활용한 이벤트 루프 처리 방식은 BIO Connector에 비해 훨씬 더 많은 연결을 효율적으로 관리하면서 요청을 처리할 수 있게 만들었다.</p>\n<p>이번 게시물에서는 Tomcat이 Selector를 통해 관리하는 수 많은 연결들을 타임아웃 관점에서 어떻게 관리하는지에 대해 살펴본다.</p>\n<h2 id=\"Tomcat의-타임아웃-관리\" style=\"position:relative;\">Tomcat의 타임아웃 관리<a href=\"#Tomcat%EC%9D%98-%ED%83%80%EC%9E%84%EC%95%84%EC%9B%83-%EA%B4%80%EB%A6%AC\" aria-label=\"Tomcat의 타임아웃 관리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>네트워크에서 발생할 수 있는 타임아웃에는 크게 3-way-handshake 중 발생하는 Connection Timeout, Read Timeout, Write Timeout 이 있다.\n이 중 톰캣과 같은 서버 측에서 Connection Timeout은 핸들링 할 수 없는데, 그 이유는 서버에서는 클라이언트 요청을 받기 위해 무한정 대기하고 핸드 쉐이크 중 에러가 발생하더라도\nTCP/IP 스택에서 자동으로 처리되기 때문이다.</p>\n<p>네트워크 상에서 Read/Write Timeout 의미는 데이터를 read/write 위해 최대 대기하는 시간을 의미한다.\n예를 들어 socket.read()에 타임아웃을 10초로 설정했다면, 이는 소켓에서 데이터를 읽기 시작하기 전에 최대 10초 동안 대기할 수 있다는 것을 의미한다.\n만약 9초에 첫 번째 패킷이 도착하고 15초에 모든 패킷 전송이 끝나더라도, socket.read()는 이미 데이터를 읽기 시작했기 때문에 타임아웃이 발생하지 않는다.\n즉, 타임아웃은 데이터가 처음으로 도착하기 전 최대 대기 시간을 말한다. 데이터가 도착하기 시작한 후에는 타임아웃은 적용되지 않는다.</p>\n<p>Spring/Tomcat 에서는 아래와 같은 Timeout 속성을 제공한다. </p>\n<ul>\n<li><strong>server.tomcat.connection-timeout</strong> : 연결을 수락한 후 요청 URI 줄이 제시될 때까지 얼마 동안 기다릴지를 밀리초 단위로 정한다. -1을 사용하면 시간 제한이 없다는 의미다. 기본값은 60초이다.   </li>\n<li><strong>server.tomcat.keep-alive-timeout</strong> : 다른 HTTP 요청을 기다리기 전에 연결을 닫을 때까지 얼마 동안 기다릴지를 밀리초 단위로 정한다. 기본값은 connectionTimeout 속성에 설정된 값을 사용한다. -1 값을 사용하면 시간 제한이 없다는 의미다.</li>\n</ul>\n<p>Tomcat에서는 별도의 Read/Write Timeout 속성은 제공하지 않고 connection-timeout 속성을 제공한다.\nAcceptor 스레드에서 클라이언트 연결이 이루어지면 해당 소켓의 Read/Write Timeout을  connection-timeout으로 설정하고 Poller 에 등록된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">setReadTimeout</span><span class=\"token punctuation\">(</span><span class=\"token function\">getConnectionTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsocketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">setWriteTimeout</span><span class=\"token punctuation\">(</span><span class=\"token function\">getConnectionTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그 후, Poller는 이벤트 루프를 돌면서 해당 소켓이 타임아웃이 발생하였는지 검사한다.\n아래는 Poller의 이벤트 루프 로직을 단순화 한 것 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">boolean</span> hasEvents <span class=\"token operator\">=</span> <span class=\"token function\">events</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        keyCount <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\n        <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span>\n            keyCount <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t  <span class=\"token function\">processKey</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\t\t\t\t\n        <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span>keyCount<span class=\"token punctuation\">,</span>hasEvents<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Process timeouts</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">processKey(sk, socketWrapper)</code> 에서 준비된 소켓의 처리가 이루어지고 <code class=\"language-text\">timeout(keyCount,hasEvents)</code> 에서 타임아웃 관련 처리가 이루어진다.   </p>\n<h3 id=\"timeoutkeyCounthasEvents\" style=\"position:relative;\">timeout(keyCount,hasEvents)<a href=\"#timeoutkeyCounthasEvents\" aria-label=\"timeoutkeyCounthasEvents permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> keyCount<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> hasEvents<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>timeout 메서드는 현재 selector에 등록된 모든 키의 수인 keyCount와 등록된 채널에서 관심 있는 이벤트가 발생했는 지 여부인 hasEvents 를 인수로 받는다.</p>\n<h4>조건 검사</h4>\n<p>timeout 메서드가 실행되면 첫 번째로 아래의 조건을 검사한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextExpiration <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>keyCount <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> hasEvents<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">&lt;</span> nextExpiration<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>close<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">nextExpiration > 0 &amp;&amp; (now &lt; nextExpiration)</code> : 현재 시간이 nextExpiration까지 아직 경과하지 않았다면</li>\n<li><code class=\"language-text\">(keyCount > 0 || hasEvents)</code> : polling 큐나 selector에 이벤트가 대기 중이라면</li>\n<li><code class=\"language-text\">!close</code> : 서버 소켓이 아직 닫히지 않았다면</li>\n</ul>\n<p>여기서 nextExpiration은 <code class=\"language-text\">System.currentTimeMillis() + socketProperties.getTimeoutInterval()</code>로 계산된다.</p>\n<p>조건의 핵심은 계산된 nextExpiration과 현재 시간을 비교해서 타임아웃 로직을 계속할지 결정하는 것이다.</p>\n<p><code class=\"language-text\">socketProperties.getTimeoutInterval()</code>의 기본 값은 1초로, 이 때문에 무한루프 내에서 1초마다 타임아웃을 검사하게 된다.\n이런 방식은 busy wait로 동작하는데, 짧은 간격으로 계속 실행되기 때문에 스레드 컨텍스트 스위칭 같은 작업 스케줄링 오버헤드를 줄여 성능을 향상시키려는 의도로 보인다.</p>\n<h4>연결되어 있는 모든 소켓 확인</h4>\n<p>Selector에 등록된 모든 SelectionKey를 가져와 연결되어 있는 모든 소켓에 대해서 타임아웃 검사를 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">:</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    keycount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">NioSocketWrapper</span> socketWrapper <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NioSocketWrapper</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// 생략...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 소켓이 현재 read 작업에 관심이 있다면 readTimeout 판단</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">interestOpsHas</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> delta <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getLastRead</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> timeout <span class=\"token operator\">=</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getReadTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeout <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> delta <span class=\"token operator\">></span> timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        readTimeout <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 소켓이 현재 write 작업에 관심이 있다면 writeTimeout 판단</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>readTimeout <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">interestOpsHas</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_WRITE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> delta <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getLastWrite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> timeout <span class=\"token operator\">=</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getWriteTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeout <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> delta <span class=\"token operator\">></span> timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        writeTimeout <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Selector로 관리하는 각 연결의 정보는 SelectionKey에 담겨있다. 이 SelectionKey에서 socketWrapper를 가져와 연결 상태를 파악하고 조절한다.</p>\n<p>socketWrapper로 해당 소켓이 마지막으로 언제 데이터를 읽었는지 (getLastRead)와 썼는지 (getLastWrite) 확인한다.\n현재 시간과 마지막으로 데이터를 읽거나 쓴 시간 사이의 차이를 delta로 계산한다.\n이 delta가 설정된 timeout을 넘으면, 그 연결은 타임아웃으로 간주하고 관련 작업을 수행한다.</p>\n<h4>타임아웃 처리</h4>\n<p>위에서 설정된 writeTimeout, readTimeout 변수를 확인하여 타임아웃이라고 판단되면 cancelledKey 메서드를 호출한다.\ncancelledKey 메서드는 할당되어 있는 자원을 해제하고 소켓 연결을 종료한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readTimeout <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span>readOperation <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>socketWrapper<span class=\"token punctuation\">.</span>readOperation<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>writeTimeout <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span>writeOperation <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>socketWrapper<span class=\"token punctuation\">.</span>writeOperation<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">processSocket</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocketEvent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ERROR</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">socketWrapper.readOperation.process()</code> 및 <code class=\"language-text\">socketWrapper.writeOperation.process()</code><br>\nsocketWrapper의 readOperation, writeOperation 는 비동기 처리일 때 사용된다.\ntimeout이 발생했을 때 등록된 비동기 작업이 있으면 process() 를 통해 해당 작업을 처리한다.<br>\n만약 비동기 작업 처리에 실패한다면<code class=\"language-text\">(!socketWrapper.readOperation.process() == true) 인 경우</code> cancelledKey 을 호출하여 socket을 close 한다.</li>\n<li><code class=\"language-text\">processSocket(socketWrapper, SocketEvent.ERROR, true)</code><br>\n동기 HTTP 요청 처리을 처리할 때 선택되는 로직이다. processSocket 메서드에 SocketEvent.ERROR라는 Enum 타입을 전달하면 해당 메서드 내에서 SocketEvent의 값에 따라 처리 로직이 분기된다.\nprocessSocket은 Worker threadPool에서 스레드 하나를 할당받아 소켓 이벤트를 처리하게 된다.\n즉, 워커 스레드를 하나 할당받아 socket close 작업을 진행한다.<br>\n만약 Worker Pool에서 스레드 할당에 실패하면 <code class=\"language-text\">(!processSocket(socketWrapper, SocketEvent.ERROR, true) == true)</code> 현재의 Main Thread(Poller Thread)에서 cancelledKey를 호출하여 socket을 close 한다.</li>\n</ul>\n<h2 id=\"Persistent-Connection\" style=\"position:relative;\">Persistent Connection<a href=\"#Persistent-Connection\" aria-label=\"Persistent Connection permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>HTTP 프로토콜은 기본적으로 비연결성(connectionless)를 기반으로 한다. 이는 매 요청마다 3-way-handshake를 맺어야 하는 오버헤드가 발생한다.\n그래서 HTTP/1.1 부터는 매 요청마다 새로운 연결을 맺는 것이 아니라 기존 연결을 재사용할 수 있는 keep-alive 메커니즘을 제공한다.</p>\n<p>그렇다면 tomcat에서는 어떻게 Persistent Connection을 관리할까? 기본적으로 Tomcat 8.0 이후부터는 java.nio의 Selector를 이용하여 소켓을 관리한다.\nSelector를 사용하여 싱글 스레드로도 대량의 Connection들을 관리할 수 있다. 여기서는 Tomcat의 코드 레벨에서 Persistent Connection (Keep-Alive Connection) 과 Non-Persistent Connection (Close Connection) 처리의 차이를 분석해보려고 한다.</p>\n<p>Tomcat의 Http11Processor는 HTTP 프로토콜의 핵심 부분을 구현하는데, Keep-alive 처리 역시 여기서 이루어진다.\nHttp11Processor의 <code class=\"language-text\">service()</code> 메서드는 소켓을 통해 들어오는 HTTP 요청을 처리한다. 요청 헤더를 파싱하고 서블릿으로 요청을 위임하고 요청 상태에 따라 소켓 상태를 결정하여 반환한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">SocketState</span> <span class=\"token function\">service</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketWrapperBase</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> socketWrapper<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">SocketState</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">OPEN</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CLOSED</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LONG</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ASYNC_END</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SENDFILE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">UPGRADING</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">UPGRADED</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ASYNC_IO</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SUSPENDED</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">SocketState service(socketWrapper) {\n    요청 정보 및 플래그 초기화\n\n    while (다양한 조건들)\n        요청 헤더 파싱 시도\n        프로토콜 준비\n        서비스 일시 중지 확인\n        요청 헤더 파싱\n        업그레이드 요청 확인\n        요청 준비 및 처리\n        요청 종료 처리\n        요청 카운터 업데이트\n        sendfile 상태 처리\n\n   return 소켓 상태 결정 및 반환\n}</code></pre></div>\n<h3 id=\"Non-Persistent-Connection-처리\" style=\"position:relative;\">Non-Persistent Connection 처리<a href=\"#Non-Persistent-Connection-%EC%B2%98%EB%A6%AC\" aria-label=\"Non Persistent Connection 처리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>HTTP 요청이 Non-persistent 인 경우 service 메서드는 SocketState.CLOSED 를 반환하게 된다.\n워커 스레드는 이 소켓 처리 결과가 SocketState.CLOSED일 경우, 소켓 연결을 종료하고 관련 자원을 해제한다. 아래 코드는 이러한 작업을 수행하는 부분이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handshake <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SocketState</span> state<span class=\"token operator\">=</span><span class=\"token class-name\">SocketState</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OPEN</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Process the request from this socket</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">==</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      state <span class=\"token operator\">=</span> <span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span><span class=\"token class-name\">SocketEvent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OPEN_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n      state <span class=\"token operator\">=</span> <span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>state<span class=\"token operator\">==</span><span class=\"token class-name\">SocketState</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CLOSED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      poller<span class=\"token punctuation\">.</span><span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span><span class=\"token function\">getSelectionKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 <code class=\"language-text\">getHandler().process()</code>는 Http11Processor의 process 메서드를 호출하는 부분이다.\n코드 마지막의 if문에서 process 메서드의 반환값이 SocketState.CLOSED일 때, <code class=\"language-text\">poller.cancelledKey()</code>를 호출해 연결을 종료하는 것을 확인할 수 있다.</p>\n<p>HTTP 요청이 Non-persistent 인지 판단하는 조건은 여러 가지 있는데 Non-persistent에 해당하는 조건이면 keepAlive 변수를 false로 변경하고 service() 메서드의 반환값으로 SocketState.CLOSED 를 리턴한다. 판단 조건은 대표적으로 아래와 같은 것들이 있다.</p>\n<h4>HTTP/1.0 으로 호출하는 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>protocolMB<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">HTTP_10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    http09 <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    http11 <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>   </code></pre></div>\n<h4>keep-alive 최대 요청이 1이거나 최대 요청을 초과한 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> maxKeepAliveRequests <span class=\"token operator\">=</span> protocol<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxKeepAliveRequests</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxKeepAliveRequests <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// keep-alive max=1 인 경우</span>\n    keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxKeepAliveRequests <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">decrementKeepAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// keep-alive max값 보다 요청을 더 많이 한 경우</span>\n    keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>HTTP 응답 상태코드가 200 범위가 아닌 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">checkExpectationAndResponseStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">hasExpectation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isRequestBodyFullyRead</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">200</span> <span class=\"token operator\">||</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">299</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Client sent Expect: 100-continue but received a</span>\n        <span class=\"token comment\">// non-2xx final response. Disable keep-alive (if enabled)</span>\n        <span class=\"token comment\">// to ensure that the connection is closed. Some clients may</span>\n        <span class=\"token comment\">// still send the body, some may send the next request.</span>\n        <span class=\"token comment\">// No way to differentiate, so close the connection to</span>\n        <span class=\"token comment\">// force the client to send the next request.</span>\n        inputBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">setSwallowInput</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>요청 헤더에 Connection: close 로 명시한 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">MimeHeaders</span> headers <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getMimeHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Check connection header</span>\n<span class=\"token class-name\">MessageBytes</span> connectionValueMB <span class=\"token operator\">=</span> headers<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CONNECTION</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionValueMB <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>connectionValueMB<span class=\"token punctuation\">.</span><span class=\"token function\">isNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> tokens <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">TokenList</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseTokenList</span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CONNECTION</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CLOSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">KEEP_ALIVE_HEADER_VALUE_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"Persistent-Connection-처리\" style=\"position:relative;\">Persistent Connection 처리<a href=\"#Persistent-Connection-%EC%B2%98%EB%A6%AC\" aria-label=\"Persistent Connection 처리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Persistent Connection이 유지되는 조건은 위의 Non-Persistent 요청이 아니라면 Keep-Alive 가 동작하여 소켓 연결을 계속 유지한다.\n이는 HTTP 헤더에 <code class=\"language-text\">Connection: Keep-alive</code> 를 명시하지 않아도 기본값으로 Keep-alive가 동작된다는 얘기이다.\n대신 response 헤더에 <code class=\"language-text\">Connection: Keep-alive</code> 와 <code class=\"language-text\">Keep-Alive: timeout=60, max=1000</code>와 같은 헤더가 나오지 않으니 클라이언트를 위해 명시적으로 요청하는것이 좋다.</p>\n<p>Persistent Connection 은 <code class=\"language-text\">server.tomcat.keep-alive-timeout</code> 속성을 통해 이루어진다.\n만약 keep-alive-timeout 동안 어떤 read/write 활동도 없다면 해당 연결은 종료된다.</p>\n<p>그럼 keep-alive-timeout은 어떻게 처리될까?\nTomcat은 클라이언트와 처음 연결한 후, Read Timeout을 기준으로 타임아웃 여부를 판단한다.\nRead Timeout 내에 클라이언트로부터 데이터가 도착하면 요청을 정상적으로 처리하고 응답한다.\n만약 이 요청이 Persistent Connection 요청이라면, Read Timeout 값을 keep-alive-timeout으로 바꾼다.\n그리고 나서는 이전에 설명한 Read/Write 타임아웃 관리 방식으로 연결을 계속 유지하고 관리한다.</p>\n<p>만약 클라이언트의 요청이 keep-alive-timeout 내에 계속 들어온다면, 해당 연결의 타임아웃은 계속해서 초기화되어 연결이 지속된다.\n이는 타임아웃이 현재 시간과 소켓에서 마지막으로 Read/Write한 시간을 기준으로 계산되기 때문이다.</p>\n<p>서버에서 연결을 유지하려고 해도 클라이언트도 해당 연결을 유지해야 keep-alive가 제대로 작동한다.\n예를 들어, curl을 사용하여 keep-alive로 요청을 보내도 curl 프로그램이 종료될 때 클라이언트에서 소켓을 먼저 닫아버리기 때문에 Persistent Connection은 유지되지 않는다.</p>\n<p>그리고 keep-alive의 주요 목적은 이미 맺어진 연결을 재사용하는 것이다.\n따라서 클라이언트가 새로운 소켓을 통해 요청을 보내면, 서버와는 새로운 연결이 형성된다. 이 경우, 다른 소켓에서 유지되는 Persistent Connection과는 별개로 동작하므로 재사용할 수 없다.</p>\n<h2 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Tomcat에서는 연결들을 타임아웃의 관점에서 어떻게 관리하는지, 특히 Read/Write Timeout과 Persistent Connection에 초점을 맞춰 살펴보았다.\n이 과정에서 busy wait 방식을 사용하여 지속적으로 타임아웃을 검사하는 것을 확인했다.\n더불어, Tomcat에서는 <code class=\"language-text\">read-timeout</code> 또는 <code class=\"language-text\">write-timeout</code> 없이 <code class=\"language-text\">connection-timeout</code> 이라는 명칭으로 타임아웃 값을 설정하는데,\n이는 Persistent Connection의 경우 <code class=\"language-text\">keep-alive-timeout</code>으로 변경되기 때문에 <code class=\"language-text\">connection-timeout</code> 명칭을 쓰지 않았나 싶다.</p>","frontmatter":{"title":"Tomcat은 어떻게 Connection을 관리할까?","date":"October 07, 2023","update":"October 07, 2023","tags":["Tomcat"],"series":null,"thumbnail":null},"fields":{"slug":"/tomcat-connection/","thumbnail":null,"readingTime":{"minutes":17.165}}},"seriesList":{"edges":[{"node":{"id":"171aa4a2-ded5-5c2c-b54a-e64ea3f1bb1e","fields":{"slug":"/ch1/"},"frontmatter":{"title":"1장 - 신뢰할 수 있고 확장 가능하며 유지보수하기 쉬운 애플리케이션"}}},{"node":{"id":"3b2605c1-fec1-5296-80ea-ebd9aa6e3d73","fields":{"slug":"/ch2/"},"frontmatter":{"title":"2장 - 데이터 모델과 질의 언어"}}},{"node":{"id":"7bdf2f61-fe87-5308-83ce-0dc069dcc67b","fields":{"slug":"/ch3/"},"frontmatter":{"title":"3장 - 저장소와 검색"}}},{"node":{"id":"2e30191b-8ece-5039-bbca-a94005966f5f","fields":{"slug":"/ch4/"},"frontmatter":{"title":"4장 - 부호화와 발전"}}},{"node":{"id":"3a0d1c7f-1792-5981-b09e-0d3d5914a4d0","fields":{"slug":"/ch5/"},"frontmatter":{"title":"5장 - 복제"}}},{"node":{"id":"e4d42902-d086-5517-bbe4-8db2798f7a4e","fields":{"slug":"/ch6/"},"frontmatter":{"title":"6장 - 파티셔닝"}}},{"node":{"id":"01c7677e-28a2-5fd0-b8a3-7edbbb6ea219","fields":{"slug":"/ch7/"},"frontmatter":{"title":"7장 - 트랜잭션"}}},{"node":{"id":"4d8ece67-04eb-5a79-b8c5-1fa3975550ac","fields":{"slug":"/ch8/"},"frontmatter":{"title":"8장 - 분산 시스템의 골칫거리"}}},{"node":{"id":"592c1aba-d9fa-5c61-a4e2-9ec5a19ec99e","fields":{"slug":"/ch1/"},"frontmatter":{"title":"1부 - 성능 기초"}}},{"node":{"id":"9c62ca73-8311-53a9-9ea2-2248b98bcaab","fields":{"slug":"/ch2/"},"frontmatter":{"title":"2부 - 성능 개선"}}},{"node":{"id":"f3df7171-f177-58d9-9aa1-cde629229b00","fields":{"slug":"/ch3/"},"frontmatter":{"title":"3부 - 화면 응답시간 분석"}}},{"node":{"id":"dbef7d03-a3db-5d08-be18-e3457e0fafbb","fields":{"slug":"/ch4/"},"frontmatter":{"title":"4부 - 프로세스 이해하기"}}},{"node":{"id":"341143b3-bdb9-5711-a601-3b08c4a34340","fields":{"slug":"/ch5/"},"frontmatter":{"title":"5부 - 소스코드 최적화"}}},{"node":{"id":"b490e7a2-0baa-5c5d-a397-f276ff17cf37","fields":{"slug":"/ch6/"},"frontmatter":{"title":"6부 - SQL 최적화"}}},{"node":{"id":"845a24cb-583f-5c11-81d6-a9cb5b3deb3c","fields":{"slug":"/ch7/"},"frontmatter":{"title":"7부 - 애플리케이션 입장에서의 SQL 튜닝"}}},{"node":{"id":"e398111b-8093-502a-a9b1-9d72062a3b82","fields":{"slug":"/spring-autoconfigure/"},"frontmatter":{"title":"SpringBoot AutoConfiguration 시작하기"}}},{"node":{"id":"8ebbbedb-e6ae-500f-9c50-c852869253e3","fields":{"slug":"/behavior/"},"frontmatter":{"title":"디자인 패턴 - 행동 패턴"}}},{"node":{"id":"5915669d-aefc-5d66-bb50-8fece02e6f6b","fields":{"slug":"/struct/"},"frontmatter":{"title":"디자인 패턴 - 구조 패턴"}}},{"node":{"id":"4afa5d86-ed15-50b5-93d9-a68aad9c6661","fields":{"slug":"/create/"},"frontmatter":{"title":"디자인 패턴 - 생성 패턴"}}},{"node":{"id":"562d0f59-66f1-562f-af93-d4b36fd53d1b","fields":{"slug":"/Exactly_Once_Semantics/"},"frontmatter":{"title":"카프카는 어떻게 Exactly-Once Semantics 보장하나?"}}},{"node":{"id":"cd67c5f9-d4a3-5e56-900d-4a6cf095fb12","fields":{"slug":"/trasaction_in_kafka/"},"frontmatter":{"title":"카프카에서의 Transactions"}}},{"node":{"id":"9716c259-8678-553f-8ac8-763719c61715","fields":{"slug":"/enabling_exactly_once_kafka_streams/"},"frontmatter":{"title":"카프카 스트림즈의 정확히 한 번"}}},{"node":{"id":"8002e4d8-b23e-514c-8690-40b0653e000c","fields":{"slug":"/Amazon SQS Deep Dive/"},"frontmatter":{"title":"Amazon SQS 딥다이브"}}},{"node":{"id":"722ae01c-f64d-5c1d-b0db-81511fdffc65","fields":{"slug":"/Spring Cloud AWS Messaging Module Best Practice/"},"frontmatter":{"title":"Spring Cloud AWS Messaging 모듈 문제점 및 튜닝"}}},{"node":{"id":"a38c9fb2-5a48-5f2c-b5d4-09b52c64870c","fields":{"slug":"/java-collection-wrapper/"},"frontmatter":{"title":"Collection Wrapper 클래스를 이용한 Service 계층 리팩토링 "}}},{"node":{"id":"c4729eb0-0698-5aa4-bbf6-361c15caac7d","fields":{"slug":"/spring-cache-hierarchy/"},"frontmatter":{"title":"Spring Cache 로 캐시 계층 구조 사용하기"}}},{"node":{"id":"5ae46656-7d71-5b46-a454-516a563e6324","fields":{"slug":"/redis-event-notifications/"},"frontmatter":{"title":"Redis Keyspace Notifications에 대해 알아보자"}}},{"node":{"id":"363e058f-b457-5794-afb5-05cb05480255","fields":{"slug":"/jpa-slow-cause/"},"frontmatter":{"title":"JPA가 느릴 수 밖에 없는 원초적인 이유"}}},{"node":{"id":"0c1fde6e-04b9-55b9-9496-1b8635b58e46","fields":{"slug":"/ehcache3/"},"frontmatter":{"title":"Ehcache3 캐시 라이브러리 소개 (with Spring Boot)"}}},{"node":{"id":"6f729c84-2239-5a02-8561-deca0f9b05c5","fields":{"slug":"/mysql-primary-key-design/"},"frontmatter":{"title":"고성능을 위한 MySQL Primary Key 설계 전략"}}},{"node":{"id":"f7217e81-51a3-58d9-9498-e84defa6368e","fields":{"slug":"/tomcat/"},"frontmatter":{"title":"Apache Tomcat 이해하기(NIO Connector 중심)"}}},{"node":{"id":"4ac73c64-d597-5ac3-9c91-6214595d54be","fields":{"slug":"/socket_option/"},"frontmatter":{"title":"Java의 Socket Option 정리"}}},{"node":{"id":"c2d0081b-ae3d-5801-ace1-d61452e19444","fields":{"slug":"/tomcat-connection/"},"frontmatter":{"title":"Tomcat은 어떻게 Connection을 관리할까?"}}},{"node":{"id":"8d197033-5a60-5434-bc31-0481d7d6e8c4","fields":{"slug":"/spring-core-container/"},"frontmatter":{"title":"스프링으로 알아보는 IoC 컨테이너의 원리와 이해"}}},{"node":{"id":"f3cc757b-893a-536b-a5a9-fd7daa864ee1","fields":{"slug":"/socket_internal/"},"frontmatter":{"title":"요청이 급증하는 상황의 Connection reset by peer 트러블 슈팅"}}},{"node":{"id":"88220c80-fe55-5358-b042-35d46e8a3829","fields":{"slug":"/mysql-transaction-lock/"},"frontmatter":{"title":"MySQL 잠금과 트랜잭션 Deep Dive"}}},{"node":{"id":"96615645-93b2-57cd-8082-bff0befc8e71","fields":{"slug":"/java-synchronized/"},"frontmatter":{"title":"자바의 synchronized와 volatile"}}}]},"relatedPosts":{"nodes":[]},"recentPosts":{"nodes":[{"id":"96615645-93b2-57cd-8082-bff0befc8e71","html":"<h2 id=\"메모리-아키텍처\" style=\"position:relative;\">메모리 아키텍처<a href=\"#%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\" aria-label=\"메모리 아키텍처 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>최신 하드웨어에서의 동시 프로그래밍은 동일한 물리적 순간에 서로 다른 코어에서 여러 스레드를 동시해 실행할 수 있다.\n아래 [그림2]에서 이를 확인할 수 있다.\n<figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 553px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b637c4d3ea573bb279d1579a5fbf417/d35da/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAACjklEQVR42qVT2W7aUBT0/39L/iCtoiY0SqWWPYGQ2EDByHgD7wvY0zPXmFLaqg+90nDuMmfOhrW6cFDHL6iTmeD1ChMc0w1qNKtOl8Kd/IEnvvEzjsUeWp0aqP2PqHcdwT0qQb17UGfs7lDsn1GdFOuwq+74Vl1xa+8WRWyKYCZR9w9A9ITSvcd8dINke6fOCDooAsngJFhFo4Ybf0G4+QBjeCPnz0D4pJIpEqsRPPodZP4IsdNDYHUROX11PniPKEXwnGE0ROk/IfGGiOyGm7gD4Q6F+wmlEkx15E4Hruui1/+GwbCH8XgE23ERWY84hJclf0XqDbBem+j2vmIw6GL2NoPvbpFatyil39oxcxC7Y7ibV9jrF6yMPmxzAsecIrRHyCPzPJQyXiCwG661GmMtXGczlfNUqpPsMw5F2FUF1adafqIoarJp7/FzVac7ruPxiDiOm3t5aO81ioRhgP1+j91uB9M0lQ2CQNrgIM/zs+DhcBBe8+b7HjbCpR/BljGIVol0GIZYLBfQDQOGoWM6ncp+DsuylHO76OB5nrzpmC8WeJP+TYS7Wq8VN01TaCTyMJ8bWAjJMBq7XC7F4U0Fu8xw9X0lYnPFmRuNJXRdR1EUjWBZlsiyTIHltnuiaptzWmwBkSSJKpX7LM2UmOohy2Dk1ra9aMFglyCHQSjk+74aZOvLe411syxOjGBUWk77r4gby/62fjxTR2PqPNASDEDLclkGMynK4rxXJcrbJZegKAOoDC8F+ZDnmRrK9HWGd5nk82QiAzDwrr/J19THerNBLqLk/lOwjczh2LYNT3q63W7lU7Theq66Y1sus/tFsN1c9+kyepr87nzNZ/8YSPWQk+XE/gf8w1P4B88kV9LXMnU4AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"[그림2] 메모리 아키텍처\"\n        title=\"\"\n        src=\"/static/1b637c4d3ea573bb279d1579a5fbf417/d35da/img_1.png\"\n        srcset=\"/static/1b637c4d3ea573bb279d1579a5fbf417/e7570/img_1.png 170w,\n/static/1b637c4d3ea573bb279d1579a5fbf417/f46e7/img_1.png 340w,\n/static/1b637c4d3ea573bb279d1579a5fbf417/d35da/img_1.png 553w\"\n        sizes=\"(max-width: 553px) 100vw, 553px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">[그림2] 메모리 아키텍처</figcaption>\n  </figure></p>\n<p>각 CPU는 자체 레지스터를 포함하고 있는데, 이는 CPU 내부의 메모리로 간주된다. 레지스터에 접근하고 여기에 있는 변수들에 연산을 수행하는 것은 매우 빠르다.\nCPU는 캐시 메모리 계층을 가지고 있으며, 이 캐시 메모리에 빠르게 접근할 수 있다. 그러나 캐시 메모리의 접근 속도는 레지스터만큼 빠르지는 않다.</p>\n<p>모든 CPU는 메인 메모리에 접근할 수 있다. 메인 메모리는 CPU의 캐시 메모리보다 훨씬 크다.\nCPU가 메모리에서 무언가를 읽을 필요가 있을 때, 그것을 CPU의 캐시 메모리로 읽어들이고 연산을 수행한다.\nCPU는 레지스터로도 데이터를 읽어들일 수 있다. CPU가 메모리에 데이터를 다시 쓸 필요가 있을 때, 레지스터를 캐시 메모리로 플러시하고 결국 이 캐시 메모리는 메인 메모리로 플러시된다.</p>\n<p>일반적으로 플러시는 CPU가 다른 정보를 위한 공간을 만들 필요가 있을 때 수행된다. 따라서 이 플러시가 언제 일어날지에 대해서는 어떠한 가정도 할 수 없다.</p>\n<h2 id=\"Memory-Visiblity\" style=\"position:relative;\">Memory Visiblity<a href=\"#Memory-Visiblity\" aria-label=\"Memory Visiblity permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>메모리 가시성(Memory Visiblity)이란, 한 스레드에서 변경한 메모리 값이 다른 스레드에서도 동일한 값을 읽을 수 있는지라고 볼 수 있다.\n아래 코드는 가시성 문제가 발생할 수 있는 예제 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Volatile</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> stopRequested<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Thread</span> backgroundThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stopRequested<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        backgroundThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        stopRequested <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드를 메인 스레드와 backgroundThread가 각각 다른 CPU 코어에 할당되어 실행되는 경우, 프로그램이 영원히 종료되지 않을 수 있다. 메모리 아키텍처의 특성상, 메인 스레드가 stopRequested 플래그를 true로 설정하더라도 이 변경은 메인 스레드가 할당된 코어의 캐시 메모리에만 저장될 수 있다. 결과적으로, backgroundThread는 메인 스레드에서 이루어진 이 변경을 감지하지 못할 수 있다. 이러한 현상을 가시성 문제라고 부른다.</p>\n<h2 id=\"synchronized-의미\" style=\"position:relative;\">synchronized 의미<a href=\"#synchronized-%EC%9D%98%EB%AF%B8\" aria-label=\"synchronized 의미 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>synchronized 키워드는 특정 코드 블록이나 메서드에 적용할 수 있다. 특정 코드 블록이나 메서드에 들어가지 전에 스레드가 적절한 잠금을 획득해야한 다는 것을 의미한다. 한번에 하나의 스레드만 synchronized 블록을 진행할 수 있으며, 다른 스레드는 잠금을 획득할 때 까지 진입하지 못한다.</p>\n<p>메서드에 붙인 synchronized 키워드는 객체 인스턴스에 속한 잠금을 획득해야 한다. 만약 메서드가 정적 메서드라면 클래스 객체에 속한 잠금을 획득해야 한다. 코드 블록에 synchronized 키워드를 사용하면 어떤 객체를 사용하여 잠금을 획득할지 명시해야 한다.</p>\n<p>잠금을 획득한 후, synchronized 블록에 진입하면, 블록 내에서 이루어진 모든 변경사항은 메인 메모리로 플러쉬된다.\n다른 스레드가 이후에 같은 객체의 synchronized 블록에 진입하면, 메인 메모리에서 객체의 최신 상태를 읽는다.</p>\n<p>따라서, synchronized 는 잠금뿐만 아니라 동기화를 수행하는데, 동기화의 의미는 특정 객체에 대한 메모리 표현이 다른 스레드 간에 일관되게 유지된다는 것으로 해석할 수 있다.</p>\n<h2 id=\"synchronized-특징\" style=\"position:relative;\">synchronized 특징<a href=\"#synchronized-%ED%8A%B9%EC%A7%95\" aria-label=\"synchronized 특징 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>아래는 synchronized 키워드의 그 외 대표적인 특징들이다.</p>\n<ul>\n<li>객체만 잠금 가능: 자바에서는 기본 데이터 타입(primitives)이 아닌 객체(Object)만 잠금이 가능하다.</li>\n<li>객체 배열의 잠금: 객체의 배열을 잠그는 것은 배열 내의 개별 객체들을 잠그는 것이 아니다.</li>\n<li>동기화된 메소드: synchronized 메소드는 전체 메소드를 포함하는 synchronized (this){...} 블록과 동등하다.(바이트 코드 레벨에서는 다르게 나타난다.)</li>\n<li>정적 synchronized 메소드: static synchronized 메소드는 클래스 객체(Class object)를 잠근다.</li>\n<li>클래스 객체의 잠금: 클래스 객체를 잠그는 경우, getClass()는 런타임 클래스에 대한 잠금, MyClass.class에 대한 잠금은 컴파일 시점에 결정된다.</li>\n<li>Inner 클래스의 동기화: Inner 클래스에서의 동기화는 outer 클래스와 독립적이다.</li>\n<li>인터페이스의 메소드 선언과 synchronized: synchronized는 메소드 시그니처가 아니므로 인터페이스에 선언할 수 없다.</li>\n<li>비동기화 메소드: 비동기화 메소드는 잠금의 상태를 고려하지 않으며, 동기화 메소드가 실행되는 동안에도 진행될 수 있다.</li>\n<li>재진입 가능한 잠금: 이미 잠금을 보유하고 있는 스레드가 동일한 잠금에 대한 synchronized 잠금을 만나면 계속해서 진행할 수 있다.</li>\n</ul>\n<h2 id=\"volatile\" style=\"position:relative;\">volatile<a href=\"#volatile\" aria-label=\"volatile permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>volatile 필드에 대한 값은 스레드에 의해 사용되기 전에 항상 메인 메모리에서 읽는다. 그리고, 스레드가 작성한 값은 항상 메인 메모리로 플러시된다.\nvolatile과 synchronized의 차이는 synchronized는 배타적인 잠금을 사용하여 한 번에 하나의 스레드만 synchronized 블록을 실행할 수 있도록 보장하는 반면에, volatile는 잠금을 사용하지 않는다.</p>\n<p>volatile 변수는 상태 의존적인 작업에 적합하지 않다. 예를 들어, <code class=\"language-text\">x = x + 1</code> 같은 연산은 x의 현재 값을 읽고, 그 값을 수정하여 다시 x에 저장하는 non-atomic 연산이다.\n이는 x의 값을 읽는 사이에 다른 스레드가 x를 수정할 수 있으며, 이는 race condition을 일으킬 수 있기 때문에 안전하지 않다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Volatile</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">boolean</span> stopRequested<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Thread</span> backgroundThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stopRequested<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        backgroundThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        stopRequested <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>volatile로 선언된 stopRequested 플래그는 메인 스레드에서 값을 true로 변경하게 되면 이후에 발생하는 모든 해당 변수에 대한 후속 읽기는 항상 최신의 값을 읽는다는 것을 보장한다. </p>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://dev.to/rnowif/what-is-a-volatile-variable-in-java-35ef\">https://dev.to/rnowif/what-is-a-volatile-variable-in-java-35ef</a></li>\n<li><a href=\"https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html\">https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html</a></li>\n</ul>","fields":{"slug":"/java-synchronized/"},"frontmatter":{"title":"자바의 synchronized와 volatile","date":"December 02, 2023"}},{"id":"88220c80-fe55-5358-b042-35d46e8a3829","html":"<h2 id=\"잠금-엑세스-레벨\" style=\"position:relative;\">잠금 엑세스 레벨<a href=\"#%EC%9E%A0%EA%B8%88-%EC%97%91%EC%84%B8%EC%8A%A4-%EB%A0%88%EB%B2%A8\" aria-label=\"잠금 엑세스 레벨 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"공유-잠금Shared-Locks\" style=\"position:relative;\">공유 잠금(Shared Locks)<a href=\"#%EA%B3%B5%EC%9C%A0-%EC%9E%A0%EA%B8%88Shared-Locks\" aria-label=\"공유 잠금Shared Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>공유 잠금은 다수의 쿼리가 동시에 진행될 수 있도록 허용하지만 배타적 잠금을 얻으려는 시도를 차단한다. 즉, 어떤 트랜잭션이 공유 잠금을 적용하고 있다면, 해당 데이터에 대한 쓰기 작업을 시도하는 다른 트랜잭션은 잠금이 해제될 때까지 기다려야 한다.</p>\n<p>MySQL에서는 <code class=\"language-text\">FOR SHARE</code>나 <code class=\"language-text\">LOCK IN SHARE MODE</code> 같은 locking read clauses를 사용해서 쿼리가 참조하는 행들에 잠금을 걸 수 있다. 이런 절이 쿼리에 포함되어 있으면, 해당 쿼리를 실행하는 동안 선택된 행들은 다른 트랜잭션에서 데이터를 읽을 순\n있지만 변경하거나 삭제할 수는 없다.</p>\n<p>이 잠금은 기본적으로 바깥쪽(outer) 쿼리에만 적용되고 내부(subquery) 쿼리에는 적용되지 않는다. 즉, 내부 쿼리에 별도로 잠금 절을 명시하지 않으면 내부 쿼리가 참조하는 테이블의 행은 잠금되지 않는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> t1\n<span class=\"token keyword\">WHERE</span> c1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> c1 <span class=\"token keyword\">FROM</span> t2<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">SHARE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>여기서 t1 테이블의 행들은 FOR SHARE로 인해 잠금이 걸리지만, 서브쿼리에서 참조하는 t2 테이블의 행들은 잠금이 걸리지 않는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> t1\n<span class=\"token keyword\">WHERE</span> c1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> c1 <span class=\"token keyword\">FROM</span> t2 <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">SHARE</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">SHARE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>두번째 예시에서는 t1 테이블 뿐만 아니라 서브쿼리 안에도 FOR UPDATE가 명시되어 있어서 t2 테이블의 행들도 잠금이 걸린다. 이 경우, t1과 t2 테이블에서 참조하는 모든 행들이 다른 트랜잭션에 의해 변경할 수 없다.</p>\n<h3 id=\"배타적-잠금Exclusive-Locks\" style=\"position:relative;\">배타적 잠금(Exclusive Locks)<a href=\"#%EB%B0%B0%ED%83%80%EC%A0%81-%EC%9E%A0%EA%B8%88Exclusive-Locks\" aria-label=\"배타적 잠금Exclusive Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>배타적 잠금은 해당 자원에 대한 접근을 획득한 스레드 혹은 트랜잭션만이 자원을 읽거나 쓸 수 있게 하며, 다른 스레드는 접근할 수 없다.</p>\n<p>MySQL에서는 <code class=\"language-text\">FOR UPDATE</code> 를 사용해서 배타적 잠금을 걸 수 있다.</p>\n<h3 id=\"의도-잠금Intention-Locks\" style=\"position:relative;\">의도 잠금(Intention Locks)<a href=\"#%EC%9D%98%EB%8F%84-%EC%9E%A0%EA%B8%88Intention-Locks\" aria-label=\"의도 잠금Intention Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>InnoDB 엔진에서 구현된 다중 세분성 잠금(multiple granularity locking) 메커니즘은 행 레벨 잠금과 테이블 레벨 잠금을 용이하게 한다. 이 메커니즘은 <code class=\"language-text\">LOCK TABLES ... WRITE</code>와 같은 구문을 통해 지정된 테이블에 대한 배타적 잠금(X lock)\n을\n설정할 수 있게 한다. 다중 세분성 잠금을 구현하기 위해 InnoDB는 의도 잠금이라는 테이블 레벨 잠금을 사용한다. 의도 잠금은 트랜잭션이 후에 테이블의 행에 대해 요구할 잠금 유형(공유 또는 배타적)을 나타내는 데 사용된다. 의도 잠금에는 의도 공유 잠금(IS)과 의도 배타적 잠금(\nIX) 두 가지\n유형이 있다.</p>\n<p>IS 잠금은 트랜잭션이 테이블의 개별 행에 공유 잠금을 설정할 의도가 있음을 표시하며, IX 잠금은 배타적 잠금을 설정할 의도가 있음을 표시한다. 예를 들어, <code class=\"language-text\">SELECT ... FOR SHARE</code>는 IS 잠금을, <code class=\"language-text\">SELECT ... FOR UPDATE</code>는 IX 잠금을 설정한다.</p>\n<p>의도 잠금 프로토콜에 따르면, 트랜잭션이 테이블의 행에 공유 잠금을 획득하기 전에 반드시 해당 테이블에 대해 IS 잠금 또는 그보다 강력한 잠금을 먼저 획득해야 한다. 또한 트랜잭션이 테이블의 행에 배타적 잠금을 획득하기 전에는 IX 잠금을 먼저 획득해야 한다.</p>\n<h3 id=\"잠금-호환성\" style=\"position:relative;\">잠금 호환성<a href=\"#%EC%9E%A0%EA%B8%88-%ED%98%B8%ED%99%98%EC%84%B1\" aria-label=\"잠금 호환성 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>데이터베이스 잠금은 여러 트랜잭션이 동시에 데이터에 접근할 때 일관성과 정합성을 유지하기 위해 사용된다. 잠금 호환성은 다음과 같다:</p>\n<ul>\n<li>의도 공유 잠금(IS)은 다른 의도 공유 잠금(IS)과 호환된다.</li>\n<li>의도 배타 잠금(IX)은 다른 의도 잠금(IS 또는 IX)과 호환된다.</li>\n<li>실제 공유 잠금(S)은 다른 공유 잠금(S)과 호환된다.</li>\n<li>실제 배타 잠금(X)은 다른 어떤 잠금과도 호환되지 않는다.</li>\n</ul>\n<p>한 트랜잭션이 의도 배타 잠금(IX)을 가지고 있다면, 다른 트랜잭션이 의도 잠금을 획득하는 것을 방지하지 않지만, 실제 잠금으로의 전환은 제한할 수 있다.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th align=\"center\">Exclusive (X)</th>\n<th align=\"center\">Intention Exclusive (IX)</th>\n<th align=\"center\">Shared (S)</th>\n<th align=\"center\">Intention Shared (IS)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Exclusive (X)</td>\n<td align=\"center\">X</td>\n<td align=\"center\">X</td>\n<td align=\"center\">X</td>\n<td align=\"center\">X</td>\n</tr>\n<tr>\n<td>Intention Exclusive (IX)</td>\n<td align=\"center\">X</td>\n<td align=\"center\">✓</td>\n<td align=\"center\">X</td>\n<td align=\"center\">✓</td>\n</tr>\n<tr>\n<td>Shared (S)</td>\n<td align=\"center\">X</td>\n<td align=\"center\">X</td>\n<td align=\"center\">✓</td>\n<td align=\"center\">✓</td>\n</tr>\n<tr>\n<td>Intention Shared (IS)</td>\n<td align=\"center\">X</td>\n<td align=\"center\">✓</td>\n<td align=\"center\">✓</td>\n<td align=\"center\">✓</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"InnoDB의-잠금\" style=\"position:relative;\">InnoDB의 잠금<a href=\"#InnoDB%EC%9D%98-%EC%9E%A0%EA%B8%88\" aria-label=\"InnoDB의 잠금 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"Record-Locks\" style=\"position:relative;\">Record Locks<a href=\"#Record-Locks\" aria-label=\"Record Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>레코드 락은 인덱스 레코드를 잠그는 것을 의미한다. <code class=\"language-text\">performance_schema.data_locks</code> 테이블의 LOCK<em>MODE 에서는 `X,REC</em>NOT_GAP` 로 출력되는 잠금이 레코드 락을 의미한다. 따로 생성한 인덱스가 없는 테이블은 InnoDB가 자체적으로 생성한 클러스터 인덱스를 이용해 락을 건다.</p>\n<h3 id=\"Gap-Locks\" style=\"position:relative;\">Gap Locks<a href=\"#Gap-Locks\" aria-label=\"Gap Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>갭 잠금(Gap Lock)은 InnoDB 스토리지 엔진에서 두 레코드 사이의 갭을 잠그는 메커니즘으로, 클러스터 인덱스 또는 보조 인덱스에서 레코드 간의 공간을 잠그는 데 사용된다.</p>\n<p>갭 잠금은 다른 트랜잭션이 해당 갭에 새로운 레코드를 삽입하는 것을 방지하여 데이터의 일관성을 유지하는 데 기여한다. 이는 특히 여러 트랜잭션이 동시에 수행될 때 중요하다.</p>\n<p>갭 잠금의 주요 목적은 특정 범위에 대한 새로운 삽입을 방지하여 높은 격리 수준에서 발생할 수 있는 '팬텀 리드'를 방지하는 것이다.</p>\n<h3 id=\"Next-Key-Locks\" style=\"position:relative;\">Next Key Locks<a href=\"#Next-Key-Locks\" aria-label=\"Next Key Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>넥스트 키 잠금은 인덱스 레코드에 대한 레코드 잠금과 그 인덱스 레코드 이전의 간격에 대한 간격 잠금을 결합한 것이다.</p>\n<p>'Busan' 에 사는 멤버를 갱신하는 UPDATE 쿼리 실행 상황을 고려해 보자. 해당 쿼리가 진행 중일 때 다른 트랜잭션이 해당 갭에 새로운 도시를 삽입하면, UPDATE 쿼리가 처리해야 할 대상이 누잠금될 위험이 있다.</p>\n<p>이러한 상황을 방지하기 위해 갭 잠금이 사용될 때, 새로운 레코드의 삽입은 허용되지 않는다. 이는 UPDATE 쿼리가 실행 중일 때 해당 갭에 있는 데이터의 일관성이 유지됨을 보장한다. 즉, 갭 잠금은 해당 UPDATE 쿼리가 커밋되기 전까지는 새로운 레코드의 삽입을 방지한다.</p>\n<p>결과적으로, 갭 잠금이 설정되면, 갭에 해당하는 새 데이터의 삽입이나 수정이 일시적으로 제한되어, 트랜잭션의 일관성과 격리 수준이 유지된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">## Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">begin</span> <span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'busan'</span> <span class=\"token keyword\">for</span> <span class=\"token keyword\">share</span> <span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">## Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span> LOCK_DATA <span class=\"token keyword\">from</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+------------+</span>\n<span class=\"token operator\">|</span> OBJECT_SCHEMA <span class=\"token operator\">|</span> OBJECT_NAME <span class=\"token operator\">|</span> INDEX_NAME      <span class=\"token operator\">|</span> LOCK_TYPE <span class=\"token operator\">|</span> LOCK_MODE     <span class=\"token operator\">|</span> LOCK_DATA  <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+------------+</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>            <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> <span class=\"token operator\">IS</span>            <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S             <span class=\"token operator\">|</span> <span class=\"token string\">'busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S             <span class=\"token operator\">|</span> <span class=\"token string\">'busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S             <span class=\"token operator\">|</span> <span class=\"token string\">'busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> <span class=\"token number\">4</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> <span class=\"token number\">5</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> <span class=\"token number\">6</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>GAP         <span class=\"token operator\">|</span> <span class=\"token string\">'Seoul'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+------------+</span>\n<span class=\"token number\">8</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>1행 : 'member' 테이블 자체에 대한 Intent Shared(IS) 잠금이 걸려 있음을 나타낸다. 이것은 Connection 1이 해당 테이블의 데이터를 공유 모드로 읽기 위해 의도하고 있음을 의미한다.</li>\n<li>2~4행 : <code class=\"language-text\">MEMBER_CITY_IDX</code> 인덱스를 사용하는 'busan'에 해당하는 레코드들에 대해서는 Shared(S) 잠금이 걸려 있다. 넥스트 키 잠금을 의미하며, 이전 레코드와 현재 레코드를 포함해서 잠금이 걸리게 된다.</li>\n<li>5~7행 : PRIMARY 인덱스에 대해서는 <code class=\"language-text\">S,REC_NOT_GAP</code> 잠금이 걸려 있다. <code class=\"language-text\">REC_NOT_GAP</code>는 Record Not Gaplock의 약자로 갭락이 걸리지 않았다는 것을 의미한다. 즉 행 수준 잠금을 의미한다.</li>\n<li>8행 : 'Seoul'에 해당하는 레코드에 대한 'S,GAP' 잠금이 걸려 있는데, ('busan',6) ~ ('Seoul', 1) 까지의 갭 잠금을 의미한다.</li>\n</ul>\n<h3 id=\"Insert-Intention-Locks\" style=\"position:relative;\">Insert Intention Locks<a href=\"#Insert-Intention-Locks\" aria-label=\"Insert Intention Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>삽입 의도 잠금은 INSERT 명령을 사용할 때 다른 트랜잭션이 새 레코드를 추가할 의도를 알리는 데 사용된다. 이 잠금은 실제 레코드에 대해서는 아니라 아직 생성되지 않은 레코드(갭)에 대해 설정된다.</p>\n<h3 id=\"Auto-Increament-Locks\" style=\"position:relative;\">Auto Increament Locks<a href=\"#Auto-Increament-Locks\" aria-label=\"Auto Increament Locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>자동 증가 잠금은 여러 트랜잭션이 데이터를 삽입할 때 각각 고유한 값을 할당받을 수 있도록 하는 메커니즘이다. MySQL에서는 자동 증가 값을 관리하기 위해 다음과 같은 세 가지 잠금 모드를 지원하며, 이는 <code class=\"language-text\">innodb_autoinc_lock_mode</code> 옵션을 통해 설정 가능하다.</p>\n<ul>\n<li>0 (traditional lock mode): MySQL 5.0 이전의 동작을 모방하는 모드다. 이 모드에서는 자동 증가 잠금이 문장의 마지막까지 유지되며, 값은 반복 가능하고 연속적인 순서대로 할당된다. 데이터의 일관성과 예측 가능성을 중시하는 상황에서 유용하다.</li>\n<li>1 (consecutive lock mode): INSERT 문이 실행될 때 삽잠금입될 행의 수를 알고 있다면 필요한 자동 증가 값을 가벼운 뮤텍스 아래에서 할당하고 자동 증가 잠금을 회피할 수 있다. 삽입될 행의 수를 모르는 경우에는 자동 증가 잠금이 걸리고 문장의 끝까지\n유지된다. 이\n모드는 MySQL 5.7 및 그 이전 버전에서 기본값으로 설정되었다.</li>\n<li>2 (interleaved lock mode): 자동 증가 잠금을 전혀 사용하지 않으며, 동시에 발생하는 삽입 작업으로 인해 자동 증가 값이 섞일 수 있다. 이 모드는 바이너리 로깅이 비활성화되었거나 binlog_format이 ROW로 설정된 경우에만 안전하다. MySQL 8에서는\n이\n모드가 기본값으로 설정되어 있다.</li>\n</ul>\n<h2 id=\"트랜잭션과-잠금\" style=\"position:relative;\">트랜잭션과 잠금<a href=\"#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EA%B3%BC-%EC%9E%A0%EA%B8%88\" aria-label=\"트랜잭션과 잠금 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>여기서는 각 트랜잭션 격리 수준별로 잠금에 어떠한 영향을 미치는지 살펴본다. 예제를 위해 아래와 같은 스키마에서 테스트를 진행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">create</span> <span class=\"token keyword\">table</span> SYSTEM_SCHM<span class=\"token punctuation\">.</span>MEMBER\n<span class=\"token punctuation\">(</span>\n    id   <span class=\"token keyword\">bigint</span>      <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n    city <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n    name <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">36</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n    age  <span class=\"token keyword\">int</span>         <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">primary</span> <span class=\"token keyword\">key</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">create</span> <span class=\"token keyword\">index</span> MEMBER_CITY_IDX\n    <span class=\"token keyword\">on</span> MEMBER <span class=\"token punctuation\">(</span>city<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">insert</span> <span class=\"token keyword\">into</span> SYSTEM_SCHM<span class=\"token punctuation\">.</span>MEMBER<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> age<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">values</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Seoul'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'John'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Seoul'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Yun'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Seoul'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Merry'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Hong'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Kim'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       <span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Merry'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">21</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"Serializable\" style=\"position:relative;\">Serializable<a href=\"#Serializable\" aria-label=\"Serializable permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Serializable 격리 수준은 사용 가능한 격리 수준 중 가장 엄격하다.\nSELECT 문을 포함한 모든 Statement은 잠금을 흭득한다. 단, autocommit이 활성화된 상태에서 실행되는 SELECT 문이나 명시적인 트랜잭션이 시작되지 않은 경우는 제외된다.</p>\n<p>SELECT 문에 대해서는 FOR SHARE를 추가한 것과 동등한 효과를 낸다. 즉, SERIALIZABLE 격리 수준에서는 SELECT 문도 다른 트랜잭션에 의해 수정되지 않도록 잠금을 획득한다.\nSERIALIZABLE 격리 수준은 데이터의 일관성을 최대한 보장하기 위해 많은 잠금을 사용하며, 이는 동시성 처리에 있어서 성능 저하를 일으킬 수 있다. 따라서, 필요한 경우에만 사용하는 것이 좋다.</p>\n<p>아래는 Serializable 격리 수준에서 잠금이 어떻게 동작되는지를 보여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'SERIALIZABLE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span>LOCK_STATUS<span class=\"token punctuation\">,</span>LOCK_DATA\n<span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+---------------------+</span>\n<span class=\"token operator\">|</span> OBJECT_SCHEMA <span class=\"token operator\">|</span> OBJECT_NAME <span class=\"token operator\">|</span> INDEX_NAME      <span class=\"token operator\">|</span> LOCK_TYPE <span class=\"token operator\">|</span> LOCK_MODE     <span class=\"token operator\">|</span> LOCK_STATUS <span class=\"token operator\">|</span> LOCK_DATA           <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+---------------------+</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>            <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> <span class=\"token operator\">IS</span>            <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>                <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">4</span>                   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">5</span>                   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">6</span>                   <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>GAP         <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Seoul'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+---------------------+</span></code></pre></div>\n<p><code class=\"language-text\">MEMBER_CITY_IDX</code> 로 읽는 모든 인덱스 레코드에 넥스트 키 잠금이 걸리고 기본키에는 행 수준 잠금을 걸게된다. 'Busan'에 대한 마지막 인덱스 뒤인 (Seoul, 'John', 1) 레코드에 갭잠금이 걸리는것을 볼 수 있다.\nSerializable 격리 수준에서는 넥스트 키 잠금과 갭 잠금에 공유 잠금이 걸려 Phantom Read를 예방할 수 있다.</p>\n<p>아래는 MEMBER 테이블의 Primary Key로 유니크한 레코드를 SELECT 할 때 획득되는 잠금을 나타낸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'SERIALIZABLE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2 </span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span>LOCK_STATUS<span class=\"token punctuation\">,</span>LOCK_DATA <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+------------+-----------+---------------+-------------+-----------+</span>\n<span class=\"token operator\">|</span> OBJECT_SCHEMA <span class=\"token operator\">|</span> OBJECT_NAME <span class=\"token operator\">|</span> INDEX_NAME <span class=\"token operator\">|</span> LOCK_TYPE <span class=\"token operator\">|</span> LOCK_MODE     <span class=\"token operator\">|</span> LOCK_STATUS <span class=\"token operator\">|</span> LOCK_DATA <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+------------+-----------+---------------+-------------+-----------+</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> <span class=\"token operator\">IS</span>            <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>      <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>    <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> S<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">1</span>         <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+------------+-----------+---------------+-------------+-----------+</span>\n<span class=\"token number\">2</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Primary Key는 WHERE 조건에 맞는 레코드가 1건인 것을 보장하므로 Primary Record에 행 수준 잠금<code class=\"language-text\">(S,REC_NOT_GAP)</code>을 획득하는 것을 볼 수 있다.</p>\n<p>아래는 <code class=\"language-text\">MEMBER_CITY_IDX</code> 인덱스의 하위 집합을 UPDATE 할 때 발생하는 잠금을 나타낸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'SERIALIZABLE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> MEMBER <span class=\"token keyword\">SET</span> AGE <span class=\"token operator\">=</span> AGE <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span> city<span class=\"token operator\">=</span><span class=\"token string\">'Busan'</span> <span class=\"token operator\">and</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'Hong'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span>LOCK_STATUS<span class=\"token punctuation\">,</span>LOCK_DATA <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token operator\">|</span> OBJECT_SCHEMA <span class=\"token operator\">|</span> OBJECT_NAME <span class=\"token operator\">|</span> INDEX_NAME      <span class=\"token operator\">|</span> LOCK_TYPE <span class=\"token operator\">|</span> LOCK_MODE     <span class=\"token operator\">|</span> LOCK_STATUS <span class=\"token operator\">|</span> LOCK_DATA  <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>            <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> IX            <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">4</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">5</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">6</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>GAP         <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Seoul'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token number\">8</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">MEMBER_CITY_IDX</code> 인덱스에 name에 대한 인덱스가 없기 때문에 city='Busan' 영역에 넥스트 키락과 갭락이 걸리는 것을 확인할 수 있다.</p>\n<h3 id=\"Repeatable-Read\" style=\"position:relative;\">Repeatable Read<a href=\"#Repeatable-Read\" aria-label=\"Repeatable Read permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Repeatable Read 격리 수준은 InnoDB에서 기본으로 설정된 격리 수준이다.\n이 수준에서 SELECT 쿼리는 특정 시점의 데이터베이스 상태를 반영하는 스냅샷을 통해 구현된다.\n이 스냅샷은 트랜잭션이 시작될 때 또는 트랜잭션 내에서 첫 번째 SQL 문장이 실행될 때 생성된다.\nInnoDB는 Multi-Version Concurrency Control(MVCC)을 사용하여 스냅샷을 제공하한다.</p>\n<p>아래 예시는 Repeatable Read 격리 수준에서 스냅샷 읽기를 사용한 읽관된 읽기과 잠금을 보여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'REPEATABLE-READ'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> city  <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> age <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Hong  <span class=\"token operator\">|</span>  <span class=\"token number\">29</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Kim   <span class=\"token operator\">|</span>  <span class=\"token number\">26</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Merry <span class=\"token operator\">|</span>  <span class=\"token number\">22</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span>LOCK_STATUS<span class=\"token punctuation\">,</span>LOCK_DATA\n  <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\nEmpty <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 3</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> SYSTEM_SCHM<span class=\"token punctuation\">.</span>MEMBER<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> age<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'July'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token keyword\">row</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> city  <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> age <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Hong  <span class=\"token operator\">|</span>  <span class=\"token number\">29</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Kim   <span class=\"token operator\">|</span>  <span class=\"token number\">26</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Merry <span class=\"token operator\">|</span>  <span class=\"token number\">22</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>이 케이스에서 SELECT 시, 공유잠금이 유지되지 않는데 이것이 Serializable과 Repeatable Read의 가장 중요한 차이이다.\nConnection3에서 MEMBER 테이블에 새로운 레코드를 Insert를 하더라도, Connection1 에서 다시 SELECT를 해도 새로 추가된 레코드가 나타나지 않는 것을 볼 수 있다.\n이는 스냅샷 읽기를 사용해서 트랜잭션이 데이터를 읽는 동안 다른 트랜잭션이 해당 테이블을 수정해도, 최초 트랜잭션은 원래의 데이터 상태를 계속 볼 수 있기 때문이다.</p>\n<p>MySQL의 Repeatable Read 격리 수준의 잘못 알려진 사실은, MySQL의 Repeatable Read 격리 수준에서는 MVCC를 통해 Phantom Read 현상이 발생하지 않는다는 것 이다.\nMVCC는 스냅샷 읽기를 통해 읽기 작업의 동시성을 높히기 위한 것으로, UPDATE나 DELETE 문에는 적용되지 않는다.\n즉, 최초 트랜잭션에서 스냅샷에서 데이터를 읽은 후, 다른 트랜잭션에서 첫번째 트랜잭션에서 사용된 필터와 일치하는 행의 변경사항을 커밋하면 첫 번째 트랜잭션에서 이 행을 수정할 수 있고, 이후에는 스냅샷에 포함될 수 있다.</p>\n<p>아래는 Repeatable Read 격리 수준에서 발생할 수 있는 Phantom Read의 예를 보여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'REPEATABLE-READ'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> city  <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> age <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Hong  <span class=\"token operator\">|</span>  <span class=\"token number\">29</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Kim   <span class=\"token operator\">|</span>  <span class=\"token number\">26</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Merry <span class=\"token operator\">|</span>  <span class=\"token number\">22</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> SYSTEM_SCHM<span class=\"token punctuation\">.</span>MEMBER<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> age<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'July'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token keyword\">row</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> MEMBER <span class=\"token keyword\">SET</span> AGE <span class=\"token operator\">=</span> AGE <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span>  city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">Rows</span> <span class=\"token keyword\">matched</span>: <span class=\"token number\">4</span>  Changed: <span class=\"token number\">4</span>  <span class=\"token keyword\">Warnings</span>: <span class=\"token number\">0</span>\n\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> city  <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> age <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Hong  <span class=\"token operator\">|</span>  <span class=\"token number\">30</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">8</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> July  <span class=\"token operator\">|</span>  <span class=\"token number\">23</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Kim   <span class=\"token operator\">|</span>  <span class=\"token number\">27</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Merry <span class=\"token operator\">|</span>  <span class=\"token number\">23</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token number\">4</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Connection1 에서는 도시가 부산인 모든 멤버(city='Busan')를 쿼리한다. 그런 다음 Connection2는 'Busan'에 새로운 멤버를 추가 후 커밋한다.\n여기까지는 Connection1이 SELECT 문을 반복해도 똑같은 멤버가 반환된다. 그러나 Connection1에서 Busan의 모든 멤버에 대해 UPDATE하면\n4개 행이 업데이트되고 추가 SELECT에서도 4개행의 반환되는 것을 확인할 수 있다.</p>\n<p>Phantom read를 막기 위해서는 Connection1에서 FOR SHARE 절을 사용하여 공유잠금을 요청하거나 Serializable 격리 수준으로 변경해야한다.</p>\n<p>마지막으로, 아래는 REPEATABLE-READ 격리 수준에서 <code class=\"language-text\">MEMBER_CITY_IDX</code> 인덱덱의 하위 집합을 UPDATE 할 때 발생하는 잠금을 나타낸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'REPEATABLE'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> MEMBER <span class=\"token keyword\">SET</span> AGE <span class=\"token operator\">=</span> AGE <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span> city<span class=\"token operator\">=</span><span class=\"token string\">'Busan'</span> <span class=\"token operator\">and</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'Hong'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span>LOCK_STATUS<span class=\"token punctuation\">,</span>LOCK_DATA <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token operator\">|</span> OBJECT_SCHEMA <span class=\"token operator\">|</span> OBJECT_NAME <span class=\"token operator\">|</span> INDEX_NAME      <span class=\"token operator\">|</span> LOCK_TYPE <span class=\"token operator\">|</span> LOCK_MODE     <span class=\"token operator\">|</span> LOCK_STATUS <span class=\"token operator\">|</span> LOCK_DATA  <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>            <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> IX            <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X             <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">4</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">5</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">6</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>GAP         <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Seoul'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token number\">8</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Serializable 격리 수준과 동일한 수준의 8개의 잠금을 확인할 수 있다.</p>\n<h3 id=\"Read-Committed\" style=\"position:relative;\">Read Committed<a href=\"#Read-Committed\" aria-label=\"Read Committed permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Read Committed와 Repeatable Read의 주요 차이점은 일관된 읽기를 지원하지 않는 다는 것이다.\n이는 스냅샷 사용을 하지 않기 때문에, 오래된 undo 로그를 더 빨리 정리할 수 있게 하는데, 특히 오랜시간 동안 실행되는 Long 트랜잭션에서 중요하다.</p>\n<p>또한, Read Committed에서는 외래 키와 고유 키 제약 조건을 확인하는 경우, 그리고 페이지 분할이 발생하는 경우에만 갭 잠금을 사용한다.\n페이지 분할은 InnoDB 페이지가 거의 가득 찼을 때 중간에 레코드를 삽입하거나 기존 레코드가 커져서 페이지에 더 이상 공간이 없을 때 발생한다.</p>\n<p>아래는 Read Committed에서 발생할 수 있는 non-Repeatable Read 문제를 보여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'READ-COMMITTED'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> city  <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> age <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Hong  <span class=\"token operator\">|</span>  <span class=\"token number\">28</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Kim   <span class=\"token operator\">|</span>  <span class=\"token number\">25</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Merry <span class=\"token operator\">|</span>  <span class=\"token number\">21</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> MEMBER <span class=\"token keyword\">SET</span> age <span class=\"token operator\">=</span> <span class=\"token number\">30</span> <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">COMMIT</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> MEMBER <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span> id <span class=\"token operator\">|</span> city  <span class=\"token operator\">|</span> name  <span class=\"token operator\">|</span> age <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">4</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Hong  <span class=\"token operator\">|</span>  <span class=\"token number\">30</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">5</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Kim   <span class=\"token operator\">|</span>  <span class=\"token number\">30</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span>  <span class=\"token number\">6</span> <span class=\"token operator\">|</span> Busan <span class=\"token operator\">|</span> Merry <span class=\"token operator\">|</span>  <span class=\"token number\">30</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----+-------+-------+-----+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Connection2에서 city=Busan에 해당 하는 모든 멤버의 나이를 30으로 UPDATE를 하고 커밋한 뒤, Connection1에서 SELECT 하면 마지막 커밋의 레코드를 읽어오는 것을 확인할 수 있다.\n이 격리 수준에서는 non-Repeatable Read 문제와 Phantom Read 현상이 발생할 수 있다.</p>\n<p>또, 다른 특징으로는 WHERE 절에 따라 어떤 레코드가 해당 쿼리에 영향을 받는지 결정할 때, 이 레코드들에 잠금이 걸리게 된다.\n그러나 Read Committed 격리 수준에서는 잠금이 걸린 레코드 중에서 실제로 수정되지 않는 레코드들에 대한 잠금은 WHERE 절의 평가가 끝나는 즉시 해재된다.</p>\n<p>아래는 Read Committed 격리 수준에서 <code class=\"language-text\">MEMBER_CITY_IDX</code> 인덱덱의 하위 집합을 UPDATE 할 때 발생하는 잠금을 나타낸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'READ-COMMITTED'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> MEMBER <span class=\"token keyword\">SET</span> AGE <span class=\"token operator\">=</span> AGE <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span> city<span class=\"token operator\">=</span><span class=\"token string\">'Busan'</span> <span class=\"token operator\">and</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'Hong'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span>LOCK_STATUS<span class=\"token punctuation\">,</span>LOCK_DATA <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token operator\">|</span> OBJECT_SCHEMA <span class=\"token operator\">|</span> OBJECT_NAME <span class=\"token operator\">|</span> INDEX_NAME      <span class=\"token operator\">|</span> LOCK_TYPE <span class=\"token operator\">|</span> LOCK_MODE     <span class=\"token operator\">|</span> LOCK_STATUS <span class=\"token operator\">|</span> LOCK_DATA  <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>            <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> IX            <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> MEMBER_CITY_IDX <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token string\">'Busan'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>         <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">4</span>          <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+-----------------+-----------+---------------+-------------+------------+</span>\n<span class=\"token number\">3</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Read Committed 격리 수준에서는 <code class=\"language-text\">city='Busan' and name = 'Hong'</code> 조건을 만족하는 레코드 2건(인덱스와 PK)에 대해서만 행 수준 잠금이 걸려있는 것을 확인할 수 있다.\n실제로는 Repeatable Read 격리 수준과 마찬가지로 city='Busan'에 해당하는 레코드 모두에 대해서 잠금을 걸지만, WHERE 조건에 평가가 끝나는 즉시 잠금을 회수하기 때문에 이러한 잠금은 관측하기가 어렵다.</p>\n<p>Read Committed 격리 수준의 또 다른 특징은 semi-consistent read다.\nsemi-consistent read는 인덱스가 없는 열에서 동작하며 어떤 Statement가 실행될 때 행의 마지막 커밋된 값과 WHERE 절을 비교하여\n해당 Statement가 특정 행을 업데이트하지 않을 것으로 판단되면, 다른 트랜잭션이 해당 행에 잠금을 걸고 있어도 잠금 충돌이 발생하지 않는다.</p>\n<p>아래는 semi-consistent read 예를 보여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'READ-COMMITTED'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> MEMBER <span class=\"token keyword\">SET</span> AGE <span class=\"token operator\">=</span> AGE <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span>  name <span class=\"token operator\">=</span> <span class=\"token string\">'Hong'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 2</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SET</span> transaction_isolation <span class=\"token operator\">=</span> <span class=\"token string\">'READ-COMMITTED'</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">BEGIN</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> MEMBER <span class=\"token keyword\">SET</span> AGE <span class=\"token operator\">=</span> AGE <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span>  name <span class=\"token operator\">=</span> <span class=\"token string\">'Kim'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 3</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> OBJECT_SCHEMA<span class=\"token punctuation\">,</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_MODE<span class=\"token punctuation\">,</span>LOCK_STATUS<span class=\"token punctuation\">,</span>LOCK_DATA <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+------------+-----------+---------------+-------------+-----------+</span>\n<span class=\"token operator\">|</span> OBJECT_SCHEMA <span class=\"token operator\">|</span> OBJECT_NAME <span class=\"token operator\">|</span> INDEX_NAME <span class=\"token operator\">|</span> LOCK_TYPE <span class=\"token operator\">|</span> LOCK_MODE     <span class=\"token operator\">|</span> LOCK_STATUS <span class=\"token operator\">|</span> LOCK_DATA <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+------------+-----------+---------------+-------------+-----------+</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> IX            <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>      <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>    <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">5</span>         <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>       <span class=\"token operator\">|</span> <span class=\"token keyword\">TABLE</span>     <span class=\"token operator\">|</span> IX            <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token boolean\">NULL</span>      <span class=\"token operator\">|</span>\n<span class=\"token operator\">|</span> system_schm   <span class=\"token operator\">|</span> member      <span class=\"token operator\">|</span> <span class=\"token keyword\">PRIMARY</span>    <span class=\"token operator\">|</span> RECORD    <span class=\"token operator\">|</span> X<span class=\"token punctuation\">,</span>REC_NOT_GAP <span class=\"token operator\">|</span> GRANTED     <span class=\"token operator\">|</span> <span class=\"token number\">4</span>         <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">---------------+-------------+------------+-----------+---------------+-------------+-----------+</span>\n<span class=\"token number\">4</span> <span class=\"token keyword\">rows</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>두 트랜젹선 모두 WHERE절에서 name을 비교하지만 Hong, Kim 서로 다른 레코드를 업데이트한다.\nname은 인덱싱되어 있지 않아 semi-consistent read로 잠금 충돌이 발생하지 않는다.</p>\n<h3 id=\"Read-Uncommitted\" style=\"position:relative;\">Read Uncommitted<a href=\"#Read-Uncommitted\" aria-label=\"Read Uncommitted permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Read Uncommitted 격리 수준을 사용하는 트랜잭션은 아직 커밋되지 않은 데이터를 읽을 수 있으며, 이를 더티 리드(dirty read)라고 한다.\n더티 리드를 제외하고는 동작은 READ COMMITTED와 동일하다. 주요 용도는 대략적인 값만 필요한 경우이다.</p>\n<h2 id=\"Deadlock\" style=\"position:relative;\">Deadlock<a href=\"#Deadlock\" aria-label=\"Deadlock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>데드락(Deadlock)이란, 두 개 이상의 작업이 서로 상대방의 작업이 끝나기 만을 기다리고 있기 때문에 결과적으로 아무것도 완료되지 못하는 상태이다.\n아래 예제는 데드락의 예이다.</p>\n<h4>사례1</h4>\n<table>\n<thead>\n<tr>\n<th align=\"center\">trx-1</th>\n<th align=\"center\">trx-2</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">UPDATE member SET age = age + 1 WHERE id = 1;</td>\n<td align=\"center\">UPDATE member SET age = age + 1 WHERE id = 2;</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">UPDATE member SET age = age + 1 WHERE id = 1;</td>\n</tr>\n<tr>\n<td align=\"center\">UPDATE member SET age = age + 1 WHERE id = 2;</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">deadlock</td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<p>trx-1은 id=1에 배타적 잠금을 설정한채로 id=2의 배타적 잠금을 원하고, trx-2는 id=2에 배타적 잠금을 설정한채로 id=1의 배타적 잠금을 원하기 때문에\n두 트랜잭션은 영원히 완료할 수 없다.</p>\n<h4>사례2</h4>\n<table>\n<thead>\n<tr>\n<th align=\"center\">trx-1</th>\n<th align=\"center\">trx-2</th>\n<th align=\"center\">trx-3</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">DELETE FROM member WHERE id = 1;</td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">INSERT INTO member VALUES(1, ...);</td>\n<td align=\"center\">INSERT INTO member VALUES(1, ...);</td>\n</tr>\n<tr>\n<td align=\"center\">commit;</td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">deadlock</td>\n<td align=\"center\"></td>\n</tr>\n</tbody>\n</table>\n<p>trx-1은 id=1 행에 대해 배타적 잠금을 획득한다.\ntrx-2와 trx-3은 동일한 행에 대해 INSERT하여 Duplicate key error가 발생하고, 해당 행에 대해 공유 잠금(Shared Lock)을 요청한다.</p>\n<blockquote>\n<p>InnoDB에서의 INSERT는 Duplicate key error 발생하면 해당 레코드에 공유 잠금을 먼저 설정하고 배타적 잠금을 획득하기 때문이다.<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup></p>\n</blockquote>\n<p>trx-1이 커밋하면 행에 대한 배타적 잠금을 해제하고, trx-2와 trx-3은 행에 대한 공유 잠금을 획득하게 된다.\n이 시점에서, trx-2와 trx-3는 데드락이 발생한다. 두 세션 모두 다른 세션에 의해 보유된 공유 잠금 때문에 해당 행에 대한 배타적 잠금을 획득할 수 없기 때문이다.</p>\n<h3 id=\"RollBack\" style=\"position:relative;\">RollBack<a href=\"#RollBack\" aria-label=\"RollBack permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>데드락이 발생하면, InnoDB는 가장 적은 작업을 수행한 트랜잭션을 롤백한다. 가장 적은 작업이란 <code class=\"language-text\">information_schema.INNODB_TRX</code> 뷰에서 <code class=\"language-text\">trx_weight</code>값이 적은 트랜잭션을 의미한다.\n이를 트랜잭션 가중치라고 하는데 트랜잭션의 가중치는 변경된 행의 수와 트랜잭션에 의해 잠긴 행의 수를 반영한다.<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># Connection 1</span>\n<span class=\"token operator\">></span> <span class=\"token keyword\">begin</span> <span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> member <span class=\"token keyword\">SET</span> age <span class=\"token operator\">=</span> age <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token keyword\">WHERE</span> id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token keyword\">row</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">Rows</span> <span class=\"token keyword\">matched</span>: <span class=\"token number\">1</span>  Changed: <span class=\"token number\">1</span>  <span class=\"token keyword\">Warnings</span>: <span class=\"token number\">0</span>\n\n<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> trx_id<span class=\"token punctuation\">,</span> trx_weight <span class=\"token keyword\">FROM</span> information_schema<span class=\"token punctuation\">.</span>INNODB_TRX<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------------+</span>\n<span class=\"token operator\">|</span> trx_id <span class=\"token operator\">|</span> trx_weight <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token number\">280342</span> <span class=\"token operator\">|</span>          <span class=\"token number\">3</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">--------+------------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"서비스-환경에서의-데드락\" style=\"position:relative;\">서비스 환경에서의 데드락<a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%EC%9D%98-%EB%8D%B0%EB%93%9C%EB%9D%BD\" aria-label=\"서비스 환경에서의 데드락 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>서비스 환경에서의 데드락은 예제와 같이 단순한 케이스가 아닌 암시적인 잠금으로 데드락의 원인 파악에 어려움이 있는 경우가 많다.\n대표적으로 UPSERT를 처리하는 <code class=\"language-text\">INSERT INTO T SELECT ... FROM ... ON DUPLICATE KEY</code> 와 같은 구문이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> MEMBER <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> age<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">SELECT</span> id<span class=\"token punctuation\">,</span> city<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> age\n<span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span>\n      <span class=\"token keyword\">FROM</span> MEMBER\n      <span class=\"token keyword\">WHERE</span> city <span class=\"token operator\">=</span> <span class=\"token string\">'Busan'</span>\n        <span class=\"token operator\">AND</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'Hong'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> T\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">DUPLICATE</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">UPDATE</span> age <span class=\"token operator\">=</span> T<span class=\"token punctuation\">.</span>age <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 SQL은 MEMBER 테이블에 city='Busan' 이면서 name='Hong'인 멤버를 SELECT 하여 다시 MEMBER에 INSERT 한다.\n만약, 중복된 값이 있다면 age를 1증가시킨다.</p>\n<p>이 쿼리가 실행되면 아래와 같은 잠금을 필요로 한다.</p>\n<ul>\n<li>FROM절 서브쿼리 실행을 위한 공유 잠금</li>\n<li>서브쿼리의 SELECT 결과를 INSERT 할 때, 중복키가 발생하면 해당 키에 대한 공유 잠금</li>\n<li>UPDATE를 위한 배타적 잠금</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th align=\"center\">trx-1</th>\n<th align=\"center\">trx-2</th>\n<th align=\"center\">trx-3</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">BEGIN;</td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">SELECT * FROM MEMBER WHERE city='Busan' FOR UPDATE ;</td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">BEGIN;</td>\n<td align=\"center\">BEGIN;</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">INSERT INTO ... ON DUPLICATE KEY UPDATE ;</td>\n<td align=\"center\">INSERT INTO ... ON DUPLICATE KEY UPDATE ;</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">wants MEMBER_IDX S Lock</td>\n<td align=\"center\">wants MEMBER_IDX S Lock</td>\n</tr>\n<tr>\n<td align=\"center\">rollback;</td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">grant MEMBER_IDX S Lock</td>\n<td align=\"center\">grant MEMBER_IDX S Lock</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"center\">wants id=4 X Lock</td>\n<td align=\"center\">wants id=5 X Lock</td>\n</tr>\n</tbody>\n</table>\n<p>같은 원리로 UPDATE 구문에서 SELF JOIN 하는 경우 데드락의 발생 가능성이 높아진다.\nUPDATE 구문의 JOIN이 걸린 테이블에는 공유 잠금을 설정하고 수정에 영향을 받는 레코드에 대한 배타적 잠금을 설정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">UPDATE</span> MEMBER\n    <span class=\"token keyword\">JOIN</span> MEMBER\n    <span class=\"token keyword\">ON</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">as</span> CHILD\n<span class=\"token keyword\">SET</span> AGE <span class=\"token operator\">=</span> CHILD<span class=\"token punctuation\">.</span>AGE<span class=\"token punctuation\">;</span></code></pre></div>\n<p>이러한 자신의 테이블을 JOIN하여 UPDATE 하는 구문 역시 공유 잠금을 획득 후 UPDATE를 위해 배타적 잠금으로 잠금을 업그레이드하면서 데드락이 발생할 수 있다.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p><a href=\"https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html\">https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p><a href=\"https://dev.mysql.com/doc/refman/8.0/en/information-schema-innodb-trx-table.html\">https://dev.mysql.com/doc/refman/8.0/en/information-schema-innodb-trx-table.html</a></p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/mysql-transaction-lock/"},"frontmatter":{"title":"MySQL 잠금과 트랜잭션 Deep Dive","date":"November 16, 2023"}},{"id":"f3cc757b-893a-536b-a5a9-fd7daa864ee1","html":"<h2 id=\"문제-상황\" style=\"position:relative;\">문제 상황<a href=\"#%EB%AC%B8%EC%A0%9C-%EC%83%81%ED%99%A9\" aria-label=\"문제 상황 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>소켓을 활용하여 서버-클라이언트 간 통신을 진행하는 과정에서, 클라이언트로부터의 요청이 일시적으로 급증하는 상황을 테스트하던 중,\n클라이언트 측에서 <code class=\"language-text\">Connection reset by peer</code> 라는 예외가 간헐적으로 발생하였다. 아래는 해당 예외가 발생했을 때 클라이언트 측에서 기록된 로그이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hello, world!\nHello, world!\nHello, world!\norg.springframework.web.client.ResourceAccessException: I/O error: Connection reset by peer; nested exception is java.net.SocketException: Connection reset by peer\n\tat org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:453)\n\tat org.springframework.web.client.RestTemplate.execute(RestTemplate.java:401)\n\tat org.springframework.web.client.RestTemplate.getForObject(RestTemplate.java:199)\n\tat com.example.ehcache.EhcacheApplication2.lambda$main$0(EhcacheApplication2.java:35)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\n\tat java.base/java.lang.Thread.run(Thread.java:833)\nCaused by: java.net.SocketException: Connection reset by peer\n\tat java.base/sun.nio.ch.Net.connect0(Native Method)\n\tat java.base/sun.nio.ch.Net.connect(Net.java:579)\n\tat java.base/sun.nio.ch.Net.connect(Net.java:568)</code></pre></div>\n<p><code class=\"language-text\">Hello, world!</code>는 클라이언트가 서버로부터 정상적으로 응답을 받아 출력한 메시지이다.\n그 아래에 나타나는 <code class=\"language-text\">java.net.SocketException: Connection reset by peer</code> 예외는 RestTemplate을 통한 소켓 통신 중 발생했다는 것을 확인할 수 있다.</p>\n<p>해당 문제가 발생한 서버-클라이언트 코드는 아래와 같다.\n여기서 서버는 스레드풀 기반의 간단한 HTTP 서버를 구현하였고, 클라이언트는 이 서버에 스레드 1000개를 사용하여 동시에 요청을 보내는 구조를 가지고 있다.</p>\n<h4>Server</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ServerExampleApplication</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">8100</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">NUM_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocket</span> serverSocket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">Socket</span> socket <span class=\"token operator\">=</span> serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\texecutorService<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ClientHandler</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ClientHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Socket</span> socket<span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">ClientHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Socket</span> socket<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>socket <span class=\"token operator\">=</span> socket<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token annotation punctuation\">@Override</span>\n\t\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">BufferedReader</span> input <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedReader</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InputStreamReader</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tinput<span class=\"token punctuation\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\t<span class=\"token class-name\">PrintWriter</span> writer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PrintWriter</span><span class=\"token punctuation\">(</span>socket<span class=\"token punctuation\">.</span><span class=\"token function\">getOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HTTP/1.1 200 OK\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type: text/plain\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Connection: close\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello, world!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\twriter<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tinput<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Client</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:8100\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">NUM_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">ExecutorService</span> es <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">RestTemplate</span> restTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span>\n\t\t\t\t\t<span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\t<span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">getForObject</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>시스템 환경에 따라 예외 재현이 안될 수 있다.</p>\n</blockquote>\n<p>요청량이 많아 서버의 리소스가 부족해져 요청을 제대로 처리하지 못하는 상황이 이해는 가지만, 시스템이 요청을 처리할지 여부를 결정하는 기준이 무엇인지에 대해 궁금증이 생겼다.</p>\n<p>이번 글에서는 요청이 폭증하는 상황에서 발생하는 <code class=\"language-text\">Connection reset by peer</code> 예외의 원인을 깊이 있게 분석한다.</p>\n<h2 id=\"원인-분석-과정\" style=\"position:relative;\">원인 분석 과정<a href=\"#%EC%9B%90%EC%9D%B8-%EB%B6%84%EC%84%9D-%EA%B3%BC%EC%A0%95\" aria-label=\"원인 분석 과정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"패킷-분석\" style=\"position:relative;\">패킷 분석<a href=\"#%ED%8C%A8%ED%82%B7-%EB%B6%84%EC%84%9D\" aria-label=\"패킷 분석 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>클라이언트 쪽에서 <code class=\"language-text\">Connection reset by peer</code> 예외가 발생했지만, 서버 애플리케이션 단에서는 어떤 예외도 잡아낼 수 없었다.\n상황을 더 자세히 파악하기 위해 Wireshark를 사용해 패킷을 분석하였다.\n아래 <strong>그림 1</strong>은 문제가 발생한 시점의 서버-클라이언트 소켓 통신 패킷 캡쳐 화면이다.\n<figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/caebe6ce8ad4511e6b3105eb35dbb515/f8d80/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 6.470588235294117%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAS0lEQVR42i3KOQ6AIBQAUe/foQWfTQ1WIgJxOd9ojMU0L9NVM5LFUyRwhUg1E+212y8UHcjaUezI/n+pNyQlX6vSbIOlycxhI6eLPBkEOZ/PcIT8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"[그림1]문제가 발생한 서버-클라이언트 소켓 통신\"\n        title=\"\"\n        src=\"/static/caebe6ce8ad4511e6b3105eb35dbb515/ca1dc/img.png\"\n        srcset=\"/static/caebe6ce8ad4511e6b3105eb35dbb515/e7570/img.png 170w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/f46e7/img.png 340w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/ca1dc/img.png 680w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/02d09/img.png 1020w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/9d567/img.png 1360w,\n/static/caebe6ce8ad4511e6b3105eb35dbb515/f8d80/img.png 1516w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">[그림1]문제가 발생한 서버-클라이언트 소켓 통신</figcaption>\n  </figure></p>\n<ul>\n<li>3842번 패킷 : 클라이언트 -> 서버로 <code class=\"language-text\">SYN</code> 패킷을 전송하였다.</li>\n<li>3843번 패킷 : 서버 -> 클라이언트로 <code class=\"language-text\">SYN,ACK</code> 으로 응답하였다.</li>\n<li>3845번 패킷 : 클라이언트 -> 서버로 <code class=\"language-text\">ACK</code>로 응답 후, 3-way Handshake가 완료되었다.</li>\n<li>3848번 패킷 : 서버 -> 클라이언트로 <code class=\"language-text\">RST</code> 패킷을 전송한다.</li>\n</ul>\n<p>캡쳐된 패킷을 살펴보면 정상적인 TCP 3-way Handshake가 진행된 후, 서버에서 RST 패킷을 전송하여 연결을 강제로 종료하였다.\nRST 패킷은 연결의 문제나 예외적인 상황에서 전송되므로 해당 연결에 문제가 발생했음을 알 수 있다.</p>\n<p>문제 상황에서 클라이언트가 출력한 스택 트레이스를 살펴보면, socket.connect() 를 수행 중 예외가 발생한 것을 확인할 수 있다.\n즉, 클라이언트 소켓이 connect()를 호출해 수행하던 중 3-way Handshake를 완료한 후에 서버로부터 RST 패킷을 받아 <code class=\"language-text\">Connection reset by peer</code> 예외가 발생된 것으로 확인된다.</p>\n<h3 id=\"테스트-환경-전환\" style=\"position:relative;\">테스트 환경 전환<a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%ED%99%98%EA%B2%BD-%EC%A0%84%ED%99%98\" aria-label=\"테스트 환경 전환 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>애플리케이션 로그와 패킷 분석 결과, 예외가 애플리케이션 레벨보다는 OS나 TCP/IP 프로토콜 레벨에서 발생한 것 추측되었다.\n패킷 분석에서 서버가 RST 패킷을 전송한 걸 확인했는데, 애플리케이션에는 <code class=\"language-text\">RST</code> 패킷을 전송하는 로직이나 패킷을 보낼 조건을 결정하는 로직이 없기 때문이다.</p>\n<p>원인을 보다 구체적으로 파악하기 위해 MacOS 환경 대신 리눅스 환경에서 동일한 서버-클라이언트 코드로 테스트를 해보기로 결정했다.\nDocker를 사용해 리눅스 환경을 구성하고 테스트를 진행했다. 여기서는 ubuntu 리눅스를 선택했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">-v</span> ~/docker/linux:/home ubuntu</code></pre></div>\n<p>동일한 서버-클라이언트 코드를 사용해 테스트 했을 때, 같은 스레드와 부하에도 불구하고 리눅스 환경에서는 <code class=\"language-text\">Connection reset by peer</code> 예외가 한 번도 발생하지 않았다.\n여러번 테스트해도 결과는 같았고 심지어 클라이언트 부하를 증가시켜도 예외가 발생하지 않았다.\n이 결과로 볼 때, 서버가 클라이언트에게 <code class=\"language-text\">RST</code> 패킷을 전송하는 결정 및 과정이 OS나 TCP/IP 프로토콜 레벨에서 이루어지고 있을 가능성이 매우 높아졌다.</p>\n<h3 id=\"소켓-내부-로직-분석\" style=\"position:relative;\">소켓 내부 로직 분석<a href=\"#%EC%86%8C%EC%BC%93-%EB%82%B4%EB%B6%80-%EB%A1%9C%EC%A7%81-%EB%B6%84%EC%84%9D\" aria-label=\"소켓 내부 로직 분석 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>리눅스 환경에서 예외가 재현되지 않는 것을 확인 후, Socket 클래스 내부 동작을 살펴보았다.\nSocket 클래스의 연산은 결국 PlainSocketImpl 클래스의 native 메서드를 호출하는 것을 확인할 수 있었다.\n이러한 네이티브 메서드는 OS의 시스템 호출을 통해 소켓 작업을 처리한다. 따라서, 시스템 레벨에서 소켓이 어떻게 동작되는지 확인이 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">PlainSocketImpl</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractPlainSocketImpl</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// [...]</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketCreate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> stream<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> isServer<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketConnect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InetAddress</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> timeout<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketBind</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InetAddress</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketListen</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> count<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketAccept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketImpl</span> s<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">int</span> <span class=\"token function\">socketAvailable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketClose0</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> useDeferredClose<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketShutdown</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> howto<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">static</span> <span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">initProto</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketSetOption0</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> cmd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> on<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">int</span> <span class=\"token function\">socketGetOption</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> opt<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> iaContainerObj<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">native</span> <span class=\"token keyword\">void</span> <span class=\"token function\">socketSendUrgentData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"소켓-통신-내부-구조\" style=\"position:relative;\">소켓 통신 내부 구조<a href=\"#%EC%86%8C%EC%BC%93-%ED%86%B5%EC%8B%A0-%EB%82%B4%EB%B6%80-%EA%B5%AC%EC%A1%B0\" aria-label=\"소켓 통신 내부 구조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>RST 패킷의 원인을 파악하기 위해, 소켓 통신의 내부 구조를 살펴보자.\n먼저, 서버에서 클라이언트의 요청을 수락하는 accept 시스템 호출에 대한 설명을 man 명령어로 확인하면 다음과 같다.<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">man</span> accept</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">accept() extracts the first connection request on the queue\nof pending connections, creates a new socket with the same properties of\nsocket, and allocates a new file descriptor for the socket. If no\npending connections are present on the queue, and the socket is not\nmarked as non-blocking, accept() blocks the caller until a connection is present.</code></pre></div>\n<blockquote>\n<p>accept() 함수는 대기 중인 연결 요청의 큐에서 첫 번째 연결 요청을 추출하여,\n해당 소켓과 동일한 속성을 가진 새로운 소켓을 생성하고 그 소켓에 대한 새로운 파일 디스크립터를 할당한다.\n큐에 대기 중인 연결이 없고 소켓이 non-blocking으로 설정되지 않은 경우, accept()는 연결이 있을 때까지 호출자를 차단한다.</p>\n</blockquote>\n<p>man 에서 설명된 내용을 기반으로 소켓 내부적으로 연결 요청을 위한 대기열를 내부적으로 유지한 다는 것을 알 수 있다.\n소켓 통신 과정 중, 내부에 대기열이 존재한다는 실마리를 통해 관련 자료를 참조하여 내용을 정리할 수 있었다.\n참조한 자료는 맨 아래 더 읽을거리에 정리해두었다.</p>\n<h3 id=\"SYN-큐와-accept-큐\" style=\"position:relative;\">SYN 큐와 accept 큐<a href=\"#SYN-%ED%81%90%EC%99%80-accept-%ED%81%90\" aria-label=\"SYN 큐와 accept 큐 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>리눅스 커널은 3-Way Handshake 과정 중 내부적으로 SYN 큐와 accept 큐를 유지한다.\n아래 프로세스는 3-Way Handshake 과정 중 두 개의 큐가 어떻게 사용되는 지를 설명한다.</p>\n<ol>\n<li>클라이언트는 서버에 연결을 시작하려고 SYN 패킷을 보내고, 이후 <code class=\"language-text\">SYN_SENT</code> 상태로 들어간다.</li>\n<li>서버는 클라이언트의 SYN 요청을 받으면 <code class=\"language-text\">SYN_RECV</code> 상태로 변경된다. 이때, 커널은 이 연결 정보를 SYN 큐에 저장하고 클라이언트에게 SYN+ACK 패킷을 응답한다.</li>\n<li>클라이언트는 서버로부터 받은 SYN + ACK를 받고, ACK를 서버에게 응답하면서 <code class=\"language-text\">ESTABLISHED</code> 상태로 변경된다.</li>\n<li>서버는 클라이언트로부터의 ACK를 받으면, 커널은 연결 정보를 SYN 큐에서 제거하고 accept 큐에 추가한다. 그 후 서버는 <code class=\"language-text\">ESTABLISHED</code> 상태로 들어간다.</li>\n<li>서버 애플리케이션에서 accept 함수를 호출하면, 연결은 accept 큐에서 꺼내진다.</li>\n</ol>\n<p>아래 <strong>그림2</strong>는 위 프로세스를 다이어그램으로 표현한 것 이다.\n<figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5fa15322156f084449a8ed27ed873cf9/045f5/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC4klEQVR42oVUTW/aQBTk/1966rmXqodKvVc59FKpqdoqUiBJE0IgBPAHGH+sP9a7/pjOrjGEJKi2ng328+y8N/N2oPUYafoJRfEFVb1BCzAaRn82aPiwLH8w7yOU+oq6rnZ5r8+B1tfYbN5DiA8E9J8lYv/bAOb5GXzvHe+foWtll2xenBawZXJV1WjMVycOkyPEFqvVDFEckGF9MndgLlXFEtrTgObIs4iVLJESuKkbHEogr6axYX6zZIk4WttE05tTDNM0gLMaQyQ+tNIEYMkG5CiRDPMswWJ+B2cxhi6LkwzrWkMWGYo8I9scSRghEwUXeoLjnMFzv6HSUVdyWYTYPJ3Df/yOXGygdAUppWVgWpHLEmmh6AQFVZbQWvOuLCNTWZYukGVLLqoMYEvkEk1FgFoSoLECRWQgEsF2xLh58HBx62K6ZFsqjVLVmDoKk1UFJyj3bbElmz9pkWA4vcRwNsRoOqSSIVKCGUDD5lB2p66uW4KV+DuXHaAhUXfVWEClCsRUMckj3kOWW0DEwpblBS4myzEenHs8rqa2fzKX7Kck2/ot27S24S9tY5LNqpt4TTb3BJzA2ayswkVOMUSKhIuWMkUU3SDcXpLIetfDis5vzTjVNmxDep8dKd0xMr41wOa9kgKe95sq/6QwqwNg25rkpovD3Fm/Wc+RbUX1zTPDfp14cJMVvNg5mpxB7zGj7luAe2AC2g93rRmvb/Frfo4bd8Q9oPveitJwOoqcvSgz1I3umLbtnlkfYeRiNruC78/puwxpnkJwKEpOmnnfLzyQbKrrTOk7x3rs1KGVpI223G0ES9ddMc9Gbg9ohjoI17i4+4PRbITx8g6JSKhaSBUT3C/vcf14jasZlUyjnYnbfX+PBOyNLbm6sceaESQcPcURk8r6cCsC+JGPuTuBHyxQkmFje4k3Y2AuRr0jH7avd5sij7kfTmh4n2P6H8B+E+jjSN3dM2ObPu8UmAH8B0I4E+p9tuhHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"[그림2] 소켓 통신 과정\"\n        title=\"\"\n        src=\"/static/5fa15322156f084449a8ed27ed873cf9/ca1dc/img_1.png\"\n        srcset=\"/static/5fa15322156f084449a8ed27ed873cf9/e7570/img_1.png 170w,\n/static/5fa15322156f084449a8ed27ed873cf9/f46e7/img_1.png 340w,\n/static/5fa15322156f084449a8ed27ed873cf9/ca1dc/img_1.png 680w,\n/static/5fa15322156f084449a8ed27ed873cf9/045f5/img_1.png 797w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">[그림2] 소켓 통신 과정</figcaption>\n  </figure></p>\n<p>SYN 큐는 1번에서 클라이언트가 보내온 SYN 패킷<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup>을 저장한다.\nSYN + ACK 패킷으로 응답하고, 클라이언트로부터 ACK 응답이 오지 않을 경우 재시도하기 위해 클라이언트 요청을 일시적으로 저장하기 위한 용도이다.</p>\n<p>애플리케이션에서 accept()를 호출하지 않아도 클라이언트로 ACK 까지 받게되면 서버와 클라이언트 모두 <code class=\"language-text\">ESTABLISHED</code> 상태이다.\naccept 큐는 4번에서 클라이언트로부터의 ACK 응답을 일시적으로 저장해두고, accept()가 호출되면 이 대기열에서 제거되고 애플리케이션에 전달된다.</p>\n<p>SYN 큐와 accept 큐의 크기를 결정하는 관련 커널 파리미터는 아래와 같다.<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sysctl</span> net.ipv4.tcp_max_syn_backlog\n<span class=\"token function\">sysctl</span> net.core.somaxconn </code></pre></div>\n<blockquote>\n<p>tcp_max_syn_backlog :\nMaximal number of remembered connection requests, which have not\nreceived an acknowledgment from connecting client.\nThe minimal value is 128 for low memory machines, and it will\nincrease in proportion to the memory of machine.\nIf server suffers from overload, try increasing this number.</p>\n</blockquote>\n<blockquote>\n<p>somaxconn :\nLimit of socket listen() backlog, known in userspace as SOMAXCONN.\nDefaults to 128. See also tcp_max_syn_backlog for additional tuning\nfor TCP sockets.</p>\n</blockquote>\n<h3 id=\"listen\" style=\"position:relative;\">listen()<a href=\"#listen\" aria-label=\"listen permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>listen 함수를 호출할 때, 두 번째 인수로 주어지는 backlog는 대기 중인 연결 요청의 최대 수를 정의한다.\naccept 큐의 크기 결정에 있어서, somaxconn 커널 파라미터와 listen 함수의 backlog 인자 두 가지가 중요한 역할을 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> sockfd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> backlog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>accept 큐의 크기를 결정하는 방식은 공식 문서에 따르면 다음과 같이 설명되어 있다.<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup></p>\n<blockquote>\n<p>Now it specifies the queue length for completely\nestablished sockets waiting to be accepted, instead of the number\nof incomplete connection requests. The maximum length of the\nqueue for incomplete sockets can be set using\n/proc/sys/net/ipv4/tcp_max_syn_backlog. When syncookies are\nenabled there is no logical maximum length and this setting is\nignored. See tcp(7) for more information.\nIf the backlog argument is greater than the value in\n/proc/sys/net/core/somaxconn, then it is silently capped to that\nvalue. Since Linux 5.4, the default in this file is 4096; in\nearlier kernels, the default value is 128. Before Linux 2.4.25,\nthis limit was a hard coded value, SOMAXCONN, with the value 128.</p>\n</blockquote>\n<p>요약하면, backlog 값이 /proc/sys/net/core/somaxconn보다 크면, 자동으로 somaxconn 값으로 제한된다.\n불완전한 연결의 최대 큐 길이는 /proc/sys/net/ipv4/tcp_max_syn_backlog로 설정이 가능하며, Linux 2.2 이전에는 somaxconn 값이 불완전한 연결 요청의 수를 나타내었다고 한다.\n즉, accept 큐의 크기는 <strong>min(somaxconn, backlog)</strong> 값으로 설정된다.</p>\n<h2 id=\"검증-및-테스트\" style=\"position:relative;\">검증 및 테스트<a href=\"#%EA%B2%80%EC%A6%9D-%EB%B0%8F-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"검증 및 테스트 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>리눅스 환경에서 커널 파라미터 설정을 테스트하기 위한 서버-클라이언트 코드를 아래와 같이 작성한다.</p>\n<h4>Server</h4>\n<p>ServerSocket 인스턴스를 생성하여 연결을 대기하는 상태로 유지하되, accept() 메서드를 호출하여 연결을 수락하지는 않는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Server</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">8100</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocket</span> serverSocket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Client</h4>\n<p>RestTemplate을 사용하여 서버에 NUM_THREADS 개수만큼의 요청을 1초 간격으로 전송한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Client</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:8100\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">NUM_THREADS</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">ExecutorService</span> es <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">RestTemplate</span> restTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token constant\">NUM_THREADS</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span>\n\t\t\t\t\t<span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\t<span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">getForObject</span><span class=\"token punctuation\">(</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tes<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>somaxconn=5, 요청 10개인 경우</h4>\n<p>somaxconn 파라미터를 5로 설정하여 서버를 시작하고 10개의 클라이언트 요청을 전송한다. 이후 netstat을 사용하여 소켓의 상태를 확인한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo sysctl -w kern.ipc.somaxconn=5</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ netstat -an | grep 8100\ntcp        6      0 0.0.0.0:8888            0.0.0.0:*               LISTEN\ntcp        0      1 127.0.0.1:57826         127.0.0.1:8888          SYN_SENT\ntcp        0      0 127.0.0.1:57824         127.0.0.1:8888          ESTABLISHED\ntcp        0      1 127.0.0.1:57832         127.0.0.1:8888          SYN_SENT\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57814         ESTABLISHED\ntcp        0      1 127.0.0.1:57828         127.0.0.1:8888          SYN_SENT\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57818         ESTABLISHED\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57824         ESTABLISHED\ntcp        0      0 127.0.0.1:57822         127.0.0.1:8888          ESTABLISHED\ntcp        0      0 127.0.0.1:57820         127.0.0.1:8888          ESTABLISHED\ntcp        0      1 127.0.0.1:57830         127.0.0.1:8888          SYN_SENT\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57820         ESTABLISHED\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57816         ESTABLISHED\ntcp      116      0 127.0.0.1:8888          127.0.0.1:57822         ESTABLISHED\ntcp        0      0 127.0.0.1:57818         127.0.0.1:8888          ESTABLISHED\ntcp        0      0 127.0.0.1:57814         127.0.0.1:8888          ESTABLISHED\ntcp        0      0 127.0.0.1:57816         127.0.0.1:8888          ESTABLISHED</code></pre></div>\n<p>netstat을 통해 확인했을 때, <code class=\"language-text\">ESTABLISHED</code> 상태인 소켓쌍이 총 6개 생성되었고, 나머지 4개의 요청이 <code class=\"language-text\">SYN_SENT</code> 상태로 남아있는 것을 볼 수 있다.\n즉, <code class=\"language-text\">ESTABLISHED</code> 상태인 소켓이 somaxconn의 한계에 도달하면, 그 이후의 요청들은 클라이언트 측에서 <code class=\"language-text\">SYN_SENT</code> 상태로 대기하게 된다.\n<code class=\"language-text\">SYN_SENT</code> 상태인 클라이언트 소켓은 SYN + ACK 응답을 받지 못하여, 일정 시간을 지나면 타임아웃 처리되어 드롭된다.\n이 때, 클라이언트에서 <code class=\"language-text\">Caused by: java.net.ConnectException: Operation timed out</code> 예외를 받을 수 있다.</p>\n<p>somaxconn을 5로 설정했지만 <code class=\"language-text\">ESTABLISHED</code> 상태 소켓이 6쌍인 이유는 accept 큐가 꽉 차 있는지 여부를 검사하는 로직에서 >= 조건 대신 > 조건을 사용하기 때문에 최대 backlog 값보다 1개를 더 받게된다.<sup id=\"fnref-5\"><a href=\"#fn-5\" class=\"footnote-ref\">5</a></sup>\n이는 커널 버전이나 운영체제 별로 다를 수 있으니 참고하길 바란다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> bool <span class=\"token function\">sk_acceptq_is_full</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock</span> <span class=\"token operator\">*</span>sk<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">READ_ONCE</span><span class=\"token punctuation\">(</span>sk<span class=\"token operator\">-></span>sk_ack_backlog<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token function\">READ_ONCE</span><span class=\"token punctuation\">(</span>sk<span class=\"token operator\">-></span>sk_max_ack_backlog<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음으로, 4개의 소켓이 <code class=\"language-text\">SYN_SENT</code> 상태인 것을 확인할 수 있다.\n그런데 특이한 점은 SYN 큐가 가득 차 있지 않아도 해당 소켓들이 <code class=\"language-text\">SYN_RECV</code> 상태가 아닌 <code class=\"language-text\">SYN_SENT</code> 상태에 있다는 점이다.\n이 상황은 클라이언트가 SYN 패킷을 보냈지만 서버에서 SYN + ACK 응답을 받지 못한 상황을 나타낸다.\naccept 큐가 가득 찰 경우 SYN 큐에 요청이 순서대로 저장되어 <code class=\"language-text\">SYN_RECV</code> 상태를 예상했는데, 정확한 원인은 커널 소스에서 확인해볼 수 있었다.\n아래는 커널 소스에 일부분이다.</p>\n<p>listen() 이후 클라이언트 요청이 오면 아래 <code class=\"language-text\">tcp_conn_request</code><sup id=\"fnref-6\"><a href=\"#fn-6\" class=\"footnote-ref\">6</a></sup> 함수가 실행된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">tcp_conn_request</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">request_sock_ops</span> <span class=\"token operator\">*</span>rsk_ops<span class=\"token punctuation\">,</span>\n\t\t     <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">tcp_request_sock_ops</span> <span class=\"token operator\">*</span>af_ops<span class=\"token punctuation\">,</span>\n\t\t     <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sock</span> <span class=\"token operator\">*</span>sk<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">sk_buff</span> <span class=\"token operator\">*</span>skb<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>syncookies <span class=\"token operator\">==</span> <span class=\"token number\">2</span> <span class=\"token operator\">||</span> <span class=\"token function\">inet_csk_reqsk_queue_is_full</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>isn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\twant_cookie <span class=\"token operator\">=</span> <span class=\"token function\">tcp_syn_flood_action</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">,</span> rsk_ops<span class=\"token operator\">-></span>slab_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>want_cookie<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">goto</span> drop<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sk_acceptq_is_full</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">NET_INC_STATS</span><span class=\"token punctuation\">(</span><span class=\"token function\">sock_net</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> LINUX_MIB_LISTENOVERFLOWS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">goto</span> drop<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token comment\">// ... 중략</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 소스에서 첫 번째 if문은 <code class=\"language-text\">inet_csk_reqsk_queue_is_full()</code> 함수를 통해 SYN 큐가 꽉 찼는지 확인한다.\n만약 꽉 찼다면, 바로 드롭 처리가 되는 것을 볼 수 있다.\n다음으로 <code class=\"language-text\">sk_acceptq_is_full()</code> 함수로 accept 큐가 꽉 찼는지 확인하고, 꽉 차 있을 경우에도 드롭 처리한다.\n즉, SYN 큐는 꽉 차 있지 않아도 accept 큐가 꽉 차면 요청이 드롭된다는 것을 알 수 있다.</p>\n<blockquote>\n<p>SYN 큐는 내용이 복잡하고 방대하여 여기서 다루지는 않는다. SYN 큐에 관한 자세한 내용은 아래 첨부된 링크를 통해 참조할 수 있다.<sup id=\"fnref-7\"><a href=\"#fn-7\" class=\"footnote-ref\">7</a></sup><sup id=\"fnref-8\"><a href=\"#fn-8\" class=\"footnote-ref\">8</a></sup></p>\n</blockquote>\n<h2 id=\"Connection-reset-by-peer\" style=\"position:relative;\">Connection reset by peer<a href=\"#Connection-reset-by-peer\" aria-label=\"Connection reset by peer permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>테스트를 통해 somaxconn 크기만큼 accept 큐 크기가 결정되는 것을 확인할 수 있었다.\naccept 큐가 꽉 차더라도 <code class=\"language-text\">Connection reset by peer</code> 예외는 발생하지 않았다.\n대신 큐가 꽉 찬 후로는 들어오는 요청이 <code class=\"language-text\">SYN_SENT</code> 상태에서 멈춰 타임아웃이 발생했다.</p>\n<p>그렇다면 <code class=\"language-text\">Connection reset by peer</code> 예외는 언제 발생하는 것일까?\n결론부터 말하면 SYN 큐에 accept 큐 사이즈를 초과하는 요청이 몰릴 경우, SYN 큐에서 accept 큐로 이동하는 과정에서 accept 큐의 오버플로가 발생하게 되면, 그 추가 요청에 대해서 <code class=\"language-text\">Connection reset by peer</code> 예외가 발생한다.</p>\n<p>위의 테스트 로직에서 클라이언트에서 1초 간격으로 10개의 요청을 보내도록 하였다. 1초는 3-Way-Handshaking을 하는데 충분한 시간으로\n요청 패킷이 SYN 큐 -> accept 큐까지 가는데 충분한 시간이다. 그래서 결국 SYN 큐에는 요청들이 머물지 않고 accept 큐에서만 요청이 머물게 된다.\n요청마다 충분한 텀이 있기 때문에 accept 큐에만 요청이 쌓이다가 그 이상의 요청이 오게 되면 서버에서는 ACK 응답을 주지 않고 클라이언트 측에서는 timeout이 발생한다.</p>\n<p>만약 클라이언트 요청 간의 1초 간격을 없애면 어떻게 될까? SYN 큐의 크기가 10이고, accept 큐 크기가 5라고 가정하자.\n이 상황에서 클라이언트로부터 동시에 7개의 요청이 들어온다고 생각해보자.\n클라이언트는 SYN 패킷 7개를 전송하고, 서버의 SYN 큐에 7개의 요청이 쌓인다.\n서버는 클라이언트에게 SYN + ACK 응답을 보낸다.\n그 후 서버는 클라이언트로 총 7개의 ACK를 받아 <code class=\"language-text\">ESTABLISHED</code> 상태가 되어, 7개의 요청을 accept 큐에 넣을 것이다. 그런데 accept 큐의 크기는 5이다.\n따라서 5개의 요청은 큐에 들어가고, 나머지 2개의 요청은 버려진다. 그렇지만 해당 2개의 요청은 이미 <code class=\"language-text\">ESTABLISHED</code> 상태이기 때문에 클라이언트와의 TCP 연결을 끊기 위해 RST 패킷을 전송한다.\n아래 그림3은 요청이 몰렸을 때, 2개의 RST 패킷이 발생하는 상황을 표현한다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 658px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/29e4866ff56c2985a9d0cd6bca3a1640/e7930/img_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102.35294117647058%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC9UlEQVR42q1Uy27TQBTNZ7BhiQRskBAb2CD+gw1igxAfgIT4BRYgJHZFrBCVSim0FPpK0xLUNO4zj8aJ4zzsPGvnYcd2EtuHO06cJn1IrcRIVzPyjM8959w7E7DtKej6dcTjdyDLN2Hb9ylkDIaLyeEMvrrbUJQbODq6hWrlGvr91/SN7dgI2HYC3e5HFItTaDY/Edg0HEe/ANAdAsowzQ+Q5Hdott7Q+fXhlouAf1TTdNpwcJnh2DYsTUO9LKNRr8Pp9UZ7gYEMhwBbxK43lOUSi5M4w9DW0axEEON+IM8vwbFk+MfGGGpXYGihrYooiAeoSAlYhnLC0GfQaDRQqVRQJwmqqsIwDHQ6HW8esRzOrmNCKe/jgFuGkAzCMUsjt0eAx8fHVOk4crkcstksMpkMFapIlZe9uVarecESW1YXhmVDJ5sisRJevo/g7750liH7URRFD4zneaRSKW+dTqe9dT6f99axWAw7u7vY4/7i61oGtx8v4PPv9MUesrlHlWu32x4rQRCQTCaxtbWFcDiMjY0NzM8vILjyCz/DOTx8sYzZ9ez5gDa1hK5TFZtNz1MmmQVjzhj67Hf39hE/4DAXyuLu0yV8WREmJUuShGg06rHJk49MGgNhwTwtFAoeYLVa9ewxTIuq08N8KIVHz2bxLZiaBGTFWFhcRJhkhTY3we3sYJsS8OQd87ZSLsOgqo/3pmmaA+8LeU/VBKBAMlZnZsBzHA4JLHF4SH0mgiemAs1FJpuxpCiTFVKpRPLTaGkGRKmBtm4OPRwCtsmzXqvFzAQ1ItxaFQZlNkimSpLrlLBK4DmKPPMxnkB0O4zvoQzuPZnD9BJ/qij6yV2euG5UJGo8UIcDLKGiwJYlaGtBdOJ7mNvM4cHzNcwExXOqzH5mYP6NYH6denNc/8ZQcztdA3+4NF69XcV65BRDXb/Ea+NOPmedjkHtpaLdUtBsqB6BUVFY3/X7/Us9DuO3y2J2jOWakMya+iqDtY1Pwk8SwH8e/wAyPOPyOHGj3gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"[그림3]RST 패킷 발생\"\n        title=\"\"\n        src=\"/static/29e4866ff56c2985a9d0cd6bca3a1640/e7930/img_2.png\"\n        srcset=\"/static/29e4866ff56c2985a9d0cd6bca3a1640/e7570/img_2.png 170w,\n/static/29e4866ff56c2985a9d0cd6bca3a1640/f46e7/img_2.png 340w,\n/static/29e4866ff56c2985a9d0cd6bca3a1640/e7930/img_2.png 658w\"\n        sizes=\"(max-width: 658px) 100vw, 658px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">[그림3]RST 패킷 발생</figcaption>\n  </figure></p>\n<h2 id=\"문제-해결-및-마무리\" style=\"position:relative;\">문제 해결 및 마무리<a href=\"#%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%EB%B0%8F-%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"문제 해결 및 마무리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>지금까지 내용을 정리해보면 <code class=\"language-text\">Connection reset by peer</code> 예외는 클라이언트가 RST 패킷을 수신할 때 발생한다.\n이 RST 패킷은 서버의 accept 큐에 너무 많은 요청이 동시에 도착하여 오버플로우가 발생할 때, 서버가 클라이언트에게 전송하여 소켓 연결을 종료한다.</p>\n<p>이 문제를 해결하기 위해선 listen() 함수의 backlog 값을 조절하거나, 커널 파라미터를 수정할 필요가 있다.\n앞서 살펴본 바와 같이 <strong>min(somaxconn, backlog)</strong> 공식에 따라, somaxconn 값이 backlog보다 작으면 그 값이 적용된다. 따라서 somaxconn 값이 너무 작으면 조정이 필요하다.</p>\n<p>그렇다면 적절한 accept 큐의 크기는 얼마일까? 이는 서버의 환경과 상황에 따라 다르다. 무조건적으로 accept 큐의 크기를 늘린다고 해서 처리량이 그만큼 비례해서 늘어나는 것은 아니다.\n대신, 리눅스에서는 이를 참고할 수 있는 통계를 제공한다.</p>\n<ul>\n<li>TcpExtListenOverflows :  SYN 큐에서 발생하는 오버플로를 추적한다.</li>\n<li>TcpExtListenDrops : accept 큐에서 발생하는 드롭을 추적한다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ sudo apt-get install iproute2\n\n$ nstat -az TcpExtListenDrops\nTcpExtListenDrops 12946172 0.0\n\n$ nstat -az TcpExtListenOverflows\nTcpExtListenOverflows 11447 0.0</code></pre></div>\n<p>또는 netstat의 Recv-Q 로 SYN 큐에 쌓인 요청 수를 알 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-an</span>\nActive Internet connections <span class=\"token punctuation\">(</span>servers and established<span class=\"token punctuation\">)</span>\nProto Recv-Q Send-Q Local Address           Foreign Address         State\ntcp       <span class=\"token number\">20</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:8888            <span class=\"token number\">0.0</span>.0.0:*               LISTEN</code></pre></div>\n<p>이러한 통계를 활용하면 서버의 상황에 맞게 최적의 값을 결정할 수 있다.</p>\n<h2 id=\"더-읽을거리\" style=\"position:relative;\">더 읽을거리<a href=\"#%EB%8D%94-%EC%9D%BD%EC%9D%84%EA%B1%B0%EB%A6%AC\" aria-label=\"더 읽을거리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://blog.cloudflare.com/syn-packet-handling-in-the-wild/\">https://blog.cloudflare.com/syn-packet-handling-in-the-wild/</a></li>\n<li><a href=\"https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203\">https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203</a></li>\n<li><a href=\"https://brunch.co.kr/@alden/6\">https://brunch.co.kr/@alden/6</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p><a href=\"https://man7.org/linux/man-pages/man2/accept.2.html\">https://man7.org/linux/man-pages/man2/accept.2.html</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-2\">\n<p>구체적으로 <a href=\"https://elixir.free-electrons.com/linux/v4.14.12/source/include/net/inet_sock.h#L73\">inet_reqeust_sock</a> 을 저장한다.    </p>\n<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-3\">\n<p><a href=\"https://elixir.bootlin.com/linux/v4.15.18/source/Documentation/networking/ip-sysctl.txt#L372\">https://elixir.bootlin.com/linux/v4.15.18/source/Documentation/networking/ip-sysctl.txt#L372</a>    </p>\n<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-4\">\n<p><a href=\"https://man7.org/linux/man-pages/man2/listen.2.html\">https://man7.org/linux/man-pages/man2/listen.2.html</a>    </p>\n<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-5\">\n<p><a href=\"https://elixir.bootlin.com/linux/latest/source/include/net/sock.h#L1033\">https://elixir.bootlin.com/linux/latest/source/include/net/sock.h#L1033</a></p>\n<a href=\"#fnref-5\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-6\">\n<p><a href=\"https://elixir.bootlin.com/linux/latest/source/net/ipv4/tcp_input.c#L6942\">https://elixir.bootlin.com/linux/latest/source/net/ipv4/tcp_input.c#L6942</a></p>\n<a href=\"#fnref-6\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-7\">\n<p><a href=\"https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203\">https://www.alibabacloud.com/blog/tcp-syn-queue-and-accept-queue-overflow-explained_599203</a></p>\n<a href=\"#fnref-7\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-8\">\n<p><a href=\"https://brunch.co.kr/@alden/6\">https://brunch.co.kr/@alden/6</a></p>\n<a href=\"#fnref-8\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"slug":"/socket_internal/"},"frontmatter":{"title":"요청이 급증하는 상황의 Connection reset by peer 트러블 슈팅","date":"October 30, 2023"}},{"id":"0bbc831b-b7eb-5629-8c7d-30c1dd056af5","html":"<h2 id=\"Selector\" style=\"position:relative;\">Selector<a href=\"#Selector\" aria-label=\"Selector permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Buffer 편에서도 보았듯이, java.nio 는 기존 Java I/O의 한계를 극복하기 위해서 탄생되었다.\nC/C++의 경우에는 이미 POSIX 계열 OS의 select()나 poll() 같은 시스템 호출로 멀티플렉싱을 구현하였지만 기존 Java I/O는 이를 사용할 수 없었다.</p>\n<p>Selector는 멀티플렉싱 I/O를 가능하게 한다. 멀티플렉싱 I/O는 단일 스레드 또는 프로세스가 여러 I/O 작업을 모니터링하고, 준비된 작업에만 대한 처리를 수행하는 방식을 의미한다.</p>\n<p>Selector는 여러 SelectableChannel 객체를 등록하고, 등록된 채널들 중 어떤 채널이 준비된 상태인지 확인하는 역할을 한다.\nselect() 메서드를 호출하면 Selector는 등록된 채널들을 확인하고, 준비된 채널들의 SelectionKey를 반환한다.</p>\n<p>SelectionKey는 SelectableChannel과 Selector 간의 연결을 나타내는 키이다.\nSelectionKey는 각 채널의 관심 작업(읽기, 쓰기 등)을 기억하며, 해당 채널이 현재 어떤 작업을 수행할 준비가 되었는지 모니터링한다.</p>\n<p>SelectableChannel은 I/O 채널을 나타내는 추상 클래스이다. SocketChannel, ServerSocketChannel 등이 이를 구현한다.\nSelectableChannel은 Selector와 함께 사용되어 특정 작업(읽기,쓰기 등)을 수행할 수 있는지 확인합니다.</p>\n<p>멀티플렉싱 구현의 핵심은 준비된 상태의 채널을 쉽게 확인할 수 있다는 것에 있다. 이를 준비성 선택(readiness selection)이라고 한다.</p>\n<p>준비성 선택은 언뜻보면 non-blocking 모드와 폴링으로 구현이 가능할 것 같지만 작업의 준비 여부를 확인하는 코드와 데이터를 처리하는 코드를 분리하기 어려울 수 있다.\n또한, non-blocking 모드로 각 채널에 대해 직접 준비 여부를 물어보는 것은 많은 시스템 호출로 비용이 많이 드는 작업이다.</p>\n<p>nio 이전에는 준비성 선택을 흉내내기 위해 각 소켓에 대한 각각의 스레드를 만들고 read() 메서드에서 데이터를 기다리도록 하는 방법이 사용되었다.\n이렇게 하면 각 스레드가 소켓 모니터 역할을 수행하고 JVM의 스레드 스케줄러가 알림 메커니즘 역할을 수행한다.</p>\n<p>Java NIO에서는 준비성 선택을 운영 체제에 위임하고, Selector 클래스를 통해 이용할 수 있다.\nSelector는 여러 채널의 상태를 모니터링하고, 해당 채널이 준비 상태인 경우 알려줌으로써 효율적인 I/O 처리를 가능하게 한다.\n이를 통해 다수의 클라이언트와 연결을 관리하고 데이터를 처리할 수 있다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 606px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2168fc5feabb8bd7c1cb526019e46b74/cec09/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.235294117647065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABbUlEQVR42nWSbcuCYAyF+/9/qrDIoC99ycyyqDRIK8RKe19cg0nm8wjDm7PtbGdb6/V6CV8URXK5XPRt2Pl8ltPpVMPKshTP8/T9fr8b1sJxv99lNBrJbrerAvnm87naN7bf78VxnKq44fYpIc4gCGqE2GKxkPV6Lc/ns0pIkkTG47FkWSaPx0M7vl6vasS1TNpsNmt0iLTpdKpyDUvTVFzX1U4hYSQ0BAcFlBAHiYfDoSF5uVzWMGLo8F/Jt9tNmSE8Ho/6NttsNmpIMYwYxsOb3O+FKCGVkAHharXSynEca9ckgiOHKyiKQmfq+75st1vNg7TWIRXZcL/fl8FgoIsIw1DJu92u4pBizJSYXq+nvuFw2CS0DTEXKtKhYciFmE1inBcxxEJEbGOGeZ7rxpDClhk6Sfwnk0k1WzDiiKEIfk7o+6SUkABmhVQ7ZIwzarfb0ul09G0447BYijUk21Ko/mscL/aXz1T8Sv4ABrmOHmaMKX8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"selection 연관 클래스들 관계\"\n        title=\"\"\n        src=\"/static/2168fc5feabb8bd7c1cb526019e46b74/cec09/img.png\"\n        srcset=\"/static/2168fc5feabb8bd7c1cb526019e46b74/e7570/img.png 170w,\n/static/2168fc5feabb8bd7c1cb526019e46b74/f46e7/img.png 340w,\n/static/2168fc5feabb8bd7c1cb526019e46b74/cec09/img.png 606w\"\n        sizes=\"(max-width: 606px) 100vw, 606px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">selection 연관 클래스들 관계</figcaption>\n  </figure></p>\n<p>위 그림은 아래 코드로 표현할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Selector</span> selector <span class=\"token operator\">=</span> <span class=\"token class-name\">Selector</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nchannel1<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nchannel2<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_WRITE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nchannel3<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_WRITE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 채널이 준비될 때까지 최대 10초간 블록킹된다.</span>\nreadyCount <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이 코드는 Selector를 생성한 다음, 각각 다른 관심사 집합을 가지는 기존의 세 개의 소켓 채널을 Selector에 등록한다.\nselector.select(10000) 는 등록된 채널에서 관심 이벤트가 발생할 때까지 최대 10초간 블록킹된다.</p>\n<p>아래는 Selector의 주요 API 목록이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Selector</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Closeable</span> <span class=\"token punctuation\">{</span>\n\n\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Selector</span> <span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">SelectorProvider</span><span class=\"token punctuation\">.</span><span class=\"token function\">provider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">openSelector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isOpen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">SelectorProvider</span> <span class=\"token function\">provider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">int</span> <span class=\"token function\">selectNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">int</span> <span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> timeout<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\t\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">int</span> <span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">Selector</span> <span class=\"token function\">wakeup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">void</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"SelectableChannel\" style=\"position:relative;\">SelectableChannel<a href=\"#SelectableChannel\" aria-label=\"SelectableChannel permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SelectableChannel</span>\n    <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractInterruptibleChannel</span>\n    <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Channel</span>\n<span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">SelectorProvider</span> <span class=\"token function\">provider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">int</span> <span class=\"token function\">validOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isRegistered</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">SelectionKey</span> <span class=\"token function\">keyFor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Selector</span> sel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">SelectionKey</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Selector</span> sel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> ops<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ClosedChannelException</span><span class=\"token punctuation\">;</span>\n\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">SelectionKey</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Selector</span> sel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> ops<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> att<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ClosedChannelException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Selector의 채널 등록은 SelectableChannel 의 register()로 할 수 있다.\nregister는 Selector 객체와 ops라는 정수 매개변수를 인자로 받는다.</p>\n<p>ops 매개변수는 채널이 등록되는 관심 작업 집합을 나타낸다.\n이 값은 채널의 준비 상태를 확인할 때 Selector가 확힌해야 하는 I/O 작업을 비트 마스크로 표현한 것이다.\n구체적인 작업 비트는 SelectionKey 클래스의 public static 필드로 정의되어 있다.</p>\n<p>JDK 1.4부터는 읽기(OP_READ), 쓰기(OP_WRITE), 연결(OP_CONNECT), 수락(OP_ACCEPT) 작업이 정의되어 있다.\n각 채널마다 지원되는 작업이 있다. SocketChannel의 경우 accept 작업을 수행할 수 없다.\n지원되지 않는 작업에 채널을 Selector에 등록하려고 하면 Exception이 발생한다. validOps() 메서드를 사용하면 해당 채널이 허용하는 작업 집합(비트 마스크)을 얻을 수 있다.</p>\n<p>두번째 register() 메서드에는 att 라는 Objcet를 받는 것을 확인할 수 있다. 해당 객체 참조를 SelectionKey이 전달하고 attch()로 해당 참조를 다시 얻을 수 있다.</p>\n<p>하나의 채널 객체는 여러 Selector에 등록될 수 있다. 채널이 현재 어떤 선택기에 등록되어 있는지 확인하려면 isRegistered() 메서드를 호출하면 된다.\n이 메서드는 채널이 적어도 하나의 선택기에 등록되어 있는지 여부에 대한 정보를 제공하지만, 채널이 어떤 선택기에 등록되어 있는지에 대한 정보는 제공하지 않는다.</p>\n<p>각 채널의 Selector와 채널 등록은 SelectionKey 으로 캡슐화된다. keyFor() 메서드는 특정 채널과 주어진 Selector에 연결된 SelectionKey를 반환한다.</p>\n<h2 id=\"SelectionKey\" style=\"position:relative;\">SelectionKey<a href=\"#SelectionKey\" aria-label=\"SelectionKey permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>SelectionKey는 특정 채널을 특정 Selector와 등록 관계를 나타내며, 해당 채널을 모니터링하고 제어할 수 있다.\n아래는 SelectionKey의 주요 API와 설명이다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SelectionKey</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">OP_WRITE</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">OP_CONNECT</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">OP_ACCEPT</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">SelectableChannel</span> <span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">Selector</span> <span class=\"token function\">selector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">void</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isValid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">int</span> <span class=\"token function\">interestOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">void</span> <span class=\"token function\">interestOps</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> ops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">int</span> <span class=\"token function\">readyOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isReadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isWritable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isConnectable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isAcceptable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> ob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>channel()</h4>\n<p>SelectionKey와 관련된 SelectableChannel 객체를 반환한다.</p>\n<h4>selector()</h4>\n<p>SelectionKey와 관련된 Selector 객체를 반환한다.</p>\n<h4>cancel()</h4>\n<p>Selector와 Channel 관계를 해지할 때 사용된다. 해당 선택 키가 무효화되고 연결이 해제된다.\n다만, SelectionKey이 취소된다고 해도 Selector에 채널은 등록된 상태로 남아있다. 채널은 Selector의 다음 select() 메서드 호출 또는 진행 중인 select() 메서드 완료 시점에 해지된다.\n채널이 취소된 SelectionKey와 함께 Selector 등록된 상태에서 해당 SelectionKey를 사용하려고 시도하면 CancelledKeyException이 발생한다.</p>\n<h4>isValid()</h4>\n<p>키가 아직 유효한 등록을 나타내는지 확인한다. 채널이 닫히면 해당 채널과 관련된 모든 SelectionKey이가 자동으로 무효화 된다.</p>\n<h4>interestOps()</h4>\n<p>현재 SelectionKey의 관심 작업 집합을 반환한다. 이 값은 SelectableChannel.register 로 등록할 때 전달된 값이다.\n인수있는 interestOps()를 호출하면 새로운 관심 작업 집합을 설정할 수 있다.</p>\n<h4>readyOps()</h4>\n<p>현재 선택 키와 관련된 채널에서 실제로 수행 가능한 I/O 작업의 집합을 반환한다.\n이 집합은 최근 select() 메서드 호출로 결정된 것으로, 관심 작업 집합 중에서 실제로 수행 가능한 작업을 나타낸다.   </p>\n<p>중요한 점은 readyOps()의 반환값은 절대적인 보장을 의미하는 것은 아니다.\nreadyOps은 Selector가 마지막으로 등록된 채널들의 상태를 확인한 시점에서의 정보를 담고 있기 때문이다.\n따라서, 멀티스레딩 환경에서는 주의가 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> readyOps <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">readyOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>readyOps <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read <span class=\"token punctuation\">(</span>myBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>isReadable()</h4>\n<p>isReadable(), isWritable(), isConnectable(), isAcceptable() 각 메서드는 채널이 각 작업에 대해 준비 상태인지를 검사하는 역할을 한다.\n예를 들어 <code class=\"language-text\">key.isWritable()</code> 는 <code class=\"language-text\">(key.readyOps() &amp; SelectionKey.OP_WRITE) != 0</code> 와 동일하다.</p>\n<h4>attach()</h4>\n<p>이 메서드는 SelectionKey에 첨부 객체를 설정할 수 있다. 일반적으로 핸들러 객체, 비즈니스 객체, 다른 채널 등과 관련짓는 데 사용할 수 있다.\nSelectableChannel.register의 att 매개변수와 동일하게 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">,</span> myObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위의 코드는 아래 코드와 동일하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nkey<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>myObject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>attachment()</h4>\n<p>이 메서드를 호출하면 SelectionKey에 첨부된 객체 핸들을 가져올 수 있다.\n만약 첨부된 객체가 설정되지 않았거나 명시적으로 null이 지정되었다면 이 메서드는 null을 반환한다.</p>\n<h2 id=\"Selector-동작원리\" style=\"position:relative;\">Selector 동작원리<a href=\"#Selector-%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC\" aria-label=\"Selector 동작원리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Selector는 등록된 채널들의 집합을 관리하며, 각 등록은 SelectionKey 객체로 캡슐화된다.\nSelector 객체는 세 가지 종류의 키 집합을 유지한다.</p>\n<ul>\n<li><strong>Registered key set</strong>은 Selector에 등록된 모든 키 집합을 나타낸다. keys() 메서드로 가져올 수 있다.   </li>\n<li><strong>Selected key set</strong>은 등록된 키의 관심 작업 집합 중 적어도 하나의 작업에 대해 준비가 된 키 집합을 의미한다.\nselectedKeys() 메서드로 가져올 수 있다.</li>\n<li><strong>Cancelled key set</strong>은 cancel()로 무효환된 키들의 집합이다. 비공개로 유지되어 직접 접근할 수 없다.</li>\n</ul>\n<p>Selector에서 select() 메서드를 호출하면 다음 세 단계가 수행된다.</p>\n<h4>취소된 키 확인</h4>\n<p>취소된 키 집합을 확인한다. 취소된 키가 있다면 이들은 다른 두 키 집합(Registered key set, elected key set)에서 제거되고, 관련된 채널은 등록 해제된다.\n이 부분은 SelectionKey의 cancel() 메서드에서 이미 설명했다.</p>\n<h4>작업 관심 집합 확인</h4>\n<p>등록된 키 집합의 각 키의 작업 관심 집합을 조사한다.\n이 시점 이후에 작업 관심 집합에 대한 변경 사항은 고려되지 않는다.</p>\n<h4>채널 준비 상태 확인</h4>\n<p>OS에게 현재 채널의 작업 관심 상태를 확인하도록 요청한다.\n이때 스레드는 현재 채널이 준비되지 않았다면 일정 시간 동안 blocking될 수 있다.\n시스템 호출이 완료되면 채널의 준비 상태가 결정된다.</p>\n<p>그 후, OS로부터 각 채널의 키에 대한 <strong>준비된 집합(ready sets)</strong>을 얻게 되는데, 각각의 키가 Selected key set에 포함되지 않으면 해당 키를 Selected key set 에 추가한다.</p>\n<p>만약, 채널의 키가 Selected key set에 이미 포함되어 있다면, 현재 채널이 어떤 작업에(OP_XXXX) 준비되어 있는지를 나타내는 비트를 업데이트한다.</p>\n<h4>취소된 키 재확인</h4>\n<p><strong>채널 준비 상태 확인</strong>에서 스레드가 블록킹되어 시간이 많이 흐를 수 있다. 그 동안 SelectionKey가 취소될 수 있기 때문에 취소된 키를 재확인한다.</p>\n<h4>결과값 리턴</h4>\n<p>select() 메서드로 반환되는 값은 <strong>채널 준비 상태 확인</strong>에서 준비된 집합(ready sets)이 수정된 키의 수를 나타낸다.\nSelection key set 내의 모든 채널의 총 수가 아닌, select 메서드 호출 간에 준비된 채널의 수를 나타낸다.</p>\n<p>예를 들어, 첫 번째 select() 호출에서 2개의 채널이 작업 준비 상태로 판단되면 반환값은 2개 된다.\n두 번째 호출에서 1개의 추가 채널이 작업 준비 상태로 추가되면 반환값 1이 된다.\n세 번째 호출에서 아무 채널도 변경사항이 없으면 반환값은 0이 된다.</p>\n<p>Selector 클래스에는 세 가지 형태의 select() 메서드가 있다. 각각에 대해 알아보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>인수없는 select() 는 준비된 채널이 생길 때 까지 블로킹된다. 따라서 반환값은 항상 0 보다 큰 값을 가진다.\n만약, 다른 스레드에서 wakeup() 메서드를 호출하면 0이 반환될 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token number\">100000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>다음은 long timeout 매개변수를 받는 select 이다. 준비된 채널을 확인하기 위해  최대 해당 시간만큼 대기할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>non-blocking 모드의 select 메서드이다. 준비된 채널이 없으면 0을 반환한다.</p>\n<h2 id=\"Selection-작업-중지하기\" style=\"position:relative;\">Selection 작업 중지하기<a href=\"#Selection-%EC%9E%91%EC%97%85-%EC%A4%91%EC%A7%80%ED%95%98%EA%B8%B0\" aria-label=\"Selection 작업 중지하기 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h4>wakeup()</h4>\n<p>Selector 객체에 대해 wakeup() 메서드를 호출하면 해당 Selector에서 select() 작업이 진행 중이라면 0을 반환시킨다.\n현재 select() 작업 중이 아니라면, 다음 select() 메서드를 호출할 때 selectNow()로 동작되어 즉시 반환된다. 그 후의 select 호출은 정상적으로 동작된다.</p>\n<h4>close()</h4>\n<p>Selector를 닫으면 현재 선택 작업 중인 스레드를 즉시 깨우고 해당 Selector와 관련된 리소스를 정리한다.</p>\n<h4>interrupt()</h4>\n<p>블로킹된 스레드의 interrupt() 메서드가 호출되면 해당 스레드의 \"인터럽트 상태\"가 설정된다.\n스레드의 인터럽트 상태가 설정된 후에 해당 스레드가 채널에서 I/O 작업을 시도하면 해당 채널이 즉시 닫히고 스레드는 ClosedByInterruptException 과 같은 예외가 발생한다.\n이런 경우에는 Thread.interrupted() 로 인터럽트 상태를 지울 수 있다.</p>\n<h2 id=\"Selector-키-관리\" style=\"position:relative;\">Selector 키 관리<a href=\"#Selector-%ED%82%A4-%EA%B4%80%EB%A6%AC\" aria-label=\"Selector 키 관리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Selector로 간단한 서버를 만들어보자. 클라이언트 요청을 accept 하고 클라이언트로부터 데이터를 읽을 수 있는 간단한 서버이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Example</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token class-name\">ServerSocketChannel</span> serverChannel <span class=\"token operator\">=</span> <span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">ServerSocket</span> server <span class=\"token operator\">=</span> serverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token class-name\">Selector</span> selector <span class=\"token operator\">=</span> <span class=\"token class-name\">Selector</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\tserver<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8080</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\tserverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tserverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_ACCEPT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\t\t<span class=\"token class-name\">Iterator</span> it <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">)</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isAcceptable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"클라이언트가 연결 요청하였습니다\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t\t<span class=\"token function\">registerChannel</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t\t\n\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isReadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"클라이언트가 데이터를 보내왔습니다\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">registerChannel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Selector</span> selector<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SelectionKey</span> key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">ServerSocketChannel</span> serverSocket <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">channel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">SocketChannel</span> socket <span class=\"token operator\">=</span> serverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>socket <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tsocket<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsocket<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>selector.select() 로 등록한 채널의 작업을 모니터링하고 아래 while 문 안에서 <code class=\"language-text\">key.isAcceptable()</code> 와 <code class=\"language-text\">key.isReadable()</code> 메서드를 통해,\naccept 작업과 read 작업 각각에 대해 처리를 하는 코드를 확인할 수 있다. </p>\n<p>하지만, 이 코드는 심각한 문제를 가지고 있는데 서버를 띄우고 클라이언트에서 접속을 하고 데이터를 보내면 다음과 같은 내용을 출력한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">클라이언트가 연결 요청하였습니다\n클라이언트가 연결 요청하였습니다\n클라이언트가 데이터를 보내왔습니다</code></pre></div>\n<p>클라이언트 1대만 접속했지만 <code class=\"language-text\">클라이언트가 연결 요청하였습니다</code> 메시지가 두 번 출력된다.\n이는 <strong>Selector 동작원리</strong> 섹션에 <strong>채널 준비 상태 확인</strong> 에서 설명을 보면 알 사 있다.,\nselect() 메서드는 준비된 작업 집합을 Selected key set에 추가하고, 이미 존재하는 키면 준비 완료된 작업의 비트를 업데이트할 뿐 이다.\n이는 별도로 SelectionKey를 제거하는 것 처럼 관리하지 않는다면 select() 연산의 결과는 계속 누적된다는 의미이다.\n이를 그림으로 표현하면 아래와 같다.\n<figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/595a25bfb9489232c3e91cbbe6c8cb67/35f7f/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABaUlEQVR42qWQ627iMBCF8/4PtX+6lbZLgYWmjbhD7k5iEgLkQi7fTtJKfYBaOvL4+Nia+YwgDFFRhOd5OI5D0zT8ZBnbY8BkbvIyXeIEZ3T+wPYTTGvLbGER6Rv63pE5IZf1gXxpkaoUfWvZnXzJ7Xh5XbA9BRR1j+FGV2ZvG8zVkSgt8ZISV12Ym1vm4ofJHVc8FWREH3tic4OKb2Pu6Gl5u2a6WHFwNemtwWh76PpeBENdNR0PKWrRo+1GDd5wrrpPjbV4TdeP2e+9w9Bao9OzjJYQxxFd2/6Mob138N8s7MU7tqs4X2sZMxM+HuudTZLdyYqWPNTkdsB1c+Si89Fz/XjkaAlb24spH9Jh6Gcksw+SuYU6l9hxyc7RPE+WPP35JzyvnMQLThFq+o76u8QPLpIrWO0Dfsv519OE1WFoRhje5ddC5i+EVVG3FFVDPTD7UjXcVy2l3Jdjrh87GbyR9RfLuvms/wM1yGAR6S/VkgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SelectionKey 상태\"\n        title=\"\"\n        src=\"/static/595a25bfb9489232c3e91cbbe6c8cb67/ca1dc/img_1.png\"\n        srcset=\"/static/595a25bfb9489232c3e91cbbe6c8cb67/e7570/img_1.png 170w,\n/static/595a25bfb9489232c3e91cbbe6c8cb67/f46e7/img_1.png 340w,\n/static/595a25bfb9489232c3e91cbbe6c8cb67/ca1dc/img_1.png 680w,\n/static/595a25bfb9489232c3e91cbbe6c8cb67/35f7f/img_1.png 818w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">SelectionKey 상태</figcaption>\n  </figure></p>\n<p>Loop1 에서 클라이언트 요청이 허용 되면 SelectionKey의 OP_ACCEPT 비트를 켠다.\nLoop2 에서 클라이언트로부터 데이터를 읽을 수 있는 상태가 되면 OP_READ 비트를 켠다.\nOP_READ 비트를 켠다고 OP_ACCEPT 비트가 꺼지는 것은 아니다. 이 정보는 키 집합에서 해당 키가\n제거될 때까지 키에 유지된다.</p>\n<p>이는 등록된 채널의 현재 상태가 제대로 표시되지 않을 수 있으므로 번거러워 보일 수 있지만,\n이는 의도된 설계로 프로그래머에게 많은 유연성을 제공하지만 키를 올바르게 관리하여 키의 상태 정보가 오래되지 않도록 보장하는 책임을 부여한다.</p>\n<p>만약 프로그램이 원래 의도대로 동작하게 하기 위해서는 준비 완료된 키를 처리하고 <strong>Selected key set</strong> 에서 <code class=\"language-text\">it.remove()</code> 로 해당 키를 제거해줘야 한다.\n해당 내용을 반영한 일반적인 Selector를 이용한 채널 관리는 모습은 아래 흐름을 가진다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Iterator</span> it <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SelectionKey</span> key<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">)</span>it<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isAcceptable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">registerChannel</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">somethingCall</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">isReadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">registerChannel</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">somethingCall</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    it<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>Selector, SelectableChannel, SelectionKey는 Java NIO의 핵심 요소로, 고성능을 위한 Native I/O 작업을 처리하는 데 사용된다.</li>\n<li>SelectableChannel은 I/O 채널을 나타내는 추상 클래스로, SocketChannel, ServerSocketChannel 등이 이를 구현한다. Selector와 함께 사용하여 채널의 작업 상태를 모니터링하고 관리한다.</li>\n<li>SelectionKey: SelectableChannel과 Selector 간의 연결을 나타내며, 채널의 관심 작업과 현재 작업 준비 상태를 관리한다.</li>\n<li>Selector 동작 원리: Selector의 select() 메서드를 호출하면 채널 상태 확인, 작업 관심 집합 확인, 채널 준비 상태 확인 등의 단계를 수행한다</li>\n<li>채널 등록 및 관리: select()는 결과를 SelectionKey에 누적시킨다. 이는 키 관리에 책임이 프로그래머에 있다.</li>\n</ul>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>Java NIO (Ron Hitchens)</li>\n</ul>","fields":{"slug":"/java-nio-selector/"},"frontmatter":{"title":"Java NIO - Selector","date":"October 19, 2023"}},{"id":"cf146ad2-1f45-5a60-a4d6-e2b637ff2e18","html":"<h2 id=\"Channel\" style=\"position:relative;\">Channel<a href=\"#Channel\" aria-label=\"Channel permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Channel은 파일이나 소켓과 같은 엔티티 간에 데이터를 효율적으로 전송하는 통로이다.\n채널은 일반적으로 운영체제의 파일 디스크립터나 핸들러와 일대일 관계를 가진다.\n채널은 Java의 플랫폼 독립성을 유지하면서도 운영 체제의 네이티브 I/O 기능에 대한 추상화를 제공한다.</p>\n<p>아래 그림은 Channel 클래스의 상속관계를 나타낸다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/84b1c560243e23d2fe3d8bc7ce7e2bff/1e052/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 131.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAADBElEQVR42oXVh27tOAwE0Pv/v5Qgvffee++9Nz4cAjTWi7xdA4p9JXI0M6SUTvzl+fn5yfHy8hJ7e3txdnYW7+/v8X9P578APcfHx9HX1xczMzPx8PDQWvsV8Pv7O97e3lrj9fU17u7u4vn5OTY3N2NkZCRGR0fj+vo6Pj4+4vPz86+gHTIEeL6+vjJpaWkpVlZWUurR0VHMz8/HxsZGbG1txe7ubszOzsbBwcGvjBMQUD1ra2vR1dUVPT09+b24uBjd3d3Nb5sNDQ3lPF9/BSyG3sDJxeDy8jKTFMb78fExx8nJSVxdXaWam5ubVrE6gs/Pz+Pw8DB9sjMg8qamppKRxPX19RgeHs63dWynp6czhyXyE1ABFhYWUlJvb28GSQK8vb2dXvLMmmSxNgFSBKjhbSPZwBIQADIuLi5iYmIi505PT3MeawOb+/v7tGF/fz8VtNpGskXe+Aag/0gz59smfOOhby2FyNPTU9ze3jZ16KiQBO2hTTTw8vJybgAY8xrAvVdXV9MOG5T/vhtAyZOTkzlIqKrZvVjzkc/j4+MZbw5Lj34E3ALkF5OBMhxbzLGUrOL9/f0J6HfJr43NNYCSxsbG8sySA8hQvWJoQ2u+Dd1RD6YNoKLYDSNDVVWyiqQA5GgnLKlwvlUWEbm1aasoOzs7aTRACc4uPxVLsGKR7KJw9MRXN3jriAZQlXhHNv+wcgQVB2uA1oHpADE2taYgerJh6A8m/HMJYGjRjoYTQD7JgDCuFkKEf/qwLopkaNFJkFBjbm4uWQAgSXXF+A2ogMtDqlpFQbtOBcaY8hEImSpuDZg35uKwI9vF3PJQMp+YX3LNuwh4hzHQYui3ItVVZr7xUH+5TSRXs7rWMAE2MDCQjEh3u7iA3Tplhze2DSB2g4OD2byOmMW6JDCofwVs0aO6wX2oECVVPLUJqKeqxxREPwLjz7+veLH6EAE+k6vSCtQA2hWgw48d2XavG0ThCpT0igWOtQqLbwBJcqxIBo4d4GqF+qdfseLI/mcbsYaHfwBJp4Fs8VqY8AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Channel 상속 관계\"\n        title=\"\"\n        src=\"/static/84b1c560243e23d2fe3d8bc7ce7e2bff/ca1dc/img.png\"\n        srcset=\"/static/84b1c560243e23d2fe3d8bc7ce7e2bff/e7570/img.png 170w,\n/static/84b1c560243e23d2fe3d8bc7ce7e2bff/f46e7/img.png 340w,\n/static/84b1c560243e23d2fe3d8bc7ce7e2bff/ca1dc/img.png 680w,\n/static/84b1c560243e23d2fe3d8bc7ce7e2bff/1e052/img.png 872w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Channel 상속 관계</figcaption>\n  </figure></p>\n<p>계층구조 상단에 WritableByteChannel과 ReadableByteChannel 인터페이스를 보게 되면 채널은 바이트 버퍼에 대해서만\n작동한다는 것을 짐작할 수 있다. 이는 운영체제의 저수준 I/O가 바이트 단위로 수행하기 때문이다.</p>\n<p>InterruptibleChannel 인터페이스는 채널이 안전하게 중단되고 닫힐 수 있도록 하는 메커니즘을 제공한다.\n스레드가 interruptible 채널에서 I/O 작업에 차단되어 있을 때, 해당 스레드의 interrupt 메서드를 호출하면 채널이 닫히고, 스레드의 중단 상태가 설정되며, 채널에서 ClosedByInterruptException이 발생한다.</p>\n<p>아래는 Channcel 인터페이스의 전체 소스이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Channel</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isOpen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"Channel-Open\" style=\"position:relative;\">Channel Open<a href=\"#Channel-Open\" aria-label=\"Channel Open permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>I/O는 크게 파일 I/O와 스트림(또는 소켓) I/O로 구분된다.\n<strong>Channel 상속 관계</strong> 이미지에서 확인할 수 있듯이 하나의 FileChannel과 세 개의 소켓 채널(SocketChannel, ServerSocketChannel, DatagramChannel)이 있음을 알 수 있다.</p>\n<p>FileChannel은 RandomAccessFile, FileInputStream, FileOutputStream 와 같은 객체에서 getChannel 메서드를 호출해야만 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 파일 채널 생성</span>\n<span class=\"token class-name\">RandomAccessFile</span> raf <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RandomAccessFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"somefile\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"r\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">FileChannel</span> fc <span class=\"token operator\">=</span> raf<span class=\"token punctuation\">.</span><span class=\"token function\">getChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>나머지 소켓 채널들은 팩토리 메서드를 통해 생성할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SocketChannel</span> sc <span class=\"token operator\">=</span> <span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsc<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"somehost\"</span><span class=\"token punctuation\">,</span>someport<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">ServerSocketChannel</span> ssc <span class=\"token operator\">=</span> <span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nssc<span class=\"token punctuation\">.</span><span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span>somelocalport<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">DatagramChannel</span> dc <span class=\"token operator\">=</span> <span class=\"token class-name\">DatagramChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"채널-사용\" style=\"position:relative;\">채널 사용<a href=\"#%EC%B1%84%EB%84%90-%EC%82%AC%EC%9A%A9\" aria-label=\"채널 사용 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>채널은 단방향(unidirectional) 또는 양방향(bidirectional)일 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ReadableByteChannel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Channel</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ByteBuffer</span> dst<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">WritableByteChannel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Channel</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ByteBuffer</span> src<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ReadableByteChannel 인터페이스는 read() 메서드를 정의하므로, 이를 구현하는 채널은 데이터를 읽을 수 있다.\n반대로 WritableByteChannel 인터페이스는 write() 메서드를 제공하므로, 이를 구현하는 채널은 데이터를 쓸 수 있다.\n어떤 채널 클래스가 두 인터페이스 중 하나만 구현하면 그 채널은 단방향이고, 두 인터페이스 모두를 구현하면 양방향 채널이 된다.</p>\n<p>ByteChannel 인터페이스는 ReadableByteChannel와 WritableByteChannel를 모두 확장하는데, 모든 File 채널과 소켓 채널이 ByteChannel을 확장하므로 양방향 채널이 된다.\n소켓은 항상 양방향이지만, 파일은 항상 그렇지 않다. 예를 들면 FileInputStream 객체에서 getChannel() 메서드로 얻는 FileChannel은 읽기 전용 채널이 된다.\n만약 해당 채널에 write를 하게 되면 NonWritableChannelException이 발생한다.</p>\n<p>아래는 System.in 채널에서 System.out 채널로 데이터를 복사하는 예제 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ChannelCopy</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">ReadableByteChannel</span> source <span class=\"token operator\">=</span> <span class=\"token class-name\">Channels</span><span class=\"token punctuation\">.</span><span class=\"token function\">newChannel</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">WritableByteChannel</span> dest <span class=\"token operator\">=</span> <span class=\"token class-name\">Channels</span><span class=\"token punctuation\">.</span><span class=\"token function\">newChannel</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">channelCopy1</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsource<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tdest<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">channelCopy1</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ReadableByteChannel</span> src<span class=\"token punctuation\">,</span> <span class=\"token class-name\">WritableByteChannel</span> dest<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">ByteBuffer</span> buffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocateDirect</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span> <span class=\"token operator\">*</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tbuffer<span class=\"token punctuation\">.</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tdest<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tbuffer<span class=\"token punctuation\">.</span><span class=\"token function\">compact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tbuffer<span class=\"token punctuation\">.</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">hasRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tdest<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"ScatterGather\" style=\"position:relative;\">Scatter/Gather<a href=\"#ScatterGather\" aria-label=\"ScatterGather permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Scatter/Gather 는 운영 체제에서 I/O 작업을 최적화하는 방법 중 하나이다.</p>\n<ul>\n<li>Scatter: 데이터를 여러 버퍼로 분산하여 읽는 것을 의미한다.</li>\n<li>Gather: 여러 버퍼에서 데이터를 모아서 쓰는 것을 의미한다.</li>\n</ul>\n<p>Scatter/Gather를 사용하면 여러 버퍼의 주소 목록을 한 번의 시스템 호출로 전달할 수 있다.\n이렇게 하면 사용자 프로세스가 여러 시스템 호출을 하는 것을 피할 수 있다.   </p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9360d4367299b407a6b6c26ffe473951/a31f0/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.82352941176471%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABE0lEQVR42nVSWaqEQAyc+19KQfDDFR1QBDcEBVFh3HfzqECLDG8CoeksVelKv67rovM8ad93Oo6DcBeOOHxdV1qWhWtE7pe90NC2LRVFQU3TcNN38ziO9Pl8OA5Dz09AFHmeR7quk23bZBgG+b5PrutSWZZMBkDYc/r/7jegaZrskiQxkGVZDJznOROBUBhkmeeZT2FPUAYMw5Bd0zRuxqTwLMuo73uq65q6rqM0TSmOY3Ich4Ig4DzqxQsYcNs2LlQUhWRZ5gkx1fv9Zk3BDAkQAyhAQAYgkFVVRUmSsOY3YBRFpKoqF6EBBYgBDMuABJBkGIZ7KeKJIMHLRI63PE0T64LRkYAjJr6RMPGNvpfy3PofAkhe5dqKWi8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3개의 버퍼에서 scattering으로 read\"\n        title=\"\"\n        src=\"/static/9360d4367299b407a6b6c26ffe473951/ca1dc/img_1.png\"\n        srcset=\"/static/9360d4367299b407a6b6c26ffe473951/e7570/img_1.png 170w,\n/static/9360d4367299b407a6b6c26ffe473951/f46e7/img_1.png 340w,\n/static/9360d4367299b407a6b6c26ffe473951/ca1dc/img_1.png 680w,\n/static/9360d4367299b407a6b6c26ffe473951/a31f0/img_1.png 685w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">3개의 버퍼에서 scattering으로 read</figcaption>\n  </figure></p>\n<p>아래는 Scatter/Gather I/O를 지원하는 인터페이스이다. read, write 메서드에 ByteBuffer 배열을 인자로 받는 것을 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ScatteringByteChannel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ReadableByteChannel</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> dsts<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> dsts<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">GatheringByteChannel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">WritableByteChannel</span> <span class=\"token punctuation\">{</span>\n\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> srcs<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> offset<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> length<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\t\t\t\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">long</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> srcs<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>아래는 Scatter로 두 개의 버퍼에 분산 저장하는 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">ByteBuffer</span> header <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span>allocateDirect <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">ByteBuffer</span> body <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span>allocateDirect <span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> buffers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> header<span class=\"token punctuation\">,</span> body <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">int</span> bytesRead <span class=\"token operator\">=</span> channel<span class=\"token punctuation\">.</span>read <span class=\"token punctuation\">(</span>buffers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>채널에 38byte가 준비되어 있다면 header에 10byte, body에 28byte가 저장된다.\n아래는 4개의 버퍼에 Scatter read를 사용한 모습이다.\n<figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/210a33dab5b459d05412c0295e64467e/e6e97/img_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1UlEQVR42pVR2QrDMAzL/39goQ+lJ73vi94aMmR0pRtrQCRxYkm2FS5rXVd0XYdxHLFtG54udb7M84yiKGBZFjzPQ1VVj0k/CKdpgmEYiOMYtm0LOZ0uyyJifNc7cRzHO1ef1TUQRRGCIIDv+6jrGn3fSzLdlmWJpmmQ57mI7ft+7/CsxE9ZlglhmqYIw1BAUvaWAm3bCih4BitR52HofnF3HAeu64orJjPGhF+gGaX7wVKTJBFi9oluWPowDBL7eyicpmmakswzwRI5FA6HYne9+kb4ArBsbucsssTeAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"scattering read using four buffers\"\n        title=\"\"\n        src=\"/static/210a33dab5b459d05412c0295e64467e/ca1dc/img_2.png\"\n        srcset=\"/static/210a33dab5b459d05412c0295e64467e/e7570/img_2.png 170w,\n/static/210a33dab5b459d05412c0295e64467e/f46e7/img_2.png 340w,\n/static/210a33dab5b459d05412c0295e64467e/ca1dc/img_2.png 680w,\n/static/210a33dab5b459d05412c0295e64467e/e6e97/img_2.png 864w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">scattering read using four buffers</figcaption>\n  </figure></p>\n<p>Scatter/Gather 적절하게 사용하면 읽은 데이터를 여러 버킷으로 분리하거나 서로 다른 데이터 덩어리를 전체 데이터로 모으는\n번거로운 작업을 운영체제에 위임하여, 시스템 호출을 줄이고 데이터 이동 작업을 줄일 수 있다.</p>\n<h2 id=\"File-Channel\" style=\"position:relative;\">File Channel<a href=\"#File-Channel\" aria-label=\"File Channel permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>FileChannel은 항상 블로킹 모드로 동작하며, 논블로킹 모드로 변경할 수 없다.\n논블러킹 모드가 파일 I/O에는 적용되지 않는 이유는 다음과 같다.</p>\n<ul>\n<li>캐싱과 최적화: 운영 체제의 캐싱과 최적화로 인해, 파일 I/O는 대부분의 경우 빠르게 처리된다. 따라서 논블로킹의 이점이 크게 나타나지 않을 수 있다.</li>\n<li>예측 가능한 데이터: 파일의 크기와 위치는 알려져 있기 때문에, 논블로킹 방식의 필요성이 상대적으로 줄어든다.</li>\n<li>구조화된 데이터: 파일의 구조화된 특성으로 인해, 스트림 지향 I/O와 같은 연속적인 데이터 흐름을 처리하는 논블로킹 방식이 필요하지 않을 수 있다.</li>\n</ul>\n<p>버퍼의 get()과 put() 메서드처럼, read()나 write()로 바이트를 전송할 때 파일의 위치도 자동으로 업데이트된다.\n파일의 위치가 size() 메서드로 반환되는 파일 크기에 도달하면, read()는 파일의 끝(end-of-file)을 나타내는 -1을 반환한다.   </p>\n<p>파일 크기를 넘어서 write()를 수행하면, 새로 쓰는 바이트를 수용하기 위해 파일 크기가 커진다. 이전 파일의 끝과 새로 추가된 바이트 사이의 바이트 값은 FileChannel 클래스에 의해 지정되지 않지만, 대부분의 경우 기본 파일 시스템의 동작을 반영한다.\n운영 체제나 파일 시스템 유형에 따라 파일에 구멍이 생길 수 있다.   </p>\n<p>파일 크기를 줄이려면, truncate()를 사용해 지정한 새 크기를 넘어서는 모든 데이터를 잘라낸다. 현재 크기가 새 크기보다 크면, 새 크기를 넘어서는 모든 바이트는 버려진다. 제공된 새 크기가 현재 파일 크기보다 크거나 같으면 파일은 수정되지 않는다. 어느 경우에든 truncate()의 부수 효과는 파일 위치를 제공된 새 크기로 설정하는 것이다.   </p>\n<p>파일이 로컬 파일 시스템에 있으면, force()에서 반환될 때 채널이 생성된 이후 (또는 마지막으로 force()가 호출된 이후) 파일에 대한 모든 수정 사항이 디스크에 기록되었음이 보장된다.\n이러한 동기화는 데이터 무결성과 신뢰할 수 있는 복구를 위해 중요하다. 예를 들어, 트랜잭션 처리와 같은 중요한 작업에서 이것은 필수적이다.   </p>\n<p>그러나 파일이 NFS와 같은 원격 파일 시스템에 있으면 이러한 동기화를 보장할 수 없다. 다른 파일 시스템에서도 구현에 따라 동일한 문제가 발생할 수 있다.\nJVM은 운영 체제나 파일 시스템이 지키지 않는 약속을 할 수 없다. 시스템 실패에도 데이터 무결성을 유지해야 하는 애플리케이션의 경우, 사용 중인 운영 체제나 파일 시스템이 그러한 측면에서 신뢰할 수 있는지 확인해야 한다.</p>\n<p>아래는 FileChannel로 파일을 Copy 하는 예제 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FileCopyExample</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">String</span> sourceFilePath <span class=\"token operator\">=</span> <span class=\"token string\">\"원본파일경로/원본파일.txt\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">String</span> destinationFilePath <span class=\"token operator\">=</span> <span class=\"token string\">\"대상파일경로/대상파일.txt\"</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token class-name\">FileInputStream</span> sourceStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileInputStream</span><span class=\"token punctuation\">(</span>sourceFilePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">FileOutputStream</span> destinationStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileOutputStream</span><span class=\"token punctuation\">(</span>destinationFilePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token class-name\">FileChannel</span> sourceChannel <span class=\"token operator\">=</span> sourceStream<span class=\"token punctuation\">.</span><span class=\"token function\">getChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">FileChannel</span> destinationChannel <span class=\"token operator\">=</span> destinationStream<span class=\"token punctuation\">.</span><span class=\"token function\">getChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token class-name\">ByteBuffer</span> buffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">int</span> bytesRead<span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>bytesRead <span class=\"token operator\">=</span> sourceChannel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tbuffer<span class=\"token punctuation\">.</span><span class=\"token function\">flip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 버퍼를 읽기 모드로 전환</span>\n\t\t\t\tdestinationChannel<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 버퍼의 내용을 대상 파일로 복사</span>\n\t\t\t\tbuffer<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 버퍼를 초기화하여 다시 쓰기 모드로 전환</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\tsourceStream<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tdestinationStream<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tsourceChannel<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tdestinationChannel<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"파일이 복사되었습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\te<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"Memory-Mapped-Files\" style=\"position:relative;\">Memory-Mapped Files<a href=\"#Memory-Mapped-Files\" aria-label=\"Memory Mapped Files permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>FileChannel 클래스의 map() 메서드를 사용하면, 파일과 특별한 유형의 ByteBuffer 사이에 가상 메모리 매핑을 설정할 수 있다. 이렇게 하면 디스크 파일을 기반으로 한 가상 메모리 매핑이 생성되고, 해당 가상 메모리 공간 주위에 MappedByteBuffer 객체가 감싸진다.   </p>\n<p>map()에서 반환된 MappedByteBuffer 객체는 대부분의 면에서 메모리 기반 버퍼처럼 동작한다. 그러나 그 데이터 요소는 디스크에 있는 파일에 저장된다. get()을 호출하면 디스크 파일에서 데이터를 가져오며, 매핑이 설정된 이후에 외부 프로세스에 의해 파일이 수정되었더라도 현재 파일의 내용을 반영한다.    </p>\n<p>메모리 매핑 메커니즘을 통해 파일에 접근하는 것은 채널을 사용할 때조차도 전통적인 방법으로 데이터를 읽거나 쓰는 것보다 훨씬 효율적일 수 있다. 명시적인 시스템 호출을 할 필요가 없기 때문이다. 더 중요한 것은 운영 체제의 가상 메모리 시스템이 자동으로 메모리 페이지를 캐시한다는 것이다.   </p>\n<p>유효한 메모리 페이지가 한 번 생성되면, 다른 시스템 호출을 하지 않고도 전체 하드웨어 속도로 다시 접근할 수 있다. 메모리 매핑을 활용하면, 자주 참조되거나 업데이트되는 인덱스나 다른 섹션이 포함된 큰 구조화된 파일에서 큰 이점을 얻을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FileChannel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractChannel</span>\n\t\t<span class=\"token keyword\">implements</span> <span class=\"token class-name\">ByteChannel</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">GatheringByteChannel</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ScatteringByteChannel</span> <span class=\"token punctuation\">{</span>\n  \n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">MappedByteBuffer</span> map <span class=\"token punctuation\">(</span><span class=\"token class-name\">MapMode</span> mode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> position<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MapMode</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MapMode</span> <span class=\"token constant\">READ_ONLY</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MapMode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"READ_ONLY\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MapMode</span> <span class=\"token constant\">READ_WRITE</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MapMode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"READ_WRITE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MapMode</span> <span class=\"token constant\">PRIVATE</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MapMode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"PRIVATE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token punctuation\">}</span>\n \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>아래 코드는 FileChannel의 전체 파일 데이터에 대해서 MappedByteBuffer를 생성하는 예이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">buffer <span class=\"token operator\">=</span> fileChannel<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FileChannel<span class=\"token punctuation\">.</span>MapMode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">READ_ONLY</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> fileChannel<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>맵핑 모드는 읽기 전용(MapMode.READ<em>ONLY) 또는 읽기/쓰기(MapMode.READ</em>WRITE)를 나타낼 수 있다. 요청한 매핑 모드는 map() 메서드가 호출되는 FileChannel 객체의 액세스 권한에 따라 제한될 수 있다.   </p>\n<p>MapMode.PRIVATE 모드는 복사 후 쓰기 매핑을 원한다는 것을 나타낸다. 이는 put()을 통해 만든 모든 수정 사항이 MappedByteBuffer 인스턴스만 볼 수 있는 개인 데이터 복사본을 생성한다는 것을 의미한다. 기본 파일에는 변경 사항이 적용되지 않으며, 버퍼가 가비지 컬렉션될 때 변경 사항은 손실된다.   </p>\n<p>복사 후 쓰기는 운영 체제에서 프로세스가 다른 프로세스를 생성할 때 가상 주소 공간을 관리하는 데 일반적으로 사용되는 기술이다. 복사 후 쓰기를 사용하면 부모 프로세스와 자식 프로세스가 메모리 페이지를 공유할 수 있게 되며, 이로 인해 동일한 파일의 여러 매핑에 대한 많은 이점이 생길 수 있다.</p>\n<p>그런데 여기서 중요한 점은, 버퍼가 해당 파일 영역을 아직 수정하지 않았을 때, 실제 파일의 해당 영역에 다른 방법(다른 프로세스나 애플리케이션)으로 변경이 발생하면, MapMode.PRIVATE 모드로 생성된 버퍼는 그 변경 사항을 볼수 있다. 즉, 파일의 원본 데이터가 변경되면, 해당 변경은 버퍼에도 반영된다.</p>\n<p>하지만, 버퍼가 이미 해당 파일 영역을 수정한 경우, 버퍼는 그 영역의 복사본을 가지고 있게 된다. 따라서, 이후에 실제 파일의 해당 영역에 변경이 발생하더라도, 버퍼는 그 변경을 반영하지 않고, 본인이 수정한 복사본의 데이터를 유지한다.   </p>\n<p>예를 들어, 파일에 \"Hello\"라는 문자열이 있고, 이를 MapMode.PRIVATE 모드로 매핑하여 버퍼를 생성했다고 가정하자.\n이후, 다른 프로세스에서 파일의 \"Hello\"를 \"World\"로 변경하면, 버퍼는 \"World\"를 볼 수 있다.\n그러나, 버퍼가 먼저 \"Hello\"를 \"Java\"로 변경한 후에 파일이 \"World\"로 바뀌면, 버퍼는 여전히 \"Java\"를 보게 된다.</p>\n<p>MappedByteBuffer의 isLoaded 메서드는 매핑된 파일이 완전히 메모리에 로드되어 있는지 확인하는 데 사용된다.\ntrue를 반환하면 매핑된 버퍼에 접근할 때 지연이 거의 없거나 전혀 없을 가능성이 높다. false를 반환해도 파일이 메모리에 완전히 로드되지 않았다는 것을 의미하지는 않는다.\n이 메서드는 보증이 아닌 힌트를 제공한다.   </p>\n<p>force 메서드는 MappedByteBuffer에서의 변경 사항을 디스크에 flush한다.\nMappedByteBuffer를 통해 파일을 업데이트할 때는 FileChannel.force() 대신 MappedByteBuffer.force()를 사용해야 한다.</p>\n<h2 id=\"Socket-Channel\" style=\"position:relative;\">Socket Channel<a href=\"#Socket-Channel\" aria-label=\"Socket Channel permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>java.nio 의 Socket Channel은 네트워크 소켓을 모델링한 클래스이다. 파일 채널과는 다르게 nonblocking 모드가 가능하며,\n소켓 연결을 위해 스레드를 할당할 필요가 없으며 하나의 스레드로도 수천 개의 소켓 연결을 관리할 수 있다.</p>\n<p>소켓 채널은 기존의 java.net에 있는 소켓이 프로토콜 연산 대부분에 재사용된다.</p>\n<p>다음 메서드는 채널의 차단 모드와 관련된 메서드이다. 모든 소켓 채널(SocketChannel, ServerSocketChannel, DatagramChannel)이 생성될 때는 그에 대응하는 피어 소켓 객체가 함께 생성된다.\n이 피어 소켓은 Socket, ServerSocket, DatagramSocket 클래스 중 하나이다.</p>\n<p>소켓 채널은 프로토콜 연산을 해당 피어 소켓 객체에 위임한다.\n채널 클래스에서 소켓 메서드가 중복되어 보이는 경우, 그 메서드에는 채널 클래스에만 해당하는 다른 연산이 있다는 의미이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SelectableChannel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractInterruptibleChannel</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Channel</span> <span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">void</span> configureBlocking <span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> block<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isBlocking</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">blockingLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>채널의 블로킹 모드로 설정하려면 configureBlocking() 메서드에 true를 인수로 전달하고, 논블로킹 모드로 설정하려면 false를 인수로 전달하면 된다.</p>\n<p>채널이 현재 어떤 모드에 있는지 확인하려면 isBlocking() 메서드로 알 수 있다.</p>\n<p>blockingLock()으로 반환된 객체는 채널이 블로킹 모드에 변경을 할 때 내부적으로 사용하는 모니터 객체이다.\n이 객체에 잠금을 보유한 스레드만 채널의 블로킹 모드를 변경할 수 있다.\n코드의 중요한 부분 동안 소켓의 블로킹 모드가 변경되지 않도록 하거나, 다른 스레드에 영향을 주지 않고 일시적으로 모드를 변경하는 데 사용할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Object</span> lockObj <span class=\"token operator\">=</span> serverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">blockingLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsynchronize <span class=\"token punctuation\">(</span>lockObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">boolean</span> prevState <span class=\"token operator\">=</span> serverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">isBlocking</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  serverChannel<span class=\"token punctuation\">.</span>configureBlocking <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  socket <span class=\"token operator\">=</span> serverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  serverChannel<span class=\"token punctuation\">.</span>configureBlocking <span class=\"token punctuation\">(</span>prevState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"ServerSocketChannel\" style=\"position:relative;\">ServerSocketChannel<a href=\"#ServerSocketChannel\" aria-label=\"ServerSocketChannel permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>ServerSocketChannel 객체는 내부적으로 ServerSocket 객체(피어 소켓)와 연관되어 있으며,\n이를 통해 일반적인 소켓 연산, 포트 바인딩 등의 작업을 수행할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">ServerSocketChannel</span> ssc <span class=\"token operator\">=</span> <span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">ServerSocket</span> serverSocket <span class=\"token operator\">=</span> ssc<span class=\"token punctuation\">.</span><span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nserverSocket<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token number\">1234</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ServerSocketChannel와 기존 ServerSocket 모두 accept() 라는 메서드를 가지고 있다.\n이 메서드는 들어오는 클라이언트 연결을 수락하기 위해 사용된다.</p>\n<p>ServerSocket의 accept() 메서드는 항상 blocking 모드로 동작한다.  즉, 서버는 새로운 연결이 수락될 때까지 대기하게 된다.   </p>\n<p>ServerSocketChannel의 accept() 메서드는 nonblocking 모드로 동작할 수 있다. 즉, 호출 시점에 수락할 연결이 없다면 null을 반환하게 된다.\n따라서, 서버는 새 연결을 기다리는 동안 다른 작업을 계속 수행할 수 있다.   </p>\n<p>ServerSocketChannel은 Selector와 함께 사용했을 때, 새 연결이 도착했을 때 이벤트를 받을 수 있다.</p>\n<h3 id=\"SocketChannel\" style=\"position:relative;\">SocketChannel<a href=\"#SocketChannel\" aria-label=\"SocketChannel permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>모든 SocketChannel 객체는 피어 객체인 Socket과 함께 생성된다.\nSocketChannel의 static 메서드인 open() 메서드는 새로운 SocketChannel 객체를 생성한다.\n새 SocketChannel에서 socket()을 호출하면 해당 피어 Socket 객체가 반환딘다.\n해당 Socket에서 getChannel()을 호출하면 원래 SocketChannel이 반환된다.</p>\n<p>SocketChannel의 연결은 open() 이나 connect() 메서드를 통해 이루어진다.\n아래는 SocketChannel 연결의 예이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SocketChannel</span> socketChannel <span class=\"token operator\">=</span> <span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"8080\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">SocketChannel</span> socketChannel <span class=\"token operator\">=</span> <span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"8080\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>nonblocking 모드에서 connect()를 호출해서 반환값이 true이면 연결이 즉시 성립되었다는 것이고, 연결이 즉시 성립되지 않으면 connect()는 false를 반환된다.</p>\n<p>만약 연결이 바로 성립되지 않는 경우 (서버에 연결하는 데 시간이 걸리는 경우), 연결은 백그라운드에서 계속 진행된다.\nisConnectPending() 메서드는 연결이 백그라운드에서 진행 중인지 확인할 수 있다.\n예를 들어, 소켓 채널을 nonblocking 모드로 설정하고 연결을 시도했을 때 연결이 즉시 성립되지 않으면 isConnectPending() 메서드는 true를 반환하고, 연결이 성립되가니 연결이 시작되지 않았을 경우 false를 반환한다.</p>\n<p>finishConnect() 메서드는 nonblocking 모드에서 연결을 시도한 후 연결 상태를 확인하는 데 사용된다.\n연결이 성립되었을 경우 true를 반환하고, 그렇지 않을 경우 false를 반환하거나 연결 과정이 시작되지 않았을 때(connect 호출 전) 예외를 발생시킨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">InetSocketAddress</span> addr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">SocketChannel</span> sc <span class=\"token operator\">=</span> <span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsc<span class=\"token punctuation\">.</span>configureBlocking <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsc<span class=\"token punctuation\">.</span>connect <span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sc<span class=\"token punctuation\">.</span><span class=\"token function\">finishConnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token function\">doSomethingElse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">doSomethingWithChannel</span><span class=\"token punctuation\">(</span>sc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsc<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>Java NIO(Ron Hitchens)</li>\n</ul>","fields":{"slug":"/java-nio-channel/"},"frontmatter":{"title":"Java NIO - Channel","date":"October 14, 2023"}},{"id":"8d197033-5a60-5434-bc31-0481d7d6e8c4","html":"<h2 id=\"What-is-Light-Weight-Container\" style=\"position:relative;\">What is Light-Weight Container?<a href=\"#What-is-Light-Weight-Container\" aria-label=\"What is Light Weight Container permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>애플리케이션 코드가 실행되는 프레임워크를 의미한다. 애플리케이션 객체(대부분 비즈니스 객체)는 컨테이너 내부에서 실행되며 컨테이너에 의해 관리된다고 한다. 다음은 경량 컨테이너가 가지는 특징들이다.</p>\n<ul>\n<li>비침투성 (Non-invasiveness): 이는 애플리케이션 코드에 특별한 의존성을 부과하지 않는 컨테이너를 의미한다. 예를 들어, 기존의 코드를 수정하지 않고도 컨테이너 내에서 실행할 수 있어야 한다. 이는 인프라가 애플리케이션 코드에 불필요한 의존성을 부과하지 않아야 함을 의미한다.</li>\n<li>빠른 시작: 컨테이너는 빠르게 시작되어야 한다. 이는 개발 및 배포 시간을 줄이고, 사용자에게 빠른 응답 시간을 제공한다..</li>\n<li>특별한 배포 단계 불필요: 컨테이너 내의 객체를 배포할 때 특별한 단계나 복잡한 설정 없이 쉽게 배포할 수 있어야 한다.</li>\n<li>다양한 환경에서의 실행: 컨테이너는 그 크기와 API 의존성이 최소화되어 다양한 환경에서 실행될 수 있어야 한다. 예를 들면 웹 컨테이너, 독립 실행형 클라이언트, 아니면 애플릿에서도 실행될 수 있어야 한다.</li>\n<li>관리 객체 추가의 낮은 장벽: 컨테이너는 객체를 배포하고 관리하는 데 있어서 노력과 성능 오버헤드가 최소화되어야 한다. 이는 세밀한 객체뿐만 아니라 대형 컴포넌트도 쉽게 배포하고 관리할 수 있어야 함을 의미한다.</li>\n</ul>\n<h2 id=\"Container-Benefits\" style=\"position:relative;\">Container Benefits<a href=\"#Container-Benefits\" aria-label=\"Container Benefits permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>Pluggability: 컨테이너는 다양한 컴포넌트의 플러그 가능성을 제공한다. 예를 들면, 동일한 컴포넌트 인터페이스에 대해 다른 EJB 구현 클래스를 사용할 수 있다. 이렇게 하면 호출 코드가 구현 전략에서 격리된다. 자바 인터페이스는 완벽한 분리를 제공하지만, 어떤 인터페이스의 구현을 사용할 것인지 결정하는 방법이 필요하다. 자바 코드에 하드코딩하면 인터페이스를 사용하는 많은 이점이 사라진다.</li>\n<li>Consistency: 컨테이너 인프라가 없으면 서비스 조회가 불규칙적이게 된다. 다른 서비스 객체는 개발자의 선호에 따라 다르게 위치할 수 있다. 구성 관리도 마찬가지로 불규칙적이게 돼서 지속적인 유지 관리 문제를 초래할 수 있다.</li>\n<li>One stop shop: 컨테이너만 찾으면 그 안의 모든 서비스를 찾을 수 있다. 모든 객체에 대해 전용 싱글톤이나 팩토리가 필요 없다.</li>\n<li>Delivery of enterprise services: 일관된 접근 방식을 사용하면 컨테이너 모델의 일부로, 또는 추가 기능으로 엔터프라이즈 서비스를 제공하는 것이 더 쉬워진다.</li>\n</ul>\n<h2 id=\"Inversion-Of-Control\" style=\"position:relative;\">Inversion Of Control<a href=\"#Inversion-Of-Control\" aria-label=\"Inversion Of Control permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>애플리케이션 코드가 컨테이너에 의존하는 것을 피하는 것이 좋다고 언급했다. 그런데 이게 어떻게 가능할까? 대부분의 비즈니스 객체는 다른 비즈니스 객체, 데이터 접근 객체, 리소스와 같은 의존성을 가진다. 그럼 객체들이 다른 관리 객체나 리소스를 찾아야 하고, 그러한 조회를 만족시킬 수 있는 컨테이너에 의존해야 하지 않을까? 컨테이너에 의존성을 도입하지 않고 의존성을 만족시키는 것은 제어의 역전(Inversion of Control)과 의존성 주입(Dependency Injection)의 마법을 통해 대부분 가능하다.</p>\n<p>제어의 역전은 프레임워크에서 중요한 개념이다. 이는 \"Don’t call us, we’ll call you.\" 라는 할리우드 원칙을 통해 가장 잘 이해된다.</p>\n<p>의존성 주입은 제어의 역전을 사용하여 모든 조회 코드를 제거하고, 컨테이너가 언어 수준에서 표현된 의존성을 자동으로 해결하게 한다.</p>\n<h2 id=\"Dependency-Injection\" style=\"position:relative;\">Dependency Injection<a href=\"#Dependency-Injection\" aria-label=\"Dependency Injection permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>이 방법은 컨테이너에게 의존성 조회를 완전히 맡기고, 관리되는 객체가 JavaBean setter 메서드나 생성자 인수를 통해 초기화될 때 의존성이 그 안으로 전달될 수 있게 하는 것이다.</p>\n<p>이것을 언어 기반의 IoC라고 부른다. 왜냐하면 특별한 컨테이너 API나 인터페이스에 의존하지 않기 때문이다. 의존성 주입을 사용하면 IoC 컨테이너가 모든 연결 작업을 처리한다. 컨테이너는 리소스를 찾는 것을 담당하고, 비즈니스 객체에 필요한 리소스를 제공한다. 애플리케이션 코드에 영향을 주지 않고 필요한 리소스를 얻기 위한 다른 접근 방식을 사용하도록 컨테이너를 재구성할 수 있다.</p>\n<p>의존성 주입 방식은 여러 가지 장점을 제공한다.</p>\n<ul>\n<li>애플리케이션 코드에서 리소스나 다른 객체를 찾기 위한 코드(lookup)가 완전히 제거된다. 이는 코드를 더 깔끔하게 만들어 준다.</li>\n<li>컨테이너 API에 대한 의존성 없어 순수한 자바 언어 개념만을 다룰 수 있다.</li>\n<li>의존성 주입을 위해 특별한 인터페이스를 구현할 필요가 없다.</li>\n</ul>\n<h2 id=\"Spring-IoC-Container\" style=\"position:relative;\">Spring IoC Container<a href=\"#Spring-IoC-Container\" aria-label=\"Spring IoC Container permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>스프링의 기본적인 경량 컨테이너 인터페이스는 BeanFactory 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">BeanFactory</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token class-name\">Object</span> <span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">Object</span> <span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Class</span> requiredType<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">boolean</span> <span class=\"token function\">containsBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">boolean</span> <span class=\"token function\">isSingleton</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">NoSuchBeanDefinitionException</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">getAliases</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">NoSuchBeanDefinitionException</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>BeanFactory 인터페이스는 문자열 이름으로 빈 인스턴스를 조회하기 위한 getBean 메서드를 제공한다.</p>\n<p>BeanFactory는 계층 구조의 일부일 수 있는데, 특정 팩토리에서 bean을 찾을 수 없으면 부모 팩토리에게 요청된다. 이렇게 해서 최상위 팩토리까지 찾게 된다. 상위 컨텍스트의 bean 정의는 하위 컨텍스트에서 볼 수 있지만 반대는 아니다.</p>\n<p>BeanFactory 인터페이스의 대부분의 구현은 이름별로 객체를 등록하는 것뿐만 아니라 그 객체들을 IoC를 사용하여 구성하는 데 풍부한 지원을 제공한다. 예를 들어, 관리되는 객체 간의 의존성과 간단한 속성을 관리한다.</p>\n<p>아래는 BeanFactory 인터페이스를 확장한 ListableBeanFactory 인터페이스이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ListableBeanFactory</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BeanFactory</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getBeanDefinitionCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">getBeanDefinitionNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token function\">getBeanDefinitionNames</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span> type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">boolean</span> <span class=\"token function\">containsBeanDefinition</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">Map</span> <span class=\"token function\">getBeansOfType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span> type<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> includePrototypes<span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">boolean</span> includeFactoryBeans<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ListableBeanFactory는 팩토리 내의 bean을 나열하는 것을 지원하는 하위 인터페이스다. 이는 정의된 bean의 수, 모든 bean의 이름, 주어진 유형의 인스턴스인 bean의 이름을 검색하는 메서드를 제공한다.</p>\n<p>ListableBeanFactory를 사용하면 프로그램이 실행되는 도중에, 즉 런타임에 어떤 객체들이 필요한지 알게 되고, 그 객체들과 함께 작동하게 만들 수 있다.</p>\n<p>다시 말해, 프로그램을 작성할 때 모든 객체를 미리 알 수 없을 때, ListableBeanFactory를 사용하면 실행 중에 필요한 객체들을 찾아서 그것들과 함께 작업할 수 있게 도와준다.</p>\n<p>어떤 객체들은 초기화와 종료 시점에 콜백을 받길 원할 수 있다. Spring의 빈 팩토리는 이를 위한 두 가지 방법을 제공한다. 콜백 인터페이스를 구현하거나, 콜백 메서드를 선언적으로 지정하는 것이다.</p>\n<p>Spring에서 제공하는 두 개의 콜백 인터페이스는 org.springframework.beans.factory.InitializingBean과 org.springframework.beans.factory.DisposableBean이다. 이들은 속성이 설정된 후와 빈 팩토리가 종료될 때 간단한 인자 없는 콜백 메서드를 제공한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">InitializingBean</span> <span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">afterPropertiesSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">DisposableBean</span> <span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>때로는 특정 빈이 자신이 속해 있는 빈 팩토리에 직접 접근해야 할 때가 있다. 예를 들어, 빈이 자신을 관리하는 빈 팩토리의 다른 서비스나 기능을 사용하려 할 때 그렇다.</p>\n<p>이런 경우를 위해 Spring은 초기화 시점에 해당 빈에게 자신이 속해 있는 빈 팩토리의 참조(reference)를 제공하는 콜백(callback) 기능을 제공한다. 이렇게 하면 빈은 자신을 관리하는 빈 팩토리에 직접 접근할 수 있다.</p>\n<p>이 콜백을 수신하기 위해서는 BeanFactoryAware 인터페이스를 구현하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">BeanFactoryAware</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Aware</span> <span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">setBeanFactory</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanFactory</span> beanFactory<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이러한 setBeanFactory 메서드는 InitializingBean 인터페이스의 afterPropertiesSet 메서드보다 먼저 호출된다.\n소개한 인터페이스는 애플리케이션 코드보다 Spring 프레임워크 자체 내에서 더 자주 사용된다.</p>\n<h2 id=\"Spring-ApplicationContext\" style=\"position:relative;\">Spring ApplicationContext<a href=\"#Spring-ApplicationContext\" aria-label=\"Spring ApplicationContext permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Spring은 빈 팩토리(bean factory)를 확장하여 애플리케이션 컨텍스트(application context) 라는 개념을 제공한다. 애플리케이션 컨텍스트는 빈 팩토리의 기능을 포함하면서도 추가적인 기능들을 제공한다.</p>\n<ul>\n<li>메시지 소스 지원: 키를 통해 지역화된 메시지를 일반적인 방식으로 검색하는 기능을 제공한다. 기본 구현은 리소스 번들에서 메시지를 읽어온다.</li>\n<li>파일 리소스 접근: 실제 리소스 환경(예: 파일 시스템 또는 ServletContext)에 의존하지 않고 상대 경로를 통해 리소스를 로드하는 기능이다.</li>\n<li>애플리케이션 이벤트 지원: Observer 디자인 패턴의 구현으로, 등록된 애플리케이션 리스너에게 애플리케이션 이벤트를 발행한다. 이를 통해 이벤트 발송자와 수신자 간의 결합도를 낮춘다. 또한, 리스너는 컨텍스트 생명주기 이벤트의 알림도 받을 수 있다. Spring의 AOP 프레임워크는 애플리케이션 \"이벤트\"의 알림 설정을 위한 대안이 될 수 있다.</li>\n</ul>\n<p>중심이 되는 인터페이스는 ApplicationContext이다. 이 인터페이스는 ListableBeanFactory를 확장한다. 따라서 애플리케이션 코드는 ApplicationContext를 마치 BeanFactory처럼 사용할 수 있다.</p>\n<h3 id=\"BeanFactoryPostProcessor\" style=\"position:relative;\">BeanFactoryPostProcessor<a href=\"#BeanFactoryPostProcessor\" aria-label=\"BeanFactoryPostProcessor permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>애플리케이션 컨텍스트는 Bean Factory Post-processing 라는 기능을 제공한다. 이 기능을 통해 애플리케이션 컨텍스트에서 읽어들인 빈 정의를 수정하거나 변경할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@FunctionalInterface</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">BeanFactoryPostProcessor</span> <span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">postProcessBeanFactory</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConfigurableListableBeanFactory</span> beanFactory<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 인터페이스를 구현하면 컨텍스트가 시작될 때 이 후처리기들은 콜백을 받을 수 있으며, 다른 모든 빈들보다 먼저 적용되기 때문에 다른 빈의 정의를 변경할 수 있다.</p>\n<p>예를 들면, 빈의 설정 정보(XML 등)에 정확한 값 대신에 플레이스홀더가 들어갈 수 있다. 데이터베이스 연결 정보나 외부 API 키 같은 민감한 정보를 직접 XML에 쓰는 대신 {db_password}와 같은 플레이스홀더를 사용할 수 있다.</p>\n<p>즉, 후처리는 빈의 설정 정보를 최종적으로 조정하거나 완성하는 단계라고 볼 수 있다.</p>\n<h2 id=\"스프링-DI의-내부-동작\" style=\"position:relative;\">스프링 DI의 내부 동작<a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81-DI%EC%9D%98-%EB%82%B4%EB%B6%80-%EB%8F%99%EC%9E%91\" aria-label=\"스프링 DI의 내부 동작 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>앞서 언급한 인터페이스들은 스프링 컨테이너의 내부 구현에 있어 핵심적인 역할을 하는 인터페이스이다. 그러나 일반 애플리케이션 개발자가 직접 사용할 일은 많지 않다.\n여기서는 스프링의 DI가 이러한 핵심 인터페이스들을 어떻게 활용하여 동작하는지에 대해 살펴볼 것이다.</p>\n<p>컴포넌트 스캔, 세부적인 구현 등 복잡한 내용은 일단 제쳐두고, 앞서 살펴본 핵심 인터페이스로 @Autowired의 DI 동작 방식에 초점을 맞춰보자.\n아래 예제는 Programmatic 방식으로 DI를 적용한 예시이다.</p>\n<ol>\n<li>ItemService 와 ItemRepository 인터페이스를 구현한다.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Autowired</span> <span class=\"token class-name\">ItemRepository</span> itemRepository<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>itemRepository<span class=\"token punctuation\">.</span><span class=\"token function\">getItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ItemRepository</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token class-name\">String</span> <span class=\"token function\">getItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemRepositoryImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ItemRepository</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"2\">\n<li>Annotation Config 기반 스프링 빈을 설정한다.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">ItemRepository</span> <span class=\"token function\">itemRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemRepositoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"3\">\n<li>\n<p>AutowireCapableBeanFactory 빈 팩토리를 사용하여 ItemService 의존성을 주입한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DIApplication</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token class-name\">ApplicationContext</span> context <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AnnotationConfigApplicationContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MyConfig</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">AutowireCapableBeanFactory</span> beanFactory <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getAutowireCapableBeanFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// Spring의 제어 밖에서 ItemService의 인스턴스를 생성한다</span>\n\t<span class=\"token class-name\">ItemService</span> itemService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// AutowireCapableBeanFactory를 사용하여 의존성을 자동 주입한다.</span>\n\tbeanFactory<span class=\"token punctuation\">.</span><span class=\"token function\">autowireBean</span><span class=\"token punctuation\">(</span>itemService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// itemService 의 의존성 주입이 완료되었다.</span>\n\titemService<span class=\"token punctuation\">.</span><span class=\"token function\">printItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// output : \"hello world\"</span>\n\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ol>\n<p>위의 예제에서, ItemService의 인스턴스는 Spring의 빈 생명주기를 관리하지 않는 외부에서 생성되었지만, AutowireCapableBeanFactory를 사용하여 ItemRepository 인터페이스에 대한\n의존성을 주입할 수 있다.</p>\n<p>AutowireCapableBeanFactory는 BeanFactory의 확장 인터페이스로 기존의 빈 인스턴스에 대한 자동 와이어링 기능을 제공하는 인터페이스이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">AutowireCapableBeanFactory</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BeanFactory</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token comment\">/**\n\t * Populate the given bean instance through applying after-instantiation callbacks\n\t * and bean property post-processing (e.g. for annotation-driven injection).\n\t * &lt;p>Note: This is essentially intended for (re-)populating annotated fields and\n\t * methods, either for new instances or for deserialized instances. It does\n\t * &lt;i>not&lt;/i> imply traditional by-name or by-type autowiring of properties;\n\t * use {@link #autowireBeanProperties} for those purposes.\n\t * @param existingBean the existing bean instance\n\t * @throws BeansException if wiring failed\n\t */</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">autowireBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> existingBean<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">BeansException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>autowireBean 메서드는 주어진 빈 인스턴스에 대한 후처리(Post-Processing)를 수행하여 @Autowired와 같은 어노테이션을 사용한 필드나 메서드를 채우는 역할을 한다.\nautowireBean 메서드는 주어진 빈 인스턴스에 대해 @Autowired와 같은 어노테이션을 사용하여 필드나 메서드에 값을 주입하는 역할을 한다.   </p>\n<p>메서드의 내부 구현을 살펴보면 아래와 같은 로직을 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InstantiationAwareBeanPostProcessor</span> bp <span class=\"token operator\">:</span> <span class=\"token function\">getBeanPostProcessorCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>instantiationAware<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token class-name\">PropertyValues</span> pvsToUse <span class=\"token operator\">=</span> bp<span class=\"token punctuation\">.</span><span class=\"token function\">postProcessProperties</span><span class=\"token punctuation\">(</span>pvs<span class=\"token punctuation\">,</span> bw<span class=\"token punctuation\">.</span><span class=\"token function\">getWrappedInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> beanName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">// ...\t</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>InstantiationAwareBeanPostProcessor 인스턴스들을 순회하며 postProcessProperties 메서드를 호출하는 것을 볼 수 있다. InstantiationAwareBeanPostProcessor 인터페이스는 BeanPostProcessor의 확장으로, 프로퍼티의 사후 처리를 위한 추가적인 콜백 메서드를 제공한다.</p>\n<p>실제로 의존성 주입은 InstantiationAwareBeanPostProcessor 인터페이스를 구현한 AutowiredAnnotationBeanPostProcessor 클래스의 postProcessProperties 메서드 내에서 수행된다.</p>\n<p>아래는 AutowiredAnnotationBeanPostProcessor 클래스의 postProcessProperties() 메서드 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AutowiredAnnotationBeanPostProcessor</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">SmartInstantiationAwareBeanPostProcessor</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BeanFactoryAware</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">PropertyValues</span> <span class=\"token function\">postProcessProperties</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">PropertyValues</span> pvs<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> bean<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> beanName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">InjectionMetadata</span> metadata <span class=\"token operator\">=</span> <span class=\"token function\">findAutowiringMetadata</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> bean<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> pvs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\tmetadata<span class=\"token punctuation\">.</span><span class=\"token function\">inject</span><span class=\"token punctuation\">(</span>bean<span class=\"token punctuation\">,</span> beanName<span class=\"token punctuation\">,</span> pvs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BeanCreationException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">throw</span> ex<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BeanCreationException</span><span class=\"token punctuation\">(</span>beanName<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Injection of autowired dependencies failed\"</span><span class=\"token punctuation\">,</span> ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> pvs<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>metadata.inject(bean, beanName, pvs); 라인에서 실제로 의존성 주입이 발생한다.</p>\n<p>AutowiredAnnotationBeanPostProcessor가 의존성을 주입하기 위해서는 먼저 주입할 객체가 Spring 컨테이너에서 관리되어야 한다. 그리고 해당 컨테이너를 참조하여 필요한 객체를 찾아야 한다.\n이때 컨테이너를 어떻게 참조할까? 바로 BeanFactoryAware 인터페이스를 구현함으로써 beanFactory를 주입받을 수 있다. AutowiredAnnotationBeanPostProcessor는 내부적으로 주입받은 beanFactory를 멤버 변수에 저장하고 있다. 그리고 postProcessProperties 메서드가 호출될 때, 이 beanFactory를 사용하여 필요한 빈을 검색하고, 그것을 통해 DI를 수행한다.</p>\n<p>위에서 살펴본 Spring의 핵심 인터페이스인 beanFactory -> BeanPostProcessor -> BeanFactoryAware -> beanFactory 중심으로 코드가 나타나고 있는 것을 볼 수 있다.</p>\n<h2 id=\"완전한-Spring-IoC\" style=\"position:relative;\">완전한 Spring IoC<a href=\"#%EC%99%84%EC%A0%84%ED%95%9C-Spring-IoC\" aria-label=\"완전한 Spring IoC permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>위에서 살펴본 예제는 DI의 작동 방식을 설명하기 위한 것으로 완전한 IoC가 적용된 것으로 보기는 어렵다.\n코드 내에서 직접 컨텍스트를 생성하고, 인스턴스를 만들며, 주입하는 과정이 특정 기술에 의존적인 침투적인 방식으로 작성되었다.\n이제 Spring에 제어권을 넘기고, 컨텍스트의 생성과 객체의 생성 및 조립을 프레임워크에 완전히 위임하는 방식을 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token class-name\">ItemRepository</span> itemRepository<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">printItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>itemRepository<span class=\"token punctuation\">.</span><span class=\"token function\">getItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ItemRepository</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token class-name\">String</span> <span class=\"token function\">getItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ItemRepositoryImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">ItemRepository</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">ItemService</span> <span class=\"token function\">itemService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemService</span><span class=\"token punctuation\">(</span><span class=\"token function\">itemRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">ItemRepository</span> <span class=\"token function\">itemRepository</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ItemRepositoryImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DIApplication</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Autowired</span> <span class=\"token class-name\">ItemService</span> itemService<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DIApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">ApplicationRunner</span> <span class=\"token function\">applicationRunner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> args <span class=\"token operator\">-></span> itemService<span class=\"token punctuation\">.</span><span class=\"token function\">printItemName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>SpringApplication.run 메서드가 실행되면서 메인 스레드의 제어권이 스프링 프레임워크로 넘어간다.\n그 후, Spring 프레임워크는 @Configuration 이 붙은 자바 설정 파일을 읽어 설정 파일에 맞게 객체를 생성하고 조립한다.\n우리는 객체 조립에 대한 설정 파일만 제공한하면 Spring이 나머지 작업을 처리해준다.</p>\n<h2 id=\"마무리\" style=\"position:relative;\">마무리<a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>경량 컨테이너의 특징과 그 장점을 살펴보았고 IoC 컨테이너의 필요성에 대해서도 살펴보았다.\nDependency Injection은 IoC의 중심 역할을 한다는 것을 알게 되었다.\n더불어, 스프링에서 IoC 컨테이너를 어떻게 구성하는지, 그리고 그것이 실제로 어떻게 작동하는지 핵심 인터페이스와 함께 구체적인 예제를 통해 알아보았다.</p>\n<p>스프링은 트랜잭션 추상화, 캐시 추상화, AOP 등의 엔터프라이즈 개발 API를 손쉽게 제공하지만, 그 중심에는 IoC 컨테이너가 있다고 생각한다.\nIoC 컨테이너는 객체지향 조립 프레임워크의 역할을 하며, 이를 통해 객체 지향 설계에 집중할 수 있게 되었다.\n그렇지 않았다면, 객체를 조립하고 생성하는 데에 훨씬 더 많은 시간을 소비했을 것이다.</p>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>Expert One-on-One J2EE Development without EJB (Rod Johnson, Juergen Hoeller) </li>\n<li><a href=\"https://docs.spring.io/spring-framework/reference/core/beans.html\">https://docs.spring.io/spring-framework/reference/core/beans.html</a></li>\n</ul>","fields":{"slug":"/spring-core-container/"},"frontmatter":{"title":"스프링으로 알아보는 IoC 컨테이너의 원리와 이해","date":"October 11, 2023"}},{"id":"c2d0081b-ae3d-5801-ace1-d61452e19444","html":"<h2 id=\"개요\" style=\"position:relative;\">개요<a href=\"#%EA%B0%9C%EC%9A%94\" aria-label=\"개요 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><a href=\"https://px201226.github.io/tomcat/\">지난 게시물</a>에서는 Tomcat의 아키텍처와 클라이언트와의 연결 방식, 그리고 요청 처리 메커니즘에 대해 알아보았다.\n특히, NIO Connector의 Selector를 활용한 이벤트 루프 처리 방식은 BIO Connector에 비해 훨씬 더 많은 연결을 효율적으로 관리하면서 요청을 처리할 수 있게 만들었다.</p>\n<p>이번 게시물에서는 Tomcat이 Selector를 통해 관리하는 수 많은 연결들을 타임아웃 관점에서 어떻게 관리하는지에 대해 살펴본다.</p>\n<h2 id=\"Tomcat의-타임아웃-관리\" style=\"position:relative;\">Tomcat의 타임아웃 관리<a href=\"#Tomcat%EC%9D%98-%ED%83%80%EC%9E%84%EC%95%84%EC%9B%83-%EA%B4%80%EB%A6%AC\" aria-label=\"Tomcat의 타임아웃 관리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>네트워크에서 발생할 수 있는 타임아웃에는 크게 3-way-handshake 중 발생하는 Connection Timeout, Read Timeout, Write Timeout 이 있다.\n이 중 톰캣과 같은 서버 측에서 Connection Timeout은 핸들링 할 수 없는데, 그 이유는 서버에서는 클라이언트 요청을 받기 위해 무한정 대기하고 핸드 쉐이크 중 에러가 발생하더라도\nTCP/IP 스택에서 자동으로 처리되기 때문이다.</p>\n<p>네트워크 상에서 Read/Write Timeout 의미는 데이터를 read/write 위해 최대 대기하는 시간을 의미한다.\n예를 들어 socket.read()에 타임아웃을 10초로 설정했다면, 이는 소켓에서 데이터를 읽기 시작하기 전에 최대 10초 동안 대기할 수 있다는 것을 의미한다.\n만약 9초에 첫 번째 패킷이 도착하고 15초에 모든 패킷 전송이 끝나더라도, socket.read()는 이미 데이터를 읽기 시작했기 때문에 타임아웃이 발생하지 않는다.\n즉, 타임아웃은 데이터가 처음으로 도착하기 전 최대 대기 시간을 말한다. 데이터가 도착하기 시작한 후에는 타임아웃은 적용되지 않는다.</p>\n<p>Spring/Tomcat 에서는 아래와 같은 Timeout 속성을 제공한다. </p>\n<ul>\n<li><strong>server.tomcat.connection-timeout</strong> : 연결을 수락한 후 요청 URI 줄이 제시될 때까지 얼마 동안 기다릴지를 밀리초 단위로 정한다. -1을 사용하면 시간 제한이 없다는 의미다. 기본값은 60초이다.   </li>\n<li><strong>server.tomcat.keep-alive-timeout</strong> : 다른 HTTP 요청을 기다리기 전에 연결을 닫을 때까지 얼마 동안 기다릴지를 밀리초 단위로 정한다. 기본값은 connectionTimeout 속성에 설정된 값을 사용한다. -1 값을 사용하면 시간 제한이 없다는 의미다.</li>\n</ul>\n<p>Tomcat에서는 별도의 Read/Write Timeout 속성은 제공하지 않고 connection-timeout 속성을 제공한다.\nAcceptor 스레드에서 클라이언트 연결이 이루어지면 해당 소켓의 Read/Write Timeout을  connection-timeout으로 설정하고 Poller 에 등록된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">setReadTimeout</span><span class=\"token punctuation\">(</span><span class=\"token function\">getConnectionTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nsocketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">setWriteTimeout</span><span class=\"token punctuation\">(</span><span class=\"token function\">getConnectionTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그 후, Poller는 이벤트 루프를 돌면서 해당 소켓이 타임아웃이 발생하였는지 검사한다.\n아래는 Poller의 이벤트 루프 로직을 단순화 한 것 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">boolean</span> hasEvents <span class=\"token operator\">=</span> <span class=\"token function\">events</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        keyCount <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\n        <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span>\n            keyCount <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t  <span class=\"token function\">processKey</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\t\t\t\t\n        <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span>keyCount<span class=\"token punctuation\">,</span>hasEvents<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Process timeouts</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">processKey(sk, socketWrapper)</code> 에서 준비된 소켓의 처리가 이루어지고 <code class=\"language-text\">timeout(keyCount,hasEvents)</code> 에서 타임아웃 관련 처리가 이루어진다.   </p>\n<h3 id=\"timeoutkeyCounthasEvents\" style=\"position:relative;\">timeout(keyCount,hasEvents)<a href=\"#timeoutkeyCounthasEvents\" aria-label=\"timeoutkeyCounthasEvents permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> keyCount<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> hasEvents<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>timeout 메서드는 현재 selector에 등록된 모든 키의 수인 keyCount와 등록된 채널에서 관심 있는 이벤트가 발생했는 지 여부인 hasEvents 를 인수로 받는다.</p>\n<h4>조건 검사</h4>\n<p>timeout 메서드가 실행되면 첫 번째로 아래의 조건을 검사한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextExpiration <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>keyCount <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> hasEvents<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">&lt;</span> nextExpiration<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>close<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">nextExpiration > 0 &amp;&amp; (now &lt; nextExpiration)</code> : 현재 시간이 nextExpiration까지 아직 경과하지 않았다면</li>\n<li><code class=\"language-text\">(keyCount > 0 || hasEvents)</code> : polling 큐나 selector에 이벤트가 대기 중이라면</li>\n<li><code class=\"language-text\">!close</code> : 서버 소켓이 아직 닫히지 않았다면</li>\n</ul>\n<p>여기서 nextExpiration은 <code class=\"language-text\">System.currentTimeMillis() + socketProperties.getTimeoutInterval()</code>로 계산된다.</p>\n<p>조건의 핵심은 계산된 nextExpiration과 현재 시간을 비교해서 타임아웃 로직을 계속할지 결정하는 것이다.</p>\n<p><code class=\"language-text\">socketProperties.getTimeoutInterval()</code>의 기본 값은 1초로, 이 때문에 무한루프 내에서 1초마다 타임아웃을 검사하게 된다.\n이런 방식은 busy wait로 동작하는데, 짧은 간격으로 계속 실행되기 때문에 스레드 컨텍스트 스위칭 같은 작업 스케줄링 오버헤드를 줄여 성능을 향상시키려는 의도로 보인다.</p>\n<h4>연결되어 있는 모든 소켓 확인</h4>\n<p>Selector에 등록된 모든 SelectionKey를 가져와 연결되어 있는 모든 소켓에 대해서 타임아웃 검사를 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">:</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    keycount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">NioSocketWrapper</span> socketWrapper <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NioSocketWrapper</span><span class=\"token punctuation\">)</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// 생략...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 소켓이 현재 read 작업에 관심이 있다면 readTimeout 판단</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">interestOpsHas</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> delta <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getLastRead</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> timeout <span class=\"token operator\">=</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getReadTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeout <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> delta <span class=\"token operator\">></span> timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        readTimeout <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 소켓이 현재 write 작업에 관심이 있다면 writeTimeout 판단</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>readTimeout <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">interestOpsHas</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_WRITE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> delta <span class=\"token operator\">=</span> now <span class=\"token operator\">-</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getLastWrite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">long</span> timeout <span class=\"token operator\">=</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getWriteTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeout <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> delta <span class=\"token operator\">></span> timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        writeTimeout <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Selector로 관리하는 각 연결의 정보는 SelectionKey에 담겨있다. 이 SelectionKey에서 socketWrapper를 가져와 연결 상태를 파악하고 조절한다.</p>\n<p>socketWrapper로 해당 소켓이 마지막으로 언제 데이터를 읽었는지 (getLastRead)와 썼는지 (getLastWrite) 확인한다.\n현재 시간과 마지막으로 데이터를 읽거나 쓴 시간 사이의 차이를 delta로 계산한다.\n이 delta가 설정된 timeout을 넘으면, 그 연결은 타임아웃으로 간주하고 관련 작업을 수행한다.</p>\n<h4>타임아웃 처리</h4>\n<p>위에서 설정된 writeTimeout, readTimeout 변수를 확인하여 타임아웃이라고 판단되면 cancelledKey 메서드를 호출한다.\ncancelledKey 메서드는 할당되어 있는 자원을 해제하고 소켓 연결을 종료한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readTimeout <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span>readOperation <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>socketWrapper<span class=\"token punctuation\">.</span>readOperation<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>writeTimeout <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span>writeOperation <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>socketWrapper<span class=\"token punctuation\">.</span>writeOperation<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">processSocket</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocketEvent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">ERROR</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">socketWrapper.readOperation.process()</code> 및 <code class=\"language-text\">socketWrapper.writeOperation.process()</code><br>\nsocketWrapper의 readOperation, writeOperation 는 비동기 처리일 때 사용된다.\ntimeout이 발생했을 때 등록된 비동기 작업이 있으면 process() 를 통해 해당 작업을 처리한다.<br>\n만약 비동기 작업 처리에 실패한다면<code class=\"language-text\">(!socketWrapper.readOperation.process() == true) 인 경우</code> cancelledKey 을 호출하여 socket을 close 한다.</li>\n<li><code class=\"language-text\">processSocket(socketWrapper, SocketEvent.ERROR, true)</code><br>\n동기 HTTP 요청 처리을 처리할 때 선택되는 로직이다. processSocket 메서드에 SocketEvent.ERROR라는 Enum 타입을 전달하면 해당 메서드 내에서 SocketEvent의 값에 따라 처리 로직이 분기된다.\nprocessSocket은 Worker threadPool에서 스레드 하나를 할당받아 소켓 이벤트를 처리하게 된다.\n즉, 워커 스레드를 하나 할당받아 socket close 작업을 진행한다.<br>\n만약 Worker Pool에서 스레드 할당에 실패하면 <code class=\"language-text\">(!processSocket(socketWrapper, SocketEvent.ERROR, true) == true)</code> 현재의 Main Thread(Poller Thread)에서 cancelledKey를 호출하여 socket을 close 한다.</li>\n</ul>\n<h2 id=\"Persistent-Connection\" style=\"position:relative;\">Persistent Connection<a href=\"#Persistent-Connection\" aria-label=\"Persistent Connection permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>HTTP 프로토콜은 기본적으로 비연결성(connectionless)를 기반으로 한다. 이는 매 요청마다 3-way-handshake를 맺어야 하는 오버헤드가 발생한다.\n그래서 HTTP/1.1 부터는 매 요청마다 새로운 연결을 맺는 것이 아니라 기존 연결을 재사용할 수 있는 keep-alive 메커니즘을 제공한다.</p>\n<p>그렇다면 tomcat에서는 어떻게 Persistent Connection을 관리할까? 기본적으로 Tomcat 8.0 이후부터는 java.nio의 Selector를 이용하여 소켓을 관리한다.\nSelector를 사용하여 싱글 스레드로도 대량의 Connection들을 관리할 수 있다. 여기서는 Tomcat의 코드 레벨에서 Persistent Connection (Keep-Alive Connection) 과 Non-Persistent Connection (Close Connection) 처리의 차이를 분석해보려고 한다.</p>\n<p>Tomcat의 Http11Processor는 HTTP 프로토콜의 핵심 부분을 구현하는데, Keep-alive 처리 역시 여기서 이루어진다.\nHttp11Processor의 <code class=\"language-text\">service()</code> 메서드는 소켓을 통해 들어오는 HTTP 요청을 처리한다. 요청 헤더를 파싱하고 서블릿으로 요청을 위임하고 요청 상태에 따라 소켓 상태를 결정하여 반환한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">SocketState</span> <span class=\"token function\">service</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketWrapperBase</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> socketWrapper<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">enum</span> <span class=\"token class-name\">SocketState</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">OPEN</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CLOSED</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">LONG</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ASYNC_END</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SENDFILE</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">UPGRADING</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">UPGRADED</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ASYNC_IO</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">SUSPENDED</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">SocketState service(socketWrapper) {\n    요청 정보 및 플래그 초기화\n\n    while (다양한 조건들)\n        요청 헤더 파싱 시도\n        프로토콜 준비\n        서비스 일시 중지 확인\n        요청 헤더 파싱\n        업그레이드 요청 확인\n        요청 준비 및 처리\n        요청 종료 처리\n        요청 카운터 업데이트\n        sendfile 상태 처리\n\n   return 소켓 상태 결정 및 반환\n}</code></pre></div>\n<h3 id=\"Non-Persistent-Connection-처리\" style=\"position:relative;\">Non-Persistent Connection 처리<a href=\"#Non-Persistent-Connection-%EC%B2%98%EB%A6%AC\" aria-label=\"Non Persistent Connection 처리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>HTTP 요청이 Non-persistent 인 경우 service 메서드는 SocketState.CLOSED 를 반환하게 된다.\n워커 스레드는 이 소켓 처리 결과가 SocketState.CLOSED일 경우, 소켓 연결을 종료하고 관련 자원을 해제한다. 아래 코드는 이러한 작업을 수행하는 부분이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handshake <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SocketState</span> state<span class=\"token operator\">=</span><span class=\"token class-name\">SocketState</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OPEN</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Process the request from this socket</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>event<span class=\"token operator\">==</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      state <span class=\"token operator\">=</span> <span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span><span class=\"token class-name\">SocketEvent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OPEN_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n      state <span class=\"token operator\">=</span> <span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>state<span class=\"token operator\">==</span><span class=\"token class-name\">SocketState</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CLOSED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      poller<span class=\"token punctuation\">.</span><span class=\"token function\">cancelledKey</span><span class=\"token punctuation\">(</span><span class=\"token function\">getSelectionKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 <code class=\"language-text\">getHandler().process()</code>는 Http11Processor의 process 메서드를 호출하는 부분이다.\n코드 마지막의 if문에서 process 메서드의 반환값이 SocketState.CLOSED일 때, <code class=\"language-text\">poller.cancelledKey()</code>를 호출해 연결을 종료하는 것을 확인할 수 있다.</p>\n<p>HTTP 요청이 Non-persistent 인지 판단하는 조건은 여러 가지 있는데 Non-persistent에 해당하는 조건이면 keepAlive 변수를 false로 변경하고 service() 메서드의 반환값으로 SocketState.CLOSED 를 리턴한다. 판단 조건은 대표적으로 아래와 같은 것들이 있다.</p>\n<h4>HTTP/1.0 으로 호출하는 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>protocolMB<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">HTTP_10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    http09 <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    http11 <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>   </code></pre></div>\n<h4>keep-alive 최대 요청이 1이거나 최대 요청을 초과한 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">int</span> maxKeepAliveRequests <span class=\"token operator\">=</span> protocol<span class=\"token punctuation\">.</span><span class=\"token function\">getMaxKeepAliveRequests</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxKeepAliveRequests <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// keep-alive max=1 인 경우</span>\n    keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>maxKeepAliveRequests <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">decrementKeepAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// keep-alive max값 보다 요청을 더 많이 한 경우</span>\n    keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>HTTP 응답 상태코드가 200 범위가 아닌 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">checkExpectationAndResponseStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">hasExpectation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isRequestBodyFullyRead</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n            <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">200</span> <span class=\"token operator\">||</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">299</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Client sent Expect: 100-continue but received a</span>\n        <span class=\"token comment\">// non-2xx final response. Disable keep-alive (if enabled)</span>\n        <span class=\"token comment\">// to ensure that the connection is closed. Some clients may</span>\n        <span class=\"token comment\">// still send the body, some may send the next request.</span>\n        <span class=\"token comment\">// No way to differentiate, so close the connection to</span>\n        <span class=\"token comment\">// force the client to send the next request.</span>\n        inputBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">setSwallowInput</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>요청 헤더에 Connection: close 로 명시한 경우</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">MimeHeaders</span> headers <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getMimeHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Check connection header</span>\n<span class=\"token class-name\">MessageBytes</span> connectionValueMB <span class=\"token operator\">=</span> headers<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CONNECTION</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>connectionValueMB <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>connectionValueMB<span class=\"token punctuation\">.</span><span class=\"token function\">isNull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> tokens <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashSet</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">TokenList</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseTokenList</span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CONNECTION</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tokens<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CLOSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Constants</span><span class=\"token punctuation\">.</span><span class=\"token constant\">KEEP_ALIVE_HEADER_VALUE_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        keepAlive <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"Persistent-Connection-처리\" style=\"position:relative;\">Persistent Connection 처리<a href=\"#Persistent-Connection-%EC%B2%98%EB%A6%AC\" aria-label=\"Persistent Connection 처리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Persistent Connection이 유지되는 조건은 위의 Non-Persistent 요청이 아니라면 Keep-Alive 가 동작하여 소켓 연결을 계속 유지한다.\n이는 HTTP 헤더에 <code class=\"language-text\">Connection: Keep-alive</code> 를 명시하지 않아도 기본값으로 Keep-alive가 동작된다는 얘기이다.\n대신 response 헤더에 <code class=\"language-text\">Connection: Keep-alive</code> 와 <code class=\"language-text\">Keep-Alive: timeout=60, max=1000</code>와 같은 헤더가 나오지 않으니 클라이언트를 위해 명시적으로 요청하는것이 좋다.</p>\n<p>Persistent Connection 은 <code class=\"language-text\">server.tomcat.keep-alive-timeout</code> 속성을 통해 이루어진다.\n만약 keep-alive-timeout 동안 어떤 read/write 활동도 없다면 해당 연결은 종료된다.</p>\n<p>그럼 keep-alive-timeout은 어떻게 처리될까?\nTomcat은 클라이언트와 처음 연결한 후, Read Timeout을 기준으로 타임아웃 여부를 판단한다.\nRead Timeout 내에 클라이언트로부터 데이터가 도착하면 요청을 정상적으로 처리하고 응답한다.\n만약 이 요청이 Persistent Connection 요청이라면, Read Timeout 값을 keep-alive-timeout으로 바꾼다.\n그리고 나서는 이전에 설명한 Read/Write 타임아웃 관리 방식으로 연결을 계속 유지하고 관리한다.</p>\n<p>만약 클라이언트의 요청이 keep-alive-timeout 내에 계속 들어온다면, 해당 연결의 타임아웃은 계속해서 초기화되어 연결이 지속된다.\n이는 타임아웃이 현재 시간과 소켓에서 마지막으로 Read/Write한 시간을 기준으로 계산되기 때문이다.</p>\n<p>서버에서 연결을 유지하려고 해도 클라이언트도 해당 연결을 유지해야 keep-alive가 제대로 작동한다.\n예를 들어, curl을 사용하여 keep-alive로 요청을 보내도 curl 프로그램이 종료될 때 클라이언트에서 소켓을 먼저 닫아버리기 때문에 Persistent Connection은 유지되지 않는다.</p>\n<p>그리고 keep-alive의 주요 목적은 이미 맺어진 연결을 재사용하는 것이다.\n따라서 클라이언트가 새로운 소켓을 통해 요청을 보내면, 서버와는 새로운 연결이 형성된다. 이 경우, 다른 소켓에서 유지되는 Persistent Connection과는 별개로 동작하므로 재사용할 수 없다.</p>\n<h2 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Tomcat에서는 연결들을 타임아웃의 관점에서 어떻게 관리하는지, 특히 Read/Write Timeout과 Persistent Connection에 초점을 맞춰 살펴보았다.\n이 과정에서 busy wait 방식을 사용하여 지속적으로 타임아웃을 검사하는 것을 확인했다.\n더불어, Tomcat에서는 <code class=\"language-text\">read-timeout</code> 또는 <code class=\"language-text\">write-timeout</code> 없이 <code class=\"language-text\">connection-timeout</code> 이라는 명칭으로 타임아웃 값을 설정하는데,\n이는 Persistent Connection의 경우 <code class=\"language-text\">keep-alive-timeout</code>으로 변경되기 때문에 <code class=\"language-text\">connection-timeout</code> 명칭을 쓰지 않았나 싶다.</p>","fields":{"slug":"/tomcat-connection/"},"frontmatter":{"title":"Tomcat은 어떻게 Connection을 관리할까?","date":"October 07, 2023"}},{"id":"95f697c4-8442-5eca-942d-91d8eeb8cc56","html":"<h2 id=\"버퍼-IO\" style=\"position:relative;\">버퍼 I/O<a href=\"#%EB%B2%84%ED%8D%BC-IO\" aria-label=\"버퍼 IO permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>운영체제의 I/O는 모두 버퍼를 통해 이루어진다. 프로세스는 버퍼에서 데이터를 채우는 (쓰기) 또는 버퍼에 데이터를 비우는 (읽기) 작업을 운영 체제에 요청함으로써 I/O를 수행한다.\n모든 데이터는 이 메커니즘을 통해 프로세스 내부로 이동하거나 나간다.\n<figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 569px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b0b73aee6b97cb3d63f04ffdca748d26/7ca0c/img_6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.705882352941174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABB0lEQVR42l1R26qDMBDs//+S2EdLxQfFVvFKq1BLq1ZFqoJ2zpmFnBMa2FwmOzOb7A6/4/P5YNs2rOsqwb0667gK5qvBvX7ekUBgnmf0fY+u66AwFcTbtsUwDEJSRrrQnyCn9/uNJElwOp0QhiHO5zOezycul4usiny/35FlGaqqkjuuDHKapvkXHMcRvu/Dsiy4rgvDMBAEAcqyFALNiFMwjmN4ngfHcXA8HpHnOYqikKCOCE7ThDRNYZomDoeDuD8eD3F8vV6wbRv7/V4wVsuqb7eb3Kl/5OtoJoLLsuB6vUrprIZR17Uk8/9IZqUU0Jug9jSJokheJIKqq3qCjn13VM/9bsoPVVAUpUmOppgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"운영체제 I/O\"\n        title=\"\"\n        src=\"/static/b0b73aee6b97cb3d63f04ffdca748d26/7ca0c/img_6.png\"\n        srcset=\"/static/b0b73aee6b97cb3d63f04ffdca748d26/e7570/img_6.png 170w,\n/static/b0b73aee6b97cb3d63f04ffdca748d26/f46e7/img_6.png 340w,\n/static/b0b73aee6b97cb3d63f04ffdca748d26/7ca0c/img_6.png 569w\"\n        sizes=\"(max-width: 569px) 100vw, 569px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">운영체제 I/O</figcaption>\n  </figure></p>\n<p>위 그림에서 사용자 공간(user space)과 커널 공간(kernel space)의 개념에 주목하자.\n사용자 공간은 일반 프로세스가 실행되는 곳이다. JVM도 사용자 공간에서 실행된다. 사용자 공간은 특권이 없어 하드웨어에 직접 접근할 수 없다.\n커널 공간은 운영 체제가 위치하는 곳으로 특별한 권한을 가진다. 모든 I/O는 커널 공간을 통해 이루어진다.</p>\n<p>프로세스가 I/O 작업을 요청하면 시스템 호출을 수행하여 커널로 제어권을 전달한다.\n커널은 필요한 데이터를 찾아 사용자 공간의 지정된 버퍼로 전송한다.\n커널은 데이터를 캐시하거나 미리 가져오려고 시도하기 때문에 프로세스가 요청하는 데이터는 이미 커널 공간에 있을 수 있다.</p>\n<p>기존 java.io 라이브러리와 NIO 간의 가장 중요한 차이점은 데이터를 패키지하고 전송하는 방법과 관련이 있다.\n운영 체제는 데이터를 큰 덩어리(버퍼)로 이동시키려고 하는 반면, 스트림 기반 I/O 클래스는 작은 단위(단일 바이트나 텍스트의 줄)로 데이터를 처리하려고 한다.\nJava의 NIO는 이러한 불일치를 해결하기 위해 도입되었다.\nNIO는 한 번에 여러 바이트의 데이터 블록을 처리하고 운영 체제의 native I/O 를 더욱 활용하여 기존 I/O의 한계를 극복한다.</p>\n<h2 id=\"Buffer\" style=\"position:relative;\">Buffer<a href=\"#Buffer\" aria-label=\"Buffer permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Buffer 객체는 고정된 양의 데이터를 관리하는 컨테이너이다. 버퍼는 채워지고 비워진다.\n버퍼는 채널과 밀접하게 작동한다. 채널은 I/O 전송이 이루어지는 포털이며, 버퍼는 그 데이터 전송의 출발지나 대상이다. 나가는 전송의 경우, 전송하고 싶은 데이터는 버퍼에 넣어져 채널로 전달된다.\n들어오는 전송의 경우, 채널은 제공하는 버퍼에 데이터를 저장한다.\n버퍼 사이의 협력하는 객체 사이의 이러한 핸드오프는 데이터 처리의 효율성을 향상시키는 핵심이다</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/88f114d19acec492c041fab251e6c7fc/a0e79/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.17647058823529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGElEQVR42p1SiaqDMBDM/39bEbQe4FG8KtaqPbwoaucxCylCH6+PLiTZbCazk90ofLBlWdA0DW63G9Z1/QSH2m6ez+draHs8HiiKAlmWoe/7N9wW+0a4JaYyWlVVSJIEjuPgeDy+VP+pkE+Z5xnjOOJ6veJyueB0OiHPcwRBAMMwsNvtxCcpkxBD7DRNcleXQzHg+z5c10Ucx7BtW9REUSREh8NB/DAMxbcsS3CmaWK/30uMKzHDMEBxYrbz+SxB1okgqrjf70LUtq3UME1TucQSsK6M87zrOpRlKXcU5fKAnSQx/bqupatcudcJ+cQtljHiSM7BBip8abq7JGcZPM+TZOq3b/DfoQnZQCpkE79WqI0/g6S6JD+UqAFOMqByiQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Buffer 종류\"\n        title=\"\"\n        src=\"/static/88f114d19acec492c041fab251e6c7fc/ca1dc/img.png\"\n        srcset=\"/static/88f114d19acec492c041fab251e6c7fc/e7570/img.png 170w,\n/static/88f114d19acec492c041fab251e6c7fc/f46e7/img.png 340w,\n/static/88f114d19acec492c041fab251e6c7fc/ca1dc/img.png 680w,\n/static/88f114d19acec492c041fab251e6c7fc/a0e79/img.png 824w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Buffer 종류</figcaption>\n  </figure></p>\n<h3 id=\"Buffer-속성\" style=\"position:relative;\">Buffer 속성<a href=\"#Buffer-%EC%86%8D%EC%84%B1\" aria-label=\"Buffer 속성 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Buffer 에는 4가지 속성이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Buffer</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token comment\">// Invariants: mark &lt;= position &lt;= limit &lt;= capacity</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> mark <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> position <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> limit<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> capacity<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>mark : 기억된 위치. mark() 호출시 mark = position으로 설정된다. reset() 호출시 position = mark로 설정된다. 설정되기 전까지 mark는 정의되지 않는다.</li>\n<li>position: 다음에 읽거나 쓸 요소의 인덱스. 상대적인 get() 및 put() 메서드에 의해 자동으로 업데이트 된다.</li>\n<li>limit: 버퍼에서 읽거나 쓸 수 있는 첫 번째 요소가 아닌 요소. 즉, 버퍼 내의 활성 요소의 수를 나타낸다.</li>\n<li>capacity: 버퍼가 가질 수 있는 데이터 요소의 최대 개수. 버퍼가 생성될 때 설정되며 변경할 수 없다.</li>\n</ul>\n<p>이 네 가지 속성 간의 관계는 항상 다음을 만족한다.<br>\n0 ≤ mark ≤ position ≤ limit ≤ capacity</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 529px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19039da6aeb3844fa83299244996eb44/3e20f/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA10lEQVR42n1R2QqEMAzc//8sH0XEF19URPDA+z7xyO4M1H3YxYE0TTOdpOlLPhjHUbZtk3Vdacuy0I7jkGma7twwDLLvO+N5npmD4X5RFJCSF5amaaQsS6mqioksyyRNU8nznHvl1ZmKwcU9+L7vWYyCruuKbduSJIlEUcQCbdve/p8hF4YhixiGIZqmfTvsuo5iqAKCav8J4MdxzDGgS8dxOCIKBkHAAwBipmmSCJznKdd1/ZhlWeL7PjmYr67rLELBuq4ZKEHP8zj4J+AleDqAj0FDGMMb2JrKJuRJHroAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Buffer.png\"\n        title=\"\"\n        src=\"/static/19039da6aeb3844fa83299244996eb44/3e20f/img_1.png\"\n        srcset=\"/static/19039da6aeb3844fa83299244996eb44/e7570/img_1.png 170w,\n/static/19039da6aeb3844fa83299244996eb44/f46e7/img_1.png 340w,\n/static/19039da6aeb3844fa83299244996eb44/3e20f/img_1.png 529w\"\n        sizes=\"(max-width: 529px) 100vw, 529px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Buffer.png</figcaption>\n  </figure></p>\n<p>예를 들어, 10의 용량을 가진 Buffer는 위의 그림과 같이 속성이 초기화된다.\nmark는 mark()가 호출되기 전까지 정의되지 않고, postition은 0으로 설정되고, capcatity와 limit은 10으로 설정된다.\n이 상태에서 데이터를 5개만 쓴 후에 버퍼를 읽기 모드로 전환한다면(flip()을 호출), limit는 5로 설정된다.\n즉, 처음 5개의 데이터 요소만 읽을 수 있다는 얘기이다.</p>\n<h3 id=\"Buffer-접근\" style=\"position:relative;\">Buffer 접근<a href=\"#Buffer-%EC%A0%91%EA%B7%BC\" aria-label=\"Buffer 접근 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>ByteBuffer와 같은 Buffer 클래스의 서브클래스에는 get(), put() 연산이 존재한다.\n이 연산은 상대적 연산과 절대적 연산으로 수행된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ByteBuffer</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Buffer</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Comparable</span> <span class=\"token punctuation\">{</span>\n\t\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">byte</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">byte</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">ByteBuffer</span> put <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">ByteBuffer</span> put <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> index<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>버퍼는 데이터 요소를 일정한 크기로 저장하는데 필요에 따라 버퍼를 완전히 채우지 않고 일부분만 채우고 버퍼를 다른 곳으로 전송하거나 읽을 수 있어야 할 것 이다.\n이때, 어디까지 데이터가 채워졌는지, 다음 데이터가 어디에 위치해야 하는지 등을 알아야 되는데 이를 위해 position 이 있다.\nByteBuffer 클래스의 index 인수를 받지 않는 get()과 put() 메서드는 이 position을 이용한 상대적 연산이다.</p>\n<p>상대적 연산은 position 값을 기준으로 데이터를 읽거나 쓰고, get(), put()을 호출하면 position 값이 1 증가한다.\n만약, put()을 호출할 때 position >= limit 이 되면 BufferOverflowException 발생하고\n마찬가지로 get()을 호출할 때 position >= limit 이라면 BufferUnderflowException 이 발생한다.</p>\n<p>절대적 연산은 특정 버퍼 위치(index)에 직접 데이터를 읽거나 쓴다.\n이 연산은 position의 값을 변경하지 않고, 버퍼의 인덱스 범위를 벗어나면 IndexOutOfBoundsException이 발생한다.</p>\n<h3 id=\"Buffer-채우기\" style=\"position:relative;\">Buffer 채우기<a href=\"#Buffer-%EC%B1%84%EC%9A%B0%EA%B8%B0\" aria-label=\"Buffer 채우기 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>아래 코드는 capacity가 10인 ByteBuffer를 할당하고, 'hello' 라는 문자를 바이트로 버퍼에 채우는 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">ByteBuffer</span> byteBuffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> bytes <span class=\"token operator\">=</span> <span class=\"token string\">\"hello\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbyteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 538px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3802ba7c05ebb4908010cd7f5e2ae42a/32ca7/img_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDUlEQVR42n2SyY6DQAxE+f8v48YpCA4Q9n2HEPaKyiNGfchMS5bBbT+XDRrUc134di4lfn3JUWNa27ZYlgXzPOP9fuP1emGaJqzrKp7GO/pxHCWH1ve9xJgfhiHO8/wBep4H3/dBH8exXEZRhDRN4TgOuq7DMAyo6xpN04ACbk8ry1IaUIAACXk+n3BdF0EQCJwgxmi2bePxeKAoCiRJIo3yPBd/C9B1XRoLUN3FcRzIskwK6KuqEjhh6q64AoKYQzCBnEKAHI+dmMy9UCFH+O/j3MopgIc1nE6AHNU0TXkhmN24/BtwmwpksWVZvzHDMGQtfNbYZd93udy2TZZ7/fH7qKu51TGXfwlrqfADWHplVUTcTmsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"buffer 채우기\"\n        title=\"\"\n        src=\"/static/3802ba7c05ebb4908010cd7f5e2ae42a/32ca7/img_2.png\"\n        srcset=\"/static/3802ba7c05ebb4908010cd7f5e2ae42a/e7570/img_2.png 170w,\n/static/3802ba7c05ebb4908010cd7f5e2ae42a/f46e7/img_2.png 340w,\n/static/3802ba7c05ebb4908010cd7f5e2ae42a/32ca7/img_2.png 538w\"\n        sizes=\"(max-width: 538px) 100vw, 538px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">buffer 채우기</figcaption>\n  </figure></p>\n<h3 id=\"Flipping\" style=\"position:relative;\">Flipping<a href=\"#Flipping\" aria-label=\"Flipping permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Buffer를 채우기 버퍼의 데이터를 읽기 위해서는 Flipping 을 통해 Buffer의 동작을 전환해야한다.\nBuffer에 'hello'가 채워진 상태에서(position=5)에서 get()을 하게 되면 빈 값을 가져올 것 이다.\n따라서, Buffer에 채워진 데이터를 읽기 위해서는 아래와 같은 작업이 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">buffer<span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>buffer의 읽을 수 있는 값을 현재 buffer의 position으로 설정하고, 현재 position을 읽기 작업을 위해 0으로 설정한다.\n이 작업은 buffer.flip() 메서드와 같은 동작을 한다.</p>\n<h3 id=\"Draining\" style=\"position:relative;\">Draining<a href=\"#Draining\" aria-label=\"Draining permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Draining 이란 Buffer에서 데이터를 읽어 오는 것을 의미한다. 위에서 Buffer에 데이터를 읽기 전에 Flipping 이라는 작업이 필요하다는 것을 설명했다.\nFlipping후 Buffer의 읽기모드로 바꿔 position 에서 시작하여 limit 전까지의 데이터를 읽어야 한다.</p>\n<p>이 때, 사용되는 메서드가 hasRemaining() 과 remaining() 이다.\nhasRemaining() 는 현재 position과 limit을 비교하여 읽을 수 있는 데이터 있는지 여부를 반환한다.\nremaining()은 현재 position에서 limit 까지 남아있는 데이터의 수를 반환한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">hasRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tbyteArray<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"Marking\" style=\"position:relative;\">Marking<a href=\"#Marking\" aria-label=\"Marking permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>mark()메서드는 호출될 때 Buffer 클래스의 mark 속성을 현재 position 값으로 변경한다.\n이는 위리를 기억하고 있다가 나중에 해당 위치로 돌아갈 수 있도록 하기 위함이다.\nreset() 메서드는 position을 현재 mark 값으로 설정한다. mark 값이 정의되어 있지 않다면 Exception이 발생한다.</p>\n<p>밑에 코드를 실행하면 Buffer는 아래 그림과 같은 상태가 된다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">buffer<span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mark</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">position</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 518px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d8c8957da569f5b8f477c50dd0f0af2/2f227/img_3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVR42nWRW4+CUAyE+f8/y8QXicYXDRG8AILiBRQUEJXZfE00+7A7SVPOOW1nOjhVVanrOj0eD8tt2+r5fFq+3W56v99qmkZ1XVvmnjr6+L7f77peryqKQsBZLBba7/fa7XY6nU46HA46Ho+WuaNwvV6rLEsLmok8z+3M+/l8/pI7nudZg+/7Wi6Xms/nWq1WCsNQ0+lUm81GkEZRpDiOjSzLMos0Tb/B0NfrJQfp2+3WggGu65oCmofDoa0EM4PH4/F3GMo+9nBGkK2cJIkx0MTwIAhMBX5x9xs0Q4AdbIWv4HK52Lnvezmz2cxWAgwfjUamEFDwF/gpk8nEtgLYMxgMzFMHNTAAjOYRdf8BEoI1P3X4h8dY8AOPxBIaCtS0VQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Marking\"\n        title=\"\"\n        src=\"/static/1d8c8957da569f5b8f477c50dd0f0af2/2f227/img_3.png\"\n        srcset=\"/static/1d8c8957da569f5b8f477c50dd0f0af2/e7570/img_3.png 170w,\n/static/1d8c8957da569f5b8f477c50dd0f0af2/f46e7/img_3.png 340w,\n/static/1d8c8957da569f5b8f477c50dd0f0af2/2f227/img_3.png 518w\"\n        sizes=\"(max-width: 518px) 100vw, 518px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Marking</figcaption>\n  </figure></p>\n<p>mark=2 이고, 현재 position이 4이므로 이 상태에서 read를 하게 되면 'ow' 를 읽을 것 이다.\n여기서 reset()을 하면 현재 position 값을 2로 설정된다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 531px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/131dab0da4277abba67a9fd2a2a1e579/b2c14/img_4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABA0lEQVR42m1RSY6DQAzM/7/DC3LlRA4cQBAWiS3s+05lyhEoisZStd22u2RX3/Bn+75jWRZs2yY443VdL/zm53mWO8G4bVtS4cajKAp4nieeKMsSVVUhz3OkaSpIkgR1XaNpGgF7eP/uO47jQxiGIUzTxPP5FOi6Dtu24TiO5Ol5j+NYiLMsExLGzEVRJOScVAjHcUQQBFIgmaIo6PseXdddmKZJaoZhCBGH4KTsIxlr18pMWpYlBWrEB8Mw4NdYYw/18n1fpqRRR25AL4Sc7PF4iNhMqqoK13Vxfhi1+QaNhJqmSUw97/c7Xq/Xh5Dr8DNoJKUuXPM/OwkpEz/kjPmG/g0ojBY906QKLgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"reset 후 상태\"\n        title=\"\"\n        src=\"/static/131dab0da4277abba67a9fd2a2a1e579/b2c14/img_4.png\"\n        srcset=\"/static/131dab0da4277abba67a9fd2a2a1e579/e7570/img_4.png 170w,\n/static/131dab0da4277abba67a9fd2a2a1e579/f46e7/img_4.png 340w,\n/static/131dab0da4277abba67a9fd2a2a1e579/b2c14/img_4.png 531w\"\n        sizes=\"(max-width: 531px) 100vw, 531px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">reset 후 상태</figcaption>\n  </figure></p>\n<h3 id=\"Comparing\" style=\"position:relative;\">Comparing<a href=\"#Comparing\" aria-label=\"Comparing permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>버퍼 두개가 동일하다는 것은 다음 조건을 만족해야 한다.</p>\n<ul>\n<li>두 객체가 같은 타입이어야 한다.</li>\n<li>두 버퍼에 남아있는 요소의 수가 같아야 한다. (즉, position에서 limit까지 요소 수)</li>\n<li>남아있는 데이터 요소의 순서가 각 버퍼에서 동일해야 한다.</li>\n</ul>\n<p>compare 는 다음과 같은 기준으로 비교된다. 여기서 크다 작다는 버퍼의 남아있는 요소의 수가 많냐 적냐를 말한다.</p>\n<ul>\n<li>음수: 메서드를 호출한 버퍼가 전달된 버퍼보다 작다.</li>\n<li>0: 두 버퍼가 동일하다.</li>\n<li>양수: 메서드를 호출한 버퍼가 전달된 버퍼보다 크다.</li>\n</ul>\n<h3 id=\"Buffer의-생성\" style=\"position:relative;\">Buffer의 생성<a href=\"#Buffer%EC%9D%98-%EC%83%9D%EC%84%B1\" aria-label=\"Buffer의 생성 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Buffer는 생성자를 통해 직접 생성할 수 없다. 인스턴스를 생성하기 위해서는 각 클래스의 정적 팩토리 메서드를 사용해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 사이즈 100인 char형 buffer </span>\n<span class=\"token class-name\">CharBuffer</span> charBuffer <span class=\"token operator\">=</span> <span class=\"token class-name\">CharBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// wrap 을 사용한 버퍼 생성</span>\n<span class=\"token keyword\">char</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> myArray <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">char</span> <span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">CharBuffer</span> charbuffer <span class=\"token operator\">=</span> <span class=\"token class-name\">CharBuffer</span><span class=\"token punctuation\">.</span>wrap <span class=\"token punctuation\">(</span>myArray<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// CharSequence를 입력받는 wrap</span>\n<span class=\"token class-name\">CharBuffer</span><span class=\"token punctuation\">.</span>wrap <span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello World\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>wrap을 이용한 Buffer는 읽기/쓰기 작업 시, 실제 myArray를 참조하게 된다. 이렇게 생성한 Buffer를 non-direct buffer라고 한다.\nnon-direct buffer는 실제 데이터를 저장하기 위해 내부적으로 배열을 사용한다. 이 배열이 바로 backing arrays 라고 한다. wrap 의 예에서는 myArray가 backing array가 된다.\n이와 반대로, direct Buffer 는 JVM 밖의 위치하는 네이티브 메모리 영역에 직접 할당되어 GC에 영향받지 않는다.</p>\n<h3 id=\"ByteBuffer\" style=\"position:relative;\">ByteBuffer<a href=\"#ByteBuffer\" aria-label=\"ByteBuffer permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>기본 원시 타입(int, long, char 등)에 대한 버퍼가 있지만 그 중에서도 ByteBuffer 는 특별하다.\n기본 원시 타입은 연손적인 바이트 시퀀스로 메모리에 저장된다.\n또한, JVM과 운영 체제 간에 데이터를 이동할 때 바이트 중심으로 이루어지기 때문이다. 때문에 다른 원시 타입에는 없는 ByteBuffer 만의 고유 API를 가진다.</p>\n<table>\n<thead>\n<tr>\n<th>Data Type</th>\n<th>Size (bytes)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Byte</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Char</td>\n<td>2</td>\n</tr>\n<tr>\n<td>Short</td>\n<td>2</td>\n</tr>\n<tr>\n<td>Int</td>\n<td>4</td>\n</tr>\n<tr>\n<td>Long</td>\n<td>8</td>\n</tr>\n<tr>\n<td>Float</td>\n<td>4</td>\n</tr>\n<tr>\n<td>Double</td>\n<td>8</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>HTTP 에서는 8비트로 구성된 바이트를 옥텟(octet)이라고 한다. 이는 초기 컴퓨터에서 바이트가 꼭 8비트를 의미하는 것은 아니였기 때문이다.</p>\n</blockquote>\n<p>ByteBuffer 는 다른 버퍼 유형과 다르게 채널에 의한 I/O 작업의 대상이 될 수 있다. 채널은 ByteBuffer만을 인자로 받기 때문이다.\n운영제제의 I/O는 연속된 바이트 메모리 영역에서 수행되는데, JVM 내에서의 바이트 배열은 연속적으로 메모리에 저장되지 않을 수 있으며, 가비지 컬렉터에 의해 언제든지 이동될 수 있다.\n그래서 바이트 배열이 연속적인 메모리 공간에 저장되는지는 JVM의 구현에 따라 달라질 수 있다.</p>\n<p>이런 문제점을 해결하기 위해 direct buffer가 있다. direct buffer는 채널 및 네이티브 I/O 함수와 상호작용하기 위해 설계되었다.\ndirect buffer는 네이티브 메모리 영역에 직접 할당되어 데이터를 JVM의 메모리에서 운영 체제의 메모리로 복사할 필요 없이 바로 네이티브 I/O 연산에 사용할 수 있다.\n그래서 일반적으로 I/O 작업 시에는 direct buffer를 사용하는데, non-direct buffer를 채널로 전달하게 되면 채널은 내부적으로 다음과 같은 작업을 수행한다.</p>\n<ol>\n<li>임시 direct buffer 를 생성한다.</li>\n<li>non-direct buffer의 데이터를 direct buffer로 복사한다.</li>\n<li>direct buffer를 사용하여 I/O 작업을 수행한다.</li>\n<li>작업이 끝나면, 임시 direct buffer는 GC된다.</li>\n</ol>\n<p>대신 일반적으로 direct buffer 생성 비용은 non-direct buffer 생성 비용보다 클 수 있다. direct 버퍼는 운영체제 코드를 통해 할당되기 때문이다.\ndirect buffer는 ByteBuffer 클래스의 allocateDirect() 정적 팩토리 메서드로 생성할 수 있다.</p>\n<h3 id=\"View-Buffer\" style=\"position:relative;\">View Buffer<a href=\"#View-Buffer\" aria-label=\"View Buffer permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>뷰 버퍼는 원본 버퍼와 데이터를 공유하지만, 자체적인 속성 (예: position, limit, capacity 등)을 가진다.\n이는 뷰 버퍼를 통해 데이터를 읽거나 쓸 때 원본 버퍼의 데이터가 변경되며, 반대의 경우도 마찬가지이다.\n위에서 나온 duplicate()와 wrap() 메서드로 만든 버퍼도 뷰 버퍼의 일종으로 볼 수 있다.</p>\n<p>뷰 버퍼의 주요 사용 사례는 ByteBuffer의 바이트 데이터를 다른 원시 타입으로 해석할 필요가 있을 때이다.\n이 때, ByteBuffer의 asIntBuffer(), asCharBuffer() 등의 팩토리 메서드를 통해 원하는 원시 타입의 뷰 버퍼를 생성할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ByteBuffer</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Buffer</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Comparable</span> <span class=\"token punctuation\">{</span>\n  \n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">CharBuffer</span> <span class=\"token function\">asCharBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">ShortBuffer</span> <span class=\"token function\">asShortBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">IntBuffer</span> <span class=\"token function\">asIntBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">LongBuffer</span> <span class=\"token function\">asLongBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">FloatBuffer</span> <span class=\"token function\">asFloatBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token class-name\">DoubleBuffer</span> <span class=\"token function\">asDoubleBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>    </code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bcf2377a68a305cc95f39ad0d3300f94/3a6ec/img_5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVR42n2RZ6rEMAyEc/+T5QbZ/MmGTds00nvR8gkc8iA8g7BsS6OZsSX/rOM45DxPjaf8aVlPlxSv6ypZlklVVZLnuRRFceVlWcr3+5WmaaTvexmGQbqu0x7rCWiaJpnnWRsAADhNU83jOJYkSSQIAgXZtk2WZdE+mCvgvu96yTSCR+4IGtjHcdQBBEDUM5j3uwUKaFjc5bEbebDiDgDkceYN1uSQMP4qYBiG4nmeNjGdJqKuax1i27ZEUSRGjeu6F8vX6yWO41yWKSAsDLvP53N5So5EwPENAJQYhlgDGYZB5o9kAKHu+75KI2g03r7fb/ULYH6Yc9u2WmM+SgGN9nvwAbAyRt/fzGIQNXyIqQHwB5utto08uG2NAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"char형 view buffer\"\n        title=\"\"\n        src=\"/static/bcf2377a68a305cc95f39ad0d3300f94/ca1dc/img_5.png\"\n        srcset=\"/static/bcf2377a68a305cc95f39ad0d3300f94/e7570/img_5.png 170w,\n/static/bcf2377a68a305cc95f39ad0d3300f94/f46e7/img_5.png 340w,\n/static/bcf2377a68a305cc95f39ad0d3300f94/ca1dc/img_5.png 680w,\n/static/bcf2377a68a305cc95f39ad0d3300f94/3a6ec/img_5.png 686w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">char형 view buffer</figcaption>\n  </figure></p>\n<h2 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><strong>버퍼 기반 I/O</strong></p>\n<ul>\n<li>운영체제의 모든 I/O 작업은 버퍼를 통해 이루어진다.</li>\n<li>프로세스는 데이터를 버퍼에 쓰거나 버퍼에서 데이터를 읽음으로써 I/O를 수행한다.</li>\n<li>사용자 공간에서는 하드웨어에 직접 접근할 수 없으며, 모든 I/O는 커널 공간을 통해 이루어진다.   </li>\n</ul>\n<p><strong>Java NIO</strong></p>\n<ul>\n<li>기존 java.io 라이브러리와 NIO의 주요 차이는 데이터 처리 방식에 있다.</li>\n<li>운영 체제는 데이터를 큰 덩어리(버퍼)로 처리하는 반면, 스트림 기반 I/O는 작은 단위로 데이터를 처리한다.</li>\n<li>NIO는 이러한 불일치를 해결하며, 한 번에 여러 바이트의 데이터 블록을 처리한다.   </li>\n</ul>\n<p><strong>Buffer</strong></p>\n<ul>\n<li>Buffer는 고정된 양의 데이터를 관리하는 컨테이너로, 데이터 전송의 출발지나 대상이 된다.</li>\n<li>Buffer는 채워지고 비워지며, 주요 속성으로는 mark, position, limit, capacity가 있다.</li>\n<li>Buffer는 데이터를 읽고 쓸 때 상대적 연산과 절대적 연산을 제공한다.   </li>\n</ul>\n<p><strong>ByteBuffer</strong></p>\n<ul>\n<li>ByteBuffer는 특별하며, 바이트 중심의 I/O 작업의 대상이 될 수 있다.</li>\n<li>ByteBuffer는 direct buffer와 non-direct buffer 두 종류가 있으며, direct buffer는 네이티브 메모리 영역에 직접 할당된다.</li>\n<li>뷰 버퍼는 원본 버퍼와 데이터를 공유하지만, 자체적인 속성을 가진다.</li>\n</ul>","fields":{"slug":"/java-nio-buffer/"},"frontmatter":{"title":"Java NIO - Buffer","date":"October 03, 2023"}},{"id":"4ac73c64-d597-5ac3-9c91-6214595d54be","html":"<h2 id=\"Socket-Option\" style=\"position:relative;\">Socket Option<a href=\"#Socket-Option\" aria-label=\"Socket Option permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>소켓 옵션은 자바의 Socket 클래스가 사용하는 네트워크 소켓이 데이터를 어떻게 보내고 받을 것인지를 결정한다. 자바에서는 클라이언트 측 소켓에 대해 9가지 옵션이 존재한다.</p>\n<ul>\n<li>TCP_NODELAY</li>\n<li>SO_BINDADDR</li>\n<li>SO_TIMEOUT</li>\n<li>SO_LINGER</li>\n<li>SO_SNDBUF</li>\n<li>SO_RCVBUF</li>\n<li>SO_KEEPALIVE</li>\n<li>OOBINLINE</li>\n<li>IP_TOS</li>\n</ul>\n<p>java.net.SocketOptions 인터페이스에 각 옵션이 정의되어 있고 socket 클래스의 메서드를 통해 옵션을 설정할 수 있다. 여기서는 주요 옵션들에 기능에 대해 정리한다.</p>\n<h2 id=\"TCP_NODELAY\" style=\"position:relative;\">TCP_NODELAY<a href=\"#TCP_NODELAY\" aria-label=\"TCP_NODELAY permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setTcpNoDelay</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> on<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">getTcpNoDelay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span></code></pre></div>\n<p>TCP는 기본적으로 Nagle’s 알고리즘을 사용하여 작은 패킷들을 합쳐서 하나의 큰 패킷으로 전송한다. 이렇게 하는 이유는 작은 패킷들을 하나씩 보내는 것보다, 여러 패킷을 하나의 큰 패킷으로 합쳐서 보내면 전송 효율이 높아지기 때문이다. Nagle’s 알고리즘은 데이터를 효율적으로 전송하기 좋은 방법이지만, 특정 상황에서는 좋은 방법이 아닐 수 있다. 예를 들면 실시간 빠른 응답이 필요한 애플리케이션(게임, GUI 프로그램 등)에서는 패킷이 지연 없이 바로 전송되어야 한다. TCP_NODELAY를 true로 설정하면, Nagle’s 알고리즘이 비활성화되어 작은 패킷도 즉시 전송된다.\n즉, 패킷을 버퍼링하지 않고 즉시 전송하는 것을 의미한다.</p>\n<h2 id=\"SO_LINGER\" style=\"position:relative;\">SO_LINGER<a href=\"#SO_LINGER\" aria-label=\"SO_LINGER permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setSoLinger</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> on<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> seconds<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getSoLinger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span></code></pre></div>\n<p>SO_LINGER 옵션은 소켓을 닫을 때 아직 전송되지 않은 패킷을 어떻게 처리될지를 결정한다.\n큰 파일을 다른 컴퓨터에게 전송하고 있는 상태에서 파일 전송이 완전히 끝나기 전에 close() 메서드를 호출하면 어떻게 될까? 기본적으로 close() 메서드를 호출하면 연결을 종료하려고 시도하고, 아직 전송되지 않은 데이터가 있다면 그 데이터를 원격지에 전송하려고 한다. 이렇게 하는 이유는 연결을 종료하기 전에 전송되지 않은 데이터를 안전하게 전송하기 위해서이다. 따라서, close() 메서드가 즉시 반환되었다고 시스템 내부 작업이 완전히 끝났다고 판단할 수는 없다. 이 옵션은 소켓을 close 할 때 처리를 세밀하게 조정할 수 있다.</p>\n<ul>\n<li>비활성화된 경우 (-1): 소켓은 바로 닫히며 아직 전송되지 않은 데이터가 있다면 시스템은 그 데이터를 전송하려고 한다. 이 때 얼마나 오랜 시간 동안 노력할지는 시스템의 기본 설정에 따라 다르다.</li>\n<li>활성화된 경우 (0 이상의 값): 설정된 시간(초) 동안 아직 전송되지 않은 데이터를 전송하려고 노력하고, 그 시간이 지나면 남은 데이터를 전송하지 않고 소켓을 close한다.</li>\n<li>0인 경우: 아직 전송되지 않은 모든 데이터는 버려지고 즉시 소켓이 close된다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">socket<span class=\"token punctuation\">.</span><span class=\"token function\">setSoLinger</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// SO\\_LINGER 옵션 비활성화</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">setSoLinger</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// close() 후, 5분 동안 추가 데이터 전송을 허용</span></code></pre></div>\n<p>getSoLinger() 메서드는 SO_LINGER 옵션이 비활성화되어 있다면 -1을 반환하고, 그게 아니라면 현재 소켓의 \"linger\" 시간 즉, 닫히기 전에 남은 데이터를 전송하는 데 허용된 시간을 초 단위로 반환한다.</p>\n<h2 id=\"SO_TIMEOUT\" style=\"position:relative;\">SO_TIMEOUT<a href=\"#SO_TIMEOUT\" aria-label=\"SO_TIMEOUT permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setSoTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> milliseconds<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getSoTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span></code></pre></div>\n<p>SO_TIMEOUT 옵션은 너무 오랫동안 데이터를 기다리지 않도록 할 수 있다.\nsockect.read() 메서드는 소켓에서 데이터를 읽을 때까지 블록킹된다. 이 옵션을  사용하면 read() 메서드가 무한정으로 블록킹 되지 않도록 타임아웃을 설정할 수 있다. 0 으로 설정할 경우 타임아웃이 없음을 의미하고 기본값으로 사용된다.\n예를 들어, 1분의 read timeout을 설정하고 싶다면 socket.setSoTimeout(60000); 로 설정한다.</p>\n<h2 id=\"SO_RCVBUF-SO_SNDBUF\" style=\"position:relative;\">SO_RCVBUF, SO_SNDBUF<a href=\"#SO_RCVBUF-SO_SNDBUF\" aria-label=\"SO_RCVBUF SO_SNDBUF permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setReceiveBufferSize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> size<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IllegalArgumentException</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getReceiveBufferSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setSendBufferSize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> size<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IllegalArgumentException</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">getSendBufferSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span></code></pre></div>\n<p>SO_RCVBUF는 네트워크 입력을 위한 버퍼 크기를, SO_SNDBUF는 네트워크 출력을 위한 버퍼 크기를 제어한다.\n파일 전송과 같은 상황에서는 큰 버퍼가 이점이 있지만, 게임과 같은 실시간 통신이 필요한 상황의 경우에는 버퍼를 사용할 경우 전송 지연이 발생할 수 있다. 운영체제 마다 다르지만 일반적으로 128바이트가 일반적인 기본값이다.\n버퍼 크기는 소켓의 최대 속도를 결정하는데, 최대 가능한 대역폭은 버퍼 크기를 지연시간으로 나눈 값이다.\n예를 들어, 두 호스트 간의 전송 지연시간이 0.5초에 버퍼 크기가 128바이트라면 128byte/0.5s = 256byte/1s가 된다. 지연시간은 애플리케이션이 제어할 수 없는 변수이므로 버퍼 사이즈를 두 배로 늘리면 대역폭도 두 배로 증가한다.\n물론 네트워크가 처리할 수 있는 대역폭은 제한되어 있기 때문에 그 보다 작게 설정해야 한다.</p>\n<p>java doc을 확인해보면 setReceiveBufferSize, setSendBufferSize 는 네트워크 I/O 버퍼를 설정하기 위한 크기에 대한 힌트로 사용된다.</p>\n<blockquote>\n<p>Sets the SO_SNDBUF option to the specified value for this Socket. The SO_SNDBUF option is used by the platform's networking code as a hint for the size to set the underlying network I/O buffers.</p>\n</blockquote>\n<p>이는 set으로 설정하더라도 실제 구현에서는 값이 달라질 수 있다는 얘기이다. 실제 버퍼가 어떤 크기로 설정되어 있는지 확인하기 위해 getSendBufferSize() 메서드로 확인할 수 있다.</p>\n<h2 id=\"SO_KEEPALIVE\" style=\"position:relative;\">SO_KEEPALIVE<a href=\"#SO_KEEPALIVE\" aria-label=\"SO_KEEPALIVE permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setKeepAlive</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> on<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span> \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">getKeepAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span></code></pre></div>\n<p>SO_KEEPALIVE는 HTTP 프로토콜에 Keepalive 헤더와는 다른 옵션이다. SO_KEEPALIVE 옵션은 서버가 죽어있는지 헬스 체크를 확인하기 위해 주기적으로 패킷을 보내는 옵션이다. 서버가 이 패킷에 응답하지 않으면 클라이언트는 응답을 받을 때 까지 시도하다가 결국 응답을 받지 못하면 소켓을 close한다. 네트워크 연결이 적절히 종료되지 않고 클라이언트나 서버 중 한 쪽에서만 종료된 경우를 half open 연결이라고 하는데, SO_KEEPALIVE는 그 상태를 감지하기 위한 기능이다.</p>\n<p>TCP Keepalive의 상세 설정은 운영체제 파라미터를 통해 설정할 수 있다.\n아래는 Linux에서 keepalive 관련 설정값들이다.</p>\n<ul>\n<li>/proc/sys/net/ipv4/tcp_keepalive_time<br>\n이 파일에 저장된 값은 TCP keep-alive 패킷이 처음으로 전송되기 시작하는 시간을 초 단위로 나타낸다.\n일반적으로 기본값은 7200초(2시간)이다. 즉, 연결이 비활성 상태로 있을 때 2시간 후에 첫 번째 keep-alive 패킷이 전송된다.</li>\n<li>/proc/sys/net/ipv4/tcp_keepalive_intvl<br>\n이 파일에 저장된 값은 keep-alive 패킷 간의 간격을 초 단위로 나타낸다.\n예를 들어, 첫 번째 keep-alive 패킷에 대한 응답이 없으면 이 파일에 지정된 간격 후에 두 번째 패킷이 전송된다.\n일반적으로 기본값은 75초이다.</li>\n<li>/proc/sys/net/ipv4/tcp_keepalive_probes<br>\n이 파일에 저장된 값은 연속적으로 전송될 수 있는 keep-alive 패킷의 최대 횟수를 나타낸다.\n일반적으로 기본값은 9이다. 즉, keep-alive 패킷 9회 연속으로 응답이 없을 경우 연결이 끊어진다.</li>\n</ul>\n<h2 id=\"OOBINLINE\" style=\"position:relative;\">OOBINLINE<a href=\"#OOBINLINE\" aria-label=\"OOBINLINE permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">sendUrgentData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> data<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setOOBInline</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> on<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span> \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">getOOBInline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span></code></pre></div>\n<p>TCP에는 긴급 데이터(Urgent Data)를 바로 전송하는 기능이 있다. sendUrgentData() 메서드를 사용하면 int data를 거의 바로 전송한다. 전송될 바이트는 data 파라미터의 최하위 8비트가 전송된다. OutputStream에 이미 데이터가 기록되어 있다면 이미 기록되어 있는 데이터 뒤에 전송된다.</p>\n<p>OOBINLINE 값이 true이면 소켓의 입력 스트림에 위치하게 되어 일반적인 방법으로 읽을 수 있다. 기본값은 false이다. Java에서는 긴급 데이터는 일반 데이터와 구별하지 않기 때문에 긴급 바이트를 처리하기가 어려운데, Ctrl-C 같은 특별한 의미를 갖는 바이트를 전송이 필요할 때 써볼 수 있다.</p>\n<h2 id=\"SO_REUSEADDR\" style=\"position:relative;\">SO_REUSEADDR<a href=\"#SO_REUSEADDR\" aria-label=\"SO_REUSEADDR permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setReuseAddress</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> on<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span> \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">getReuseAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SocketException</span></code></pre></div>\n<p>SO_REUSEADDR 옵션은 소켓을 닫았을 때 해당 소켓의 포트를 즉시 다시 사용할 수 있게 해주는 역할은 한다.\n소켓 연결을 끊게 되면 먼저 연결을 끊는 쪽에서 TIME_WAIT 상태로 일정시간 유지되는데, 이는 네트워크 상에 아직 도착하지 않은 마지막 패킷들이 소켓에 도착할 시간을 확보하기 위한 것이다. 따라서, 소켓 연결이 끊어진다고 해서 그 포트가 즉시 재사용되지 않는다. 시스템은 이러한 늦게 도착한 패킷들을 처리하지 않지만, 그 패킷들이 같은 포트를 사용하는 다른 프로세스에게 잘못 전달되는 것을 방지하기 위해 일정시간을 대기한다.\nSO_REUSEADDR 옵션을 활성화하면, 이러한 대기 시간 없이 포트를 즉시 재사용할 수 있게 한다.</p>\n<p>TIME_WAIT 상태에 자세한 설명은 <a href=\"https://tech.kakao.com/2016/04/21/closewait-timewait/\">카카오 기술블로그</a>에 잘 정리된 것이 있으니 참고하길 바란다.</p>\n<p>setReuseAddress() 메서드가 작동하려면 소켓이 포트에 바인됭되기 전에 setReuseAddress() 호출해야 한다.\n즉 인자없는 생성자 new Socket() 을 통해 소켓을 생성한다음 setReuseAddress(true)를 호출하고 connect() 메서드를 통해 소켓을 연결해야 한다.</p>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>TCP/IP Illustrated</li>\n<li>자바 네트워크 프로그래밍 4판</li>\n</ul>","fields":{"slug":"/socket_option/"},"frontmatter":{"title":"Java의 Socket Option 정리","date":"September 29, 2023"}},{"id":"f7217e81-51a3-58d9-9498-e84defa6368e","html":"<h2 id=\"Jakarta-EE\" style=\"position:relative;\">Jakarta EE<a href=\"#Jakarta-EE\" aria-label=\"Jakarta EE permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Jakarta EE(Java EE)는 기업용 애플리케이션에 필요한 기능들의 사양을 정의해둔 명세서이다.\n즉, 대규모 애플리케이션을 개발하는데 필요한 표준화된 Java API의 모음이라고 할 수 있다.\nJava API의 특징은 API를 제공하는 구현 벤더와 분리되어 있기 때문에 API를 준수한다면 플러그 형태로 구현 벤더를 교체할 수 있다는 장점이 있다.\n구체적으로는 JSP, Servlet, EJB, JMS, JMX, JTA 등 기업용 애플리케이션을 개발하고 실행하는 데 필요한 사양들을 명시하고 있다.\n<a href=\"http://java.sun.com/javaee/technologies/\">여기서</a> Jakarta EE(Java EE) API의 전체 목록을 확인할 수 있다.\n다양한 써드파티에서 Jakarta EE(Java EE) 스펙을 준수한 구현을 제공하는데 대표적으로 아래와 같은 벤더가 있다.\nJakarta EE(Java EE) 스펙을 완전히 구현한 것을 WAS(Web Application Server)라고 한다.</p>\n<ul>\n<li>JBoss(www.jboss.org)</li>\n<li>JOnAS(jonas.objectweb.org)</li>\n<li>Geronimo(geronimo.apache.org)</li>\n</ul>\n<h2 id=\"Servlet\" style=\"position:relative;\">Servlet<a href=\"#Servlet\" aria-label=\"Servlet permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>서블릿은 Jakarta EE API 중 하나로, Java 기술을 기반으로 한 웹 컴포넌트이다. Servlet은 서버 측에서 실행되는 Java 클래스로, 클라이언트의 요청을 처리하고 동적인 웹 페이지를 생성한다.\nJakarta EE(Java EE)의 Servlet 주요 스펙을 요약하면 다음과 같다. <a href=\"https://download.oracle.com/otn-pub/jcp/servlet-3_1-fr-eval-spec/servlet-3_1-final.pdf?AuthParam=1695794208_54642e957120d983f4ca811f71280a25\">Servlet 3.1 Spec docs</a></p>\n<ul>\n<li>요청/응답 모델: Servlet은 HTTP 요청을 받아 처리한 후, 응답을 반환하는 요청/응답 모델을 기반으로 한다.</li>\n<li>생명주기 관리: Servlet은 특정 생명주기를 가진다. 주요 메소드로는 init(), service(), doGet(), doPost(), destroy() 등이 있다.</li>\n<li>세션 관리: Servlet 스펙은 클라이언트 세션을 관리하기 위한 API를 제공한다.</li>\n<li>컨텍스트 공유: ServletContext를 통해 애플리케이션 전체에 걸쳐 정보를 공유할 수 있다.</li>\n<li>필터링: 필터를 사용하여 요청 및 응답에 대한 사전 및 사후 처리를 수행할 수 있다.</li>\n<li>이벤트 리스너: 웹 애플리케이션의 생명주기 이벤트나 세션 생성/소멸 등의 이벤트에 대한 리스너를 정의할 수 있다.</li>\n<li>멀티 스레딩: Servlet은 멀티 스레딩 환경에서 실행된다.</li>\n<li>포워딩 및 리다이렉션: 요청을 다른 리소스로 포워딩하거나, 클라이언트에게 다른 URL로 리다이렉션 요청을 보낼 수 있다.</li>\n<li>보안: Servlet 스펙은 선언적인 보안을 제공하여, 웹 리소스에 대한 접근 제어를 쉽게 구성할 수 있다.</li>\n</ul>\n<h2 id=\"Servlet-Containner\" style=\"position:relative;\">Servlet Containner<a href=\"#Servlet-Containner\" aria-label=\"Servlet Containner permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>웹 서버나 애플리케이션 서버의 일부로서, 네트워크 서비스를 제공한다. 웹 애플리케이션의 생명 주기를 관리하며, 요청을 받아 처리하고, 웹 페이지의 동적인 내용을 생성하는 역할을 한다.\n클라이언트가 웹서버에 HTTP 요청을 보내면, 서블릿 컨테이너가 이 요청을 받아서 요청 URL에 해당하는 서블릿에 전달하며, 서블릿 쓰레드가 사용자의 요청을 처리한 후 서블릿 컨테이너를 통해 응답을 반환한다.</p>\n<h2 id=\"Tomcat\" style=\"position:relative;\">Tomcat<a href=\"#Tomcat\" aria-label=\"Tomcat permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Tomcat은 Servlet 및 JSP 사양을 구현한 서블릿 컨테이너이다. JSP와 서블릿 처리, 서블릿의 수명 주기 관리, 요청 URL을 서블릿 코드로 매핑, HTTP 요청 수신 및 응답, 필터 체인 관리 등을 처리해준다. 톰캣은 Jakarta EE를 완전히 구현한 WAS는 아니고, JSP 와 Servlet 사양만 구현했기 때문에 Servlet Containner 또는 Web Container 라고 부른다.</p>\n<h2 id=\"Tomcat-Architecture\" style=\"position:relative;\">Tomcat Architecture<a href=\"#Tomcat-Architecture\" aria-label=\"Tomcat Architecture permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e87b355feb27c84754d957baa200ab8b/44e31/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.35294117647059%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAByElEQVR42n2T16pqQRBE/f+/0BcRTIgJI0bMOecsmEVQn+zL6sveHM/DaShnMzNdXV09WrbbrYzHY6lWq+L3+yUQCIjX65VQKCTRaPRPxGIxE/F4XPb7vVjW67UMh0NJp9Nit9slk8lIsViUZrMpo9FIz4z1JwaDgfR6PQXf+XxeVquVWAyFEE0mE3m/30Lc73dVmUwmtTpFyuWylEolBR3N53PN2Ww20ul0/hPy0+/3JZvNCmqJz+cjh8NBrFar2Gw2cTgc4vF41BKAJVgDaaFQkHa7rVDC6XQqkUhE6vW6uXm9XgXlKISIYsfjUbrdrloxm81UGaBl8kyFi8XC9Izvy+Uij8dDdrudkvl8Pk2gMC1CZqyQ1Wo1abVa34QYikI28QOFTMzpdIrL5dJECr1eLzmdTrJcLnUwFDFUs5ot53I53aQFEkjGT8gAigiKQH673XSQ3EMQYkxCEhuNhrZNaxACkt1ut4KLBMpR+Xw+1RZAsa+h0CIqU6mUOWXifD5LOByWYDCoKozpGwEp/qHsayiQ8HAh/JmIGh47dtASRWnTAI8ZEp4O56x4a2GaXKhUKmbb+AmwghUlnP8GJJxxL5FI6F/vHwZnR4/9FDRRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Tomcat Architecture\"\n        title=\"\"\n        src=\"/static/e87b355feb27c84754d957baa200ab8b/ca1dc/img.png\"\n        srcset=\"/static/e87b355feb27c84754d957baa200ab8b/e7570/img.png 170w,\n/static/e87b355feb27c84754d957baa200ab8b/f46e7/img.png 340w,\n/static/e87b355feb27c84754d957baa200ab8b/ca1dc/img.png 680w,\n/static/e87b355feb27c84754d957baa200ab8b/44e31/img.png 949w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Tomcat Architecture</figcaption>\n  </figure></p>\n<h4>Server</h4>\n<p>Tomcat 웹 애플리케이션 서버 자체를 의미한다. 하나의 JVM 내에서 하나의 Server 인터턴스를 실행할 수 있다.\n여러 개의 JVM 인스턴스를 실행한다면 여러 대의 Tomcat Server 인스턴스를 생성할 수 있는데\n각각의 Server 인서턴스는 다른 네트워크 포트를 사용해야 충돌이 발생하지 않는다.</p>\n<h4>Service</h4>\n<p>톰캣 최상위 컴포넌트 중 하나로, container 와 Connector 를 하나로 묶는다. 일반적으로 하나의 Engine 타입의\n컨테이너 하나와 여러 개의 Connector로 구성된다. Service는 여러 웹 애플리케이션을 관리하고 클라이언트의 요청을 처리하는 단위이다. 클라이언트가 요청을 하면 Connector가 요청을 받아, Engine(container)에게 전달한다.\nEngine은 요청을 웹 애플리케이션으로 라우팅하고 결과를 반환한다.\n각 Service는 이름이 부여되어 있어 로그 메시지를 통해 Service를 쉽게 식별할 수 있다.</p>\n<h4>Connectors</h4>\n<p>Connectors는 클라이언트의 웹 요청을 받아서 적절한 애플리케이션으로 전달하는 역할을 하는 컴포넌트이다.\n이를 통해 HTTP, HTTPS 등 다양한 프로토콜과 포트를 사용하여 웹 애플리케이션에 접근할 수 있게 한다.\n하나의 Engine은 여러 개의 Connectors를 설정할 수 있는데, 각 Connectors의 포트는 유일해야 한다.\n기본 Connector는 Coyote이며 HTTP 1.1을 구현한다. 그 외에도 AJP, SSL Connector, HTTP 2.0 Connector 등이 있다.</p>\n<h4>Engine</h4>\n<p>Engine은 Tomcat 서버에서 가장 상위에 위치한 컨테이너이다.\nCatalina 서블릿 엔진을 대표하고, HTTP 헤더를 분석하여 요청을 어느 가상 호스트나 컨텍스트로 전달할지 결정한다.\n하나의 Engine 내에는 여러 Hosts가 포함될 수 있고, 각 Host는 여러 웹 애플리케이션을 나타낼 수 있다.\n또한 Context는 단일 웹 애플리케이션을 나타낸다.</p>\n<h4>Realm</h4>\n<p>Realm은 사용자 인증과 권한을 부여하는 컴포넌트이다. Realm은 전체 엔진에서 공통적으로 적용되므로 엔진 내의 애플리케이션은\n인증을 위한 Realm을 공유하게 된다.</p>\n<h4>Valves</h4>\n<p>Valves 요청과 응답을 가로채서 사전 처리를 할 수 있다. 이는 Servlet의 필터와 비슷하지만, Valves 톰캣 고유의 컴포넌트이다.\nHosts, contexts, Engine에 Valves를 포함시킬 수 있다. Valves는 엔진과 컨텍스트 사이, 호스트와 컨텍스트 사이, 컨텍스트와 웹 리로스 사이에서 요청을 가로챌 수 있다.\nRequest 헤더 및 쿠키 저장, Response 헤더 및 쿠기 등을 로깅 등에 사용된다.</p>\n<h4>Host</h4>\n<p>Host는 아파치 웹 서버의 가상 호스트와 유사하다. 하나의 물리적 서버에 여러 개의 웹 사이트를 호스팅할 수 있다.\nHost는 보통 Engine 내에 위치해 Engine의 요청을 받아 해당 요청이 어느 Host로 전달될지 판단한다.</p>\n<h4>Context</h4>\n<p>Context는 웹 애플리케이션을 나타낸다. Engine이나 Host에게 애플리케이션의 루트 폴더 위치를 알려주는 등의 설정을 포함한다.\n여러 Context가 하나의 호스트를 공유할 수 있다.</p>\n<h2 id=\"serverxml\" style=\"position:relative;\">server.xml<a href=\"#serverxml\" aria-label=\"serverxml permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>server.xml은 Tomcat 서버 구성 요소를 정의한다. Service, Connector, engine, Realm, Valve, Host 등의 구성이 포함된다.\ntomcat이 설치된 conf 디렉토리에서 확인할 수 있다. tomcat 8 버전 기준으로 설치 후 기본 설정을 확인해보면 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Server</span> <span class=\"token attr-name\">port</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>8005<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">shutdown</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>SHUTDOWN<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Listener</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.catalina.startup.VersionLoggerListener<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n  <span class=\"token comment\">&lt;!--  ...--></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>GlobalNamingResources</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Resource</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UserDatabase<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">auth</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Container<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.catalina.UserDatabase<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">description</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>User database that can be updated and saved<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">factory</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.catalina.users.MemoryUserDatabaseFactory<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">pathname</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>conf/tomcat-users.xml<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>GlobalNamingResources</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Service</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Catalina<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Connector</span> <span class=\"token attr-name\">port</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>8080<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">protocol</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>HTTP/1.1<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">connectionTimeout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>20000<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">redirectPort</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>8443<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">maxParameterCount</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1000<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token punctuation\">/></span></span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Engine</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Catalina<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">defaultHost</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>localhost<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Realm</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.catalina.realm.LockOutRealm<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Realm</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.catalina.realm.UserDatabaseRealm<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">resourceName</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UserDatabase<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Realm</span><span class=\"token punctuation\">></span></span>\n\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Host</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>localhost<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">appBase</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>webapps<span class=\"token punctuation\">\"</span></span>\n        <span class=\"token attr-name\">unpackWARs</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">autoDeploy</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Valve</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>org.apache.catalina.valves.AccessLogValve<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">directory</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>logs<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">prefix</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>localhost_access_log<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">suffix</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.txt<span class=\"token punctuation\">\"</span></span>\n          <span class=\"token attr-name\">pattern</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>%h %l %u %t <span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span>%r<span class=\"token entity named-entity\" title=\"&quot;\">&amp;quot;</span> %s %b<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Host</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Engine</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Service</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Server</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>server.xml 파일의 컴포넌트 구성은 아래와 같이 컴포넌트가 부모-자식 관계를 가지고 있는 것을 볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Server\n├── Listener (여러 개 존재 가능)\n├── GlobalNamingResources\n│   └── Resource (UserDatabase)\n└── Service (Catalina)\n    ├── Connector (port=8080, protocol=HTTP/1.1)\n    └── Engine (Catalina)\n        ├── Realm (LockOutRealm)\n        │   └── Realm (UserDatabaseRealm)\n        └── Host (localhost)\n            └── Valve (AccessLogValve)</code></pre></div>\n<ul>\n<li>Server: 최상위 컴포넌트로 서버의 전반적인 설정을 관리한다.</li>\n<li>Listener: 서버 라이프사이클 이벤트를 처리한다.</li>\n<li>GlobalNamingResources: 글로벌 네이밍 리소스, UserDatabase 같은 리소스 설정이 있다.</li>\n<li>Service: 하나 이상의 커넥터(Connector)와 하나의 엔진(Engine)을 가진다.</li>\n<li>Connector: HTTP 요청을 처리한다.</li>\n<li>Engine: 실제로 웹 애플리케이션을 처리하는 컴포넌트이다.</li>\n<li>Realm: 보안 관련 설정을 담당한다.</li>\n<li>Host: 가상 호스트 설정을 관리한다.</li>\n<li>Valve: 로깅이나 보안 등 추가적인 처리를 담당한다.</li>\n</ul>\n<blockquote>\n<p>Catalina라는 이름의 서비스에서 HTTP 1.1 프로토콜과 8080 포트 번호가 정의되어 있는 것을 볼 수 있다.\n이 설정은 톰캣을 설치했을 때 기본으로 제공되는 소개 페이지를 호스팅하는 역할을 한다.</p>\n</blockquote>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f5e1e2f64382811c2e8c640546e34fd4/c84e4/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 99.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEgklEQVR42m2U229UVRTG57+Qik9yS0xMjDEYFYohxGfAhAiYECMXFSLRByNPvvKkj0Z5aBAKxKjcqdD7hba003Y6My3tTOfazuXMnPuZOXNm2pmf6xwTogkn+bLWXnutb39r75UT6t63j4MHuul+fy/vvvUGe9/czdt7XuOd3dvZK3hvdxcf7HmV/Xu62C9+965tHNj5Ch8KDu7cxsEd2zi0o4uPdm3n0OtdhC5eusz3l69w+sIlTpz6guOnvuTo8dMBjvwHhz/5nCMnzvDxp+c4evIsx059xcmz33DyzNecOX+R899+x2fnLhAqlUqk19LkMjkyqUxgFYnZpoWuapi6EUCvqliGSavh0XQbNMU2JMczbZp1F032DV0npCgKsZUosbUoi4lFFlcWUUwFp+lgNkyMhoHVsLA8K7BBzJVDxFdLOdRylrJRRHVUNjc3CSFfVI9zL9XHYHaA0fURhjKD9Kf6GUz3M5wdZEjivh3ODsneQJA3LDmj66P0Z/u5l7jDxPoYmzQJmVs605E7jD34gecbY8zrM8xXJ5mtThDRpyk0k5idEmp7A+0lqDbzpLJJ0rkkak0hlFDCXO05xpNbh5kq36W38CvXcz8H6M3/wrB2l6g7zlorTLI1+z8kNmdZcWeYW54mshJm3VojVDHlMfQkOS3BajFCzk1S8FIUmxlRlw7WpWYWm4ooLWN1lBdwqOJ0qhieguaWcDblUbJVk+HoCou5EhnVxm51SCkm8ZyCYjepb4HV7JCuWlTqLdknQKXWIpZXiEpdyfGwJa+2CSHbNSnJK5VNGRXPkGRZWyVyqsRsUdU0AtgtS15X+xee76sU/Tq7HMT0moojLx9ylVnUpZuYyTuYa3dpbgzQKg5APSaxPspz11Dmb2In7rOljomMMM3KMwqRG5Sjv+Nm/6ZtPhXZk+AsCKG6QHHlNuXEA8qr91ETD7FzTwLCzNgNYn/9RGb0KvmJa7QqPuE8LWWa4kQPhfHfUCJ/YCUf0chLjTUnLReekZvrRRGyiqhQBPXyELhxtNQTSvE/cZVRPHWchh93wqL0GdWRK1izN3FFiCu1zXQfaDOErOwUubEe7PRjIQmL9Bk5aUqUxDBkyJXUQyoy9IaobhuTAWFLC5OfvY6e6cMpDOAWBmmIDVrWVkeI3/6Rjale2voEHXNSCseFMIr2/BG58R5Kc7eCgrY+HhzYEiXrs9fkah5Tl7gt99jw792ZJ+Spyxirj9FXB9gy5+XuokIWAZlFrzJHLTsiCp7ilabo2AvSxRI0knREjX/PuIJGXOyiYIVQo+FimjqWbeLWa1im/Fl0VaAFa8exsG0L161RrzkYhoyNYQS+D11T0TQZcMnxuUL5/DoLCxE2Ngrokri6miAcniOVSgupztLSEsvLz1GUihRqxONLkrsR7KmqSiwWI5fPB3uWJXOoi1Mul0WFHQT8/6O/9lWYpil+iUqlEig2DJ1CoRAQmUEnGslkgmKxGOT7nYQ8z5O2nIDMJ63VpLV6/UXMdV3a7XaAra0tOp1OYF8GP+cfT1Jug03+AN8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_1.png\"\n        title=\"\"\n        src=\"/static/f5e1e2f64382811c2e8c640546e34fd4/ca1dc/img_1.png\"\n        srcset=\"/static/f5e1e2f64382811c2e8c640546e34fd4/e7570/img_1.png 170w,\n/static/f5e1e2f64382811c2e8c640546e34fd4/f46e7/img_1.png 340w,\n/static/f5e1e2f64382811c2e8c640546e34fd4/ca1dc/img_1.png 680w,\n/static/f5e1e2f64382811c2e8c640546e34fd4/02d09/img_1.png 1020w,\n/static/f5e1e2f64382811c2e8c640546e34fd4/c84e4/img_1.png 1037w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">img_1.png</figcaption>\n  </figure></p>\n<h2 id=\"webxml\" style=\"position:relative;\">web.xml<a href=\"#webxml\" aria-label=\"webxml permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>web.xml 파일은 톰캣에 웹 애플리케이션을 어떻게 배포하고 실행할지에 대한 기본 설정을 제공한다.\n서블릿 사양에 따르면 모든 웹 애플리케이션에는 deployment descriptor(web.xml)가 포함되어야 한다.\n만약 웹 애플리케이션마다 개별 배포 설명자를 가지고 있다면 해당 개별 설정이 web.xml 설정을 덮어씌운다.</p>\n<p>아래와 같은 URL로 요청을 받으면 tomcat의 각 구성요소는 다음과 같은 흐름으로 처리한다.</p>\n<p><code class=\"language-text\">https://www.example.com/store/book/</code></p>\n<ul>\n<li>https://: : Connector로 SSL 설정 (/conf/server.xml)</li>\n<li>www.example.com : Virtual host name (/conf/server.xml)</li>\n<li>/store : context path (Context Descriptor XML)</li>\n<li>/book : 서블릿 맵핑 (/WEB-INF/web.xml) </li>\n</ul>\n<p>위 URL의 프로토콜(https://) 부분이 먼저 서비스에서 분석되고 Coyote Connector가 요청을 엔진으로 전달된다.\n다음으로, 엔진에서 호스트 이름(www.example.com)을 파싱하여 호스트 컴포넌트를 선택한다.\n호스트는 배포된 웹 애플리케이션 컨텍스트(/store)에 대해 URL을 맵핑하고, 마지막으로 web.xml에 의해 서블릿 맵핑을 수행한다.</p>\n<h2 id=\"Connector-아키텍처\" style=\"position:relative;\">Connector 아키텍처<a href=\"#Connector-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\" aria-label=\"Connector 아키텍처 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Tomcat에는 Java로 작성된 org.apache.catalina.Connector 컴포넌트가\n있다. <a href=\"https://github.com/Oreste-Luci/apache-tomcat-8.0.26-src/blob/master/java/org/apache/catalina/connector/Connector.java\">Connector</a> 종류에는 HTTP/HTTPS 호출을 위한\nHTTP 1.1 커넥터, AJP(Apache JServ Protocol) 호출을 위한 AJP/1.3 커넥터가 있다. HTTP2 커넥터를 사용하기 위해서는 기존 HTTP 1.1 커넥터을 사용하고 HTTP2 UpgradeProtocol을 사용하면 된다.\n설정 바식은 server.xml 파일의 Connector 태그 내에서 protocol 속성을 통해 설정할 수 있다.</p>\n<ul>\n<li>HTTP/1.1: org.apache.coyote.http11.Http11AprProtocol</li>\n<li>AJP/1.3: org.apache.coyote.ajp.AjpAprProtocol</li>\n</ul>\n<h3 id=\"AJP-커넥터\" style=\"position:relative;\">AJP 커넥터<a href=\"#AJP-%EC%BB%A4%EB%84%A5%ED%84%B0\" aria-label=\"AJP 커넥터 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>AJP(Apache JServ Protocol)란, Tomcat과 다른 웹 서버 (예: Apache) 간에 통신을 최적화하기 위한 프로토콜이다. 웹 서버와 Tomcat 간에 통신이 필요할 때 AJP는 HTTP 프록시보다 더 빠른 성능을 제공한다. 그렇다면 어떻게 AJP는 HTTP보다\n빠른 성능을 제공할까?</p>\n<ul>\n<li>바이너리 포맷 사용: AJP13는 데이터 전송을 위해 바이너리 형식을 사용한다. 이전 버전인 AJP10과 AJP11은 텍스트 기반의 데이터 형식을 사용하였다. 바이너리 형식은 텍스트 형식보다 효율적으로 데이터를 인코딩하여 전송할 수 있다.</li>\n<li>재사용 가능한 연결 및 영구적 연결: 웹 서버와 서블릿 컨테이너 간의 통신은 네트워크 소켓을 통해 이루어진다. 이 연결은 여러 요청 및 응답에 대해 재사용할 수 있어 핸드쉐이크에 필요한 추가적인 시간이 절약할 수 있다.</li>\n<li>바이너리 인코딩: AJP는 HTTP 명령 및 헤더에 대한 바이너리 인코딩을 정의한다. 예를 들어, HTTP의 'GET' 명령은 AJP에서는 단일 바이트 값인 2로 표현된다. 이러한 바이너리 인코딩은 데이터의 크기를 줄이고 전송 속도를 높인다.</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/96d4c260f4c67ef7fbb74e5be92f13f9/4ec94/img_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 83.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAACO0lEQVR42oVUyW7iQBDl/38ALqNh0cwJJDYhBIon7GCBAbMYbFbbQOAISa5v/ErTkklI5vBU3eWqV6+q2x25XC7YbrfY7/d38NwdDl6Af9Z3t+L7GKew2+1wOp0QcV0X0+kUi8UClmUJltYcuulAG3rQjC3+GHtoIx9dc4VF8E3FhTGbzURYxPd9zOdz2LaN5XKJRYCVbeHZPOKXfsPPZx8/nvb43X/Hk3mGs7RgOw6cEJhLUqqMeJ53R6hgTi0YUxv9sQXdmGBgLmDOgnWvh0ajgVqtJrZer4s6dviQkNYwDLjBXN5eb8Hc9ng5HfH+9orj4SDjoRrmKEhnjwiJ1WqFfr8P3z/gfL5I9dF4jOPxFOzPQub8r2VuTNNEs9lEL2hpMBiIj+SsTlImUoWu62i324JOpyOWgu4UMpkOkrKl0WgkwcViEblcTmw+n5dkxk4mE4wD1YwnmPtlywQJW60WEokEYrEYotEo4vG4+NScCdUyfd+eMquydU3TUKlURB0tfeGboMbx5aGoIH5kS5wlSbrdrhwUlVerVWSzWaTTaSnEq/OwZUXGFkjGeZVKJSSTSaRSKVnTR0VqhrTfXmwVPBwORRXVFAoFZDIZlMtlURu+fwTjP50yHaxEIqpgewxQ82SS2rMQD4etMpaWo+E3IVT/sjq99XothIfgr7jdbjI3Frper58utjrpTy2rk1IvB+8i93yJWIAXnGuV+BHqpZLXhm8YqzBRYbPZCIlSoNa04bgwGMdu/wK3qKMfUQpjewAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_2.png\"\n        title=\"\"\n        src=\"/static/96d4c260f4c67ef7fbb74e5be92f13f9/ca1dc/img_2.png\"\n        srcset=\"/static/96d4c260f4c67ef7fbb74e5be92f13f9/e7570/img_2.png 170w,\n/static/96d4c260f4c67ef7fbb74e5be92f13f9/f46e7/img_2.png 340w,\n/static/96d4c260f4c67ef7fbb74e5be92f13f9/ca1dc/img_2.png 680w,\n/static/96d4c260f4c67ef7fbb74e5be92f13f9/4ec94/img_2.png 846w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">img_2.png</figcaption>\n  </figure></p>\n<h3 id=\"HTTP-Connector\" style=\"position:relative;\">HTTP Connector<a href=\"#HTTP-Connector\" aria-label=\"HTTP Connector permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>HTTP Connector는 HTTP 프로토콜을 구현하는 Java 클래스이다. HTTP Connector는 서블릿 및 JSP에 대한 요청 이외에도 정적 컨텐츠 리소스에 대한 요청에도 응답한다.\nHTTP Connector는 HTTP 요청을 구문 분석하고 Tomcat 서블릿 엔진에 전달하는 코드가 있다.\nHTTP Connector 종류에는 HTTP/1.1 커넥터, NIO HTTP 커넥터, 네이티브 코드에 최적화된 APR HTTP 커넥터 등이 존재한다.\n이 컴포넌트는 서버의 특정 TCP 포트번호에서 연결을 대기(listen)한다.\n하나의 서비스 내에 여러 Connector 들이 구성될 수 있고, 요청을 Engine에게 전달하여 응답을 반환한다.\nConnector 설정은 아래와 같은 server.xml에서 xml 태그로 설정할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Connector</span> <span class=\"token attr-name\">port</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>”8080”</span>\n <span class=\"token attr-name\">protocol</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>”HTTP/1.1”</span>\n <span class=\"token attr-name\">maxThreads</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>”150”</span>\n <span class=\"token attr-name\">connectionTimeout</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>”20000”</span>\n <span class=\"token attr-name\">redirectPort</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>”8443”</span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>HTTP 1.1 Connector의 동작방식은 공식문서에 잘 설명되어있다. 동시에 받은 요청이 현재 사용 가능한 worker 스레드보다 많으면, 설정된 최대치(maxThreads 속성의 값)까지 추가 스레드가 생성된다.\n더 많은 동시 요청이 오게되면, 현재 연결 수가 maxConnections에 도달할 때까지 Tomcat은 새로운 연결을 accept한다.\n연결은 Connector가 생성한 서버 소켓에서 연결을 처리할 스레드가 사용 가능해질 때까지 대기큐에 머물게 된다. maxConnections에 도달하면, 운영 체제는 추가 연결을 큐에 넣는다. 이 때, 운영 체제에서 제공하는 연결 큐의 크기는 acceptCount 속성으로 정의할 수\n있다. 운영 체제 큐가 가득 차면, 추가 연결 요청이 거부되거나 timeout이 발생하게 된다.\n스프링을 사용하면 로그에 <strong>http-nio-8080-exec-?</strong> 라는 Worker 스레드 이름을 볼 수 있는데, 이 Worker 스레드풀을 초기화하는 로직이 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// https://github.com/apache/tomcat/blob/main/java/org/apache/tomcat/util/net/AbstractEndpoint.java</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">createExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    internalExecutor<span class=\"token operator\">=</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">TaskQueue</span> taskqueue<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TaskQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">TaskThreadFactory</span> tf<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TaskThreadFactory</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\"-exec-\"</span><span class=\"token punctuation\">,</span>daemon<span class=\"token punctuation\">,</span><span class=\"token function\">getThreadPriority</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    executor<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span><span class=\"token function\">getMinSpareThreads</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token function\">getMaxThreads</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">60</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SECONDS</span><span class=\"token punctuation\">,</span>taskqueue<span class=\"token punctuation\">,</span>tf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    taskqueue<span class=\"token punctuation\">.</span><span class=\"token function\">setParent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">)</span>executor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">executor = new ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), 60, TimeUnit.SECONDS,taskqueue, tf)</code> 라인을 보면 Executor 구현체로 ThreadPoolExecutor을 사용하는 것을\n볼 수 있다.\nThreadPoolExecutor 동작은 <a href=\"https://px201226.github.io/java-concurrency-executor/\">여기</a>에 정리해둔 내용이 있으니 참고하자.\nThreadPoolExecutor 기본 동작은 내부 Queue가 꽉 차지 않는 이상 corePoolSize를 늘리지 않는데, 공식문서에서 유휴 스레드가 없으면 스레드를 생성한다는 내용과 차이점이 있다. 이 점은 생성자로 주입한 TaskQueue 의 구현을 보면 이해할 수 있다.   </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// https://github.com/apache/tomcat/blob/main/java/org/apache/tomcat/util/threads/TaskQueue.java</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TaskQueue</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">offer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">//we can't do any checks</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parent <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token comment\">//we are maxed out on threads, simply queue the object</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">getPoolSizeNoLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">getMaximumPoolSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token comment\">//we have idle threads, just add it to the queue</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">getSubmittedCount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">getPoolSizeNoLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token comment\">//if we have less threads than maximum force creation of a new thread</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">getPoolSizeNoLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> parent<span class=\"token punctuation\">.</span><span class=\"token function\">getMaximumPoolSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token comment\">//if we reached here, we need to add it to the queue</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>TaskQueue는 톰캣에서 LinkedBlockingQueue를 확장한 큐로 BlockingQueue::offer 메서드를 오버라이딩한다.\noffer 메서드의 내용을 살펴보면 현재 스레드 풀의 크기가 최대 스레드풀 크기가 동일하면 작업을 큐에 추가한다.\n그렇지 않다면 제출된 작업 수가 현재 스레드 풀보다 작은 경우, 즉 유휴 스레드가 있는 경우 작업을 큐에 추가한다.\n그것도 아니라면 현재 풀 사이즈가 maximum 풀사이즈보다 작으면 false를 반환하여 새로운 스레드를 생성한다.\n아래는 HTTP Connector를 구성하는 속성들이다.\n자세한 내용은 <a href=\"https://tomcat.apache.org/tomcat-8.5-doc/config/http.html\">여기서</a> 확인할 수 있다.   </p>\n<table>\n<thead>\n<tr>\n<th>속성명</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>maxConnections</td>\n<td>서버가 한 번에 수용하고 처리할 수 있는 최대 연결 수. 이 숫자에 도달하면 서버는 추가로 한 개의 연결을 수용하지만 처리하지는 않는다. 이 추가 연결은 처리 중인 연결 수가 maxConnections 아래로 떨어질 때까지 차단된다. 제한에 도달했을 때 운영 체제는 여전히 acceptCount 설정을 기반으로 연결을 수락할 수 있다. NIO 및 NIO2의 경우 기본값은 10,000이다. APR/native의 경우 기본값은 8,192이다. NIO/NIO2에만 해당되는데, 이 값을 -1로 설정하면 maxConnections 기능이 비활성화되고 연결이 계산되지 않는다.</td>\n</tr>\n<tr>\n<td>acceptCount</td>\n<td>maxConnections에 도달했을 때 들어오는 연결 요청에 대해 운영 체제에서 제공하는 대기열의 최대 길이. 운영 체제는 이 설정을 무시하고 대기열에 다른 크기를 사용할 수 있다. 이 큐가 가득 차면 운영 체제에서 추가 연결을 거부하거나 타임아웃이 발생한다. 기본값은 100</td>\n</tr>\n<tr>\n<td>maxKeepAliveRequest</td>\n<td>이 속성은 HTTP 요청의 \"keep-alive\" 동작을 제어하며 지속적인 연결(즉, 동일한 HTTP 연결을 통해 여러 요청을 보낼 수 있게 함)을 가능하게 한다. 서버에서 연결이 닫힐 때까지 파이프라인화할 수 있는 요청의 최대 수를 지정한다. maxKeepAliveRequest의 기본값은 100이며, 1로 설정하면 HTTP keep-alive 동작과 파이프라인화가 비활성화된다.</td>\n</tr>\n<tr>\n<td>maxSpareThreads</td>\n<td>maxSpareThreads 속성은 사용되지 않는 스레드의 최대 수를 제어한다. Tomcat이 사용되지 않는 것들을 중지하기 전에 허용될 수 있는 스레드의 최대 수다. maxSpareThreads의 기본값은 50이다.</td>\n</tr>\n<tr>\n<td>minSpareThreads</td>\n<td>minSpareThreads 속성은 커넥터가 초기화될 때 시작되는 스레드의 최소 수를 지정한다. minSpareThreads의 기본값은 4다.</td>\n</tr>\n<tr>\n<td>maxThreads</td>\n<td>이 속성은 이 커넥터가 요청을 처리하기 위해 생성되는 스레드의 최대 수를 지정한다. 이는 차례로 커넥터가 처리할 수 있는 동시 요청의 최대 수를 지정한다. maxThreads의 기본값은 200 스레드다.</td>\n</tr>\n<tr>\n<td>socketBuffer</td>\n<td>소켓 출력 버퍼링에 사용될 버퍼의 크기(바이트 단위)를 지정한다. 소켓 버퍼의 사용은 성능을 향상시킨다. 기본적으로 9,000 바이트 크기의 버퍼가 사용되며, socketBuffer를 -1로 설정하면 버퍼링이 꺼진다.</td>\n</tr>\n<tr>\n<td>tcpNoDelay</td>\n<td>이 속성이 true로 설정되면, TCP<em>NO</em>DELAY 네트워크 소켓 옵션이 활성화된다. 기본값은 true다.</td>\n</tr>\n<tr>\n<td>connectionLinger</td>\n<td>이 Connector에서 사용하는 소켓이 닫혔을 때 얼마 동안 대기할지 정하는 초 단위의 시간이다. 기본값은 -1로 설정되어 있어서 소켓 지속 기능이 비활성화된다.</td>\n</tr>\n<tr>\n<td>connectionTimeout</td>\n<td>이 Connector는 연결을 수락한 후 요청 URI 줄이 제시될 때까지 얼마 동안 기다릴지를 밀리초 단위로 정한다. -1을 사용하면 시간 제한이 없다는 의미다. 기본값은 60000(즉, 60초)이지만 Tomcat에 포함된 표준 server.xml에서는 이 값을 20000(즉, 20초)으로 설정한다는 것을 주의하라. disableUploadTimeout이 false로 설정되지 않으면, 요청 본문(있는 경우)을 읽을 때 이 시간 제한도 사용된다.</td>\n</tr>\n<tr>\n<td>keepAliveTimeout</td>\n<td>이 Connector는 다른 HTTP 요청을 기다리기 전에 연결을 닫을 때까지 얼마 동안 기다릴지를 밀리초 단위로 정한다. 기본값은 connectionTimeout 속성에 설정된 값을 사용한다. -1 값을 사용하면 시간 제한이 없다는 의미다.</td>\n</tr>\n<tr>\n<td>maxKeepAliveRequests</td>\n<td>서버에 의해 연결이 닫힐 때까지 파이프라인에 넣을 수 있는 HTTP 요청의 최대 수를 정한다. 이 속성을 1로 설정하면 HTTP/1.0 지속 연결과 HTTP/1.1 지속 연결 및 파이프라이닝이 모두 비활성화된다. -1로 설정하면 파이프라인 또는 지속 연결 HTTP 요청의 수에 제한이                                                                                                                                                                  없다. 지정되지 않으면 이 속성은 100으로 설정된다.</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"HTTP-NIO-Connector\" style=\"position:relative;\">HTTP NIO Connector<a href=\"#HTTP-NIO-Connector\" aria-label=\"HTTP NIO Connector permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>HTTP Connector에는 내부 프로토콜에 따라 크게 3가지 프로토콜 구현체가 존재한다.\nBIO Connnector는 Tomcat 8.0부터 삭제되어 여기서는 NIO Connector 중심으로 알아본다.</p>\n<table>\n<thead>\n<tr>\n<th>이름</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>BIO Connector</td>\n<td>Tomcat 7의 기본 Connector (org.apache.coyote.http11.Http11Protocol)<br/>Java Blocking API를 사용하여 구현</td>\n</tr>\n<tr>\n<td>NIO Connector</td>\n<td>Tomcat 8 이후 기본 Connector (org.apache.coyote.http11.Http11NioProtocol)<br/> Java NIO API를 사용하여 구현</td>\n</tr>\n<tr>\n<td>APR Connector</td>\n<td>APR 라이브러리를 사용해 더 나은 성능의 Connector (org.apache.coyote.http11.Http11AprProtocol)<br/>JNI(Java Native Interface) 라이브러리를 사용하여 구현</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Http11NioProtocol\" style=\"position:relative;\">Http11NioProtocol<a href=\"#Http11NioProtocol\" aria-label=\"Http11NioProtocol permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Java Non-Blocking IO의 핵심은 Selector를 이용한 채널 관리이다.\n관심있는 채널(요청, 읽기, 준비완료 등)에 Selector에 등록하고 싱글 스레드가 Selector를 폴링하여 준비된 채널에 대해 지정된 콜백을 실행하여 작업을 처리한다.\nHTTP NIO Connector 도 위와 같은 방식으로 이벤트를 처리하고 있으며, 아래 그림과 아키텍처를 가진다.<br>\n<figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/34f49f6cf213fa6ff308eafb28c1eb71/476b8/img_3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.88235294117647%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABBElEQVR42qWT6QqAQAiE9/3fMyi67zvjEyaW6F8Louk6jq6FYRis6zpDr+v6S6ZpsgBQ3/c2jqNd12V/DqBhWRY35nl2lgiV+CameCzEzvO04zhcy+ZuIAi7uq6tLEurqsratrV9353xW8QE4Y4Kb9vmZIIcBKmCVoL870MyXXAfEk3TuM1bOCBB5pimqRVF4WAcwACFmVrDViGApVXEZ6iHoRI2LfONzSjyPLcsyyxJErcZC+ACAhR5AJkhIFzWLGGLxq+itERHFMNHDB9dkYf/YUgrVAEENiQyF7Ufr1S8dxoZpJ5HUXtUox0NWvsZP5Rm9bWzvjYkaLckBGL7S77+FLBuRgRZdKuGFwMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"NIO Connector 구성\"\n        title=\"\"\n        src=\"/static/34f49f6cf213fa6ff308eafb28c1eb71/ca1dc/img_3.png\"\n        srcset=\"/static/34f49f6cf213fa6ff308eafb28c1eb71/e7570/img_3.png 170w,\n/static/34f49f6cf213fa6ff308eafb28c1eb71/f46e7/img_3.png 340w,\n/static/34f49f6cf213fa6ff308eafb28c1eb71/ca1dc/img_3.png 680w,\n/static/34f49f6cf213fa6ff308eafb28c1eb71/476b8/img_3.png 803w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">NIO Connector 구성</figcaption>\n  </figure></p>\n<h4>Acceptor</h4>\n<p>Acceptor 스레드는 serverSocket.accept() 로 소켓 연결을 하고 반환된 SocketChannel 을\nTomcat의 NioChannel로 캡슐화한다. NioChannel은 다시 PollerEvent로 래핑되고 이벤트 큐에 등록한다.\nAcceptor 스레드는 소켓 연결 수락에 대한 이벤트를 생성하는 생성자 스레드를 의미한다.</p>\n<h4>Poller</h4>\n<p>Non Blocking IO 처리의 핵심인 이벤트 루프 로직이 포함되어 있다. Poller는 이벤트 큐에서 PollerEvent를 소비한다.\nPollerEvent 에서 꺼낸 Channel을 Selector에 등록하고 Selector는 읽을 수 있는 소켓을 순회하며 해당 소켓을 Worker 스레드에 전달한다.</p>\n<h4>Executor(Worker Thread)</h4>\n<p>Worker 스레드에서는 Poller로부터 소켓을 받아 SocketProcessor 객체로 캡슐화하고 Http11NioProcessor에서 CoyoteAdapter를 호출한다.\n스프링 로그에 출력되는 <code class=\"language-text\">http-nio-8080-exec-?</code> 가 바로 이 Worker 스레드를 의미한다.\nCoyoteAdapter는 Connector와 Container(Engine) 사에에 다리 역할을 한다. 요청의 매개 변수를 파싱하고 해당 context를 찾아 Engine에게 전달한다.\nEngine은 요청을 처리하여 반환값을 반환한다.</p>\n<h3 id=\"요청-처리\" style=\"position:relative;\">요청 처리<a href=\"#%EC%9A%94%EC%B2%AD-%EC%B2%98%EB%A6%AC\" aria-label=\"요청 처리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>다음으로 Tomcat에서 요청을 어떻게 수락하고 서블릿까지 전달되어 처리되는 과정을 살펴보자.</p>\n<p>먼저, Tomcat이 run 하게 되면 poller와 acceptor 스레드를 하나씩 생성하고 시작된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// poller 스레드 생성 및 시작</span>\npoller <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Poller</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Thread</span> pollerThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>poller<span class=\"token punctuation\">,</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"-Poller\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npollerThread<span class=\"token punctuation\">.</span><span class=\"token function\">setPriority</span><span class=\"token punctuation\">(</span>threadPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npollerThread<span class=\"token punctuation\">.</span><span class=\"token function\">setDaemon</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npollerThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">startAcceptorThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    acceptor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Acceptor</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> threadName <span class=\"token operator\">=</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"-Acceptor\"</span><span class=\"token punctuation\">;</span>\n    acceptor<span class=\"token punctuation\">.</span><span class=\"token function\">setThreadName</span><span class=\"token punctuation\">(</span>threadName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span> t <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>acceptor<span class=\"token punctuation\">,</span> threadName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    t<span class=\"token punctuation\">.</span><span class=\"token function\">setPriority</span><span class=\"token punctuation\">(</span><span class=\"token function\">getAcceptorThreadPriority</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    t<span class=\"token punctuation\">.</span><span class=\"token function\">setDaemon</span><span class=\"token punctuation\">(</span><span class=\"token function\">getDaemon</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    t<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위에서 살펴봤듯이 poller와 acceptor 스레드가 실행되면 이벤트 큐를 처리하거나 소켓 연결을 수락하는데, 이 작업을 처리하기 위해 무한루프로 구현된다.</p>\n<p>Acceptor 스레드가 실행되면 ServerSocketChannel의 accept() 메서드를 통해 클라이언트 연결을 수락할 때까지 대기한다.\naccept()는 blocking 모드로 동작된다. 이는 클라이언트 연결을 위한 스레드를 따로 만들었기 때문에 불필요하게 non-blocking 모드로 폴링할 필요가 없기 때문인 것으로 보인다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NioEndpoint</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractJsseEndpoint</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">NioChannel</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token class-name\">SocketChannel</span> <span class=\"token function\">serverSocketAccept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">SocketChannel</span> result <span class=\"token operator\">=</span> serverSock<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token comment\">// Bug does not affect Windows platform and Unix Domain Socket. Skip the check.</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token class-name\">JrePlatform</span><span class=\"token punctuation\">.</span><span class=\"token constant\">IS_WINDOWS</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">getUnixDomainSocketPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token class-name\">SocketAddress</span> currentRemoteAddress <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">getRemoteAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">long</span> currentNanoTime <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">nanoTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentRemoteAddress<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>previousAcceptedSocketRemoteAddress<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n\t\t\t\t\tcurrentNanoTime <span class=\"token operator\">-</span> previousAcceptedSocketNanoTime <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"endpoint.err.duplicateAccept\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\tpreviousAcceptedSocketRemoteAddress <span class=\"token operator\">=</span> currentRemoteAddress<span class=\"token punctuation\">;</span>\n\t\t\tpreviousAcceptedSocketNanoTime <span class=\"token operator\">=</span> currentNanoTime<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약, 위에서 요청이 accept() 되어 소켓 연결이 이루어지면 반환된 SocketChannel을 이벤트 큐에 등록한다.\n이 작업은 Acceptor 스레드에서 NioEndpoint은 setSocketOptions() 메서드를 통해 이루어진다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NioEndpoint</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractJsseEndpoint</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">NioChannel</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocketChannel</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">setSocketOptions</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketChannel</span> socket<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">NioSocketWrapper</span> socketWrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token comment\">//...</span>\n\t\t\t<span class=\"token class-name\">NioSocketWrapper</span> newWrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NioSocketWrapper</span><span class=\"token punctuation\">(</span>channel<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\tsocketWrapper <span class=\"token operator\">=</span> newWrapper<span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token comment\">//...</span>\n\t\t\tpoller<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">//...</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">NioSocketWrapper</span> socketWrapper<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tsocketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">interestOps</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//this is what OP_REGISTER turns into.</span>\n\t\t<span class=\"token class-name\">PollerEvent</span> pollerEvent <span class=\"token operator\">=</span> <span class=\"token function\">createPollerEvent</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span> <span class=\"token constant\">OP_REGISTER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token function\">addEvent</span><span class=\"token punctuation\">(</span>pollerEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>        </code></pre></div>\n<p>SocketChannel을 NioSocketWrapper로 랩핑 후 poller.register()로 Poller 이벤트 등록이 끝나면, Acceptor 스레드는 다음 요청을 수락하기 위해 처음의 accept()로 다시 돌아가 대기하게 된다.\n이로써, Acceptor의 역할은 끝나고 다음 작업은 Poller 스레드에서 이루어진다.</p>\n<p>Poller 스레드도 Acceptor 스레드와 마찬가지로 무한루프를 돌면서 이벤트 큐에 등록된 이벤트가 있는지 폴링 방식으로 검사한다.\n클라이언트 연결이 이루어진다면 다음으로 클라이언트에서 데이터를 읽어야 할 차례이다. 클라이언트 요청값을 읽어 들이기 위해서 Selector에 OP<em>READ를 등록한다.\n`sc.register(getSelector(), SelectionKey.OP</em>READ, socketWrapper)`</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Poller</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">events</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">boolean</span> result <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token class-name\">PollerEvent</span> pe <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size <span class=\"token operator\">=</span> events<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> size <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>pe <span class=\"token operator\">=</span> events<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tresult <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">NioSocketWrapper</span> socketWrapper <span class=\"token operator\">=</span> pe<span class=\"token punctuation\">.</span><span class=\"token function\">getSocketWrapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">SocketChannel</span> sc <span class=\"token operator\">=</span> socketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getSocket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getIOChannel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">int</span> interestOps <span class=\"token operator\">=</span> pe<span class=\"token punctuation\">.</span><span class=\"token function\">getInterestOps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sc <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"endpoint.nio.nullSocketChannel\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tsocketWrapper<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>interestOps <span class=\"token operator\">==</span> <span class=\"token constant\">OP_REGISTER</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\tsc<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token function\">getSelector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"endpoint.nio.registerFail\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token comment\">//..</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그 후, Poller 스레드는 selector.select() 로 채널에서 이벤트 수신를 수신한다.\n반환된 SelectionKey의 attatchment에서 NioSocketWrapper을 꺼내와서 processKey()로 소켓을 처리하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Poller</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// Loop until destroy() is called</span>\n\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token keyword\">boolean</span> hasEvents <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>close<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\thasEvents <span class=\"token operator\">=</span> <span class=\"token function\">events</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wakeupCounter<span class=\"token punctuation\">.</span><span class=\"token function\">getAndSet</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\t<span class=\"token comment\">// If we are here, means we have other stuff to do</span>\n\t\t\t\t\t\t<span class=\"token comment\">// Do a non blocking select</span>\n\t\t\t\t\t\tkeyCount <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\tkeyCount <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>selectorTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t\twakeupCounter<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\n\n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token comment\">// ... </span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\t<span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> iterator <span class=\"token operator\">=</span>\n\t\t\t\t\tkeyCount <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n\t\t\t<span class=\"token comment\">// Walk through the collection of ready keys and dispatch</span>\n\t\t\t<span class=\"token comment\">// any active event.</span>\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>iterator <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">SelectionKey</span> sk <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\titerator<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token class-name\">NioSocketWrapper</span> socketWrapper <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">NioSocketWrapper</span><span class=\"token punctuation\">)</span> sk<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token comment\">// Attachment may be null if another thread has called</span>\n\t\t\t\t<span class=\"token comment\">// cancelledKey()</span>\n\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>socketWrapper <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token function\">processKey</span><span class=\"token punctuation\">(</span>sk<span class=\"token punctuation\">,</span> socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\n\t\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>processKey() 에서는 소켓 처리에 필요한 객체(SocketProcessorBase)를 생성하고, 스레드풀 Exector를 통해 소켓 처리를 위임한다.\nExecutor 스레드는 Worker Pool 스레드를 의미한다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AbstractEndpoint</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">U</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">processSocket</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketWrapperBase</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> socketWrapper<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SocketEvent</span> event<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> dispatch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token comment\">//...</span>\n\t\t<span class=\"token class-name\">SocketProcessorBase</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">S</span><span class=\"token punctuation\">></span></span> sc <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sc <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tsc <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">createSocketProcessor</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\tsc<span class=\"token punctuation\">.</span><span class=\"token function\">reset</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token class-name\">Executor</span> executor <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dispatch <span class=\"token operator\">&amp;&amp;</span> executor <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\texecutor<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>sc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\tsc<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>소켓 처리를 넘겨 받은 Worker에서는 reqeust, response 객체를 세팅하고, CoyoteAdapter를 통해 서블릿으로 소켓처리를 위임한다. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// SocketProcessor.java</span>\n<span class=\"token function\">getHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">,</span><span class=\"token class-name\">SocketEvent</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OPEN_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// AbstractProcessorLight.java</span>\nstate<span class=\"token operator\">=</span><span class=\"token function\">service</span><span class=\"token punctuation\">(</span>socketWrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 요청 위임</span>\n\n<span class=\"token comment\">// Http11Processor.java</span>\n<span class=\"token function\">getAdapter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">service</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// CoyoteAdapter로 요청 위임  </span>\n\n<span class=\"token comment\">// CoyoteAdapter.java</span>\nconnector<span class=\"token punctuation\">.</span><span class=\"token function\">getService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getPipeline</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 컨테이너로 요청 전달</span></code></pre></div>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li><a href=\"https://tomcat.apache.org/tomcat-8.5-doc/config/http.html\">https://tomcat.apache.org/tomcat-8.5-doc/config/http.html</a></li>\n<li><a href=\"https://download.oracle.com/otn-pub/jcp/servlet-3_1-fr-eval-spec/servlet-3_1-final.pdf?AuthParam=1695794208_54642e957120d983f4ca811f71280a25\">https://download.oracle.com/otn-pub/jcp/servlet-3_1-fr-eval-spec/servlet-3_1-final.pdf?AuthParam=1695794208_54642e957120d983f4ca811f71280a25</a></li>\n<li><a href=\"https://velog.io/@jihoson94/BIO-NIO-Connector-in-Tomcat\">https://velog.io/@jihoson94/BIO-NIO-Connector-in-Tomcat</a></li>\n<li><a href=\"https://www.programmersought.com/article/90283888271/\">https://www.programmersought.com/article/90283888271/</a></li>\n<li>Pro apache tomcat 6</li>\n</ul>","fields":{"slug":"/tomcat/"},"frontmatter":{"title":"Apache Tomcat 이해하기(NIO Connector 중심)","date":"September 26, 2023"}},{"id":"cf054fe0-228c-59bf-a5f2-b34c4879742c","html":"<h2 id=\"ReentrantLock\" style=\"position:relative;\">ReentrantLock<a href=\"#ReentrantLock\" aria-label=\"ReentrantLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>고유락(intrinsic locking, synchronized lock. monitor lock)과 달리 ReentrantLock은 폴링, 타임아웃, 인터럽트 가능한 잠금 획득을 선택할 수 있으며, 모든 잠금 및 해제 연산이 명시적이다. 아래 Lock 인터페이스는 추상적인 잠금 연산을 정의한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Lock</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> timeout<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span> unit<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Condition</span> <span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ReentrantLock은 Lock 인터페이스를 구현한 구현체하여, ReentrantLock을 획득과 해제는 synchronized 블록에 진입하고 종료하는 것과 동일한 메모리 시맨틱(가시성)을 가진다.</p>\n<p>ReentrantLock을 사용하는 이유는 고유락의 한계 때문에 탄생하였다. 고유락은 데드락 같은 상황이 발생하더라도 영원히 대기해야 되고 또, 코드 블록 단위로 잠금을 획득하고 해제되어야 되기 때문에 좀 더 유연한 잠금 메커니즘이 필요하거나 더 나은 성능을 위해 탄생되었다. 잠금 관리에 많은 리소스가 사용되면 애플리케이션이 사용할 수 있는 리소스가 줄어들기 때문이다.</p>\n<p>ReentrantLock은 고유락보다 더 많은 주의가 필요한데 락의 해제를 직접 관리해주어야 되기 때문에 더 많은 주의가 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Lock</span> lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nlock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// update object state</span>\n    <span class=\"token comment\">// catch exceptions and restore invariants if necessary</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Java 6.0 부터 synchronized와 비교했을 때 ReentrantLock 이 성능적으로 약간 더 우세하다고 한다.\n성능 상의 이유로 synchronized 대신 ReentrantLock 을 사용하는 것은 불필요한 복잡성을 추가하는 것일 수 있으므로, 특별한 이유가 없다면 굳이 그렇게 할 필요가 없다고 생각한다.</p>\n</blockquote>\n<h2 id=\"타임아웃-Lock\" style=\"position:relative;\">타임아웃 Lock<a href=\"#%ED%83%80%EC%9E%84%EC%95%84%EC%9B%83-Lock\" aria-label=\"타임아웃 Lock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>lock::tyrLock 을 사용하면 고유락보다 더 정교한 오류 복구가 가능해진다. 고유락을 사용하여 데드락이 발생하면 애플리케이션을 재시작해야만 복구할 수 있지만 시간제한 잠금은 확률론적 방식으로 교착 상태 회피를 제공한다.\nlock::lockInterruptibly 메서드는 락을 획득하려고 시도할 때, 현재 스레드가 인터럽트되었는지도 확인한다. 락을 기다리는 동안 인터럽트가 발생하면 예외처리가 가능하고 고유락 처럼 무한정 대기하여 데드락에 빠지는 상황을 방지할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Lock</span> lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    lock<span class=\"token punctuation\">.</span><span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Critical section</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Handle interruption</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"공정성fairness\" style=\"position:relative;\">공정성(fairness)<a href=\"#%EA%B3%B5%EC%A0%95%EC%84%B1fairness\" aria-label=\"공정성fairness permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>ReentrantLock 생성자에는 boolean 타입의 fairness 공정성 옵션을 제공한다.</p>\n<ul>\n<li>공정한 락(Fair Lock): 스레드들이 요청한 순서대로 락을 획득한다. 즉, 먼저 요청한 스레드가 먼저 락을 얻는다.</li>\n<li>비공정한 락(Nonfair Lock): 락이 사용 가능한 상태에서 요청한 스레드는 대기 중인 스레드를 무시하고 락을 바로 획득할 수 있다. 이를 \"barging\"이라고 한다. (기본값)</li>\n</ul>\n<p>공정성은 항상 옳은 것 처럼 보일 수 있지만 실제로는 성낭 상의 비용이 발생하여 비공정한 락이 대부분의 경우에 더 높은 성능을 보인다. 비공정한 락에서는 \"barging\"이라는 현상이 성능을 향상시킨다. 예를 들어, 스레드 A가 락을 보유하고 있고, 스레드 B가 그 락을 요청했다면, B는 대기 상태로 들어간다. A가 락을 해제하면, B는 다시 실행되고, 그 사이에 스레드 C가 락을 요청하면, C는 B가 깨어나기도 전에 락을 얻을 수 있다. 이로 인해 전반적인 처리량(throughput)이 향상될 수 있다. 공정한 락은 락을 오랫동안 보유하여 락 요청 시 대기 시간이 길 때 비공정 락 방식보다 유리할 수 있다.</p>\n<p>비공정한 락에서는 락을 요청한 순서와 무관하게 락을 획득할 수 있어 일부 스레드는 락을 획득하지 못하는 기아 상태가 발생할 수 있다. 대부분의 비공정한 락의 구현은 통계정 공정성을 기반으로 하는데 통계적 공정성이란 시스템이 모든 작업에 완벽한 공정성을 보장하지 않더라도, 긴 시간 동안 봤을 때 거의 모든 요청 또는 작업이 공정하게 처리될 것이라는 확률적인 보장을 의미한다.</p>\n<h2 id=\"Read-write-locks\" style=\"position:relative;\">Read-write locks<a href=\"#Read-write-locks\" aria-label=\"Read write locks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>대부분의 데이터 구조는 읽기 중심 작업으로 때때로 수정 작업이 발생한다. Read-write lock은 리소스는 여러 읽기 작업에 의해 동시에 접근될 수 있지만, 쓰기 작업이 일어날 때는 해당 리소스에 단독으로 접근하며 다른 읽기나 쓰기 작업은 접근할 수 없게 된다. 이러한 방식은 데이터의 일관성을 유지하면서 동시성(concurrency)을 높일 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ReadWriteLock</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Lock</span> <span class=\"token function\">readLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Lock</span> <span class=\"token function\">writeLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ReadWriteLock을 구현하기 위해서는 아래와 같은 고려사항이 있을 수 있다.</p>\n<ul>\n<li>Release Preference: 쓰기 락(write lock)이 해제될 때 대기 중인 읽기 작업(readers)과 쓰기 작업(writers) 중 누구에게 우선권을 줄 것인지를 의미한다. 이를 선택하는 방법에 따라 성능과 공정성이 달라질 수 있다.</li>\n<li>Reader Barging: 읽기 락(read lock)이 활성화되어 있고 쓰기 작업(writer)이 대기 중일 때, 새로 도착하는 읽기 작업이 즉시 접근할 수 있을지, 아니면 대기 중인 쓰기 작업 뒤에 줄을 서야 하는지를 의미한다. 읽기 작업이 쓰기 작업보다 먼저 접근하는 것은 동시성을 향상시키지만, 쓰기 작업이 계속 대기 상태에 머물러 기아 상태에 빠질 수 있다.</li>\n<li>Reentrancy: 읽기 락과 쓰기 락이 재진입 가능한지(reentrant) 여부입니다. 재진입 가능하다는 것은 하나의 스레드가 이미 획득한 락을 다시 획득할 수 있다는 의미이다.</li>\n<li>Downgrading: 쓰기 락을 보유하고 있는 스레드가 쓰기 락을 해제하지 않고 읽기 락을 획득할 수 있는지 여부입니다. 이렇게 하면 쓰기 작업을 수행한 후에 읽기 작업으로 레벨을 낮춰서 다른 쓰기 작업이 도중에 리소스를 변경하지 못하게 할 수 있다.</li>\n<li>Upgrading: 읽기 락을 보유하고 있는 상태에서 쓰기 락으로 업그레이드할 수 있는지 여부입니다. 대부분의 읽기-쓰기 락 구현체에서는 업그레이드를 지원하지 않는데, 두 개의 리더가 동시에 쓰기 잠금으로 업그레이드를 시도하면 어느 쪽도 읽기 잠금을 해제못하는 데드락이 발생할 수 있기 때문이다.</li>\n</ul>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>Java Concurrency in practice</li>\n</ul>","fields":{"slug":"/java-concurrency-lock/"},"frontmatter":{"title":"Java의 동시성 프로그래밍 - Lock","date":"September 19, 2023"}},{"id":"3419fd75-1867-5820-8915-bb4785885a65","html":"<h2 id=\"DeadLock\" style=\"position:relative;\">DeadLock<a href=\"#DeadLock\" aria-label=\"DeadLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>스레드 A각 잠금 L을 점유하고 있고 잠금 M을 획득하려고 시도하는 동시에 스레드 B가 잠금 M을 보유하고 있고 잠금 L을 획득하려고 시도하면 두 스레드는 영원히 대기하게 된다. 이러한 상황을 데드락이라고 한다.</p>\n<h2 id=\"lock-ordering-deadlocks\" style=\"position:relative;\">lock-ordering deadlocks<a href=\"#lock-ordering-deadlocks\" aria-label=\"lock ordering deadlocks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>아래 코드는 leftRight(), rightLeft 메서드가 left, right 락을 서로 다른 순서로 잠금을 획득하려고 하기 때문에 데드락이 발생할 수 있다. lock-ordering 은 left, right 락을 필요로 하는 모든 스레드에서 항상 같은 순서로 left, right 락을 획득하도록 하면 데드락이 발생하지 않는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LeftRightDeadlock</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> left <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> right <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">leftRight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">rightLeft</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>right<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">doSomethingElse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">A ---> lock left -> try to lock right -> wait forever\nB -----> lock right -> try to lock left -> wait forever</code></pre></div>\n<h2 id=\"Dynamic-lock-order-deadlocks\" style=\"position:relative;\">Dynamic lock order deadlocks<a href=\"#Dynamic-lock-order-deadlocks\" aria-label=\"Dynamic lock order deadlocks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>데드락을 예방하기 위해 잠금 순서를 제어하기 명확하지 않을 때가 있다. 예를 들면 다음과 같은 fromAccount 에서 toAccount로 계좌 이체하는 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transferMoney</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Account</span> fromAccount<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Account</span> toAccount<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DollarAmount</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>fromAccount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>toAccount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>       </code></pre></div>\n<p>위의 코드는 아래와 같은 방식으로 from, to Account를 반대로 호출하면 데드락이 발생할 수 있다.</p>\n<ul>\n<li>A: transferMoney(myAccount, yourAccount, 10);</li>\n<li>B: transferMoney(yourAccount, myAccount, 20);</li>\n</ul>\n<p>이런 경우에는 System::identityHashCode 와 같은 해시 코드를 사용하여 일관된 잠금 순서를 보장할 수 있다.\n다만, hashCode 는 드물지만 중복되는 경우도 있기 때문에 해시 코드가 동일한 경우에도 잠금 순서를 보장할 수 있어야 한다. 이런 경우에 사용할 수 있는 방법이 <em>tie breaking</em> 방식이다.</p>\n<p>tie breaking 방식은 fromAccount, toAccount 잠금을 획득하기 전에 tie breaking 잠금을 획득함으로써 한번에 두개의 잠금을 획득하여 데드락 가능성을 제거할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> tie <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">transferMoney</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Account</span> fromAccount<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Account</span> toAccount<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DollarAmount</span> amount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">int</span> fromHash <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">identityHashCode</span><span class=\"token punctuation\">(</span>fromAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> toHash <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">identityHashCode</span><span class=\"token punctuation\">(</span>toAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fromHash <span class=\"token operator\">></span> toHash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>fromAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>toAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">//...</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>fromHash <span class=\"token operator\">&lt;</span> toHash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>toAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>fromHash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">//...</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>tie<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>fromAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>toAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">//...</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"객체-협력관계에서의-deadlocks\" style=\"position:relative;\">객체 협력관계에서의 deadlocks<a href=\"#%EA%B0%9D%EC%B2%B4-%ED%98%91%EB%A0%A5%EA%B4%80%EA%B3%84%EC%97%90%EC%84%9C%EC%9D%98-deadlocks\" aria-label=\"객체 협력관계에서의 deadlocks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>두 개 이상의 자원(또는 객체, 클래스 등)이 상호 작용을 해야 하는 상황에서 데드락이 발생할 수 있다.\n클래스 A의 method1은 A의 상태를 업데이트하고, 클래스 B의 어떤 메서드를 호출한다.<br>\n클래스 B의 method2는 B의 상태를 업데이트하고, 클래스 A의 상태를 참조한다.</p>\n<p>이 두 메서드가 서로 다른 스레드에서 동시에 호출될 경우 데드락이 발생할 수 있다.</p>\n<ul>\n<li>method1은 A의 락을 획득하고 B의 메서드를 호출하기 전에 락을 유지한다.</li>\n<li>method2는 B의 락을 획득하고 A의 상태를 참조하기 전에 락을 유지한다.</li>\n</ul>\n<p>이런 상황에서는 open call 이나 락의 범위를 축소하여 데드락 가능성을 제거할 수 있다.</p>\n<ul>\n<li>Open Call: 락 없이 메소드를 호출하는 것.</li>\n<li>synchronized 블록 축소: 전체 메소드에 synchronized를 사용하는 대신에, 실제로 공유 상태에 접근하는 부분만 synchronized 블록으로 묶는다.</li>\n</ul>\n<blockquote>\n<p>결합된(composed) 객체를 나중에 동기화(synchronizing)하는 대신에 처음부터 동기화된 객체를 결합하는 것이 더 복잡하다. 동기화된 객체를 안전하게 사용하려면 오픈 콜(open calls)과 락의 순서 정하기(careful lock ordering) 같은 기술이 필요하다.</p>\n</blockquote>\n<h2 id=\"리소스-deadlocks\" style=\"position:relative;\">리소스 deadlocks<a href=\"#%EB%A6%AC%EC%86%8C%EC%8A%A4-deadlocks\" aria-label=\"리소스 deadlocks permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"리소스-기반-데드락Resource-based-Deadlock\" style=\"position:relative;\">리소스 기반 데드락(Resource-based Deadlock)<a href=\"#%EB%A6%AC%EC%86%8C%EC%8A%A4-%EA%B8%B0%EB%B0%98-%EB%8D%B0%EB%93%9C%EB%9D%BDResource-based-Deadlock\" aria-label=\"리소스 기반 데드락Resource based Deadlock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>예를 들어 두 개의 데이터베이스 연결 풀이 있다고 가정해보자. 스레드 A가 데이터베이스 D1에 연결을 확보하고, D2에 연결을 기다리고 있을 수 있다.\n동시에 스레드 B가 D2에 연결을 확보하고 D1에 연결을 기다릴 수 있다.\n이런 상황에서 두 스레드는 각각 다른 스레드가 확보하고 있는 리소스를 기다리므로 데드락이 발생한다.</p>\n<h3 id=\"스레드-기아-데드락Thread-Starvation-Deadlock\" style=\"position:relative;\">스레드 기아 데드락(Thread-Starvation Deadlock)<a href=\"#%EC%8A%A4%EB%A0%88%EB%93%9C-%EA%B8%B0%EC%95%84-%EB%8D%B0%EB%93%9C%EB%9D%BDThread-Starvation-Deadlock\" aria-label=\"스레드 기아 데드락Thread Starvation Deadlock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>이 형태의 데드락은 하나의 스레드가 결과를 기다리는 동안 다른 스레드가 그 결과를 생성해야 하는 상황에서 발생한다.\n예를 들어, 하나의 작업이 결과를 생성하고, 다른 작업이 그 결과를 기다리는 경우, 첫 번째 작업이 완료되지 않으면 두 번째 작업도 영원히 기다리게 된다. 이는 특히 작업들이 한정된 스레드 풀에서 실행될 때 문제가 될 수 있다.</p>\n<h2 id=\"Timed-tryLock\" style=\"position:relative;\">Timed tryLock<a href=\"#Timed-tryLock\" aria-label=\"Timed tryLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>명시적인 Lock 클래스의 \"timed tryLock\" 기능을 사용하면 무한정 대기하는 대신에 타임아웃을 설정할 수 있다.\n일반적인 내장 락(intrinsic locks)은 락을 획득할 수 없으면 영원히 대기하게 되지만 명시적인 락(explicit locks)은 타임아웃을 설정할 수 있어, 락 획득에 실패하면 재시도할 수 있는 제어권을 얻을 수 있다.</p>\n<h2 id=\"livelock\" style=\"position:relative;\">livelock<a href=\"#livelock\" aria-label=\"livelock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>라이브락은 스레드가 차단되지는 않았지만 계속 실패할 수 있는 작업을 계속 재시도하여 스레드가 계속 진행되지 못하는 상태의 한 형태를 말한다.</p>\n<p>예를 들어, 메시징 애플리케이션에서 메시지 처리에서 버그로 인해 특정 유형의 메시지가 항상 실패하면, 그 메시지는 계속해서 큐의 앞으로 돌아가고 다시 처리된다. 이러한 문제는 \"poison message problem\"이라고도 부른다. 스레드는 차단되지 않지만, 계속해서 같은 실패를 반복하므로 실제로는 작업이 진행되지 않는다.</p>\n<p>또는, 협력하는 스레드에서 여러 스레드가 서로의 상태에 반응하여 변경하되, 그 결과로 어느 스레드도 진행되지 못하는 상태가 될 수 있다. 두 사람이 복도에서 서로 양보하면서 영원히 지나가지 못하는 상황을 생각할 수 있다.</p>\n<p>이러한 유형의 라이브락을 해결하는 하나의 방법은 재시도 메커니즘에 무작위성을 도입하는 것 이다. 예를 들어, 이더넷 네트워크에서 두 스테이션이 동시에 패킷을 보내면 충돌이 발생한다고 할 때 두 스테이션은 재시도 시간에 무작위성을 도입하여 충돌을 피할 수 있다.</p>\n<p>아래는 Worker1 과 Worker2가 같은 자원 commonResource에 접근하려고 시도하고, 스레드가 자원에 접근할 수 없는 경우 자원을 상대방에게 양보하여 livelock이 발생하는 예제이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LiveLockExample</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CommonResource</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">Worker</span> owner<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">CommonResource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Worker</span> owner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>owner <span class=\"token operator\">=</span> owner<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Worker</span> <span class=\"token function\">getOwner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> owner<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setOwner</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Worker</span> d<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            owner <span class=\"token operator\">=</span> d<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Worker</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> active<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>active <span class=\"token operator\">=</span> active<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> active<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">work</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CommonResource</span> commonResource<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Worker</span> otherWorker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>active<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// If resource is owned by someone else, wait</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>commonResource<span class=\"token punctuation\">.</span><span class=\"token function\">getOwner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token comment\">// handle</span>\n                    <span class=\"token punctuation\">}</span>\n                    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token comment\">// If other worker is also active, hand over the common resource to the other worker</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>otherWorker<span class=\"token punctuation\">.</span><span class=\"token function\">isActive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" : handing over the resource to the worker: \"</span> <span class=\"token operator\">+</span> otherWorker<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    commonResource<span class=\"token punctuation\">.</span><span class=\"token function\">setOwner</span><span class=\"token punctuation\">(</span>otherWorker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token comment\">// Now use the commonResource</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\": working on the common resource\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                active <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// work completed, so set active to false</span>\n                commonResource<span class=\"token punctuation\">.</span><span class=\"token function\">setOwner</span><span class=\"token punctuation\">(</span>otherWorker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Worker</span> worker1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Worker 1 \"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Worker</span> worker2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Worker 2\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">CommonResource</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CommonResource</span><span class=\"token punctuation\">(</span>worker1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> worker1<span class=\"token punctuation\">.</span><span class=\"token function\">work</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> worker2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> worker2<span class=\"token punctuation\">.</span><span class=\"token function\">work</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> worker1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>위의 메시징 애플리케이션에서는 Dead-letter-Queue 나 Retry Limit, Exponential Backoff 방식을 사용할 수 있다.</p>\n</blockquote>\n<h2 id=\"참조\" style=\"position:relative;\">참조<a href=\"#%EC%B0%B8%EC%A1%B0\" aria-label=\"참조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>Java Concurrency in practice</li>\n</ul>","fields":{"slug":"/java-concurrency-deadlock/"},"frontmatter":{"title":"Java의 동시성 프로그래밍 - Deadlock","date":"September 18, 2023"}},{"id":"fb92d1e5-6500-58e2-9bf6-4e575c5e083c","html":"<h2 id=\"Executor\" style=\"position:relative;\">Executor<a href=\"#Executor\" aria-label=\"Executor permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Task는 논리적인 작업 단위이며, 스레드는 Task를 비동기적으로 실행할 수 있는 기술이다. Java에서는 Task 실행을 추상화하여 Executor 라는 인터페이스를 제공한다. Executor는 다양한 Task 실행 정책을 지원하는 비동기 프레임워크에 기반이 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Executor</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Executor 구현은 통계 수집, 애플리케이션 관리 및 모니터링을 추가하기 위한 라이프사이클 지원 및 후크를 제공한다.\nExecutor는 생산자-소비자 패턴을 기반으로 Task을 등록하는 작업과 Task를 처리하는 작업을 분리하였다.\nTask의 등록과 처리를 분리는 특정 Task의 실행 정책을 쉽게 변경할 수 있다는 장점이 있다.\n실행 정책은 무엇을, 어디서, 언제, 어떻게를 포함한다.</p>\n<ul>\n<li>Task는 어떤 스레드에서 실행되는가?</li>\n<li>Task는 어떤 순서로 실행되어야 하는가? (FIFO, LIFO, Priority)</li>\n<li>동시에 실행할 수 있는 작업 수는?</li>\n<li>몇 개의 작업이 실행 대기열에 포함될 수 있나?</li>\n<li>처리량 제한으로 작업을 거부해야하는 경우, 어떻게 처리해야 하나?</li>\n<li>작업을 실행하기 전후 조치는?</li>\n</ul>\n<blockquote>\n<p>현재 new Thread(runnable).start() 와 같은 저수준의 스레드를 직접 다루고 있다면 Executor 나 비동기 프레임워크 사용을 적극적으로 고려해보는 것이 좋다.</p>\n</blockquote>\n<h2 id=\"Executor-라이프사이클\" style=\"position:relative;\">Executor 라이프사이클<a href=\"#Executor-%EB%9D%BC%EC%9D%B4%ED%94%84%EC%82%AC%EC%9D%B4%ED%81%B4\" aria-label=\"Executor 라이프사이클 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Executor는 Task를 비동기적으로 처리하기 때문에 특정 시점에 제출된 작업의 상태를 즉시 알 수 없다.\n완료되거나 실행 중이거나 실행대기 중일 수 도 있다. Executor는 애플리케이션이 정상적으로 또는 갑작스럽게 종료되더라도 종료로 인한 영향받는 작업의 상태 정보를 애플리케이션에 전달할 수 있어야 한다.\nExecutor의 수명 주기 문제를 해결하기 위해 ExecutorService 인터페이스는 Executor를 확장하여 라이프 사이클 관리를 위한 여러 가지 메서드를 제공한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ExecutorService</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Executor</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">shutdownNow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">boolean</span> <span class=\"token function\">isShutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">boolean</span> <span class=\"token function\">isTerminated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">boolean</span> <span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> timeout<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span> unit<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>ExecutorService , ExecutorCompletionService 차이\nExecutorService 는 Task를 제출한 순서대로 결과를 가져와서 처리할 수 있다.\nExecutorCompletionService 는 Task를 제출한 순서와 상관없이 내부적으로 BlockingQueue 사용하여 완료된 작업 목록 리스트를 유지하여 완료된 Task를 poll 하거나 take할 수 있다.</p>\n</blockquote>\n<h2 id=\"ThreadPoolExecutor\" style=\"position:relative;\">ThreadPoolExecutor<a href=\"#ThreadPoolExecutor\" aria-label=\"ThreadPoolExecutor permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>ThreadPoolExecutor 는 Executors의 정적 팩토리 메서드로 생성할 수 있는 newCachedThreadPool, newFixedThreadPool, newScheduledThreadPool 의 기본 구현을 제공한다.\n기본 구현의 실행 정책이 필요에 맞지 않는 경우 ThreadPoolExecutor 생성자를 통해 정의할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> corePoolSize<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token keyword\">int</span> maximumPoolSize<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token keyword\">long</span> keepAliveTime<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token class-name\">TimeUnit</span> unit<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token class-name\">BlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">></span></span> workQueue<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token class-name\">ThreadFactory</span> threadFactory<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token class-name\">RejectedExecutionHandler</span> handler\n\t\t<span class=\"token punctuation\">)</span> </code></pre></div>\n<ul>\n<li>corePoolSize : 스레드 수의 하한, 최소 corePoolSize 만큼의 스레드 수를 유지한다. workQueue가 꽉 차지 않는 이상 스레드 수를 늘리지 않는다.</li>\n<li>maximumPoolSize : 스레드 수의 상한, workQueue가 꽉찰 경우 최대로 생성될 수 있는 스레드 수</li>\n<li>keepAliveTime : 유휴 상태인 스레드가 keepAliveTime 시간이 지나면 스레드를 회수하여 corePoolSize를 유지한다.</li>\n</ul>\n<p>Task 마다 스레드를 생성해서 처리하는 것과 비교하여 스레드 풀을 사용하면 CPU를 차지하기 위해 경쟁하면서 대기하는 대신 ThreadPoolExecutor를 사용하면 ThreadPoolExecutor이 관리하는 Runnable Queue에서 대기시킬 수 있다. 이는 스레드를 직접\n만들어 대기하는 것보다 훨씬 경제적이지만, 클라이언트가 서버가 처리할 수 있는 속도보다 더 많은 요청을 몰릴 경우 메모리 부족또는 응답 시간 지연 같은 문제가 여전히 발생할 수 있다.</p>\n<p>ThreadPoolExecutor는 실행 대기 중인 태스크를 보관하기 위해 BlockingQueue를 사용할 수 있다. 이러한 Task 큐 종류에는 unbounded 큐, bounded 큐, synchronous handoff가 있다.\nnewFixedThreadPool 및 newSingleThreadExecutor 의 기본 Task 큐로는 unbounded LinkedBlockingQueue를 사용하는 것 이다. 따라서, 작업이 실행할 수 있는 속도보다 빨리 도착하는 경우 큐가 제한 없이 커질 수 있다.</p>\n<p>보다 안정적인 리소스를 관리 전략으로는 ArrayBlockingQueue나 bounded LinkedBlockingQueue, PriorityBlockingQueue 와 같은 bounded 큐를 사용하는 것이다.</p>\n<p>synchronous handoff은 큐를 사용하는 것이 아니라 스레드 간의 핸드 오프를 관리하는 메커니즘이다.\n핸드 오프를 사용하는 SynchronousQueue는 작업을 큐에 넣고 소비자가 큐에서 작업을 꺼내서 실행하는 방식이 아니라 작업을 큐에 넣으려면 다른 스레드가 이미 핸드오프 수락을 위해 대기 중이어야 한다. 작업을 실행할 스레드에 바로 전달할 수 있으므로 더 효율적이다.\nSynchronousQueue는 스레드풀이 무제한이거나 초과 작업을 거부하는 것이 허용되는 경우에 유용한 선택지이다. newCachedThreadPool이 SynchronousQueue를 사용한다.</p>\n<h2 id=\"포화-정책Saturation-policies\" style=\"position:relative;\">포화 정책(Saturation policies)<a href=\"#%ED%8F%AC%ED%99%94-%EC%A0%95%EC%B1%85Saturation-policies\" aria-label=\"포화 정책Saturation policies permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>포화 정책은 스레드 풀의 작업 대기열이 가득 찼을 때 어떻게 동작할지를 설명한다. bounded 큐가 가득 차면 포화 정책이 실행된다. ThreadPoolExecutor에 대한 포화 정책은 setRejectedExecutionHandler 메서드를 호출하여 설정할 수 있다.\nRejectedExecutionHandler 구현에는 AbortPolicy, CallerRunsPolicy, DiscardOldestPolicy가 있다.</p>\n<ul>\n<li>AbortPolicy: 기본 정책으로 작업 대기열이 가득 차면 RejectedExecutionException을 발생시킨다. 호출자는 이 예외를 잡아서(try-catch) 오버플로우를 처리할 수 있다.</li>\n<li>DiscardPolicy: 새로 제출된 작업이 대기열에 들어갈 수 없다면, 그 작업을 무시한다.</li>\n<li>DiscardOldestPolicy: 대기열에서 가장 먼저 실행될 작업을 제거하고 새로운 작업을 대기열에 추가하려고 시도한다. 만약 대기열이 우선순위 큐라면, 가장 높은 우선순위의 작업이 제거된다.</li>\n<li>CallerRunsPolicy: 이 정책은 작업을 무시하지도, 예외를 발생시키지도 않는다. 대신, 새로운 작업을 제출한 스레드에서 작업을 실행한다. 이는 일종의 '스로틀링'(throttling)으로, 새 작업의 흐름을 늦추기 위해 일부 작업을 호출자에게 다시 돌려보낸다.\nCallerRunsPolicy를 사용하면, 예를 들어 웹 서버에서 모든 스레드가 사용 중이고 대기열이 가득 차면, 다음 작업은 execute 호출을 하는 메인 스레드에서 실행된다.</li>\n</ul>\n<p>다음은 CallerRunsPolicy 를 사용한 고정 스레드풀 Executor를 생성하는 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">ThreadPoolExecutor</span> executor<span class=\"token operator\">=</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolExecutor</span><span class=\"token punctuation\">(</span>\n\t\t<span class=\"token constant\">N_THREADS</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token constant\">N_THREADS</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token number\">0L</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MILLISECONDS</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedBlockingQueue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token constant\">CAPACITY</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nexecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setRejectedExecutionHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolExecutor<span class=\"token punctuation\">.</span>CallerRunsPolicy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"ThreadFactory\" style=\"position:relative;\">ThreadFactory<a href=\"#ThreadFactory\" aria-label=\"ThreadFactory permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>스레드 풀에서 새로운 스레드를 생성해야 할 때 ThreadFactory 를 통해 스레드를 생성한다. 기본 스레드 팩토리는 논데몬 스레드를 생성한다. 사용자 정의 스레드 팩토리를 사용하는 이유는 UncaughtExceptionHandler를 지정하거나 디버그 로깅을 수행하는 것과 같은\n사용자 지정 스레드 클래스의 인스턴스를 인스턴스화할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ThreadFactory</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token class-name\">Thread</span> <span class=\"token function\">newThread</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"Extending-ThreadPoolExecutor\" style=\"position:relative;\">Extending ThreadPoolExecutor<a href=\"#Extending-ThreadPoolExecutor\" aria-label=\"Extending ThreadPoolExecutor permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>ThreadPoolExecutor 는 확장을 위해 설계되어 서브클래스가 오바라이드할 수 있는 후크 메서드를 제공한다.\nbeforeExecute, afterExecute 메서드는 작업을 실행하는 스레드에서 호출되며, beforeExecute가 RuntimeException을 던지면 태스트가 실행되지 않고 afterExecute도 호출되지 않는다.\nterminate 메서드는 모든 작업이 완료되고 워커 스레드가 종료된 후 스레드 풀 종료가 완료될 때 호출된다.</p>","fields":{"slug":"/java-concurrency-executor/"},"frontmatter":{"title":"Java의 동시성 프로그래밍 - Executor","date":"September 17, 2023"}},{"id":"a2016a03-202f-508f-b077-7f1c0b11e4b5","html":"<h2 id=\"동시성-프로그래밍-모델\" style=\"position:relative;\">동시성 프로그래밍 모델<a href=\"#%EB%8F%99%EC%8B%9C%EC%84%B1-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D-%EB%AA%A8%EB%8D%B8\" aria-label=\"동시성 프로그래밍 모델 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>동시성은 여러 태스크가 동시에 실행된다는 시스템 속성이다. 또한 태스크들 사이에서 상호 작용을 수행할 수 있다.\n이러한 동시성은 단일 코어 프로세서부터 멀티 코어 프로세서, 다중 프로세서, 그리고 분산 시스템까지 다양한 컴퓨팅 환경에서 구현될 수 있다.\n주 목적은 사용자의 응답성을 향상시키고 처리량을 증가시키는 것이다.</p>\n<p>동시성은 주로 멀티스레딩과 연관되어 있지만, 멀티스레딩에서 발생하는 문제들은 분산 시스템에서도 유사하게 나타난다.\n이는 두 시스템 모두 컴퓨팅 리소스를 효율적으로 활용하여 하나의 목표를 달성하기 위한 메커니즘이기 때문이다.\n공유 상태 관리, 작업 분산, 그리고 작업 순서 조정과 같은 공통적인 문제가 포함된다.</p>\n<p>웹 서버의 경우, 일반적으로 요청과 처리의 워크플로우를 가지며, 여러 웹 요청을 동시에 처리할 수 있어야 한다.\n여기서는 인기있는 인기있는 웹 프레임워크의 동시성 프로그래밍 모델에 대해서 알아보려고 한다. </p>\n<h2 id=\"Thread-based-Concurrency\" style=\"position:relative;\">Thread-based Concurrency<a href=\"#Thread-based-Concurrency\" aria-label=\"Thread based Concurrency permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>스레드 기반 접근 방식은 들어오는 각 요청을 별도의 스레드와 연결한다. thread-per-request 모델이라고도 한다.\nThread-based Concurrency 모델은 스레드가 원격 호출, File I/O 등의 이유로 블로킹될 수 있다고 가정한다.\n이러한 이유로 대량 스레드풀을 사용하여 스레드 하나가 요청 하나를 처리한다.\n또한 요청 처리에 필요한 모든 작업을 순차적으로 코딩할 수 있기 때문에 코딩 난이도 및 디버깅이 용이하다는 장점이 있다.\n아래는 Socket 기반 요청이 들어올 때 마다 Counter 값을 증가시키고 응답하는 간단한 웹 서버를 구현한 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> counter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> socket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerSocket</span><span class=\"token punctuation\">(</span><span class=\"token number\">8080</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> clientSocket <span class=\"token operator\">=</span> socket<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"accept client\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">WorkerRunnable</span><span class=\"token punctuation\">(</span>clientSocket<span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Counter</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Integer</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token class-name\">Integer</span> <span class=\"token function\">increase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WorkerRunnable</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Socket</span> clientSocket<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Counter</span> counter<span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">WorkerRunnable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Socket</span> clientSocket<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Counter</span> counter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clientSocket <span class=\"token operator\">=</span> clientSocket<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>counter <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token annotation punctuation\">@Override</span>\n\t\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">BufferedReader</span> input <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedReader</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InputStreamReader</span><span class=\"token punctuation\">(</span>clientSocket<span class=\"token punctuation\">.</span><span class=\"token function\">getInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token class-name\">OutputStream</span> output <span class=\"token operator\">=</span> clientSocket<span class=\"token punctuation\">.</span><span class=\"token function\">getOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> time <span class=\"token operator\">=</span> <span class=\"token class-name\">LocalDateTime</span><span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token class-name\">String</span> readLine<span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token class-name\">String</span> req <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>readLine <span class=\"token operator\">=</span> input<span class=\"token punctuation\">.</span><span class=\"token function\">readLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\treq <span class=\"token operator\">=</span> readLine<span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readLine<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// If the end of the http request, stop</span>\n\t\t\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> req<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"favicon.ico\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> increase <span class=\"token operator\">=</span> counter<span class=\"token punctuation\">.</span><span class=\"token function\">increase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t\t\toutput<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>\n\t\t\t\t\t\t<span class=\"token punctuation\">(</span><span class=\"token string\">\"HTTP/1.1 200 OK\\n\\nWorkerRunnable: \"</span> <span class=\"token operator\">+</span>\n\t\t\t\t\t\t\t\tincrease <span class=\"token operator\">+</span> <span class=\"token string\">\" - \"</span> <span class=\"token operator\">+</span> time <span class=\"token operator\">+</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\toutput<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\toutput<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tinput<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Request processed: {}\"</span><span class=\"token punctuation\">,</span> increase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>ex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Counter 클래스는 여러 스레드가 Counter 값을 증가시키기 위해 쓰기 경쟁이 발생할 수 있다.\n이는 Counter 값이 변경 가능한 공유 상태이기 때문에 Counter 값이 CPU 스케줄링과 같은\n특정 타이밍에 따라 연산의 결과가 달라질 수 있기 때문이다. 이러한 상황을 경쟁 상태(Race Condition) 이라고 한다.</p>\n<p>경쟁 상태의 원인은 변경 가능한 공유 변수에 대한 연산이 atomic operation이 아니기 때문이다.\nwiki 에서는 atomic operation을 다음과 같이 정의하고 있다.</p>\n<blockquote>\n<p>원자적 연산은 연산이 실행되는 동안 다른 프로세스가 해당 연산 중에 읽거나 변경하는 상태를 읽거나 변경할 수 없는 연산을 의미합니다.</p>\n</blockquote>\n<p>즉, atomic operation은 단순히 쪼갤 수 없는 연산이 아니라 한 번에 하나의 코드 섹션을 실행할 수 있는 operation 이라고 볼 수 있다.\n여기서는 counter 변수에 값을 증가시키는 메서드를 synchronized 로 동기화하여 경쟁 상태를 해결하였다.\n공유 상태를 사용하는 동시성 모델의 경우 자바에서는 synchronized 와 같은 잠금 메커니즘을 사용하게 된다.</p>\n<p>잠금을 사용하면 임계 영역에 대한 엑세스를 직렬화하여 atomic operation을 구현할 수 있다.\n잠금은 너무 크게 잡으면 동시성이 떨어지고, 잠금을 너무 미세하게 잡으면 데드락, 기아상태 등을 유발하기 쉬워진다.</p>\n<p>스레드 기반 동시성 모델의 또 다른 단점은 Context-Switching 오버헤드이다.\nCPU가 한 스레드 실행에서 다른 스레드 실행으로 전환할 때 CPU는 현재 스레드의 로컬 데이터, 프로그램 포인터 등을 저장하고 실행할 다음 스레드의 로컬 데이터, 프로그램 포인터 등을 로드해야 한다.\n이 비용은 결코 저렴하지 않다. 불필요한 컨텍스트 스위칭으로 많은 시간을 허비할 수도 있다.</p>\n<h2 id=\"Event-driven-Concurrency\" style=\"position:relative;\">Event-driven Concurrency<a href=\"#Event-driven-Concurrency\" aria-label=\"Event driven Concurrency permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Event-driven Concurrency은 이벤트에 응답하여 동시에 여러 작업을 수행하는 프로그래밍 방식을 의미한다.\n이는 전통적인 스레드 기반의 동시성과는 다르게 동작하는데, 스레드 기반 동시성은 여러 스레드가 동시에 실행되는 반면,\nEvent-driven Concurrency은 일반적으로 한 스레드 내에서 여러 작업을 비동기적으로 수행된다.\n따라서 스레드 관리, 동기화 문제, 데드락 등의 복잡한 동시성 문제에서 자유롭다.</p>\n<p>대신, 스레드 기반 동시성에 비해 실행 흐름을 파악하기 어렵고 콜백 지옥 같은 문제로 코드 복잡성이 증가할 수 있다.\nCPU 집약적인 작업(이미지 처리, 동영상 처리) 등 에는 적합하지 않을 수 있다. 한 작업이 너무 오래 걸리면 다른 이벤트 처리가 지연될 수 있기 때문이다.</p>\n<p>이러한 패러다임은 Node.js, Vert.x 등의 프레임워크에서 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">EventHandler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span> key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ReactorEventLoopExample</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Selector</span> selector <span class=\"token operator\">=</span> <span class=\"token class-name\">Selector</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">ServerSocketChannel</span> serverChannel <span class=\"token operator\">=</span> <span class=\"token class-name\">ServerSocketChannel</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        serverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        serverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InetSocketAddress</span><span class=\"token punctuation\">(</span><span class=\"token number\">8080</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">SelectionKey</span> key <span class=\"token operator\">=</span> serverChannel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_ACCEPT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        key<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AcceptHandler</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> serverChannel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> readyChannels <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>readyChannels <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Set</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> selectedKeys <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">.</span><span class=\"token function\">selectedKeys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">Iterator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">></span></span> keyIterator <span class=\"token operator\">=</span> selectedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>keyIterator<span class=\"token punctuation\">.</span><span class=\"token function\">hasNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">SelectionKey</span> selectionKey <span class=\"token operator\">=</span> keyIterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">EventHandler</span> handler <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">EventHandler</span><span class=\"token punctuation\">)</span> selectionKey<span class=\"token punctuation\">.</span><span class=\"token function\">attachment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handler <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    handler<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>selectionKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                keyIterator<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AcceptHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EventHandler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Selector</span> selector<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ServerSocketChannel</span> serverSocketChannel<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 카운터 추가</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AcceptHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Selector</span> selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ServerSocketChannel</span> serverSocketChannel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>selector <span class=\"token operator\">=</span> selector<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>serverSocketChannel <span class=\"token operator\">=</span> serverSocketChannel<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span> key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SocketChannel</span> clientChannel <span class=\"token operator\">=</span> serverSocketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>clientChannel <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            counter<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 클라이언트가 연결될 때마다 카운터 증가</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Client accepted. Current connection count: \"</span> <span class=\"token operator\">+</span> counter<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            clientChannel<span class=\"token punctuation\">.</span><span class=\"token function\">configureBlocking</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">SelectionKey</span> clientKey <span class=\"token operator\">=</span> clientChannel<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SelectionKey</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OP_READ</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            clientKey<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ReadHandler</span><span class=\"token punctuation\">(</span>clientChannel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ReadHandler</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">EventHandler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SocketChannel</span> socketChannel<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ReadHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocketChannel</span> socketChannel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>socketChannel <span class=\"token operator\">=</span> socketChannel<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SelectionKey</span> key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ByteBuffer</span> buffer <span class=\"token operator\">=</span> <span class=\"token class-name\">ByteBuffer</span><span class=\"token punctuation\">.</span><span class=\"token function\">allocate</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> read <span class=\"token operator\">=</span> socketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>read <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">String</span> output <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Received: \"</span> <span class=\"token operator\">+</span> output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>read <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            socketChannel<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 예제는 싱글 스레드를 사용한 이벤트 루프 방식의 간단한 서버이다. 싱글 스레드로 동작하기 때문에 counter 값을 동기화하기 위한 스레드 조정이 필요없다.\n싱글 스레드를 사용하기 때문에 Race condition이 발생하지 않고 context switching 오버헤드도 발생하지 않는다.\n이벤트 루프 내 Blocking I/O 작업이 발생하면 이벤트 루프가 블록킹 상태로 유지되기 때문에 이러한 작업은 별도의 백그라운드 스레드에서 처리해야 동시성을 높일 수 있다.</p>\n<h2 id=\"Actor-based-Concurrency\" style=\"position:relative;\">Actor-based Concurrency<a href=\"#Actor-based-Concurrency\" aria-label=\"Actor based Concurrency permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>","fields":{"slug":"/java-concurrency-model/"},"frontmatter":{"title":"웹 서버를 위한 동시성 프로그래밍 모델","date":"September 07, 2023"}},{"id":"ecca18c5-bf6e-5774-8ac7-467855cb953f","html":"<h2 id=\"synchronized-락의-단점\" style=\"position:relative;\">synchronized 락의 단점<a href=\"#synchronized-%EB%9D%BD%EC%9D%98-%EB%8B%A8%EC%A0%90\" aria-label=\"synchronized 락의 단점 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>락이 걸린 객체에서 일어나는 동기화 작업은 모두 균등하게 취급된다.</li>\n<li>락 획득/해제는 반드시 메서드 수준이나 메서드 내부의 동기화 블록 안에서 이루어져야 한다.</li>\n<li>락을 얻지 못한 스레드는 블로킹된다. 락을 얻지 못할 경우, 락을 얻어 처리를 계속하려고 시도하는 것조차 불가능하다.</li>\n</ul>\n<p>락이 걸린 데이터에 모든 연산이 동등하게 취급된다는 의미는 읽기/쓰기 작업에 동일한 레벨의 락의 필요하다는 의미이다.</p>\n<h2 id=\"Java-동시성-라이브러리\" style=\"position:relative;\">Java 동시성 라이브러리<a href=\"#Java-%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC\" aria-label=\"Java 동시성 라이브러리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>java.util.concurrent 패키지에는 멀티스레드 애플리케이션을 더 쉽게 개발할 수 있게 설계된 자바의 표준 라이브러리이다. 이 라이브러리에서 제공하는 기능은 크게 다음과 같다.</p>\n<ul>\n<li>락, 세마포어</li>\n<li>atomics</li>\n<li>Blocking Queue</li>\n<li>latch</li>\n<li>\n<p>Executor</p>\n<!-- more -->\n</li>\n</ul>\n<h3 id=\"javautilconcurrentlocksLock\" style=\"position:relative;\">java.util.concurrent.locks.Lock<a href=\"#javautilconcurrentlocksLock\" aria-label=\"javautilconcurrentlocksLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Lock</span> <span class=\"token punctuation\">{</span>\n\n\n    <span class=\"token comment\">/**\n    * 기존 방식대로 락을 획득하고 락을 사용할 수 있을 때까지 블록킹한다\n    **/</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n    * 대기중인 스레드에 인터럽트할 수 있게 해준다. interrupt() 가 호출되면 대기 상태가 * 인터럽트되며 InterruptedException 이 던져진다.\n    **/</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token comment\">/**\n    * 호출 시점에 잠금이 해제된 경우에만 잠금을 획득한다.\n    **/</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    \n    <span class=\"token comment\">/**\n    * 락을 획득하려고 시도한다. 타임아웃이 설정이 가능하다.\n    **/</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> time<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span> unit<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token comment\">/**\n    * 락을 해제한다. lock()에 대응되는 후속 호출이다.\n    **/</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token comment\">/**\n    * 락 주위에 조건을 설정해 유연하게 락을 활용할 수 있다. (읽기와 쓰기를 분리할 수 있다)\n    **/</span>  \n    <span class=\"token class-name\">Condition</span> <span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ReentrantLock 클래스는 Lock의 주요 구현체로, 내부적으로 int 값으로 compareAndSwap()을 한다.\n(AtomicInteger 클래스의 Unsafe 클래스 참조)</p>\n<h3 id=\"읽기쓰기-락\" style=\"position:relative;\">읽기/쓰기 락<a href=\"#%EC%9D%BD%EA%B8%B0%EC%93%B0%EA%B8%B0-%EB%9D%BD\" aria-label=\"읽기쓰기 락 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>기존 synchronized 나 ReentrantLock 을 이용하면 한 가지 락 정책을 따를 수 밖에 없다.\n한 읽기 스레드 때문에 나머지 읽기 스레드를 블로킹하여 처리율이 낮아질 수 있다.\n이럴 때 ReentrantReadWriteLock 클래스의 ReadLock, WriteLock을 활용하면 여러 스레드가\n읽기 작업을 하는 도중에도 다른 읽기 스레드를 블로킹하지 않게 할 수 있다. 블로킹은 쓰기 작업을 할 때만 발생한다.\nReentrantReadWriteLock의 생성자로 boolean fair 라는 파라미터를 받는데 기본값은 false, 불공정(non-fair) 모드이다.\n'불공정’이란 말 자체의 의미처럼 락을 획득한 스레드 하나가 다른 여러 스레드가 고갈되건 말건 상관하지 않습니다. 반대로, '공정’ 모드에서는 어느 정도 스레드 간 공정성이 보장되도록 FIFO에 가까운 방식으로 락을 획득할 수 있게 함으로써 각 스레드가 대기하는 시간을 최대한 균등하게 분배한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StockInventory</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ReentrantReadWriteLock</span> rwl <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantReadWriteLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Lock</span> readLock <span class=\"token operator\">=</span> rwl<span class=\"token punctuation\">.</span><span class=\"token function\">readLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Lock</span> writeLock <span class=\"token operator\">=</span> rwl<span class=\"token punctuation\">.</span><span class=\"token function\">writeLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> stockRepository <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Integer</span> <span class=\"token function\">getStock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        readLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"readLock lock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> stockRepository<span class=\"token punctuation\">.</span><span class=\"token function\">getOrDefault</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            readLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"readLock unLock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">increaseStock</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        writeLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"writeLock lock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            stockRepository<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> stockRepository<span class=\"token punctuation\">.</span><span class=\"token function\">getOrDefault</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            writeLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"writeLock unlock\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"ReadLock-vs-ReadLock\" style=\"position:relative;\">ReadLock vs ReadLock<a href=\"#ReadLock-vs-ReadLock\" aria-label=\"ReadLock vs ReadLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">readLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockInventory</span> stockInventory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StockInventory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> qty <span class=\"token operator\">=</span> stockInventory<span class=\"token punctuation\">.</span><span class=\"token function\">getStock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>qty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> qty <span class=\"token operator\">=</span> stockInventory<span class=\"token punctuation\">.</span><span class=\"token function\">getStock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>qty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">15:40:09.316 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- readLock lock\n15:40:09.316 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- readLock lock\n15:40:11.321 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- readLock unLock\n0\n15:40:11.324 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- readLock unLock\n0</code></pre></div>\n<p>읽기 vs 읽기 시, 락 경합이 발생하지 않는다.</p>\n<h3 id=\"WriteLock-vs-WriteLock\" style=\"position:relative;\">WriteLock vs WriteLock<a href=\"#WriteLock-vs-WriteLock\" aria-label=\"WriteLock vs WriteLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">writeLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockInventory</span> stockInventory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StockInventory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                stockInventory<span class=\"token punctuation\">.</span><span class=\"token function\">increaseStock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                stockInventory<span class=\"token punctuation\">.</span><span class=\"token function\">increaseStock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">15:42:00.459 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock lock\n15:42:02.467 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock lock\n15:42:02.467 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock unlock\n15:42:04.471 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock unlock</code></pre></div>\n<p>먼저 writeLock을 점유한 스레드가 unlock 할 때까지, 뒤에 writeLock 쓰레드가 대기한다.</p>\n<h3 id=\"WriteLock-vs-ReadLock\" style=\"position:relative;\">WriteLock vs ReadLock<a href=\"#WriteLock-vs-ReadLock\" aria-label=\"WriteLock vs ReadLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">writeLockVsReadLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">StockInventory</span> stockInventory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StockInventory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                stockInventory<span class=\"token punctuation\">.</span><span class=\"token function\">increaseStock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>\n            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> qty <span class=\"token operator\">=</span> stockInventory<span class=\"token punctuation\">.</span><span class=\"token function\">getStock</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"aaa\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>qty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">15:44:10.126 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock lock\n15:44:12.133 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- readLock lock\n15:44:12.133 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock unlock\n15:44:14.144 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- readLock unLock\n1</code></pre></div>\n<p>writeLock을 점유한 스레드가 unlock 할 때 까지, readLock이 대기한다.</p>\n<h3 id=\"ReadWrite-vs-WriteLock\" style=\"position:relative;\">ReadWrite vs WriteLock<a href=\"#ReadWrite-vs-WriteLock\" aria-label=\"ReadWrite vs WriteLock permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token number\">15</span><span class=\"token operator\">:</span><span class=\"token number\">46</span><span class=\"token operator\">:</span><span class=\"token number\">12.891</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Thread</span><span class=\"token operator\">-</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token constant\">INFO</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>javaconcurrency<span class=\"token punctuation\">.</span>lib<span class=\"token punctuation\">.</span></span>StockInventory</span> <span class=\"token operator\">--</span> readLock lock\n<span class=\"token number\">15</span><span class=\"token operator\">:</span><span class=\"token number\">46</span><span class=\"token operator\">:</span><span class=\"token number\">14.899</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Thread</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token constant\">INFO</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>javaconcurrency<span class=\"token punctuation\">.</span>lib<span class=\"token punctuation\">.</span></span>StockInventory</span> <span class=\"token operator\">--</span> writeLock lock\n<span class=\"token number\">15</span><span class=\"token operator\">:</span><span class=\"token number\">46</span><span class=\"token operator\">:</span><span class=\"token number\">14.899</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Thread</span><span class=\"token operator\">-</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token constant\">INFO</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>javaconcurrency<span class=\"token punctuation\">.</span>lib<span class=\"token punctuation\">.</span></span>StockInventory</span> <span class=\"token operator\">--</span> readLock unLock\n<span class=\"token number\">0</span>\n<span class=\"token number\">15</span><span class=\"token operator\">:</span><span class=\"token number\">46</span><span class=\"token operator\">:</span><span class=\"token number\">16.904</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Thread</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token constant\">INFO</span> <span class=\"token class-name\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>javaconcurrency<span class=\"token punctuation\">.</span>lib<span class=\"token punctuation\">.</span></span>StockInventory</span> <span class=\"token operator\">--</span> writeLock unlock</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">15:46:56.315 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- readLock lock\n15:46:58.323 [Thread-0] INFO com.example.javaconcurrency.lib.StockInventory -- readLock unLock\n0\n15:46:58.325 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock lock\n15:47:00.330 [Thread-1] INFO com.example.javaconcurrency.lib.StockInventory -- writeLock unlock</code></pre></div>\n<p>readLock 점유한 스레드가 unlock 할 때 까지, writeLock 대기한다.</p>\n<h2 id=\"세마포어\" style=\"position:relative;\">세마포어<a href=\"#%EC%84%B8%EB%A7%88%ED%8F%AC%EC%96%B4\" aria-label=\"세마포어 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>세마포어는 풀 스레드나 DB 접속 객체 등 여러 리소스를 최대 X개 객체까지만 액세스를 허용한다는 전제하에 정해진 수량의 퍼밋으로 액세스를 제어한다.\nSemaphore 클래스의 acquire() 메서드는 사용 가능한 퍼밋 수를 하나씩 줄이는데, 더 이상 쓸 수 있는 퍼밋이 없을 경우 블로킹된다.\nrelease() 메서드는 퍼밋을 반납하고 대기 중인 스레드 중에서 하나에게 해제한 퍼밋을 전달한다.\n세마포어는 리소스를 기다리는 스레드가 리소스를 점유하지 못하는 기아상태가 될 가능성이 커서 공정모드로 초기화하는 경우가 많다.\n퍼밋이 하나뿐인 세마포어는 뮤텍스와 동등하다. 그러나 뮤텍스는 뮤텍스가 걸린 스레드만 해제할 수 있는 반면, 세마포어는 비소유 스레드도 락을 해제할 수 있다는 점이 다르다.</p>\n<h3 id=\"Connection-Pool-예제\" style=\"position:relative;\">Connection Pool 예제<a href=\"#Connection-Pool-%EC%98%88%EC%A0%9C\" aria-label=\"Connection Pool 예제 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ConnectionPool</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Semaphore</span> semaphore<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Queue</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> connectionPool<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ConnectionPool</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> poolSize<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>semaphore <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Semaphore</span><span class=\"token punctuation\">(</span>poolSize<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>connectionPool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> poolSize<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            connectionPool<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pool\"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">acquireConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n        semaphore<span class=\"token punctuation\">.</span><span class=\"token function\">acquire</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"acquire connection\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> connectionPool<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">releaseConnection</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> connection<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"release connection\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        connectionPool<span class=\"token punctuation\">.</span><span class=\"token function\">offer</span><span class=\"token punctuation\">(</span>connection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        semaphore<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ConnectionPoolTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">semaphoreTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> connectionPool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConnectionPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">4</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> connection <span class=\"token operator\">=</span> connectionPool<span class=\"token punctuation\">.</span><span class=\"token function\">acquireConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connection acquired = {}\"</span><span class=\"token punctuation\">,</span> connection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    connectionPool<span class=\"token punctuation\">.</span><span class=\"token function\">releaseConnection</span><span class=\"token punctuation\">(</span>connection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span>\n\n\n        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">15000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">16:26:59.908 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n16:26:59.908 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n16:26:59.912 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool1\n16:26:59.911 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n16:27:01.918 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n16:27:01.918 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n16:27:01.919 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n16:27:01.919 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n16:27:01.919 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool1\n16:27:01.919 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n16:27:03.925 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n16:27:03.925 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection</code></pre></div>\n<p>semaphore fair = true 시, 리소스에 락을 획득하려고 하는 스레드가 많을 때 할당되는 방식이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">semaphore_wait_Test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> connectionPool <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ConnectionPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">10</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> connection <span class=\"token operator\">=</span> connectionPool<span class=\"token punctuation\">.</span><span class=\"token function\">acquireConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connection acquired = {}\"</span><span class=\"token punctuation\">,</span> connection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">2000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                connectionPool<span class=\"token punctuation\">.</span><span class=\"token function\">releaseConnection</span><span class=\"token punctuation\">(</span>connection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n\n\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">15000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">21:00:09.426 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:09.427 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n21:00:11.432 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n21:00:11.432 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:11.432 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n21:00:13.437 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n21:00:13.438 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:13.438 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n21:00:15.443 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n21:00:15.443 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:15.443 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n21:00:17.448 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n21:00:17.449 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:17.449 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n21:00:19.452 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n21:00:19.452 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:19.452 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n21:00:21.453 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n21:00:21.453 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:21.453 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0\n21:00:23.457 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.ConnectionPool -- release connection\n21:00:23.458 [pool-1-thread-5] INFO com.example.javaconcurrency.lib.ConnectionPool -- acquire connection\n21:00:23.458 [pool-1-thread-5] INFO com.example.javaconcurrency.lib.ConnectionPoolTest -- connection acquired = pool0</code></pre></div>\n<p>executorService.execute() 로 실행된 스레드 순서별로 (1~5) 락을 공정하게 획득하는 것을 확인할 수 있다.</p>\n<h2 id=\"Latch\" style=\"position:relative;\">Latch<a href=\"#Latch\" aria-label=\"Latch permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Latch 는 스레드의 실행을 제어하는 유용한 기법이다. 스레드가 태스크#1 -> 태스크#2 -> 태스크#3 순서로 진행되어야 한다면 Latch를\n쓰기에 적합한 경우다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">LatchExample</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">CountDownLatch</span> latch<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">LatchExample</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">CountDownLatch</span> latch<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>latch <span class=\"token operator\">=</span> latch<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Do parallel Async Processing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tlatch<span class=\"token punctuation\">.</span><span class=\"token function\">countDown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\tlatch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Done parallel Async Processing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">latch_test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> countDownLatch <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CountDownLatch</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> pool <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">5</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        pool<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">LatchExample</span><span class=\"token punctuation\">(</span>countDownLatch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"await on main\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    countDownLatch<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"done on main\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">21:15:33.891 [pool-1-thread-5] INFO com.example.javaconcurrency.lib.LatchExample -- Do parallel Async Processing\n21:15:33.891 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.LatchExample -- Do parallel Async Processing\n21:15:33.891 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.LatchExample -- Do parallel Async Processing\n21:15:33.891 [main] INFO com.example.javaconcurrency.lib.LatchExampleTest -- await on main\n21:15:33.891 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.LatchExample -- Do parallel Async Processing\n21:15:33.891 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.LatchExample -- Do parallel Async Processing\n21:15:34.898 [pool-1-thread-5] INFO com.example.javaconcurrency.lib.LatchExample -- Done parallel Async Processing\n21:15:34.899 [pool-1-thread-2] INFO com.example.javaconcurrency.lib.LatchExample -- Done parallel Async Processing\n21:15:34.898 [main] INFO com.example.javaconcurrency.lib.LatchExampleTest -- done on main\n21:15:34.898 [pool-1-thread-3] INFO com.example.javaconcurrency.lib.LatchExample -- Done parallel Async Processing\n21:15:34.899 [pool-1-thread-4] INFO com.example.javaconcurrency.lib.LatchExample -- Done parallel Async Processing\n21:15:34.898 [pool-1-thread-1] INFO com.example.javaconcurrency.lib.LatchExample -- Done parallel Async Processing</code></pre></div>\n<p>Latch 카운터가 처음에 5로 세팅하고 countDown()을 호출할 때마다 카운트 값은 1만큼 감소한다.\n카운트가 0이 되면 래치가 열리고 await() 함수 때문에 대기 중이던 스레드는 모두 해제되어 처리를 재개하게 된다.\n래치는 단 한번밖에 사용할 수 없다. 결과가 0이 되면 해당 래치는 두 번 다시 재사용할 수 없다.</p>\n<h2 id=\"Executor와-태스크-추상화\" style=\"position:relative;\">Executor와 태스크 추상화<a href=\"#Executor%EC%99%80-%ED%83%9C%EC%8A%A4%ED%81%AC-%EC%B6%94%EC%83%81%ED%99%94\" aria-label=\"Executor와 태스크 추상화 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>저수준의 스레드 문제를 직접 다루려고 하기 보다는 java.util.concurrent 패키지에서 적절한 수준으로 추상화된 동시 프로그래밍 라이브러리를 쓰는 편이 좋다.\nJava에서는 일의 단위를 Task로 추상화하여 개발자는 실제 스레드의 수명주기를 일일히 신경 쓸 필요없이 사용할 수 있도록 하였다.\nExecutorService는 관리되는 스레드 풀에서 태스크 실행 메커니즘을 규정한 인터페이스다.<br>\nExecutors는 헬퍼 클래스로, 스레드 풀을 생성하는 팩터리 메서드를 제공한다.</p>\n<ul>\n<li>newFixedThreadPool(int nThreads)\n크기가 고정된 스레드 풀을 지닌 ExecutorService를 생성한다. 스레드는 재사용되며 스레드가 전부 사용 중일 경우, 새 태스크는 큐에 보관한다.</li>\n<li>newCachedThreadPool()\n필요한 만큼 스레드를 생성하되 가급적 스레드를 재사용한다. 생성된 스레드는 60초 간 유지되며, 그 이후에는 캐시에서 삭제된다.\n소규모 비동기 태스크의 성능을 향상시킬 수 있다.</li>\n<li>newSingleThreadExecutor()\n스레드 하나만 가지는 ExecutorService를 생성한다.</li>\n<li>newScheduledThreadPool(int corePoolSize)\n미래에 태스크를 실행시킬 수 있도록 Callable 과 지연 시간을 전달받는 메서들이 있다.</li>\n</ul>\n<h2 id=\"포크조인\" style=\"position:relative;\">포크/조인<a href=\"#%ED%8F%AC%ED%81%AC%EC%A1%B0%EC%9D%B8\" aria-label=\"포크조인 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>자바 7부터 등장한 포크 조인 프레임워크는 멀티 프로세서 환경에서 효율적으로 작동하는 새로운 API를 제공한다.\n이 프레임워크는 ForkJoinPool 이라는 새로운 ExecutorService 구현체에 기반한다. ForkJoinPool 클래스는 다음과 같은 다음과 같은 특징을 가진다.</p>\n<ul>\n<li>하위 분할 태스크를 효율적으로 처리할 수 있다.</li>\n<li>Work-Stealing(작업 빼앗기) 알고리즘을 구현한다.</li>\n</ul>\n<p>Work-Stealing 알고리즘은 어느 스레드가 자신이 할당받은 작업을 모두 마쳤는데 다른 스레드에 아직 배로그가 남아 있으면\n바쁜 스레드의 큐에서 작업을 가져와 실행할 수 있다.</p>\n<h2 id=\"스트림과-병렬-스트림\" style=\"position:relative;\">스트림과 병렬 스트림<a href=\"#%EC%8A%A4%ED%8A%B8%EB%A6%BC%EA%B3%BC-%EB%B3%91%EB%A0%AC-%EC%8A%A4%ED%8A%B8%EB%A6%BC\" aria-label=\"스트림과 병렬 스트림 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>모든 컬렉션은 Collection 인터페이스에 있는 stream() 메서드를 제공해야한다.\nstream()은 스트림을 생성하는 구현체를 내어주는 메서드로 내부에서 ReferencePipeline을 생성한다.\nparallelStream()은 병렬로 데이터를 작업 후 그 결과를 재조합할 수 있다. 내부적ㅇ로 Spliterator를 써서 작업을 분할하고\n공용 포크/조인 풀에서 연산을 수행한다.</p>\n<h2 id=\"락-프리-기법\" style=\"position:relative;\">락-프리 기법<a href=\"#%EB%9D%BD-%ED%94%84%EB%A6%AC-%EA%B8%B0%EB%B2%95\" aria-label=\"락 프리 기법 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>락-프리 기법은 블로킹 기반의 락 메커니즘이 처리율에 악영향을 미친다는 전제하에 시작되었다.\n스레드 락이 걸리는 상황에서는 스레드를 중단/재개시키는 과정(컨텍스트 스위칭)에 많은 시간이 소요될 수 있으므로 락-프리한 기법보다 훨씬 느릴 수 밖에 없다.</p>","fields":{"slug":"/java-concurrency/"},"frontmatter":{"title":"Java의 동시성 프로그래밍 - overview","date":"August 14, 2023"}},{"id":"6f729c84-2239-5a02-8561-deca0f9b05c5","html":"<h2 id=\"Primary-Key-설계의-중요성\" style=\"position:relative;\">Primary Key 설계의 중요성<a href=\"#Primary-Key-%EC%84%A4%EA%B3%84%EC%9D%98-%EC%A4%91%EC%9A%94%EC%84%B1\" aria-label=\"Primary Key 설계의 중요성 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>InnoDB 기준으로 MySQL은 Primary Key를 기준으로 데이터를 클러스터링한다.\n클러스터링이라는 용어는 인접한 키 값이 있는 레코드가 물리적으로도 인접하게 저장된다는 것을 말한다.\n즉, 논리적인 PK 값에 의해 레코드의 물리적인 위치가 결정된다.\nPK값이 변경된다면 해당 레코드의 물리적인 위치도 변경된다는 얘기다.   </p>\n<p>모든 데이터베이스가 마찬가지겠지만 MySQL의 PK 설계는 다른 데이터베이스보다 더 중요하다고 볼 수 있다.\n왜냐하면, 일부 데이터베이스에서는 클러스터링할 인덱스를 선택할 수 있지만 MySQL은 기본키로 고정되어 변경할 수 없다. (MySQL 8.x 기준)<br>\n또한, MySQL은 Secondary Index의 Leaf Node에 오라클과 같이 물리적 위치에 대한 참조(ROWID)가 아닌 PK 값을 저장하고, PK 인덱스를 통해 실제 디스크 블록에 접근한다. 따라서, MySQL에서 PK 는 단순히 데이터를 식별하기 위한 식별자 역할뿐만 아니라 내부 구현에도 관여하기 때문에 그 중요성은 매우 크다고 볼 수 있다.</p>\n<h2 id=\"클러스터형-인덱스\" style=\"position:relative;\">클러스터형 인덱스<a href=\"#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%ED%98%95-%EC%9D%B8%EB%8D%B1%EC%8A%A4\" aria-label=\"클러스터형 인덱스 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>고성능을 위한 Primary Key 를 설계하기 위해서는 Primary Key 의 저장 구조인 클러스터형 인덱스에 대한 이해가 필요하다.\n아래의 그림은 <strong>Secondary Index</strong>(Non-Clusted Index) 와 <strong>Primary Key Index</strong>(Clusted Index) 의 저장 구조를 나타낸다.   </p>\n<p><strong>Secondary Index</strong>(Non-Clusted Index) 그림의 리프 노드를 보면 Index Key 값에 해당 하는 Primary Key 값을 저장하고 있는 것을 볼 수 있다.\nIndex Key 값은 정렬되어 있지만 Index Key 값에 맵핑되는 Primary Key들 사이에는 아무런 순서관계가 없다.</p>\n<p><strong>Primary Key Index</strong>(Clusted Index) 그림의 리프 노드는 Index Key 값 기준으로 정렬되어 있고,\n참조가 아닌 실제 레코드를 저장하는 페이지가 리프노드에 위치해 있다. 페이지 내에서도 Primary Index Key 값 기준으로 레코드가 물리적으로 정렬되어 있다.</p>\n<!-- more -->\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a67dad59e6a37da0b5730238ef926ae2/f97d7/index-tree.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.94117647058825%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDElEQVR42p2Ta2+iQBiF/f//Zj/sl00v2nQ3rbV1d1vXFRURQQXkLggjcPYwpU3TaGt2kjckM8zzXs6ZFt4tz7axms0QBcHrXlVVMk5ZLXmhLJ9hvo/QsZHYFubTKVzXfQWeuiRw67mwxmO4jgOx38uDXZbBNU1EqyV87qe73WnA9WoFQ5tB+zuEuVgg2W7lgW1ZMNj6gommioJdmp4GnPR62MxURJoKY/AI8/E3/MkYPvfssYLINGApI6TLJTwmyYX4GFgUBQq2I1hBXe1gMEDAWYokQckzKQhnXDAyjkEQWDYzPy4KYVb3BlrnEqsf19AuzhCNhrUaEvYCDSiWvdAR+t5RB0gg0gThdRvOxTeUD12E7TOI4RMqClTlOcBKXVYfW2vkgQ+Vcw3D8KADJLDM2QovZmynjpwAwSQyF6vRKZizXqNsLqfsyNZ1BJyvW9vsjWCtJo2somLIb20d7hm8ZKgqdKpszOdI4lj+brFaU9MwH40wYWyj6B3w7Wqq2NGbk34fG3WKZGli3n+ActeFN1EQEL6h1WIq79BaKat3+cKE2B8AvnCLPUq2X1DZPI5gGAb+DJ4QMJHYxijZRbkXsquqVr5xROszo5a0lH9/C+fuBvpVG3r7HM6vn0ef5AfA558rAsOrS8TfO9h0zmF+/QKvd/s/wKZCtpbyOWY5HZDl8o3nzfM8ZOx/bpOGDyoIltcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"\"\n        src=\"/static/a67dad59e6a37da0b5730238ef926ae2/ca1dc/index-tree.png\"\n        srcset=\"/static/a67dad59e6a37da0b5730238ef926ae2/e7570/index-tree.png 170w,\n/static/a67dad59e6a37da0b5730238ef926ae2/f46e7/index-tree.png 340w,\n/static/a67dad59e6a37da0b5730238ef926ae2/ca1dc/index-tree.png 680w,\n/static/a67dad59e6a37da0b5730238ef926ae2/02d09/index-tree.png 1020w,\n/static/a67dad59e6a37da0b5730238ef926ae2/9d567/index-tree.png 1360w,\n/static/a67dad59e6a37da0b5730238ef926ae2/f97d7/index-tree.png 2000w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">img.png</figcaption>\n  </figure></p>\n<p>Clusted Index는 구조적인 이유로 순차적인 Key 값을 넣을 때, 오버헤드가 가정 적고 가장 빠르다. 단순히 Index 트리 오른쪽 맨끝에 새로운 레코드를 삽입해주기만 하면 된다.<br>\n반면에 비순차적인 Key 값이 들어오게 되면 상황이 복잡해진다. Key 값이 기존 데이터 중간에 삽입될 수 있으므로 트리 구조를 변경사항에 맞게 갱신해야 한다.<br>\n또한, 리프 노드의 페이지 안에 있는 데이터의 순서도 조정이 필요하다. 기존 데이터 사이에 새 레코드의 적절한 위치를 찾고 공간을 확보해야 한다. 이로 인해 많은 데이터의 이동이 필요할 수 있고 페이지 분할로 단편화 문제가 발생할 수 있다.</p>\n<p>따라서 INSERT 속도가 중요한 테이블이라면 순차적인 값을 Primary Key로 선정하는 것이 유리하다.</p>\n<h2 id=\"Primary-Key-유형\" style=\"position:relative;\">Primary Key 유형<a href=\"#Primary-Key-%EC%9C%A0%ED%98%95\" aria-label=\"Primary Key 유형 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h3 id=\"자동-증가-Auto-Increment-Primary-Key\" style=\"position:relative;\">자동 증가 (Auto Increment) Primary Key<a href=\"#%EC%9E%90%EB%8F%99-%EC%A6%9D%EA%B0%80-Auto-Increment-Primary-Key\" aria-label=\"자동 증가 Auto Increment Primary Key permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><strong>장점</strong></p>\n<ul>\n<li>Primary Key 채번을 DB에 위임하므로 관리 포인트가 줄어든다.</li>\n</ul>\n<p><strong>단점</strong></p>\n<ul>\n<li>테이블의 대량 INSERT 작업 시, Auto Increament 에서 병목현상이 발생할 수 있다.</li>\n</ul>\n<h3 id=\"UID\" style=\"position:relative;\">UID<a href=\"#UID\" aria-label=\"UID permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>클러스터형 인덱스 구조를 이해하면, UUID와 같은 랜덤 값이 Primary Key로 선정될 경우, 레코드 클러스터링에 필요한 오버헤드만 발생하고 크게 이점이 없음을 알 수 있다.\n그러나 랜덤 UID가 아닌 순차적인 UID를 생성하면 Auto Increment의 병목현상과 클러스터링 오버헤드를 모두 피할 수 있다.\n순차적인 UID는 (현재시각 + 일련번호) 또는 (epoch time + 일련번호)와 같은 조합으로 순서를 유지하는 UID를 만들 수 있다.</p>\n<p><strong>장점 (Sequential UID)</strong></p>\n<ul>\n<li>대량 INSERT 작업을 매우 빠르게 처리할 수 있다.</li>\n</ul>\n<p><strong>단점 (Sequential UID)</strong></p>\n<ul>\n<li>클라이언트에서 순차적인 UID를 만들기 위해 관리가 필요하다.</li>\n</ul>\n<h3 id=\"Composite-key\" style=\"position:relative;\">Composite key<a href=\"#Composite-key\" aria-label=\"Composite key permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>논리 모델링과 물리 모델링의 격차가 적고, 사람이 이해하기 쉽다. 중복키 값이 들어올 수 있으므로 동시성 관리가 필요하다.</p>\n<p><strong>장점</strong></p>\n<ul>\n<li>공간적 지역성(Spatial Locality) 를 활용할 수 있다.</li>\n</ul>\n<p><strong>단점</strong></p>\n<ul>\n<li>클라이언트에서 채번에 대한 동시성 관리가 필요하다.</li>\n</ul>\n<h2 id=\"대리키와-복합키-비교\" style=\"position:relative;\">대리키와 복합키 비교<a href=\"#%EB%8C%80%EB%A6%AC%ED%82%A4%EC%99%80-%EB%B3%B5%ED%95%A9%ED%82%A4-%EB%B9%84%EA%B5%90\" aria-label=\"대리키와 복합키 비교 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Auto increament 와 UID 를 이용한 기본키 유형은 대리키로 일반화할 수 있다. Primary Key를 대리키로 구성한 방식과 복합키로 구성한 방식의 차이점을 비교해본다.</p>\n<h3 id=\"부모테이블의-기본키를-자식-테이블의-기본키로-쓰지-않고-외래키로-사용하는-경우-비식별관계\" style=\"position:relative;\">부모테이블의 기본키를 자식 테이블의 기본키로 쓰지 않고, 외래키로 사용하는 경우 (비식별관계)<a href=\"#%EB%B6%80%EB%AA%A8%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%98-%EA%B8%B0%EB%B3%B8%ED%82%A4%EB%A5%BC-%EC%9E%90%EC%8B%9D-%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%98-%EA%B8%B0%EB%B3%B8%ED%82%A4%EB%A1%9C-%EC%93%B0%EC%A7%80-%EC%95%8A%EA%B3%A0-%EC%99%B8%EB%9E%98%ED%82%A4%EB%A1%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EA%B2%BD%EC%9A%B0-%EB%B9%84%EC%8B%9D%EB%B3%84%EA%B4%80%EA%B3%84\" aria-label=\"부모테이블의 기본키를 자식 테이블의 기본키로 쓰지 않고 외래키로 사용하는 경우 비식별관계 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1f5e3d12fa6da564430f23e5ca41b243/b72ad/mysql_img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.647058823529413%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAy0lEQVR42pVQywqEMAzs//+aR0HB10FBREVsfT9ndwJZxNsGhrbJZKaJwR9xnheO4/iep+C+b8lf1/WDIeGZIOn51hzDWoe+77HvO5ZlQRzHCMMQzjnM84xhGGC6rpMiUVUVsiyT+ziOmKZJyBRlkBtFEXzfh+d5SNNUDJQrgkEQIM9zEWGztVaKBF2bppEG1ouiQJIkIlTXNdZ1lRVs2yYgx7RtK4Ja5DgKvunKfTEoTNOyLOX+Dtmh/kbHfoO/1B3SlAY6ImtPMPcB2IbQKDoxQukAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mysql_img_1.png\"\n        title=\"\"\n        src=\"/static/1f5e3d12fa6da564430f23e5ca41b243/ca1dc/mysql_img_1.png\"\n        srcset=\"/static/1f5e3d12fa6da564430f23e5ca41b243/e7570/mysql_img_1.png 170w,\n/static/1f5e3d12fa6da564430f23e5ca41b243/f46e7/mysql_img_1.png 340w,\n/static/1f5e3d12fa6da564430f23e5ca41b243/ca1dc/mysql_img_1.png 680w,\n/static/1f5e3d12fa6da564430f23e5ca41b243/02d09/mysql_img_1.png 1020w,\n/static/1f5e3d12fa6da564430f23e5ca41b243/b72ad/mysql_img_1.png 1242w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">mysql_img_1.png</figcaption>\n  </figure></p>\n<p>Post, Comment 테이블 둘 다 Auto Increament 기본키를 사용하고, Comment 테이블에 post_id FK 를 두어 Post와 연관관계를 맺는 방식이다.\nPost 테이블이 Driving Table이고 Comment 테이블이 Driven Table 인 경우 두 테이블을 조인하게 되면 아래 그림와 같은 방식으로 데이터를 탐색하게 된다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/78873/mysql_img_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.235294117647065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABJ0lEQVR42o2Sy4qGMAxG//d/NhfiQpcq4kJExfvdDCeQ4vyMOIUQ26QnX2I/8rC2bZNxHKXrOvXYuq4ufl2XnmVZJnEcS13XeufzBKyqSnzflzAMJQgC8TxP8jx38eM4pCgKSZJEjVjf938DqU6QqsMwSFmWauyJGRBDddu2+v2o8DxPmaZJk+d5VuiyLHp2B+77rnHGAuwVCIg5oRbP/htoCvl+BVIdDxCF30DOgP1q2aqwuQO5TCKwpml0hrRmQCvGfdQ7hfyhKIokTVOXfG8ZD4i/zp4YF1GHKuL8LKeQA4wqHLKoZvOzlgECBkRhmyEQch3Qhm2Pl1bwtGtAQLQMGAgqLc9G41qmIkGMWRKw54DZczF1XDJ1eHJe3+F/lqlEBIXMfgDl9Kcs3J4rhwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mysql_img_2.png\"\n        title=\"\"\n        src=\"/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/ca1dc/mysql_img_2.png\"\n        srcset=\"/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/e7570/mysql_img_2.png 170w,\n/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/f46e7/mysql_img_2.png 340w,\n/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/ca1dc/mysql_img_2.png 680w,\n/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/02d09/mysql_img_2.png 1020w,\n/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/9d567/mysql_img_2.png 1360w,\n/static/e16c9fb809bb5cbd5d5e61d54e7e48f4/78873/mysql_img_2.png 1520w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">mysql_img_2.png</figcaption>\n  </figure></p>\n<p>조인 연산을 수행하기 위해, Post 테이블의 기본키와 연결된 Comment 테이블의 Post_id 값으로 조인이 이루어진다. Comment 테이블의 post_id에는 이미 인덱스가 생성되어 있기 때문에, Index Range Scan을 사용하여 Post 테이블과 Comment 테이블을 맵핑할 수 있다.</p>\n<p>그 다음 단계에서는 SELECT 결과를 가져오기 위해 Comment 테이블의 레코드를 검색한다. 이 과정에서 Comment 레코드의 탐색을 위해 Random I/O가 발생하게 된다. Comment 테이블의 POST_ID_IDX 인덱스는 POST_ID별로 정렬되어 있어 같은 POST_ID를 가지더라도 COMMENT_ID는 멀리 떨어져있는 값을 가질 수 있다.</p>\n<p>예를 들어 위의 그림에서, Post 테이블에서 id=3인 레코드를 조회하면, Comment 테이블의 post_id와의 조인 결과로 Comment id (100, 200)이 반환된다. 페이지 당 50개 레코드가 저장된다고 가정하면 2개의 Comment 레코드를 가져오기 위해 총 2개의 페이지 읽기 작업이 필요하게 된다.</p>\n<h3 id=\"부모테이블의-기본키를-자식-테이블-기본키에-포함하는-경우-식별관계\" style=\"position:relative;\">부모테이블의 기본키를 자식 테이블 기본키에 포함하는 경우 (식별관계)<a href=\"#%EB%B6%80%EB%AA%A8%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%98-%EA%B8%B0%EB%B3%B8%ED%82%A4%EB%A5%BC-%EC%9E%90%EC%8B%9D-%ED%85%8C%EC%9D%B4%EB%B8%94-%EA%B8%B0%EB%B3%B8%ED%82%A4%EC%97%90-%ED%8F%AC%ED%95%A8%ED%95%98%EB%8A%94-%EA%B2%BD%EC%9A%B0-%EC%8B%9D%EB%B3%84%EA%B4%80%EA%B3%84\" aria-label=\"부모테이블의 기본키를 자식 테이블 기본키에 포함하는 경우 식별관계 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc6ee2a60d393df21fcb393cd6e4ecdc/abff7/mysql_img_3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAx0lEQVR42pVR2QqEQAyb//8+QXxwwAtXZEbxdjyypFBZfNtCcChJmlaDP2rbNuz7jhACxnFE13VY11V6xHmeMErid1kWDMMgbwXFrOM44JwXDvlFUSCOY/R9L71pmgSmrj8yiWLvPbIse8yVqIZt2yJNU1hrcV2X9O/7fsC0hgZJkmCe5ye+mhHOORnAJE3TIM9zRFGEqqrEhMZqSL6hEUU04w24ItMomJBkmnITGpVlKQHekJX1oHrHN2iqxWEUUcz3r1Z/yhfJf9Dl20Hy0wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mysql_img_3.png\"\n        title=\"\"\n        src=\"/static/dc6ee2a60d393df21fcb393cd6e4ecdc/ca1dc/mysql_img_3.png\"\n        srcset=\"/static/dc6ee2a60d393df21fcb393cd6e4ecdc/e7570/mysql_img_3.png 170w,\n/static/dc6ee2a60d393df21fcb393cd6e4ecdc/f46e7/mysql_img_3.png 340w,\n/static/dc6ee2a60d393df21fcb393cd6e4ecdc/ca1dc/mysql_img_3.png 680w,\n/static/dc6ee2a60d393df21fcb393cd6e4ecdc/02d09/mysql_img_3.png 1020w,\n/static/dc6ee2a60d393df21fcb393cd6e4ecdc/abff7/mysql_img_3.png 1267w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">mysql_img_3.png</figcaption>\n  </figure></p>\n<p>두번째 예에서는 Comment가 POST의 ID를 자신의 기본키에 포함시킨 Composite Key로 PK를 구성한 예이다. 마찬가지로 아래는 Post 테이블이 Driving Table이고 Comment 테이블이 Driven Table 인 경우 두 테이블을 조인할 때, 데이터 탐색 방식이다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fdb57c196b73d47622224329f6014673/f0e87/mysql_img_4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAABJUlEQVR42nWS2QqEMAxF5///T3xQQV8UEfd9zXA6xOk4WgitTXq8N+1LHsZxHLKuq0zTJPM8y7ZtZs8e5LMskziOpWkak389waqqkiAIxHVdcRxHPM+Tuq5P6L7vBsQ+NWEYSlmW90AGySRJDJg5iiLJ8/wHiEKUD8NwurkFUtx1nYzjaKxwQIOcDaSGn7OmNY+W27Y1gU1mlPZ9/wcEAnBZlg/w2mgFchgLwFDB+grEripk/QO0wQrEIkDWKLyzDIj8adn3fSHSNP3rIQGQmQu5AgGQK4riq5Ae0XgSWqwKCVUIkJmDqFGQ5k+FwAgS+ohZ0xf2scq31untU8tFAELUqVCfg6phkwMc1H2+tQ4AQ5Xaz8a8Q+xpXG/6Luw+A7B/SrwBZvWna8XSdDQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mysql_img_4.png\"\n        title=\"\"\n        src=\"/static/fdb57c196b73d47622224329f6014673/ca1dc/mysql_img_4.png\"\n        srcset=\"/static/fdb57c196b73d47622224329f6014673/e7570/mysql_img_4.png 170w,\n/static/fdb57c196b73d47622224329f6014673/f46e7/mysql_img_4.png 340w,\n/static/fdb57c196b73d47622224329f6014673/ca1dc/mysql_img_4.png 680w,\n/static/fdb57c196b73d47622224329f6014673/02d09/mysql_img_4.png 1020w,\n/static/fdb57c196b73d47622224329f6014673/9d567/mysql_img_4.png 1360w,\n/static/fdb57c196b73d47622224329f6014673/f0e87/mysql_img_4.png 1554w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">mysql_img_4.png</figcaption>\n  </figure></p>\n<p>첫번째 방식과 유사하게, 조인이 발생했을 때 Comment 레코드를 읽어오기 위해 페이지 3을 두 번 참조하게 되지만, 이 경우 페이지 3은 이미 캐싱되어 있으므로 두 번째 참조는 추가적인 I/O를 발생시키지 않는다.</p>\n<p>두 방식에서 논리적 페이지 I/O는 2로 동일하지만, 물리적 페이지 I/O(캐시 적용 시)는 각각 2와 1로 다르다. 조인되는 데이터가 많아질수록 두 방식 사이의 물리적 I/O 차이는 더욱 커지게 된다.</p>\n<p>이러한 결과는 두 번째 케이스에서 식별관계를 사용해 기본키를 복합키로 구성했기 때문에 발생한다. POST_ID를 기준으로 조인을 수행할 때, 공간적 지역성(Spatial Locality)의 원리가 적용되었다고 볼 수 있다. 특정 Post에 속한 Comment 집합은 같은 논리적 영역에 속하는 인스턴스라고 볼 수 있다. POST<em>ID와 COMMENT</em>ID로 클러스터링하면, 물리적으로도 POST_ID에 속한 COMMENT 집합이 유사한 영역에 위치하게 되므로 캐싱 확률이 높아지게 된다.</p>\n<p>실제로 같은 페이지 번호에 저장되어 있는 레코드를 탐색하기 위해서 몇번의 I/O가 발생했는지 확인하기 위해서는 MySQL에서 제공하는 상태 변수 중 Innodb_buffer_pool_reads 값을 확인하여 물리적 I/O 발생량을 확인할 수 있다. 해당 상태변수는 버퍼풀에서 읽지못하고 디스크에서 직접 읽은 수를 의미하는 변수이다.</p>\n<h4>데이터를 읽기 전에 Innodb_buffer_pool_reads 값</h4>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">mysql<span class=\"token operator\">></span> SHOW <span class=\"token environment constant\">SESSION</span> STATUS LIKE <span class=\"token string\">'Innodb_buffer_pool_reads%'</span><span class=\"token punctuation\">;</span>\n+--------------------------+-------+\n<span class=\"token operator\">|</span> Variable_name            <span class=\"token operator\">|</span> Value <span class=\"token operator\">|</span>\n+--------------------------+-------+\n<span class=\"token operator\">|</span> Innodb_buffer_pool_reads <span class=\"token operator\">|</span> <span class=\"token number\">1652</span>  <span class=\"token operator\">|</span>\n+--------------------------+-------+\n<span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.03</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<h4>멀리 떨어진 두 개의 Record를 두 건 읽는 경우 (레코드의 페이지가 다른 경우)</h4>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> *\n-<span class=\"token operator\">></span> from ORDER\n-<span class=\"token operator\">></span> where ORDER.ORDER_NO <span class=\"token keyword\">in</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2000,3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nSHOW <span class=\"token environment constant\">SESSION</span> STATUS LIKE <span class=\"token string\">'Innodb_buffer_pool_reads%'</span><span class=\"token punctuation\">;</span>\n+--------------------------+-------+\n<span class=\"token operator\">|</span> Variable_name            <span class=\"token operator\">|</span> Value <span class=\"token operator\">|</span>\n+--------------------------+-------+\n<span class=\"token operator\">|</span> Innodb_buffer_pool_reads <span class=\"token operator\">|</span> <span class=\"token number\">1654</span>  <span class=\"token operator\">|</span>\n+--------------------------+-------+\n<span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.04</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>PK가 2000, 3000 인 레코드 두 건을 읽었을 떄 Innodb_buffer_pool_reads 변수가 1652 → 1654 로 증가된 것을 확인할 수 있다. 2번의 Disk I/O가 발생하였다.</p>\n<h4>클러스터링으로 인접한 Record를 두 건 읽는 경우 (레코드 페이지가 같은 경우)</h4>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> *\n-<span class=\"token operator\">></span> from <span class=\"token variable\"><span class=\"token variable\">`</span>MARKETBOM2_SCHM<span class=\"token variable\">`</span></span>.BIZ_SLIP_TRADE\n-<span class=\"token operator\">></span> where BIZ_SLIP_TRADE.TRADE_SLIP_NO <span class=\"token keyword\">in</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5000,5001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmysql<span class=\"token operator\">></span> SHOW <span class=\"token environment constant\">SESSION</span> STATUS LIKE <span class=\"token string\">'Innodb_buffer_pool_reads%'</span><span class=\"token punctuation\">;</span>\n+--------------------------+-------+\n<span class=\"token operator\">|</span> Variable_name            <span class=\"token operator\">|</span> Value <span class=\"token operator\">|</span>\n+--------------------------+-------+\n<span class=\"token operator\">|</span> Innodb_buffer_pool_reads <span class=\"token operator\">|</span> <span class=\"token number\">1655</span>  <span class=\"token operator\">|</span>\n+--------------------------+-------+\n<span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<p>PK가 5000, 5001 인 레코드를 두 건 읽었을 때 Innodb_buffer_pool_read 변수가 1654 → 1655 로 증가된 것을 확인할 수 있다. 아까와 같이 레코드를 두 건 읽었지만 실제 Disk I/O 발생량은 1번인 것을 확인할 수 있다.</p>\n<h2 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>MySQL의 고성능 Primary Key 설계를 위해서는 클러스터링 인덱스의 특성을 이해하고 테이블의 주 용도 및 액세스 패턴을 정확히 파악해야 한다.</p>\n<p>쓰기 중심의 작업에서는 순차적 ID를 사용하여 성능을 최적화할 수 있다. 이는 쓰기 작업 시 디스크 I/O를 효율적으로 하기 위함이다.</p>\n<p>읽기 중심의 작업에서는 Random I/O가 주로 발생한다면 대리키를, Join 많이 걸리거나 업무적으로 연관된 데이터 중심으로 조회가 많이 되는 경우라면 물리적으로 인접할 수 있도록 업무적인 복합키를 구성하는게 유리할 것 이다.</p>\n<p>실제 업무 시스템에서는 중요한 테이블(예: 이커머스의 주문 테이블)에 대해서는 쓰기와 읽기 작업 모두 빈번하게 발생한다. 이런 상황에서는 쓰기와 읽기 간의 트레이드 오프를 고려하여 결정해야한다. 대다수의 시스템에서 쓰기 대비 읽기의 비율이 8:2 또는 9:1로 나타나기 때문에, 읽기 작업에 최적화된 설계를 택하는 것이 대체로 유리할 것 이다.</p>\n<p>중요한것은 MySQL의 클러스터 인덱스와 세컨더리 인덱스 구조를 이해하고, 그 이해를 바탕으로 시스템 요구 사항에 가장 적합한  Primary Key를 선택할 수 있어야 한다.</p>","fields":{"slug":"/mysql-primary-key-design/"},"frontmatter":{"title":"고성능을 위한 MySQL Primary Key 설계 전략","date":"August 06, 2023"}},{"id":"0c1fde6e-04b9-55b9-9496-1b8635b58e46","html":"<h2 id=\"Spring-Boot2--Ehcache3\" style=\"position:relative;\">Spring Boot2 + Ehcache3<a href=\"#Spring-Boot2--Ehcache3\" aria-label=\"Spring Boot2  Ehcache3 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Spring Cache Abstract 와 Ehcache3 모듈 설정 방법을 알아본다.</p>\n<h2 id=\"Gradle-Dependency-설정\" style=\"position:relative;\">Gradle Dependency 설정<a href=\"#Gradle-Dependency-%EC%84%A4%EC%A0%95\" aria-label=\"Gradle Dependency 설정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">implementation(\"org.springframework.boot:spring-boot-starter-cache\")\nimplementation(\"org.ehcache:ehcache:3.9.5\")\nimplementation(\"javax.cache:cache-api:1.1.1\")</code></pre></div>\n<h2 id=\"캐시-구성\" style=\"position:relative;\">캐시 구성<a href=\"#%EC%BA%90%EC%8B%9C-%EA%B5%AC%EC%84%B1\" aria-label=\"캐시 구성 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Ehcache3 버전부터는 JSR-107을 자바 표준 인터페이스를 구현하였다.\n캐시에 대한 자바 표준 인터페이스를 JCache 라고 한다.\nJPA 구현체에 Hibernate 와 EclipseLink 등이 있는 것 처럼 JCache 구현체 중 하나가 Ehcache3 이다.</p>\n<!-- more -->\n<h3 id=\"Ehcache-Configuration\" style=\"position:relative;\">Ehcache Configuration<a href=\"#Ehcache-Configuration\" aria-label=\"Ehcache Configuration permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Ehcache는 Programmatic 과 xml 두 가지 방식으로 설정할 수 있다.\n자세한건 <a href=\"https://www.ehcache.org/documentation/3.9/getting-started.html#configuring-with-java\">공식문서</a>를 참조하자.\n여기서는 XML 방식이 조금 더 관리하기 쉬울 것 같아 XML 방식으로 설정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>config</span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">xmlns:</span>xsi</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>http://www.w3.org/2001/XMLSchema-instance<span class=\"token punctuation\">'</span></span>\n  <span class=\"token attr-name\">xmlns</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>http://www.ehcache.org/v3<span class=\"token punctuation\">'</span></span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">xmlns:</span>jsr107</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://www.ehcache.org/v3/jsr107<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\"><span class=\"token namespace\">xsi:</span>schemaLocation</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://www.ehcache.org/v3 http://www.ehcache.org/schema/ehcache-core.xsd\n        http://www.ehcache.org/v3/jsr107 http://www.ehcache.org/schema/ehcache-107-ext-3.0.xsd<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>service</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token namespace\">jsr107:</span>defaults</span> <span class=\"token attr-name\">enable-management</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">enable-statistics</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>service</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>cache-template</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>default<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>listeners</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>listener</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>class</span><span class=\"token punctuation\">></span></span>com.example.springboot.cache.EhcacheEventListener<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>class</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>event-firing-mode</span><span class=\"token punctuation\">></span></span>ASYNCHRONOUS<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>event-firing-mode</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>event-ordering-mode</span><span class=\"token punctuation\">></span></span>UNORDERED<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>event-ordering-mode</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>CREATED<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>UPDATED<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>EXPIRED<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>REMOVED<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>EVICTED<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>events-to-fire-on</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>listener</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>listeners</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>resources</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>heap</span><span class=\"token punctuation\">></span></span>100<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>heap</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>offheap</span> <span class=\"token attr-name\">unit</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>MB<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>1<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>offheap</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>resources</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>cache-template</span><span class=\"token punctuation\">></span></span>\n\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>cache</span> <span class=\"token attr-name\">alias</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>findByEventGroupId<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">uses-template</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>default<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>key-type</span><span class=\"token punctuation\">></span></span>java.lang.String<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>key-type</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>value-type</span><span class=\"token punctuation\">></span></span>com.marketboro.marketbom2.module.system.domain.entity.applicationmessage.Eventagsgregator<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>value-type</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>expiry</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ttl</span> <span class=\"token attr-name\">unit</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>minutes<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>10<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ttl</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>expiry</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>cache</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>config</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><a href=\"https://www.ehcache.org/documentation/3.9/xml.html\">공식문서</a>를 참조하여 XML의 element들을 정리하였다.</p>\n<h3 id=\"config\" style=\"position:relative;\"><code class=\"language-text\">&lt;config></code><a href=\"#config\" aria-label=\"config permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>XML 구성의 루트 요소이다. 하나의 <code class=\"language-text\">&lt;config></code> 요소는 CacheManager에 대한 정의를 제공한다.</p>\n<h3 id=\"persistence\" style=\"position:relative;\"><code class=\"language-text\">&lt;persistence></code><a href=\"#persistence\" aria-label=\"persistence permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>영속화 캐시 매니저를 생성할 때 사용되는 요소이다. 여기에는 디스크에 데이터를 저장해야 하는 디렉터리 위치가 필요하다.</p>\n<h3 id=\"cache\" style=\"position:relative;\"><code class=\"language-text\">&lt;cache></code><a href=\"#cache\" aria-label=\"cache permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><code class=\"language-text\">&lt;cache></code> 요소는 CacheManager에 의해 생성 및 관리될 Cache 인스턴스를 나타낸다.\n<code class=\"language-text\">&lt;cache></code> 요소는 Alias를 필수적으로 지정해줘야한다. Alias는 네임스페이스 같은 역활을 한다.\nKey 값이 같더라도 Alias(네임스페이스)가 다르면 다른 별개로 저장된다.</p>\n<p><code class=\"language-text\">&lt;cache></code> 요소는 아래 요소들을 포함할 수 있다.</p>\n<ol>\n<li><code class=\"language-text\">&lt;key-type></code>: 캐시 Key에 해당하는 풀패키지 클래스명</li>\n<li><code class=\"language-text\">&lt;value-type></code>: 캐시 Value에 해당하는 풀패키지 클래스명</li>\n<li><code class=\"language-text\">&lt;expiry></code>: 만료 유형에 대한 설정</li>\n<li><code class=\"language-text\">&lt;eviction-advisor></code>: 캐쉬 만료에 대한 advisor를 설정한다.</li>\n<li><code class=\"language-text\">&lt;resource></code>: 스토리지 계층과 용량을 설정한다. heap 만 사용할 경우 <code class=\"language-text\">&lt;heap></code> 으로 대체 가능</li>\n</ol>\n<p>스토리지 계층은 다양한 데이터 저장 영역을 사용하도록 Ehcache를 구성할 수 있다.\nEhcache에서 지원하는 데이터 저장소는 다음과 같다.\n계층 구조를 사용하여 다중 계층 설정도 가능하다. 캐시가 On-Heap 계층에 없으면 Off-heap 계층을 참조할 수 있다.\n다중 계층 구조를 사용할 때 주의할점은, 아래 계층 스토리지 할당량보다 윗 계층 스토리지 할달량이 적어야 한다는 것이다.</p>\n<ul>\n<li>On-Heap Store<br>\nJava의 온-힙 RAM 메모리를 활용하여 캐시 항목을 저장합니다. 이 계층은 Java 애플리케이션과 동일한 힙 메모리를 사용하며, 모든 힙 메모리는 JVM 가비지 컬렉터에서 스캔해야 합니다. JVM이 사용하는 힙 공간이 많을수록 가비지 수집 일시 중지로 인해 애플리케이션 성능이 더\n많이 영향을 받습니다. 이 저장소는 매우 빠르지만 일반적으로 가장 제한된 저장소 리소스입니다.</li>\n<li>Off-Heap Store<br>\n사용 가능한 RAM에 의해서만 크기가 제한됩니다. Java 가비지 컬렉션(GC)의 영향을 받지 않습니다. 매우 빠르지만 데이터를 저장하고 다시 액세스할 때 JVM 힙으로 데이터를 이동해야 하므로 온-힙 스토어보다 느립니다.</li>\n<li>Disk Store<br>\n디스크 저장소 - 디스크(파일 시스템)를 사용하여 캐시 항목을 저장합니다. 이 유형의 저장소 리소스는 일반적으로 매우 풍부하지만 RAM 기반 저장소보다 훨씬 느립니다. 디스크 스토리지를 사용하는 모든 애플리케이션의 경우 처리량을 최적화하기 위해 빠른 전용 디스크를 사용하는 것이\n좋습니다.</li>\n<li>Clustered Store<br>\n이 데이터 저장소는 원격 서버에 있는 캐시입니다. 원격 서버에는 선택적으로 장애 조치 서버가 있어 고가용성을 향상시킬 수 있습니다. 클러스터형 스토리지는 클라이언트/서버 일관성 유지와 네트워크 지연 등의 요인으로 인해 성능이 저하될 수 있으므로 이 계층은 본질적으로 로컬 오프 힙\n스토리지보다 느립니다.\nTerracotta 라는 분산 캐시 서버로만 가능한 것 같다.</li>\n</ul>\n<h3 id=\"cache-template\" style=\"position:relative;\"><code class=\"language-text\">&lt;cache-template></code><a href=\"#cache-template\" aria-label=\"cache template permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><code class=\"language-text\">&lt;cache></code> 요소가 템플릿을 상속받아 사용할 수 있다. <code class=\"language-text\">uses-template</code> 속성을 통해 cache-template을 참조할 수 있다.</p>\n<h2 id=\"캐시-교체-정책\" style=\"position:relative;\">캐시 교체 정책<a href=\"#%EC%BA%90%EC%8B%9C-%EA%B5%90%EC%B2%B4-%EC%A0%95%EC%B1%85\" aria-label=\"캐시 교체 정책 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Ehcache 2.x 버전에서는 힙 메모리에 대한 캐시 교체 정책<code class=\"language-text\">(LRU, LFU, FIFO)</code>을 지원했다. 그런데 Ehcache 3부터는 3가지 정책이 사라졌는데,\n구글링을 통해 조사해본 결과, 힙 메모리 교체 정책과 다른 계층의 교체 정책이 다를 수 있기 때문에 지원이 중단된 듯 하다.\n그래서 3 버전 기준으로는 다음 세가지 정책을 제공하고 있다.</p>\n<ul>\n<li>no expiry : 캐시 매핑이 만료되지 않음</li>\n<li>time-to-live : 캐시 매핑이 생성된 후 정해진 기간 후에 만료됨</li>\n<li>time-to-idle : 캐시 매핑이 마지막으로 액세스한 시간 이후 정해진 기간 후에 만료됨</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>cache</span> <span class=\"token attr-name\">alias</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>withExpiry<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>expiry</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ttl</span> <span class=\"token attr-name\">unit</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>seconds<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>20<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ttl</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>expiry</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>heap</span><span class=\"token punctuation\">></span></span>100<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>heap</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>cache</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h3 id=\"Custom-expiry\" style=\"position:relative;\">Custom expiry<a href=\"#Custom-expiry\" aria-label=\"Custom expiry permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>Ehcache3 은 Custom expiry 정책을 정의할 수 있다. 아래 인터페이스를 구현하는 custom policy 클래스를 구현하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ExpiryPolicy</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token class-name\">Duration</span> <span class=\"token constant\">INFINITE</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">Duration</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofNanos</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MAX_VALUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token class-name\">ExpiryPolicy</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token constant\">NO_EXPIRY</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ExpiryPolicy</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token string\">\"No Expiry\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Duration</span> <span class=\"token function\">getExpiryForCreation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token constant\">INFINITE</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Duration</span> <span class=\"token function\">getExpiryForAccess</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Duration</span> <span class=\"token function\">getExpiryForUpdate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> oldValue<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> newValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token class-name\">Duration</span> <span class=\"token function\">getExpiryForCreation</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> var1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> var2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token class-name\">Duration</span> <span class=\"token function\">getExpiryForAccess</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> var1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> var2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token class-name\">Duration</span> <span class=\"token function\">getExpiryForUpdate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">K</span> var1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> var2<span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span> var3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>cache</span> <span class=\"token attr-name\">alias</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>withCustomExpiry<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>expiry</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>class</span><span class=\"token punctuation\">></span></span>com.pany.ehcache.MyExpiry<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>class</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>expiry</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>heap</span><span class=\"token punctuation\">></span></span>100<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>heap</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>cache</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h2 id=\"Springboot-Configuration\" style=\"position:relative;\">Springboot Configuration<a href=\"#Springboot-Configuration\" aria-label=\"Springboot Configuration permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Ehcache3 는 JCache 므로 아래와 같이 설정해줘야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">jcache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> classpath<span class=\"token punctuation\">:</span>ehcache.xml</code></pre></div>\n<p>Ehcache 2.x 버전은 아래와 같이 설정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">cache</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">ehcache</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span> classpath<span class=\"token punctuation\">:</span>ehcache.xml</code></pre></div>\n<p>그리고 어플리케이션에 <code class=\"language-text\">@EnableCaching</code> 어노테이션을 붙여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableCaching</span>\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ExampleApplication</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>새 프로젝트로 시작한다면 여기까지만 해도 Springboot 와 Ehcache 설정은 완료된다.\n만약, 프로젝트에 redis를 이미 사용 중이라면 redis가 Ehcache보다 우선순위가 높아 기본 CacheManger를 <code class=\"language-text\">RedissonSpringCacheManager</code>로 설정한다.\n따라서, 따로 Ehcache용 CacheManager를 <code class=\"language-text\">@Bean</code>으로 등록해주어야 한다.\n여기서 중요한것은 <code class=\"language-text\">org.springframework.cache.CacheManger</code> 인터페이스의 구현체로 <code class=\"language-text\">org.springframework.cache.ehcache.EhCacheCacheManager</code> 가 있는데, 이 클래스는 Ehcache2 버전에 사용되는 것이다.\n처음에도 말했듯이 Ehcache3는 JCache의 한 종류로 <code class=\"language-text\">JCacheCacheManger로</code> 등록해줘야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">IOException</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">javax<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CacheManager</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">javax<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Caching</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">javax<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>spi<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">CachingProvider</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>jcache<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">JCacheCacheManager</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Bean</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>annotation<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Configuration</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ClassPathResource</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">EhcacheConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"ehCacheManager\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span></span>CacheManager</span> <span class=\"token function\">cacheManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">CachingProvider</span> cachingProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">Caching</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCachingProvider</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"org.ehcache.jsr107.EhcacheCachingProvider\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">CacheManager</span> manager <span class=\"token operator\">=</span> cachingProvider<span class=\"token punctuation\">.</span><span class=\"token function\">getCacheManager</span><span class=\"token punctuation\">(</span>\n\t\t\t\t<span class=\"token keyword\">new</span> <span class=\"token class-name\">ClassPathResource</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/ehcache.xml\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getURI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JCacheCacheManager</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>캐싱을 적용할 메서드에 @Cacheable 어노테이션을 붙여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>cacheManager <span class=\"token operator\">=</span> <span class=\"token string\">\"ehCacheManager\"</span><span class=\"token punctuation\">,</span> cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"findById = {}\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> id<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Cache 라는 이름으로 메서드 인자인 id 값을 key로, return 값을 value로 결과를 캐싱한다.\n@Cacheable은 다음 매개변수를 사용할 수 있다.</p>\n<ul>\n<li>value / cacheName : 메서드 실행 결과가 저장될 캐시의 이름입니다.</li>\n<li>key : SpEL(Spring Expression Language) 로 캐시 항목의 키입니다 . 매개변수를 지정하지 않으면 기본적으로 모든 메서드 매개변수에 대해 키가 생성됩니다.</li>\n<li>keyGenerator : KeyGenerator 인터페이스를 구현하여 사용자 정의 캐시 키 생성을 허용하는 Bean의 이름입니다.</li>\n<li>condition : 결과를 캐시할 시기를 지정하는 SpEL(Spring Expression Language)로서의 조건입니다.</li>\n<li>unless : 결과를 캐시하지 않아야 하는 경우를 지정하는 SpEL(Spring Expression Language)로서의 조건입니다.</li>\n</ul>\n<p>스프링에서는 @Cacheable 말고도 @CacheEvict, @CachePut, @CacheConfig 어노테이션을 지원한다.\n기본적인 내용은 @Cacheable 과 크게 다르지 않으므로 자세한 내용은 <a href=\"https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/cache.html\">공식문서</a>를 참조하자.</p>\n<h2 id=\"JSR-107-어노테이션-Spring-Cache-어노테이션-비교\" style=\"position:relative;\">JSR 107 어노테이션, Spring Cache 어노테이션 비교<a href=\"#JSR-107-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98-Spring-Cache-%EC%96%B4%EB%85%B8%ED%85%8C%EC%9D%B4%EC%85%98-%EB%B9%84%EA%B5%90\" aria-label=\"JSR 107 어노테이션 Spring Cache 어노테이션 비교 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<table>\n<thead>\n<tr>\n<th>JSR 107 / JCache Annotations</th>\n<th>Spring Cache Annotations</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>@CacheResult</td>\n<td>@Cacheable</td>\n</tr>\n<tr>\n<td>@CacheRemove</td>\n<td>@CacheEvict</td>\n</tr>\n<tr>\n<td>@CacheRemoveAll</td>\n<td>@CacheEvict(allEntries=true)</td>\n</tr>\n<tr>\n<td>@CachePut</td>\n<td>@CachePut</td>\n</tr>\n<tr>\n<td>@CacheDefaults</td>\n<td>@CacheConfig</td>\n</tr>\n</tbody>\n</table>","fields":{"slug":"/ehcache3/"},"frontmatter":{"title":"Ehcache3 캐시 라이브러리 소개 (with Spring Boot)","date":"July 24, 2023"}},{"id":"363e058f-b457-5794-afb5-05cb05480255","html":"<h2 id=\"N1-쿼리는-무엇을-의마하나\" style=\"position:relative;\">N+1 쿼리는 무엇을 의마하나?<a href=\"#N1-%EC%BF%BC%EB%A6%AC%EB%8A%94-%EB%AC%B4%EC%97%87%EC%9D%84-%EC%9D%98%EB%A7%88%ED%95%98%EB%82%98\" aria-label=\"N1 쿼리는 무엇을 의마하나 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>JPA의 한계를 설명하기 위해서는 N+1 쿼리가 발생하는 원초적인 원인에 대해 이해하는 것이 필요하다.<br>\nJPA를 사용하다보면 N+1 쿼리를 경험할 수 있는데, 기술적인 방법으로 N+1 쿼리를 해결하는 게시물은 많지만, 왜 이러한 쿼리가 발생하는지에 대해 정확히 설명하는 블로그는 찾기 어렵다.<br>\n본 포스팅에서는 N+1 쿼리가 발생하는 원인을 설명하고, 이로 인해 JPA가 성능상 한계에 부딪힐 수밖에 없는 이유에 대해 설명하려고 한다.</p>\n<!-- more -->\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Member</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span> <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTO</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> username<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"team_id\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Team</span> team<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Team</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span> <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTO</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> id<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> teamName<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@OneToMany</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">></span></span> members<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaTest</span><span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token annotation punctuation\">@Test</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token class-name\">Nplus1</span>테스트<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> teams <span class=\"token operator\">=</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">createQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select team from Team team\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Team</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">getResultList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Team</span> team <span class=\"token operator\">:</span> teams<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tteam<span class=\"token punctuation\">.</span><span class=\"token function\">getMembers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>member <span class=\"token operator\">-></span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 테스트 코드를 실행시키면 team 을 조회하는 쿼리(1)와 각 team 별로 자식인 member 조회하는 쿼리(N)이 나가, 결과적으로 N+1 쿼리가 발생한다.</p>\n<p>아래는 테스트 코드를 돌렸을 때, 데이터베이스로 호출되는 SQL이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> team<span class=\"token punctuation\">;</span> <span class=\"token operator\">/</span><span class=\"token comment\">-- (1번 쿼리) --/</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> member <span class=\"token keyword\">where</span> member<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">/</span><span class=\"token comment\">-- (N 쿼리) --/</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> member <span class=\"token keyword\">where</span> member<span class=\"token punctuation\">.</span>team_id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">/</span><span class=\"token comment\">-- (N 쿼리) --/</span></code></pre></div>\n<p>간단한 이유로 N+1 쿼리가 발생하는 이유는 다음과 같다. member와 join 없이 team에 대해서만 select 쿼리를 날렸기 때문이다.\n처음에 (1번) 쿼리에서는 Team만 조회되었기 때문에, 연관된 테이블인 member를 찾기 위해 추가적인 쿼리가 필요하게 된다. 이로 인해 쿼리의 수가 N+1개가 되는 것이다.</p>\n<p>아래는 Native SQL로 N+1 쿼리를 발생시키는 코드다. (예시)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaTest</span> <span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token annotation punctuation\">@Test</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">native_sql_Nplus1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> teams <span class=\"token operator\">=</span> jdbcTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT * FROM team\"</span><span class=\"token punctuation\">,</span> teamRowMapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Team</span> team <span class=\"token operator\">:</span> teams<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> member <span class=\"token operator\">=</span> jdbcTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SELECT * FROM member WHERE member.team_id = \"</span> <span class=\"token operator\">+</span> team<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> memberRowMapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tmember<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>m <span class=\"token operator\">-></span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span><span class=\"token function\">getUsername</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>N+1 쿼리는 JPA 입장에서는 연관 관계 맵핑 정보를 보고 그대로 쿼리를 실행한 결과로 볼 수 있다. JPA는 객체지향적인 관점에서 데이터를 가져오기 위해 연관된 엔티티들을 필요에 따라 추가로 조회하는 것이므로, 이는 JPA의 기능을 잘 수행한 것이다.\n그러나 데이터베이스 입장에서는 N번의 호출로 인해 비효율적인 처리가 발생하였다.</p>\n<p>N+1 쿼리를 해결하기 위해 크게 두 가지 방법이 있다.</p>\n<ul>\n<li>member와 team을 join하는 방법.</li>\n<li>member를 조회할 때 중복을 제거한 team의 id 값들로 batch IN절을 사용해 테이블 각각을 조회 후, 어플리케이션에서 조립하는 방법.</li>\n</ul>\n<p>JPA에서는 N+1 쿼리를 해결하기 위해 fetch join, EntityGraph, batch size 조정 등의 방법을 제공하지만, 결국은 위의 두 가지 방법을 사용해야 한다.\n또한, N+1 쿼리는 조회뿐만 아니라 UPDATE, DELETE 쿼리에서도 발생할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JpaTest</span><span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token annotation punctuation\">@Test</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token class-name\">Nplus1</span>테스트<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> teams <span class=\"token operator\">=</span> em<span class=\"token punctuation\">.</span><span class=\"token function\">createQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"select team from Team team\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Team</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">getResultList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Team</span> team <span class=\"token operator\">:</span> teams<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t  team<span class=\"token punctuation\">.</span><span class=\"token function\">setTeamName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ABC\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> team<span class=\"token punctuation\">;</span> <span class=\"token operator\">/</span><span class=\"token comment\">-- (1번 쿼리) --/</span>\n<span class=\"token keyword\">UPDATE</span> team <span class=\"token keyword\">SET</span> team<span class=\"token punctuation\">.</span>teamName <span class=\"token operator\">=</span> <span class=\"token string\">'ABC'</span> <span class=\"token keyword\">WHERE</span> team<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">/</span><span class=\"token comment\">-- (N 쿼리) --/</span>\n<span class=\"token keyword\">UPDATE</span> team <span class=\"token keyword\">SET</span> team<span class=\"token punctuation\">.</span>teamName <span class=\"token operator\">=</span> <span class=\"token string\">'ABC'</span> <span class=\"token keyword\">WHERE</span> team<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">/</span><span class=\"token comment\">-- (N 쿼리) --/</span>\n<span class=\"token keyword\">UPDATE</span> team <span class=\"token keyword\">SET</span> team<span class=\"token punctuation\">.</span>teamName <span class=\"token operator\">=</span> <span class=\"token string\">'ABC'</span> <span class=\"token keyword\">WHERE</span> team<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">/</span><span class=\"token comment\">-- (N 쿼리) --/</span></code></pre></div>\n<p>이런 경우에도 쿼리 최적화가 필요하며, 모든 team 을 조회해서 teamName을 'ABC' 로 바꾸기 때문에 아래와 같은 방법으로 해결할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">UPDATE</span> team <span class=\"token keyword\">SET</span> team<span class=\"token punctuation\">.</span>teamName <span class=\"token operator\">=</span> <span class=\"token string\">'ABC'</span></code></pre></div>\n<p>특정 team 만 업데이트 하고 싶다면 아래와 같은 방법을 쓸 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">UPDATE</span> team <span class=\"token keyword\">SET</span> team<span class=\"token punctuation\">.</span>teamName <span class=\"token operator\">=</span> <span class=\"token string\">'ABC'</span> <span class=\"token keyword\">WHERE</span> team<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"관계형-데이터베이스는-집합이다\" style=\"position:relative;\">관계형 데이터베이스는 집합이다<a href=\"#%EA%B4%80%EA%B3%84%ED%98%95-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4%EB%8A%94-%EC%A7%91%ED%95%A9%EC%9D%B4%EB%8B%A4\" aria-label=\"관계형 데이터베이스는 집합이다 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>앞에서 본 N+1 쿼리와 그것을 튜닝한 쿼리의 방식에 차이점이 보이는가?\n관계형 데이터 모델은 수학의 집합론을 기반으로 한 데이터베이스 모델로, 관계형 데이터베이스의 데이터 연산은 집합적 연산으로 이루어져 있고 이에 최적화되어 있다.\n(교집합 연산 join, 합집합 연산 union, 부분집합 연산 select 등)<br>\nN+1 쿼리를 해결하는 방법은 결국 단일 Element에 대한 연산을 여러 개 수행하는 것을 피하고, 대신 집합 연산을 활용하여 효율적으로 처리하는 것이다.\n결과적으로, JPA가 성능상 한계에 부딪힐 수 밖에 없는 이유는 JPA가 엔티티 집합을 다루는 연산에 한계가 있기 때문이라고 볼 수 있다.</p>\n<p>물론, JPQL을 사용하면 Native SQL을 사용하는 것 처럼 데이터베이스의 집합연산을 할 수 있다.<br>\nUPDATE 문의 N+1 쿼리 예제에서 JPQL로 update문을 통해 teamName을 집합적으로 변경하는 로직으로 리팩토링 하면 다음과 같은 형식일 것 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">/*\nfinal var teams = em.createQuery(\"select team from Team team\", Team.class).getResultList();\n\nfor(Team team : teams){\n  team.setTeamName(\"ABC\");\n} */</span>\nteamRepository<span class=\"token punctuation\">.</span><span class=\"token function\">renameAllTeams</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ABC\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//renameAllTeams() 는 JPQL로 작성한 집합연산이다.</span></code></pre></div>\n<p>성능상의 문제는 해결되었지만, JPA로 객체지향적으로 작성한 원래의 코드가 사라지고,\n데이터베이스 사용에 대한 투명성도 사리지게 되었다. 이는 JPQL을 활용한 최적화된 쿼리가 Native SQL과 거의 동일한 형태로 변환되었기 때문이다.\n또한, 리팩토링된 코드는 JPQL을 네이티브 SQL로 파싱하는 과정만 추가된 것으로, Native SQL에 비해 JPQL이 가지는 장점도 거의 없다.</p>\n<h2 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>결국 JPA가 성능적 한계는 집합 연산에 대한 지원이 부족하다는 것으로 요약할 수 있다.\n우리가 어노테이션을 통해 JPA 연관관계에 대한 정보를 정의하지만 이것은 단일 엔티티에 대한 맵핑 정보를 제공하는 것 이다.\n따라서, JPA는 엔티티 집합을 개별 엔티티 각각으로 처리할 수 밖에 없고, 이러한 작업은 집합론을 베이스로 한 관계형 데이터베이스에서\n처리하기에는 느릴 수 밖에 없는 구조가 나오는 것 이다.\n오히려 JPA의 방식은 Key-value 기반 스토리지에 더 적합한 방식이라고 볼 수 있다.<br>\n이러한 문제점은 객체 패러다임과 관계형 패러다임 간에 쉽게 해결할 수 없는 문제라고 본다.<br>\n지금 개발하고 있는 서비스는 엔티티의 집합적 연산을 요하는 요구사항이 많아, JPA 기술에 대한 의심이 있었는데<br>\n이러한 ORM의 한계를 인정하면서 JPA의 객체지향적인 장점과 Native SQL 접근 방식을 균형있게 쓰는 것이 좋을 것 같다.</p>","fields":{"slug":"/jpa-slow-cause/"},"frontmatter":{"title":"JPA가 느릴 수 밖에 없는 원초적인 이유","date":"July 21, 2023"}},{"id":"5ae46656-7d71-5b46-a454-516a563e6324","html":"<h2 id=\"Redis-Keyspace-Notifications\" style=\"position:relative;\">Redis Keyspace Notifications<a href=\"#Redis-Keyspace-Notifications\" aria-label=\"Redis Keyspace Notifications permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Redis에는 키 및 값의 변경 사항을 실시간으로 수신할 수 있는 Pub/Sub 기능을 제공한다.</p>\n<h2 id=\"Notifications-유형\" style=\"position:relative;\">Notifications 유형<a href=\"#Notifications-%EC%9C%A0%ED%98%95\" aria-label=\"Notifications 유형 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Redis 데이터 공간에 영향을 미치는 모든 작업에 대해 다음 두 가지 유형의 이벤트가 발생된다.\n예를 들어 키를 삭제하는 명령인 <code class=\"language-text\">del myKey1</code> 이 실행되면 Redis는 다음 두 가지 명령이 트리거된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"redis\"><pre class=\"language-redis\"><code class=\"language-redis\">PUBLISH __keyspace@0__:mykey1 del\nPUBLISH __keyevent@0__:del mykey1</code></pre></div>\n<p>첫번째 PUBLISH 명령은 Key 중심 이벤트로, <code class=\"language-text\">del</code>이 이벤트의 메시지고\n두번쨰 PUBLISH 명령은 명령 중심 이벤트로, <code class=\"language-text\">myKey1</code>이 이벤트의 메시지이다.\nSub 하는 쪽에서는 Subscribe 패턴 매칭을 통해서 두 가지 유형 중 관심있는 이벤트만 선택해서 알림을 받을 수 있다.</p>\n<!-- more -->\n<h2 id=\"Redis-Keyspace-Notifications-설정\" style=\"position:relative;\">Redis Keyspace Notifications 설정<a href=\"#Redis-Keyspace-Notifications-%EC%84%A4%EC%A0%95\" aria-label=\"Redis Keyspace Notifications 설정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>기본적으로 Keyspace Notifications은 비활성화되어 있기 때문에, <code class=\"language-text\">redis.conf</code> 또는 <code class=\"language-text\">CONFIG SET</code> 명령어로 <code class=\"language-text\">notify-keyspace-events</code> 옵션을 활성화 할 수 있다.\n옵션에는 다음 값들이 있다.\n이벤트 종류</p>\n<ul>\n<li>K   Keyspace events, publish prefix \"<strong>keyspace@<db></strong>:\".</li>\n<li>E   Keyevent events, publish prefix \"<strong>keyevent@<db></strong>:\".</li>\n<li>g   공통 명령: del, expire, rename, ...</li>\n<li>$   스트링(String) 명령</li>\n<li>l   리스트(List) 명령</li>\n<li>s   셋(Set) 명령</li>\n<li>h   해시(Hash) 명령</li>\n<li>z   소트 셋(Sorted set) 명령</li>\n<li>x   만료(Expired) 이벤트 (키가 만료될 때마다 생성되는 이벤트)</li>\n<li>e   퇴출(Evicted) 이벤트 (최대메모리 정책으로 키가 삭제될 때 생성되는 이벤트)</li>\n<li>A   모든 이벤트(g$lshzxe), \"AKE\"로 지정하면 모든 이벤트를 받는다.</li>\n</ul>\n<p>여기서 K 또는 E는 필수적으로 있어야 하며, 나머지 값들은 선택적으로 설정할 수 있다.\n예를 들어, 어떤 Key가 Expire되는지만 수신하고 싶다면 아래와 같이 설정하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">notify-keyspace-events \"Kx\": 키 이벤트 + 만료 이벤트 발생</code></pre></div>\n<p>Redis 명령에 따른 이벤트 종류를 보고 싶다면 <a href=\"https://redis.io/docs/manual/keyspace-notifications/\">공식문서</a>를 참조하자.</p>\n<h2 id=\"성능-측정\" style=\"position:relative;\">성능 측정<a href=\"#%EC%84%B1%EB%8A%A5-%EC%B8%A1%EC%A0%95\" aria-label=\"성능 측정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>notify-keyspace-events 옵션을 모두 활성화 했을떄, 비활성화 했을 때 각가 redis-benchmark 를 통해 퍼모먼스를 테스트해보자.</p>\n<h3 id=\"notify-keyspace-events--모든-이벤트-비활성화\" style=\"position:relative;\">notify-keyspace-events \"\" 모든 이벤트 비활성화<a href=\"#notify-keyspace-events--%EB%AA%A8%EB%93%A0-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EB%B9%84%ED%99%9C%EC%84%B1%ED%99%94\" aria-label=\"notify keyspace events  모든 이벤트 비활성화 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># redis-cli config set notify-keyspace-events \"\"\n# redis-benchmark -q </code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PING_INLINE: 3670.67 requests per second, p50=12.391 msec\nPING_MBULK: 3668.78 requests per second, p50=12.551 msec\nSET: 4601.72 requests per second, p50=9.087 msec\nGET: 4604.90 requests per second, p50=8.999 msec\nINCR: 4708.98 requests per second, p50=8.847 msec\nLPUSH: 4750.14 requests per second, p50=8.847 msec\nRPUSH: 4620.86 requests per second, p50=8.967 msec\nLPOP: 3531.82 requests per second, p50=13.231 msec\nRPOP: 3863.84 requests per second, p50=12.007 msec\nSADD: 4677.05 requests per second, p50=8.775 msec\nHSET: 4795.01 requests per second, p50=8.743 msec\nSPOP: 3689.49 requests per second, p50=12.087 msec\nZADD: 3968.57 requests per second, p50=10.575 msec\nZPOPMIN: 3116.62 requests per second, p50=15.095 msec\nLPUSH (needed to benchmark LRANGE): 3900.31 requests per second, p50=10.743 msec\nLRANGE_100 (first 100 elements): 4876.86 requests per second, p50=8.343 msec\nLRANGE_300 (first 300 elements): 3725.23 requests per second, p50=12.071 msec\nLRANGE_500 (first 500 elements): 2396.59 requests per second, p50=20.159 msec\nLRANGE_600 (first 600 elements): 2067.31 requests per second, p50=23.663 msec\nMSET (10 keys): 4288.53 requests per second, p50=9.711 msec</code></pre></div>\n<h3 id=\"notify-keyspace-events-AKE-모든-이벤트-활성화\" style=\"position:relative;\">notify-keyspace-events AKE 모든 이벤트 활성화<a href=\"#notify-keyspace-events-AKE-%EB%AA%A8%EB%93%A0-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%ED%99%9C%EC%84%B1%ED%99%94\" aria-label=\"notify keyspace events AKE 모든 이벤트 활성화 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># redis-cli config set notify-keyspace-events AKE\n# redis-benchmark -q </code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">PING_INLINE: 3299.57 requests per second, p50=14.319 msec\nPING_MBULK: 3115.85 requests per second, p50=15.039 msec\nSET: 3974.25 requests per second, p50=10.399 msec\nGET: 3828.19 requests per second, p50=10.959 msec\nINCR: 3869.07 requests per second, p50=10.791 msec\nLPUSH: 3835.24 requests per second, p50=11.095 msec\nRPUSH: 4118.96 requests per second, p50=10.247 msec\nLPOP: 3102.89 requests per second, p50=14.991 msec\nRPOP: 3178.03 requests per second, p50=14.895 msec\nSADD: 3834.94 requests per second, p50=10.983 msec\nHSET: 3825.41 requests per second, p50=11.111 msec\nSPOP: 3389.03 requests per second, p50=13.735 msec\nZADD: 3750.94 requests per second, p50=11.207 msec\nZPOPMIN: 3117.69 requests per second, p50=14.855 msec\nLPUSH (needed to benchmark LRANGE): 3835.68 requests per second, p50=11.103 msec\nLRANGE_100 (first 100 elements): 4953.68 requests per second, p50=8.247 msec\nLRANGE_300 (first 300 elements): 3687.04 requests per second, p50=12.079 msec\nLRANGE_500 (first 500 elements): 2410.28 requests per second, p50=20.191 msec\nLRANGE_600 (first 600 elements): 2059.44 requests per second, p50=23.647 msec\nMSET (10 keys): 4043.02 requests per second, p50=10.143 msec</code></pre></div>\n<p>p50 응답시간은 큰 차이가 없지만 초당 request 처리가 100~500 정도 줄어든 것을 볼 수 있다.<br>\n따라서, 이벤트 수신이 필요없다면 redis의 해당 설정은 비활성화하는 것이 리소스를 효율적으로 쓰는데 도움이 될 것 이다.\n옵션을 활성화하더라도 꼭 필요한 이벤트 유형 옵션만 설정하는 것이 좋다.</p>\n<h2 id=\"스프링-부트-설정\" style=\"position:relative;\">스프링 부트 설정<a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81-%EB%B6%80%ED%8A%B8-%EC%84%A4%EC%A0%95\" aria-label=\"스프링 부트 설정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisConfig</span> <span class=\"token punctuation\">{</span>\n\n\n\t<span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"redisMessageTaskExecutor\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">Executor</span> <span class=\"token function\">redisMessageTaskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">ThreadPoolTaskExecutor</span> threadPoolTaskExecutor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadPoolTaskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tthreadPoolTaskExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setCorePoolSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\t\tthreadPoolTaskExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxPoolSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> threadPoolTaskExecutor<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisMessageListenerContainer</span> <span class=\"token class-name\">RedisMessageListener</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisConnectionFactory</span> connectionFactory<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RedisMessageListener</span> redisMessageListener<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">RedisMessageListenerContainer</span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisMessageListenerContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tcontainer<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>connectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tcontainer<span class=\"token punctuation\">.</span><span class=\"token function\">addMessageListener</span><span class=\"token punctuation\">(</span>redisMessageListener<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PatternTopic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"*\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tcontainer<span class=\"token punctuation\">.</span><span class=\"token function\">setTaskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token function\">asyncThreadTaskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> container<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisConnectionFactory</span> connectionFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tredisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>connectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tredisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setKeySerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tredisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setValueSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisMessageListener</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">MessageListener</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CacheManager</span><span class=\"token punctuation\">></span></span> cacheManagerList<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Message</span> message<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> pattern<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>RedisMessageListenerContainer 빈 등록 시, 주의할 점은 setTaskExecutor() 로 스레드풀을 사용하는 Executor를 등록해야 한다.<br>\nsetTaskExecutor()로 Executor를 등록하지 않으면 RedisMessageListenerContainer는 기본값으로 SimpleAsyncTaskExecutor가 사용되는데,\nSimpleAsyncTaskExecutor 는 사용될 때 마다, 새로운 스레드를 만들어서 run() 하기 때문에 Redis에서 이벤트가 수신될 때 마다 새로운 스레드가 만들어지므로 주의하자.</p>","fields":{"slug":"/redis-event-notifications/"},"frontmatter":{"title":"Redis Keyspace Notifications에 대해 알아보자","date":"July 19, 2023"}},{"id":"c4729eb0-0698-5aa4-bbf6-361c15caac7d","html":"<h2 id=\"메모리-계층-구조\" style=\"position:relative;\">메모리 계층 구조<a href=\"#%EB%A9%94%EB%AA%A8%EB%A6%AC-%EA%B3%84%EC%B8%B5-%EA%B5%AC%EC%A1%B0\" aria-label=\"메모리 계층 구조 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>메모리를 필요에 따라 여러 가지 종류로 나누어 둠을 의미한다.</li>\n<li>이떄 필요한 대부분의 경우는 CPU가 메모리에 더 빨리 접근하기 위함이다.</li>\n</ul>\n<h2 id=\"자주-쓰는-데이터는-계속-자주-쓰인다\" style=\"position:relative;\">자주 쓰는 데이터는 계속 자주 쓰인다.<a href=\"#%EC%9E%90%EC%A3%BC-%EC%93%B0%EB%8A%94-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%8A%94-%EA%B3%84%EC%86%8D-%EC%9E%90%EC%A3%BC-%EC%93%B0%EC%9D%B8%EB%8B%A4\" aria-label=\"자주 쓰는 데이터는 계속 자주 쓰인다 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>자주 쓰이는 데이터는 계속 자주 쓰이고, 자주 쓰이지 않는 데이터는 계속 자주 쓰이지 않는다.</li>\n<li>자주 쓰이으는 데이터는 전체 데이터 양에 비해 작은 양이기 때문에, 캐시는 메모리보다 더 작아도 된다.</li>\n<li>\n<p>컴퓨터 과학에서 증명된 법칙이며, 지역성의 원리라고도 한다.</p>\n<!-- more -->\n</li>\n</ul>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 544px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b7a2aa3a1ba1c6459c34facd813e9e18/cfd82/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/0lEQVR42n2TW2sTYRCG+8tE8UCxiv4A8UbwEBUVDXqtKOitKP4CQZBSShtibSpKJNWQ1lYlBxJi0iZNk2zWTfeQPT5+36bZxEMdGGZndnjnnXdnp1qtFpVKhW63y8iCYBibqsNststcts3il5/Yrh/1KIqCZVn0+/0wuq4b1qfki3Q6Ta/X2wcL8PcBP1dtZp4UOfkwx7kX2+iDIALUdR3HcTBNM3weDAZDQFn0PA/btsM4tgDNMKj3dL5WGzRUHcu2+NMkmCH6IsDNzU2SySQbGxvhxJHtqFs8Ssd5kLrJvdeXuP/+Bs9XHxP4frSJNAn2G6BM6vV6yHCyUbM0kj8WWKjM82r9JYvVeT5svZPE/w8oBZXMpLijottT8ToKiHUD4Wp1G1SDQOnjtjt4e3q0yV+A+XyeRCJBoVDA0IeNOxevsHtsms6pM3w/eoLMoSNsTc/QPn2W1uHjdJ8+i87hnwzl6Yz0k4uYmQzm22WslRX6S8tsz85hpFKYIjfeLGGJ4QcynPxivpjoCc2l7JGLmqpp4aBxDXERB2hYLpdZX8vRbPVw1VWcwgXc0jXcYgyvFMP4dpnGx/NhPnKvdFWwjOE7igCzxensjQGbzSbZ7CfaHQ1Py2EXr+OU7wqP41biGPk77K7dwha5M+Fm8TaerYg/JMASx12r1dA0jV+sECg1E8gYagAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"\"\n        src=\"/static/b7a2aa3a1ba1c6459c34facd813e9e18/cfd82/img.png\"\n        srcset=\"/static/b7a2aa3a1ba1c6459c34facd813e9e18/e7570/img.png 170w,\n/static/b7a2aa3a1ba1c6459c34facd813e9e18/f46e7/img.png 340w,\n/static/b7a2aa3a1ba1c6459c34facd813e9e18/cfd82/img.png 544w\"\n        sizes=\"(max-width: 544px) 100vw, 544px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">img.png</figcaption>\n  </figure></p>\n<h2 id=\"Spring-Cache로-캐시-계층-구조-사용하기\" style=\"position:relative;\">Spring Cache로 캐시 계층 구조 사용하기<a href=\"#Spring-Cache%EB%A1%9C-%EC%BA%90%EC%8B%9C-%EA%B3%84%EC%B8%B5-%EA%B5%AC%EC%A1%B0-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"Spring Cache로 캐시 계층 구조 사용하기 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Spring에서는 Cache 추상화를 통해 다양한 캐시 솔루션을 일관성있게 사용할 수 있게 한다.<br>\n트랜잭션과 마찬가지로, AOP를 이용해 특정 캐시 기술에 종송되지 않고 캐시 기능을 투명하게 적용할 수 있다.</p>\n<h3 id=\"CacheManager-구현체\" style=\"position:relative;\">CacheManager 구현체<a href=\"#CacheManager-%EA%B5%AC%ED%98%84%EC%B2%B4\" aria-label=\"CacheManager 구현체 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>스프링에서 제공하는 CacheManager 구현체는 아래와 같다.   </p>\n<ul>\n<li>CaffeineCacheManager</li>\n<li>CompositeCacheManager</li>\n<li>ConcurrentMapCacheManager</li>\n<li>JCacheCacheManager</li>\n<li>NoOpCacheManager</li>\n<li>SimpleCacheManager</li>\n</ul>\n<h3 id=\"의존성-추가\" style=\"position:relative;\">의존성 추가<a href=\"#%EC%9D%98%EC%A1%B4%EC%84%B1-%EC%B6%94%EA%B0%80\" aria-label=\"의존성 추가 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">implementation <span class=\"token string\">'org.springframework.boot:spring-boot-starter-cache'</span></code></pre></div>\n<h3 id=\"EnableCaching-추가\" style=\"position:relative;\">@EnableCaching 추가<a href=\"#EnableCaching-%EC%B6%94%EA%B0%80\" aria-label=\"EnableCaching 추가 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>SpringBoot 에서 Cache 추상화를 사용하기 위해 해당 어노테이션을 추가한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableCaching</span>\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SpringCacheHierarchyApplication</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringCacheHierarchyApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"L1-L2-Cache-추가\" style=\"position:relative;\">L1, L2 Cache 추가<a href=\"#L1-L2-Cache-%EC%B6%94%EA%B0%80\" aria-label=\"L1 L2 Cache 추가 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>여기서는 캐시 계층 구조가 제대로 동작하기 위해 메모리 기반의 <code class=\"language-text\">SimpleCacheManager</code> 를 확장하여 사용한다.\n메모리 캐시에서 데이터가 get이나 put 될 때, 로그를 남기도록 설정하였다.<br>\n<code class=\"language-text\">ConcurrentMapCache</code> 캐쉬는 내부적으로 <code class=\"language-text\">ConcurrentMap</code> 을 사용하여 캐시를 관리하는데 <code class=\"language-text\">ConcurrentMap</code> 의 capacity를 고정하기 어려워\nput 할 때 마다, <code class=\"language-text\">clear()</code> 메서드를 호출하였다. capacity가 1이고 FIFO 방식으로 교체하는 캐시라고 생각하면 편하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">L1Cache</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ConcurrentMapCache</span> <span class=\"token punctuation\">{</span>\n\n\n\t<span class=\"token annotation punctuation\">@Override</span> <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L1 cache lookup key = {}\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token annotation punctuation\">@Override</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L1 cache put = key:{}, value:{}\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>springcachehierarchy<span class=\"token punctuation\">.</span>cache</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Callable</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConcurrentMap</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">lombok<span class=\"token punctuation\">.</span>extern<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Slf4j</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">ConcurrentMapCache</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>serializer<span class=\"token punctuation\">.</span>support<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">SerializationDelegate</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">L2Cache</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ConcurrentMapCache</span> <span class=\"token punctuation\">{</span>\n\n\n\t<span class=\"token annotation punctuation\">@Override</span> <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L2 cache lookup key = {}\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token annotation punctuation\">@Override</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Object</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"L2 cache put = key:{}, value:{}\"</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"L1-L2-Cache-Bean-등록\" style=\"position:relative;\">L1, L2 Cache Bean 등록<a href=\"#L1-L2-Cache-Bean-%EB%93%B1%EB%A1%9D\" aria-label=\"L1 L2 Cache Bean 등록 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>위에서 만든 L1, L2 Cache 를 <code class=\"language-text\">SimpleCacheManager</code>의 구현체로 @Bean 으로 등록한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheConfig</span> <span class=\"token punctuation\">{</span>\n\t\n\t<span class=\"token annotation punctuation\">@Primary</span>\n\t<span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"l1CacheManager\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">CacheManager</span> <span class=\"token function\">l1CacheManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> simpleCacheManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleCacheManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsimpleCacheManager<span class=\"token punctuation\">.</span><span class=\"token function\">setCaches</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">L1Cache</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> simpleCacheManager<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n\n\t<span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"l2CacheManager\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">CacheManager</span> <span class=\"token function\">l2CacheManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> simpleCacheManager <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleCacheManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsimpleCacheManager<span class=\"token punctuation\">.</span><span class=\"token function\">setCaches</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">L2Cache</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> simpleCacheManager<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"CacheService\" style=\"position:relative;\">CacheService<a href=\"#CacheService\" aria-label=\"CacheService permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Caching</span><span class=\"token punctuation\">(</span>cacheable <span class=\"token operator\">=</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>cacheManager <span class=\"token operator\">=</span> <span class=\"token string\">\"l1CacheManager\"</span><span class=\"token punctuation\">,</span> cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"L1Cache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>cacheManager <span class=\"token operator\">=</span> <span class=\"token string\">\"l2CacheManager\"</span><span class=\"token punctuation\">,</span> cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"L2Cache\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"findById = {}\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> id<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">@Caching</code> 어노테이션의 <code class=\"language-text\">cacheable</code> 필드는 <code class=\"language-text\">@Cacheable</code> 어노테이션의 배열을 인자로 받는다.<br>\n첫번째 <code class=\"language-text\">@Cacheable</code> 어노테이션의 <code class=\"language-text\">cacheManager</code> 는 <code class=\"language-text\">l1CacheManager</code> 로 설정하고<br>\n두번쨰 <code class=\"language-text\">@Cacheable</code> 어노테이션읜 <code class=\"language-text\">cacheManager</code> 는 <code class=\"language-text\">l2CacheManager</code> 로 설정한다.<br>\n내가 기대하는 것은 <code class=\"language-text\">l1CacheManager</code> 에 key 값에 캐시가 없다면 <code class=\"language-text\">l2CacheManager</code> 로 값을 탐색하고,<br>\n<code class=\"language-text\">l2CacheManager</code> 도 없다면 <code class=\"language-text\">findById</code> 메서드가 호출되는 것이다. 테스트 코드로 검증을 해보자.</p>\n<h3 id=\"CacheService-캐시-계층-구조-테스트\" style=\"position:relative;\">CacheService 캐시 계층 구조 테스트<a href=\"#CacheService-%EC%BA%90%EC%8B%9C-%EA%B3%84%EC%B8%B5-%EA%B5%AC%EC%A1%B0-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"CacheService 캐시 계층 구조 테스트 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>테스트 코드를 짜고, 로그를 통해 동작을 확인해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheServiceTest</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Autowired</span> <span class=\"token class-name\">CacheService</span> cacheService<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Test</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token class-name\">CacheService_</span>캐시_동작_테스트<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> value1 <span class=\"token operator\">=</span> cacheService<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value1 return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> value2 <span class=\"token operator\">=</span> cacheService<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value2 return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> value3 <span class=\"token operator\">=</span> cacheService<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value3 return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> value4 <span class=\"token operator\">=</span> cacheService<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value4 return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> value5 <span class=\"token operator\">=</span> cacheService<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value5 return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin-bottom: 16px;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6a41b65a68adfc818763b423f16a01fb/02f69/log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB2ElEQVR42h2SS3PTQBCE9Ru4QCDEsS3LtlYr7UsPO7Ycx/EjdkKloAqSHIELBTlD8Wf4qR8TH1QrzXRrprs3ao3hsjBcOUeba5bWs/ZD7ur3rF2fWaZptWblvfSsYHIWRUEzGjEdp/JujrVqMMB0zohUOUWHBjuZo3xFVrbsblJ+fH3L7V3MsChJbYmpZxTyKFeRaEcnUdLzwqnpjXO6Y013qIh2znJjDYfg2RrNzgUe2pifH17ztDxnLdN3Jue2DEfMITg2hWY+iFllir3wVyplnsQs+l2irRQ2ImVfllwLceNKvswTnm9PeFycs8xyVmLF1jtesNemYKkzpiLxUinWssxSflz1eyzO3hGZckIhkp3IyUVyHloON2Oev59wfx+TmupYD9MW38zQriYTC2KRmBov3AkjbYmVwQ5HRDMx9SIvmBvLRMyfGce+Sfh8dcq66tGonIkEMxcVL5gXfJ0qbBwfzwsJKEhAZpDQxj3xULzZSoL7umbjRb5M/P3Y49/fV/z61GGRWUlbPJb+vq7YhSCyDdNhItLFc+GvipxaBlx0TomCbFTJ1EauSymbBkn16TDgz7c3fNx0Mak51ic+0DhPLTgnvqZxglX6+G3TjHF/wLDT5T9yGAKOhuGnIAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"\"\n        src=\"/static/6a41b65a68adfc818763b423f16a01fb/ca1dc/log.png\"\n        srcset=\"/static/6a41b65a68adfc818763b423f16a01fb/e7570/log.png 170w,\n/static/6a41b65a68adfc818763b423f16a01fb/f46e7/log.png 340w,\n/static/6a41b65a68adfc818763b423f16a01fb/ca1dc/log.png 680w,\n/static/6a41b65a68adfc818763b423f16a01fb/02d09/log.png 1020w,\n/static/6a41b65a68adfc818763b423f16a01fb/9d567/log.png 1360w,\n/static/6a41b65a68adfc818763b423f16a01fb/02f69/log.png 1394w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">img.png</figcaption>\n  </figure></p>\n<ol>\n<li><code class=\"language-text\">findById (id:a)</code> 호출 시, L1, L2 캐시 모두 Cache Miss 로 서비스 메서드가 호출되었다. 메서드가 호출되고 L1, L2 캐시 모두 호출 결과가 캐싱되었다.</li>\n<li><code class=\"language-text\">findById (id:a)</code> 호출 시, L1 캐시에 id:a 이 있으므로, Cache Hit 되었다.</li>\n<li><code class=\"language-text\">findById (id:b)</code> 호출 시, id:2가 L1, L2 캐시에 없으므로 서비스 메서드가 호출되었다. 결과가 캐싱되고, L1 캐시는 capacity가 1이므로 id:b 가 캐싱되어 있을 것이다.</li>\n<li><code class=\"language-text\">findById (id:b)</code> 호출 시, L1 캐시에 id:b 이 있으므로, Cache Hit 되었다.</li>\n<li><code class=\"language-text\">findById (id:a)</code> 호출 시, L1 캐시에서 Cache Miss로 L2 캐시에서 Cache Hit 되었다.</li>\n</ol>\n<p>로그를 통해 내가 의도한대로 동작되는 것을 확인할 수 있다. </p>\n<h2 id=\"Local-Cache-와-Redis로-L1-L2-캐시-계층-구성하기\" style=\"position:relative;\">Local Cache 와 Redis로 L1, L2 캐시 계층 구성하기<a href=\"#Local-Cache-%EC%99%80-Redis%EB%A1%9C-L1-L2-%EC%BA%90%EC%8B%9C-%EA%B3%84%EC%B8%B5-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0\" aria-label=\"Local Cache 와 Redis로 L1 L2 캐시 계층 구성하기 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>L1 계층의 캐시는 SimpleCacheManager 그대로 사용하고, L2 계층의 캐시를 Redis로 마이그레이션 한다.\n서버 인스턴스가 여러대 인 경우, L1 계층인 로컬 캐시와 L2 계층의 Redis 캐시가 일관성이 꺠질 수 있으므로\nRedis pub/sub을 사용하여 로컬 캐시와 Redis 캐시의 일관성을 유지하도록 한다.</p>\n<h3 id=\"Redis-설정\" style=\"position:relative;\">Redis 설정<a href=\"#Redis-%EC%84%A4%EC%A0%95\" aria-label=\"Redis 설정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisMessageListenerContainer</span> <span class=\"token class-name\">RedisMessageListener</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisConnectionFactory</span> connectionFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">RedisMessageListenerContainer</span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisMessageListenerContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tcontainer<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>connectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tcontainer<span class=\"token punctuation\">.</span><span class=\"token function\">addMessageListener</span><span class=\"token punctuation\">(</span>redisMessageListener<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ChannelTopic</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> container<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\t\n\t<span class=\"token annotation punctuation\">@Bean</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisConnectionFactory</span> connectionFactory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tredisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>connectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tredisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setKeySerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tredisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">setValueSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> redisTemplate<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"Redis-MessageListener-설정\" style=\"position:relative;\">Redis MessageListener 설정<a href=\"#Redis-MessageListener-%EC%84%A4%EC%A0%95\" aria-label=\"Redis MessageListener 설정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisMessageListener</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">MessageListener</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CacheManager</span><span class=\"token punctuation\">></span></span> cacheManagerList<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">Message</span> message<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> pattern<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">final</span> <span class=\"token keyword\">var</span> evictKey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">CacheManager</span> cacheManager <span class=\"token operator\">:</span> cacheManagerList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tcacheManager<span class=\"token punctuation\">.</span><span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">evict</span><span class=\"token punctuation\">(</span>evictKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"Redis-CacheManager-설정\" style=\"position:relative;\">Redis CacheManager 설정<a href=\"#Redis-CacheManager-%EC%84%A4%EC%A0%95\" aria-label=\"Redis CacheManager 설정 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheConfig</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RedisConnectionFactory</span> connectionFactory<span class=\"token punctuation\">;</span>\n\t\n\t<span class=\"token comment\">// l2RedisCacheManager bean 추가</span>\n\t<span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"l2RedisCacheManager\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">CacheManager</span> <span class=\"token function\">redisCacheManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token class-name\">RedisCacheConfiguration</span> redisCacheConfiguration <span class=\"token operator\">=</span> <span class=\"token class-name\">RedisCacheConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token function\">defaultCacheConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeKeysWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisSerializationContext<span class=\"token punctuation\">.</span>SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">serializeValuesWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RedisSerializationContext<span class=\"token punctuation\">.</span>SerializationPair</span><span class=\"token punctuation\">.</span><span class=\"token function\">fromSerializer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisSerializer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">return</span> <span class=\"token class-name\">RedisCacheManager<span class=\"token punctuation\">.</span>RedisCacheManagerBuilder</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">fromConnectionFactory</span><span class=\"token punctuation\">(</span>connectionFactory<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">cacheDefaults</span><span class=\"token punctuation\">(</span>redisCacheConfiguration<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"CacheService-Cacheable-설정변경\" style=\"position:relative;\">CacheService @Cacheable 설정변경<a href=\"#CacheService-Cacheable-%EC%84%A4%EC%A0%95%EB%B3%80%EA%B2%BD\" aria-label=\"CacheService Cacheable 설정변경 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheService</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Caching</span><span class=\"token punctuation\">(</span>cacheable <span class=\"token operator\">=</span>\n      <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>cacheManager <span class=\"token operator\">=</span> <span class=\"token string\">\"l1CacheManager\"</span><span class=\"token punctuation\">,</span> cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token annotation punctuation\">@Cacheable</span><span class=\"token punctuation\">(</span>cacheManager <span class=\"token operator\">=</span> <span class=\"token string\">\"l2RedisCacheManager\"</span><span class=\"token punctuation\">,</span> cacheNames <span class=\"token operator\">=</span> <span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"findById = {}\"</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> id<span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 코드를 추가한 후, 첫번쨰 테스트 코드를 다시 돌려보자.\nredis에 접속해서 <code class=\"language-text\">keys *</code> 명령어로 확인해보면 <code class=\"language-text\">Cache::a</code>, <code class=\"language-text\">Cache::b</code> 키값이 잘 들어가 있는 것을 볼 수 있다.</p>\n<p>Redis Pub/Sub 으로 캐시값이 evict되면 로컬캐시와 redis캐시에 잘 반영되는지 테스트 코드로 검증해보자</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CacheServiceTest</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token annotation punctuation\">@Autowired</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CacheManager</span><span class=\"token punctuation\">></span></span> cacheManagerList<span class=\"token punctuation\">;</span>\n\t<span class=\"token annotation punctuation\">@Autowired</span> <span class=\"token class-name\">RedisTemplate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> redisTemplate<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token annotation punctuation\">@Test</span>\n\t<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Reids Topic에 subscribe이 발생하면 해당 키가 l1, l2 캐시에서 evict 된다\"</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">void</span> redis_pub_sub_cache_evict_테스트<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token comment\">// given</span>\n\t\t<span class=\"token keyword\">var</span> topic <span class=\"token operator\">=</span> <span class=\"token string\">\"Cache\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> key <span class=\"token operator\">=</span> <span class=\"token string\">\"key1\"</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">var</span> value <span class=\"token operator\">=</span> <span class=\"token string\">\"value1\"</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">CacheManager</span> cacheManager <span class=\"token operator\">:</span> cacheManagerList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tcacheManager<span class=\"token punctuation\">.</span><span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token class-name\">Assertions</span><span class=\"token punctuation\">.</span><span class=\"token function\">assertEquals</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> cacheManager<span class=\"token punctuation\">.</span><span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token comment\">// when</span>\n\t\tredisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">convertAndSend</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 캐시 무효화 메시지가 subscribe 될때까지 기다린다</span>\n\n\t\t<span class=\"token comment\">// then</span>\n\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">CacheManager</span> cacheManager <span class=\"token operator\">:</span> cacheManagerList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token class-name\">Assertions</span><span class=\"token punctuation\">.</span><span class=\"token function\">assertNull</span><span class=\"token punctuation\">(</span>cacheManager<span class=\"token punctuation\">.</span><span class=\"token function\">getCache</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"정리\" style=\"position:relative;\">정리<a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor-header after\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>여기서는 2차 캐시인 redis에 데이터가 변경된다면 redis pub/sub을 key 값을 이용해서 변경된 데이터를 무효화하였다.\n필요에 따라 pub/sub 시 key,value를 한 메시지에 담아서 보내서 캐시가 새 값으로 교체되는 정책을 적용할 수 도 있다.<br>\nRedis에 대량의 데이터가 적재되어 로컬 캐시에 모두 담을 수 없는 경우 또는 서버 인스턴스 메모리를 세심하게 관리해야 되는 경우\nEhcache 같은 캐시 라이브러리와 Redis를 함께 사용해서 낮은 레이턴시를 유지하면서도 메모리 관리도 효율적으로 할 수 있을 것 이다.\n다만, 캐시 값이 변경되면 캐시 일관성을 위해 각 계층에 동기화하는 오버헤드가 발생하므로, 자주 변하지 않는 데이터로 캐시 계층을 구성해야 한다.</p>","fields":{"slug":"/spring-cache-hierarchy/"},"frontmatter":{"title":"Spring Cache 로 캐시 계층 구조 사용하기","date":"July 16, 2023"}}]}},"pageContext":{"id":"c2d0081b-ae3d-5801-ace1-d61452e19444","series":null,"tags":[],"previousPostId":"95f697c4-8442-5eca-942d-91d8eeb8cc56","nextPostId":"8d197033-5a60-5434-bc31-0481d7d6e8c4"}},"staticQueryHashes":[],"slicesMap":{}}